rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper: verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función helper: obtener datos del usuario actual
    function getCurrentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Función helper: verificar si es Admin
    function isAdmin() {
      return isAuthenticated() && (
        getCurrentUser().role == 'Admin' ||
        getCurrentUser().rol == 'admin'
      );
    }
    
    // Función helper: verificar si es Profesor
    function isTeacher() {
      return isAuthenticated() && (
        getCurrentUser().role == 'Profesor' ||
        getCurrentUser().rol == 'profesor' ||
        getCurrentUser().rol == 'teacher'
      );
    }
    
    // === COLECCIÓN: users ===
    match /users/{userId} {
      // Permitir lectura a cualquier usuario autenticado (para búsquedas)
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      // Permitir que el propio usuario actualice su perfil y progreso,
      // pero sin cambiar email/role/schoolId/createdAt.
      allow update: if isAuthenticated() && (
        isAdmin() || (
          request.auth.uid == userId &&
          request.resource.data.email == resource.data.email &&
          request.resource.data.role == resource.data.role &&
          request.resource.data.schoolId == resource.data.schoolId &&
          request.resource.data.createdAt == resource.data.createdAt
        )
      );
      allow delete: if isAdmin();
      
      match /notifications/{notifId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      match /announcementsRead/{annId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      match /progress/{docId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      match /earnedBadges/{badgeId} {
        allow read: if request.auth.uid == userId;
        allow write: if false;
      }
    }
    
    // === COLECCIÓN: schools ===
    match /schools/{schoolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // === COLECCIÓN: groups ===
    match /groups/{groupId} {
      // Para lecturas, usar get() del documento del grupo
      allow read: if isAuthenticated() && 
                     (request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      allow create: if isTeacher();
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      match /posts/{postId} {
        allow read: if isAuthenticated() && 
                       get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] in ['Estudiante', 'Profesor'];
        
        allow create: if isAuthenticated() && 
                         get(/databases/$(database)/documents/groups/$(groupId)).data.members[request.auth.uid] in ['Estudiante', 'Profesor'];
        
        allow update, delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
        
        match /replies/{replyId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update, delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
        }
      }
      
      match /assignments/{assignmentId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && 
                        get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid;
        
        match /submissions/{studentId} {
          allow read: if isAuthenticated();
          allow create, update: if isAuthenticated() && studentId == request.auth.uid;
        }
      }
    }
    
    // === COLECCIÓN: chats ===
    match /chats/{chatId} {
      // Permitir crear chat si el usuario autenticado está en participants
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Permitir leer/actualizar si el usuario está en participants
      allow read, update: if isAuthenticated() && 
                             request.auth.uid in resource.data.participants;
      
      // Subcollection de mensajes
      match /messages/{messageId} {
        // Leer mensajes si eres participante del chat
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Crear mensajes si eres participante y el senderId es tu uid
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                         request.resource.data.senderId == request.auth.uid;
      }
    }
    
    // === COLECCIÓN: courses ===
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      match /modules/{moduleId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
        
        match /lessons/{lessonId} {
          allow read: if isAuthenticated();
          allow write: if isAdmin();
          
          match /comments/{commentId} {
            allow read: if isAuthenticated();
            allow create: if isAuthenticated();
            allow update, delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
          }
        }
      }
    }
    
    // === COLECCIÓN: labGames ===
    match /labGames/{gameId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // === COLECCIÓN: lessons (catálogo principal) ===
    match /lessons/{lessonId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // === COLECCIÓN: badges ===
    match /badges/{badgeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // === COLECCIÓN: passwordResetRequests ===
    match /passwordResetRequests/{requestId} {
      // Permitir que usuarios autenticados creen solicitudes (para sí mismos o para otros)
      allow create: if isAuthenticated();
      // Solo admins pueden leer y actualizar solicitudes
      allow read, update: if isAdmin();
      // No permitir delete
      allow delete: if false;
    }
    
    // === COLECCIÓN: userPasswords ===
    match /userPasswords/{userId} {
      // Los usuarios pueden escribir solo su propio documento
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Solo admins pueden leer las contraseñas
      allow read: if isAdmin();
    }
  }
}