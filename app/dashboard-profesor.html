<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Profesor - CodeKids</title>
        <script>
            // Preaplicar tema oscuro en p√°ginas internas
            try { const t = localStorage.getItem('app-theme'); if (t==='dark'){ document.documentElement.classList.add('theme-dark','dark'); } } catch(_){ }
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
           <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/dashboard-profesor-colors.css">
        <style>
            /* Estilos para marcos de avatar */
            .avatar-frame-none {
                border: 2px solid transparent !important;
            }
            .avatar-frame-bronce {
                border: 3px solid #CD7F32 !important;
                box-shadow: 0 0 12px rgba(205, 127, 50, 0.6);
            }
            .avatar-frame-plata {
                border: 3px solid #C0C0C0 !important;
                box-shadow: 0 0 12px rgba(192, 192, 192, 0.8);
            }
            .avatar-frame-oro {
                border: 3px solid #FFD700 !important;
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            }
            .avatar-frame-diamante {
                border: 3px solid #B9F2FF !important;
                box-shadow: 0 0 18px rgba(185, 242, 255, 1), 0 0 25px rgba(0, 191, 255, 0.6);
                animation: diamondPulse 2s ease-in-out infinite;
            }
            @keyframes diamondPulse {
                0%, 100% { box-shadow: 0 0 18px rgba(185, 242, 255, 1), 0 0 25px rgba(0, 191, 255, 0.6); }
                50% { box-shadow: 0 0 25px rgba(185, 242, 255, 1), 0 0 35px rgba(0, 191, 255, 0.8); }
            }
            
            /* Estilos para pesta√±as de grupos */
            .group-tab {
                color: #6b7280;
                border-bottom-color: transparent;
                position: relative;
            }
            .group-tab:hover {
                color: #4b5563;
                background-color: #f9fafb;
            }
            .group-tab.active {
                color: #6f42c1;
                border-bottom-color: #6f42c1;
                background-color: white;
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
            
            /* Scroll personalizado para contenido del modal */
            #groupTabContent::-webkit-scrollbar {
                width: 8px;
            }
            #groupTabContent::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }
            #groupTabContent::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 10px;
            }
            #groupTabContent::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            
            /* Asegurar que el modal no corte contenido */
            #groupDetailModal {
                backdrop-filter: blur(2px);
            }
            
            /* Ajustar posici√≥n del modal para respetar sidebar */
            @media (min-width: 1024px) {
                #groupDetailModal > div {
                    margin-left: 16rem; /* 256px = w-64 del sidebar */
                }
            }
            
            @media (max-width: 1023px) {
                #groupDetailModal > div {
                    margin-left: 0;
                    padding-left: 1rem;
                    padding-right: 1rem;
                }
            }
            
            /* ============ THEME TOGGLE STYLES ============ */
            .theme-toggle { 
                background: transparent; 
                border: none; 
                cursor: pointer; 
                display: flex; 
                align-items: center; 
                gap: 8px; 
                padding: 6px; 
                border-radius: 8px; 
                transition: background 0.2s ease; 
            }
            .theme-toggle:hover { background: rgba(0, 0, 0, 0.05); }
            .theme-dark .theme-toggle:hover { background: rgba(255, 255, 255, 0.1); }
            .theme-toggle .icon-sun, .theme-toggle .icon-moon { 
                font-size: 18px; 
                line-height: 1; 
                transition: opacity 0.2s ease; 
            }
            .toggle-switch { 
                width: 44px; 
                height: 24px; 
                background: #E6E6E6; 
                border-radius: 999px; 
                position: relative; 
                display: inline-block; 
                transition: background 0.3s ease; 
            }
            .toggle-thumb { 
                width: 20px; 
                height: 20px; 
                background: #fff; 
                border-radius: 50%; 
                position: absolute; 
                top: 2px; 
                left: 2px; 
                box-shadow: 0 6px 14px rgba(0,0,0,0.12); 
                transition: transform 220ms cubic-bezier(.2,.9,.2,1); 
            }
            .theme-on .toggle-switch { background: linear-gradient(90deg, #8B39FF, #6EC6FF); }
            .theme-on .toggle-thumb { transform: translateX(20px); }
            .theme-on .icon-sun { opacity: 0.2; }
            .theme-off .icon-moon { opacity: 0.2; }
            .theme-toggle:focus-visible { 
                outline: 3px solid rgba(111, 66, 193, 0.12); 
                border-radius: 8px; 
            }
        </style>
</head>
<body class="bg-gray-50">
    
    <!-- Inicializar State Manager y Firebase PRIMERO -->
    <script src="../js/state-manager.js"></script>
    <script type="module" src="../js/firebase-init.js"></script>
    
    <!-- Header Global -->
    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-6 py-3">
            <!-- Logo est√°tico (sin navegaci√≥n) -->
            <div class="flex items-center space-x-3">
                <div class="text-3xl font-extrabold gradient-text tracking-tight no-underline" style="cursor: default;">
                    Code Kids
                </div>
            </div>

            <!-- B√∫squeda Global -->
            <div class="flex-1 max-w-xl mx-6">
                <div class="relative">
                    <input 
                        type="search" 
                        id="globalSearch"
                        placeholder="Buscar lecciones, juegos, grupos..." 
                        class="w-full pr-12 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition"
                    >
                    <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-md hover:bg-gray-100" aria-label="Buscar">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </button>
                    <!-- Resultados de b√∫squeda -->
                    <div id="searchResults" class="hidden absolute top-full mt-2 w-full bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-y-auto z-50"></div>
                </div>
            </div>

            <!-- Controles Globales + Perfil -->
            <div class="flex items-center space-x-4">

                <!-- Notificaciones -->
                <div class="relative">
                    <button id="notificationBtn" class="relative p-2 hover:bg-gray-100 rounded-lg transition">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <span id="notificationDot" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                    <!-- Dropdown de notificaciones -->
                    <div id="notificationDropdown" class="hidden absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-y-auto z-50">
                        <div class="p-4 border-b border-gray-200">
                            <h3 class="font-bold text-gray-800">Notificaciones</h3>
                        </div>
                        <div id="notificationList" class="divide-y divide-gray-100">
                            <div class="p-4 text-center text-gray-500 text-sm">No hay notificaciones</div>
                        </div>
                    </div>
                </div>

                <!-- √çcono de Configuraci√≥n (Engranaje) - Movido antes del avatar -->
                <div class="relative">
                    <button id="settingsBtn" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Configuraci√≥n">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <!-- Men√∫ dropdown de configuraci√≥n -->
                    <div id="settingsMenu" class="hidden absolute top-full right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50">
                        <label for="avatarUpload" class="block px-4 py-2 hover:bg-gray-50 cursor-pointer transition flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Cambiar foto</span>
                            <input type="file" id="avatarUpload" class="hidden" accept="image/*">
                        </label>
                        <button id="btnFrames" class="w-full text-left px-4 py-2 hover:bg-gray-50 transition flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Agregar Marco</span>
                        </button>
                        <button id="btnSettings" class="w-full text-left px-4 py-2 hover:bg-gray-50 transition flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Configuraci√≥n</span>
                        </button>
                        <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition flex items-center gap-3">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Cerrar Sesi√≥n</span>
                        </button>
                    </div>
                </div>

                <!-- Bot√≥n de Tema Claro/Oscuro -->
                <button id="themeToggle" class="theme-toggle theme-off" aria-pressed="false" title="Alternar modo claro/oscuro">
                    <span class="icon-sun" aria-hidden="true">‚òÄÔ∏è</span>
                    <div class="toggle-switch" aria-hidden="true"><span class="toggle-thumb"></span></div>
                    <span class="icon-moon" aria-hidden="true">üåô</span>
                </button>

                <!-- Avatar del Profesor (Solo visualizaci√≥n) - Movido despu√©s del icono de configuraci√≥n -->
                <div class="flex items-center space-x-2 px-2">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=Usuario&background=667eea&color=fff" class="w-10 h-10 rounded-full border-2 border-transparent" alt="Perfil">
                    <div class="hidden md:block">
                        <p id="userName" class="text-sm font-semibold text-gray-800">Cargando...</p>
                        <p id="userRole" class="text-xs text-gray-500">Profesor</p>
                    </div>
                </div>
            </div>
        </div>
    </header>
                        <label class="block px-4 py-2 hover:bg-gray-100 transition text-gray-700 cursor-pointer flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Cambiar foto</span>
                            <input id="avatarUpload" type="file" accept="image/*" class="hidden" />
                        </label>
                        <button id="openFramesModal" class="w-full text-left block px-4 py-2 hover:bg-gray-100 transition text-gray-700">ÔøΩÔ∏è Agregar Marco</button>
                        <button id="openSettings" class="w-full text-left block px-4 py-2 hover:bg-gray-100 transition text-gray-700 flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Configuraci√≥n</span>
                        </button>
                        <hr class="my-2">
                        <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 transition flex items-center gap-3">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Cerrar Sesi√≥n</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Layout Principal -->
    <div class="flex pt-16" style="min-height: calc(100vh - 4rem);">
        
        <!-- Sidebar -->
        <aside class="sidebar w-64 fixed left-0 h-full overflow-y-auto bg-white shadow-lg" style="top: 4rem;">
            <div class="p-4">
                <nav class="space-y-1">
                    <a href="#inicio" class="sidebar-item active" data-route="inicio">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Inicio</span>
                    </a>
                    
                    <a href="#calificaciones" class="sidebar-item" data-route="calificaciones">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <span>Calificaciones</span>
                    </a>

                    <a href="#tareas" class="sidebar-item" data-route="tareas">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <span>Tareas</span>
                    </a>

                    <a href="#estadisticas" class="sidebar-item" data-route="estadisticas">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Estad√≠sticas</span>
                    </a>

                    <a href="#grupos" class="sidebar-item" data-route="grupos">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>Mis Grupos</span>
                    </a>

                    <a href="#chats" class="sidebar-item" data-route="chats">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>Chats</span>
                        <span id="chatBadge" class="hidden ml-auto badge badge-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">0</span>
                    </a>

                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-0 md:ml-64 p-6">
            <!-- Secci√≥n INICIO (visible por defecto) -->
            <section id="section-inicio" class="block" data-section>
            <!-- Grid principal 2 columnas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Columna Izquierda (70%) -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Bienvenida -->
                    <div class="animate-fade-in">
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">Hola, <span id="welcomeName">Profesor</span></h1>
                        <p class="text-gray-600 text-lg">Tu centro de gesti√≥n educativa</p>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card kpi-grupos hover-lift cursor-pointer transition-smooth" onclick="window.location.hash='#grupos';">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-gray-500 uppercase">Grupos</p>
                                    <p id="statsGroups" class="text-2xl font-bold kpi-number">0</p>
                                </div>
                                <div class="w-12 h-12 kpi-icon-bg rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Total de grupos asignados</p>
                        </div>
                        
                        <div class="card kpi-estudiantes hover-lift cursor-pointer transition-smooth" onclick="window.location.hash='#estadisticas';">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-gray-500 uppercase">Estudiantes</p>
                                    <p id="statsStudents" class="text-2xl font-bold kpi-number">0</p>
                                </div>
                                <div class="w-12 h-12 kpi-icon-bg rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Total de estudiantes</p>
                        </div>
                        
                        <div class="card kpi-tareas hover-lift cursor-pointer transition-smooth" onclick="window.location.hash='#tareas'">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-gray-500 uppercase">Tareas</p>
                                    <p id="statsTasks" class="text-2xl font-bold kpi-number">0</p>
                                </div>
                                <div class="w-12 h-12 kpi-icon-bg rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Tareas pendientes</p>
                        </div>
                        
                        <div class="card kpi-promedio hover-lift cursor-pointer transition-smooth" onclick="window.location.hash='#calificaciones'">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-gray-500 uppercase">Promedio</p>
                                    <p id="statsAverage" class="text-2xl font-bold kpi-number">0</p>
                                </div>
                                <div class="w-12 h-12 kpi-icon-bg rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Promedio general</p>
                        </div>
                    </div>

                    <!-- Feed de Anuncios -->
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                </svg>
                                <span>Anuncios</span>
                            </h2>
                            <button id="refreshAnnouncements" class="text-sm px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                Actualizar
                            </button>
                        </div>
                        <div id="announcementsFeed" class="space-y-3 max-h-96 overflow-y-auto"></div>
                        <div class="mt-4 text-center">
                            <button id="loadMoreAnnouncements" class="text-sm text-indigo-600 hover:underline">Cargar m√°s</button>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha (30%) -->
                <div class="space-y-6">
                    <!-- Actividad Reciente de Estudiantes -->
                    <div class="card widget">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2 widget-icon-notification">
                                <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </span>
                            Actividad de Estudiantes
                        </h2>
                        <div id="studentActivity" class="space-y-3 text-sm">
                            <p class="text-gray-500">Sin actividad reciente</p>
                        </div>
                    </div>

                    <!-- Tareas por Calificar -->
                    <div class="card widget">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2 widget-icon-action">‚úÖ</span>
                            Por Calificar
                        </h2>
                        <div id="tasksToGrade" class="space-y-3 text-sm">
                            <p class="text-gray-500">No hay tareas pendientes</p>
                        </div>
                    </div>

                    <!-- Alerta de Bajo Rendimiento -->
                    <div class="card widget">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2 widget-icon-calendar">‚ö†Ô∏è</span>
                            Alertas
                        </h2>
                        <div id="alerts" class="space-y-2 text-xs text-gray-600">
                            <p class="text-gray-500">Sin alertas</p>
                        </div>
                    </div>
                </div>
            </div>
            </section>

            <!-- Secci√≥n CALIFICACIONES -->
            <section id="section-calificaciones" class="hidden" data-section>
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Calificaciones</span>
                    </h1>
                    <p class="text-gray-600">Gestiona y revisa las calificaciones de tus estudiantes</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <p class="text-center text-gray-400 py-8">
                        Sistema de calificaciones. 
                        <a href="profesor-calificaciones.html" class="text-indigo-600 hover:underline">Ir al sistema completo ‚Üí</a>
                    </p>
                </div>
            </section>

            <!-- Secci√≥n ESTAD√çSTICAS -->
            <section id="section-estadisticas" class="hidden" data-section>
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        <span>Estad√≠sticas de Estudiantes</span>
                    </h1>
                    <p class="text-gray-600">Analiza el rendimiento y progreso de tus estudiantes</p>
                </div>
                
                <div id="statsGridProf" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <span>Promedio por Materia</span>
                        </h3>
                        <div id="subjectAverages" class="space-y-2 text-sm">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span>Estudiantes Destacados</span>
                        </h3>
                        <div id="topStudents" class="space-y-2 text-sm">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="font-bold text-gray-800 mb-3">‚ö†Ô∏è Requieren Atenci√≥n</h3>
                        <div id="studentsAtRisk" class="space-y-2 text-sm">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n LECCIONES (oculta, para compatibilidad) -->
            <section id="section-lecciones" class="hidden" data-section>
                <!-- Vista de Cat√°logo -->
                <div id="catalogViewDash" class="mb-6">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <span>Mis Lecciones</span>
                        </h1>
                        <p class="text-gray-600">Selecciona un curso para comenzar tu aprendizaje</p>
                    </div>
                    
                    <div id="coursesGridDash" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Las tarjetas se cargar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Vista de Detalle del Curso -->
                <div id="detailViewDash" class="hidden">
                    <button id="btnBackToCatalogDash" class="mb-4 flex items-center gap-2 text-indigo-600 hover:text-indigo-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Volver al cat√°logo
                    </button>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Barra lateral con lista de videos -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow p-4">
                            <div class="mb-4">
                                <h2 id="courseTitleDash" class="text-xl font-bold text-gray-800 mb-2"></h2>
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span id="courseProgressDash">0% completado</span>
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div id="courseProgressBarDash" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="videosListDash" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Videos se cargar√°n aqu√≠ -->
                            </div>
                        </div>

                        <!-- Reproductor y descripci√≥n -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Reproductor -->
                            <div class="bg-white rounded-xl shadow overflow-hidden">
                                <div class="aspect-video bg-black relative">
                                    <div id="ytPlayerContainerDash"></div>
                                    <div id="videoLoadingDash" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75">
                                        <div class="text-white text-center">
                                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                                            <p>Cargando video...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <h3 id="currentVideoTitleDash" class="text-xl font-bold text-gray-800 mb-2">Selecciona un video</h3>
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-600">
                                            <span id="videoProgressDash">Progreso: 0%</span>
                                        </div>
                                        <button id="btnMarkCompleteDash" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition" onclick="window.markVideoCompleteDash()">
                                            ‚úì Completar y continuar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Descripci√≥n del curso -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <span>Sobre este curso</span>
                                </h3>
                                <p id="courseDescriptionDash" class="text-gray-600 leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n LABORATORIO -->
            <section id="section-laboratorio" class="hidden" data-section>
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Laboratorio de Juegos</span>
                    </h1>
                    <p class="text-gray-600">Practica programaci√≥n jugando. ¬°Gana XP mientras te diviertes!</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="gamesGridDash">
                    <!-- Juego 1: Laberinto -->
                    <div class="game-card bg-white rounded-xl shadow-lg p-6 cursor-pointer" data-game="maze">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path>
                                </svg>
                                <span>Laberinto de Bloques</span>
                            </h3>
                            <span class="text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded-full">+30 XP</span>
                        </div>
                        <p class="text-gray-600 mb-4">Programa los movimientos del robot para llegar a la meta. Usa comandos de movimiento y l√≥gica.</p>
                        <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>5 min</span>
                            <span>‚Ä¢</span>
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span>Nivel: F√°cil</span>
                        </div>
                        <button class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition font-semibold flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"></path>
                            </svg>
                            <span>Jugar Ahora</span>
                        </button>
                    </div>

                    <!-- Juego 2: Typo-Racer -->
                    <div class="game-card bg-white rounded-xl shadow-lg p-6 cursor-pointer" data-game="typo">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                <span>Typo-Racer</span>
                            </h3>
                            <span class="text-sm px-3 py-1 bg-green-100 text-green-700 rounded-full">+20 XP</span>
                        </div>
                        <p class="text-gray-600 mb-4">Escribe c√≥digo Python lo m√°s r√°pido posible. Mejora tu velocidad y precisi√≥n de tecleo.</p>
                        <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>3 min</span>
                            <span>‚Ä¢</span>
                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span>Nivel: F√°cil</span>
                        </div>
                        <button class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-3 rounded-lg hover:from-green-700 hover:to-teal-700 transition font-semibold flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"></path>
                            </svg>
                            <span>Jugar Ahora</span>
                        </button>
                    </div>
                </div>
                
                <!-- Modal del juego -->
                <div id="gameModalDash" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl w-full max-w-4xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                        <button id="closeGameBtnDash" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        <div id="gameContentDash"></div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n GRUPOS -->
            <section id="section-grupos" class="hidden" data-section>
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <span>Mis Grupos</span>
                        </h2>
                        <p class="text-gray-600 mt-1">Gestiona tus grupos y estudiantes</p>
                    </div>
                    <button id="btnCreateGroup" class="btn btn-primary flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Crear Grupo
                    </button>
                </div>
                
                <!-- Grid de Grupos -->
                <div id="groupsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center text-gray-400 py-12 col-span-full">
                        <div class="text-6xl mb-4">
                            <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <p class="text-lg mb-2">No tienes grupos creados</p>
                        <p class="text-sm">Crea tu primer grupo para comenzar</p>
                    </div>
                </div>
            </section>

            <!-- Modal: Crear/Editar Grupo -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="groupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <h3 id="groupModalTitle" class="text-2xl font-bold text-gray-800">Crear Nuevo Grupo</h3>
                        <button id="closeGroupModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <form id="groupForm" class="p-6 space-y-4">
                        <!-- Nombre del Grupo -->
                        <div>
                            <label class="form-label">Nombre del Grupo *</label>
                            <input type="text" id="groupName" class="form-input" placeholder="Ej: Python B√°sico 2025A" required>
                        </div>
                        
                        <!-- Nivel/Grado y Materia -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Nivel/Grado *</label>
                                <select id="groupLevel" class="form-input" required>
                                    <option value="">Seleccionar nivel...</option>
                                    <option value="1¬∞ B√°sico">1¬∞ B√°sico</option>
                                    <option value="2¬∞ B√°sico">2¬∞ B√°sico</option>
                                    <option value="3¬∞ B√°sico">3¬∞ B√°sico</option>
                                    <option value="4¬∞ B√°sico">4¬∞ B√°sico</option>
                                    <option value="5¬∞ B√°sico">5¬∞ B√°sico</option>
                                    <option value="6¬∞ B√°sico">6¬∞ B√°sico</option>
                                    <option value="7¬∞ B√°sico">7¬∞ B√°sico</option>
                                    <option value="8¬∞ B√°sico">8¬∞ B√°sico</option>
                                    <option value="1¬∞ Medio">1¬∞ Medio</option>
                                    <option value="2¬∞ Medio">2¬∞ Medio</option>
                                    <option value="3¬∞ Medio">3¬∞ Medio</option>
                                    <option value="4¬∞ Medio">4¬∞ Medio</option>
                                    <option value="Principiante">Principiante</option>
                                    <option value="Intermedio">Intermedio</option>
                                    <option value="Avanzado">Avanzado</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Materia</label>
                                <input type="text" id="groupSubject" class="form-input" placeholder="Ej: Programaci√≥n">
                            </div>
                        </div>
                        
                        <!-- Color de Identificaci√≥n (Paleta Code Kids) -->
                        <div>
                            <label class="form-label">Color de Identificaci√≥n *</label>
                            <div class="grid grid-cols-6 gap-2">
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#6f42c1" class="hidden" required>
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #6f42c1;" title="Morado Intenso"></div>
                                </label>
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#4f46e5" class="hidden">
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #4f46e5;" title="Azul El√©ctrico"></div>
                                </label>
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#10b981" class="hidden">
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #10b981;" title="Verde Digital"></div>
                                </label>
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#f59e0b" class="hidden">
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #f59e0b;" title="Amarillo Atenci√≥n"></div>
                                </label>
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#f97316" class="hidden">
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #f97316;" title="Naranja Acci√≥n"></div>
                                </label>
                                <label class="color-option">
                                    <input type="radio" name="groupColor" value="#a855f7" class="hidden">
                                    <div class="w-full h-12 rounded-lg cursor-pointer border-2 border-transparent hover:border-gray-400 transition" style="background-color: #a855f7;" title="P√∫rpura Tareas"></div>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Selecciona un color para personalizar la tarjeta del grupo</p>
                        </div>
                        
                        <!-- Foto/√çcono del Grupo (Opcional) -->
                        <div>
                            <label class="form-label">Foto/√çcono del Grupo (Opcional)</label>
                            <div class="flex items-center gap-4">
                                <div id="groupIconPreview" class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center border-2 border-dashed border-gray-300">
                                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="groupIconFile" accept="image/*" class="hidden">
                                    <label for="groupIconFile" class="btn bg-gray-200 hover:bg-gray-300 cursor-pointer inline-flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        Subir Imagen
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">JPG, PNG o GIF (m√°x. 2MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Periodo Escolar -->
                        <div>
                            <label class="form-label">Periodo Escolar</label>
                            <input type="text" id="groupPeriod" class="form-input" placeholder="Ej: Enero - Junio 2025">
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div>
                            <label class="form-label">Descripci√≥n</label>
                            <textarea id="groupDescription" class="form-input" rows="3" placeholder="Describe el prop√≥sito y objetivos del grupo..."></textarea>
                        </div>
                        
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="btn btn-primary flex-1">
                                <span id="groupSubmitText">Crear Grupo</span>
                            </button>
                            <button type="button" id="cancelGroupModal" class="btn bg-gray-300 hover:bg-gray-400">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal: Vista Interna del Grupo con Pesta√±as -->
            <!-- Z-INDEX: 200 - Capa de Trabajo (Vista de Grupo) -->
            <div id="groupDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto" style="z-index: 200;">
                <div class="min-h-screen px-4 py-6 flex items-start justify-center">
                    <div class="bg-white rounded-2xl shadow-2xl w-full my-8 flex flex-col" style="max-width: calc(100vw - 18rem); max-height: calc(100vh - 4rem);">
                        <!-- Header con color del grupo y gradiente -->
                        <div class="flex-shrink-0 bg-gradient-to-r from-white to-gray-50 border-b-4 px-8 py-5 flex items-center justify-between shadow-sm rounded-t-2xl" id="groupDetailHeader" style="border-color: #6f42c1;">
                            <div class="flex items-center gap-5">
                                <div id="groupDetailIcon" class="w-20 h-20 rounded-xl flex items-center justify-center text-white font-bold text-3xl shadow-lg transform hover:scale-105 transition" style="background-color: #6f42c1;">
                                    G
                                </div>
                                <div>
                                    <h3 id="groupDetailName" class="text-3xl font-bold text-gray-800 mb-1"></h3>
                                    <p id="groupDetailSubject" class="text-gray-500 font-medium"></p>
                                </div>
                            </div>
                            <button id="closeGroupDetailModal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center transition flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Sistema de Pesta√±as mejorado -->
                        <div class="flex-shrink-0 bg-white border-b border-gray-200 shadow-sm">
                            <nav class="flex px-8 gap-2" id="groupTabs">
                                <button class="group-tab active px-5 py-4 font-semibold text-sm border-b-3 transition-all flex items-center gap-2 hover:bg-gray-50 rounded-t-lg" data-tab="general">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    General
                                </button>
                                <button class="group-tab px-5 py-4 font-semibold text-sm border-b-3 transition-all flex items-center gap-2 hover:bg-gray-50 rounded-t-lg" data-tab="archivos">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                    </svg>
                                    Archivos
                                </button>
                                <button class="group-tab px-5 py-4 font-semibold text-sm border-b-3 transition-all flex items-center gap-2 hover:bg-gray-50 rounded-t-lg" data-tab="tareas">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Tareas
                                </button>
                                <button class="group-tab px-5 py-4 font-semibold text-sm border-b-3 transition-all flex items-center gap-2 hover:bg-gray-50 rounded-t-lg" data-tab="lecciones">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    Unidades
                                </button>
                            </nav>
                        </div>
                    
                    <!-- Contenido de las Pesta√±as con scroll -->
                    <div class="flex-1 overflow-y-auto bg-gray-50 rounded-b-2xl" id="groupTabContent" style="max-height: calc(100vh - 16rem);">
                        
                        <!-- TAB: GENERAL (Muro de Anuncios) -->
                        <div id="tab-general" class="tab-content active p-8">
                            <!-- KPIs del Grupo con dise√±o mejorado -->
                            <div class="grid grid-cols-4 gap-6 mb-8">
                                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition p-6 text-center border border-gray-100">
                                    <div class="inline-flex items-center justify-center w-14 h-14 bg-indigo-100 rounded-full mb-3">
                                        <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-4xl font-bold text-gray-800 mb-1" id="groupDetailStudentCount">0</div>
                                    <div class="text-sm font-medium text-gray-500">Estudiantes</div>
                                </div>
                                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition p-6 text-center border border-gray-100">
                                    <div class="inline-flex items-center justify-center w-14 h-14 bg-green-100 rounded-full mb-3">
                                        <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-bold text-gray-800 mb-1" id="groupDetailLevel">-</div>
                                    <div class="text-sm font-medium text-gray-500">Nivel</div>
                                </div>
                                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition p-6 text-center border border-gray-100">
                                    <div class="inline-flex items-center justify-center w-14 h-14 bg-purple-100 rounded-full mb-3">
                                        <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-2xl font-bold text-gray-800 mb-1" id="groupDetailPeriod">-</div>
                                    <div class="text-sm font-medium text-gray-500">Periodo</div>
                                </div>
                                <div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-xl shadow-sm hover:shadow-md transition p-6 text-center border-2" id="groupCodeCard">
                                    <div class="inline-flex items-center justify-center w-14 h-14 bg-white rounded-full mb-3 shadow-sm">
                                        <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-mono font-bold text-indigo-700 mb-2 tracking-wider" id="groupDetailCode">------</div>
                                    <div class="text-xs font-semibold text-gray-600 mb-3">C√≥digo de Clase</div>
                                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold px-4 py-2 bg-white rounded-lg hover:shadow-sm transition flex items-center gap-2 mx-auto" onclick="copyGroupCode()">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Copiar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Acciones de Gesti√≥n con mejor dise√±o -->
                            <div class="flex flex-wrap gap-3 mb-8">
                                <button 
                                    id="btnAddStudents" 
                                    data-action="addStudents"
                                    class="btn btn-primary shadow-sm hover:shadow-md transition flex items-center gap-2"
                                    type="button">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                    </svg>
                                    A√±adir Estudiantes
                                </button>
                                <button 
                                    id="btnPublishAnnouncement" 
                                    data-action="publishAnnouncement"
                                    class="btn bg-green-500 hover:bg-green-600 text-white shadow-sm hover:shadow-md transition flex items-center gap-2"
                                    type="button">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 17 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                    </svg>
                                    Publicar Anuncio
                                </button>
                                <button 
                                    id="btnDeleteGroup" 
                                    data-action="deleteGroup"
                                    class="btn bg-red-500 hover:bg-red-600 text-white shadow-sm hover:shadow-md transition flex items-center gap-2"
                                    type="button">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Eliminar
                                </button>
                            </div>
                            
                            <!-- Muro de Anuncios (Feed) con dise√±o mejorado -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                                <h4 class="text-xl font-bold text-gray-800 flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                        </svg>
                                    </div>
                                    Anuncios del Grupo
                                </h4>
                                <div id="groupAnnouncements" class="space-y-4">
                                    <div class="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                        </svg>
                                        <p class="font-medium text-gray-500">No hay anuncios publicados</p>
                                        <p class="text-sm mt-2">Usa el bot√≥n "Publicar Anuncio" para compartir informaci√≥n con el grupo</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lista de Miembros con dise√±o mejorado -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                                <h4 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                    </div>
                                    Estudiantes del Grupo
                                </h4>
                                <div id="groupStudentsList" class="space-y-3">
                                    <div class="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                        <p class="font-medium text-gray-500">No hay estudiantes en este grupo</p>
                                        <p class="text-sm mt-2">A√±ade estudiantes usando el bot√≥n "A√±adir Estudiantes"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TAB: ARCHIVOS -->
                        <div id="tab-archivos" class="tab-content hidden p-8">
                            <div class="flex items-center justify-between mb-8">
                                <h4 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                        </svg>
                                    </div>
                                    Archivos Compartidos
                                </h4>
                                <button id="btnUploadFile" class="btn btn-primary shadow-sm hover:shadow-md transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Subir Archivo
                                </button>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="groupFilesList">
                                    <div class="text-center text-gray-400 py-16 col-span-full">
                                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                        </svg>
                                        <p class="font-medium text-gray-500">No hay archivos compartidos</p>
                                        <p class="text-sm mt-2">Sube archivos para que los estudiantes puedan acceder a ellos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TAB: TAREAS -->
                        <div id="tab-tareas" class="tab-content hidden p-8">
                            <div class="flex items-center justify-between mb-8">
                                <h4 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                    </div>
                                    Tareas Asignadas
                                </h4>
                                <button class="btn btn-primary shadow-sm hover:shadow-md transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Crear Tarea
                                </button>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                                <div class="space-y-4" id="groupTasksList">
                                    <div class="text-center text-gray-400 py-16">
                                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        <p class="font-medium text-gray-500">No hay tareas asignadas</p>
                                        <p class="text-sm mt-2">Crea tareas para evaluar el progreso de tus estudiantes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TAB: UNIDADES/LECCIONES -->
                        <div id="tab-lecciones" class="tab-content hidden p-8">
                            <div class="flex items-center justify-between mb-8">
                                <h4 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                    </div>
                                    Contenido Program√°tico
                                </h4>
                                <button id="btnAssignLesson" class="btn btn-primary shadow-sm hover:shadow-md transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Asignar Lecci√≥n
                                </button>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                                <div class="space-y-4" id="groupLessonsList">
                                    <div class="text-center text-gray-400 py-16">
                                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                        <p class="font-medium text-gray-500">No hay lecciones asignadas</p>
                                        <p class="text-sm mt-2">Asigna lecciones para estructurar el contenido del curso</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    </div>
                </div>
            </div>

            <!-- Modal: A√±adir Estudiantes -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n (Sobre TODAS las capas) -->
            <div id="addStudentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" style="position: relative; z-index: 1001;">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between" style="z-index: 1002;">
                        <h3 class="text-2xl font-bold text-gray-800">A√±adir Estudiantes al Grupo</h3>
                        <button id="closeAddStudentsModal" class="text-gray-500 hover:text-gray-700 text-2xl" style="position: relative; z-index: 1003;">&times;</button>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <input type="text" id="searchStudents" class="form-input" placeholder="Buscar estudiante por nombre...">
                        </div>
                        
                        <div id="availableStudentsList" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4">Cargando estudiantes...</p>
                        </div>
                        
                        <div class="flex gap-3 pt-4 border-t border-gray-200 mt-4" style="position: relative; z-index: 1002;">
                            <button id="confirmAddStudents" class="btn btn-primary flex-1" style="position: relative; z-index: 1003;">
                                A√±adir Seleccionados
                            </button>
                            <button id="cancelAddStudents" class="btn bg-gray-300 hover:bg-gray-400" style="position: relative; z-index: 1003;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Publicar Anuncio -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n (Sobre TODAS las capas) -->
            <div id="publishAnnouncementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" style="position: relative; z-index: 1001;">
                    <div class="sticky top-0 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 flex items-center justify-between rounded-t-xl" style="z-index: 1002;">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold">Publicar Anuncio</h3>
                        </div>
                        <button id="closePublishAnnouncementModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6" style="position: relative; z-index: 1001;">
                        <!-- Informaci√≥n del grupo -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 mb-6 border border-green-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold" id="announcementGroupIcon">
                                    G
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 font-medium">Publicando en:</p>
                                    <p class="font-bold text-gray-800" id="announcementGroupName">Grupo</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de anuncio -->
                        <form id="announcementForm" class="space-y-6">
                            <!-- T√≠tulo (Opcional) -->
                            <div>
                                <label for="announcementTitle" class="block text-sm font-semibold text-gray-700 mb-2">
                                    T√≠tulo del Anuncio (Opcional)
                                </label>
                                <input 
                                    type="text" 
                                    id="announcementTitle" 
                                    class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition"
                                    placeholder="Ej: Recordatorio de Tarea, Cambio de Horario..."
                                    maxlength="100"
                                >
                                <p class="text-xs text-gray-500 mt-1">M√°ximo 100 caracteres</p>
                            </div>

                            <!-- Contenido (Requerido) -->
                            <div>
                                <label for="announcementContent" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Contenido del Mensaje <span class="text-red-500">*</span>
                                </label>
                                <textarea 
                                    id="announcementContent" 
                                    rows="6"
                                    class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition resize-none"
                                    placeholder="Escribe tu mensaje aqu√≠..."
                                    required
                                    maxlength="1000"
                                ></textarea>
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-xs text-gray-500">M√°ximo 1000 caracteres</p>
                                    <p class="text-xs text-gray-500"><span id="contentCharCount">0</span>/1000</p>
                                </div>
                            </div>

                            <!-- Tipo de anuncio -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">
                                    Tipo de Anuncio
                                </label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="announcementType" value="general" class="peer sr-only" checked>
                                        <div class="border-2 border-gray-200 rounded-lg p-3 text-center hover:border-green-300 peer-checked:border-green-500 peer-checked:bg-green-50 transition">
                                            <svg class="w-6 h-6 mx-auto text-gray-600 peer-checked:text-green-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-xs font-medium">General</p>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="announcementType" value="task" class="peer sr-only">
                                        <div class="border-2 border-gray-200 rounded-lg p-3 text-center hover:border-orange-300 peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
                                            <svg class="w-6 h-6 mx-auto text-gray-600 peer-checked:text-orange-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                            </svg>
                                            <p class="text-xs font-medium">Tarea</p>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="announcementType" value="reminder" class="peer sr-only">
                                        <div class="border-2 border-gray-200 rounded-lg p-3 text-center hover:border-yellow-300 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition">
                                            <svg class="w-6 h-6 mx-auto text-gray-600 peer-checked:text-yellow-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-xs font-medium">Recordatorio</p>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="announcementType" value="important" class="peer sr-only">
                                        <div class="border-2 border-gray-200 rounded-lg p-3 text-center hover:border-red-300 peer-checked:border-red-500 peer-checked:bg-red-50 transition">
                                            <svg class="w-6 h-6 mx-auto text-gray-600 peer-checked:text-red-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                            <p class="text-xs font-medium">Importante</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Adjuntos (Opcional) -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Adjuntos (Opcional)
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition cursor-pointer" id="attachmentDropZone">
                                    <input type="file" id="announcementAttachment" class="hidden" accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png" multiple>
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>
                                    <p class="text-sm text-gray-600 font-medium">Haz clic o arrastra archivos aqu√≠</p>
                                    <p class="text-xs text-gray-500 mt-1">PDF, DOC, PPT, Im√°genes (M√°x. 10MB cada uno)</p>
                                </div>
                                <div id="attachmentList" class="mt-3 space-y-2"></div>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="flex gap-3 pt-4 border-t border-gray-200" style="position: relative; z-index: 1002;">
                                <button type="submit" id="confirmPublishAnnouncement" class="btn bg-green-500 hover:bg-green-600 text-white flex-1 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition" style="position: relative; z-index: 1003;">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Publicar Anuncio
                                </button>
                                <button type="button" id="cancelPublishAnnouncement" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-6" style="position: relative; z-index: 1003;">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ========== MODAL: SUBIR ARCHIVO ========== -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="uploadFileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto" style="z-index: 1000;">
                <div class="min-h-screen px-4 flex items-center justify-center">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full transform transition-all">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6 rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Subir Archivo al Grupo
                                </h3>
                                <button id="closeUploadFileModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <form id="uploadFileForm" class="p-8 space-y-6">
                            <!-- Zona de Drag & Drop -->
                            <div id="fileDropZone" class="border-3 border-dashed border-indigo-300 rounded-xl p-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer">
                                <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.txt,.jpg,.jpeg,.png,.gif">
                                <svg class="w-16 h-16 mx-auto text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-lg font-semibold text-gray-700 mb-2">Arrastra tu archivo aqu√≠</p>
                                <p class="text-sm text-gray-500 mb-4">o haz clic para seleccionar</p>
                                <div class="flex flex-wrap gap-2 justify-center text-xs text-gray-400">
                                    <span class="bg-gray-100 px-2 py-1 rounded">PDF</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">Word</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">Excel</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">PowerPoint</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">ZIP</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">Im√°genes</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-3">Tama√±o m√°ximo: 10MB</p>
                            </div>

                            <!-- Archivo Seleccionado -->
                            <div id="filePreview" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-4">
                                <div class="flex items-center gap-4">
                                    <div class="flex-shrink-0 w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-gray-800 truncate" id="selectedFileName">archivo.pdf</p>
                                        <p class="text-sm text-gray-600" id="selectedFileSize">0 KB</p>
                                    </div>
                                    <button type="button" id="removeFile" class="flex-shrink-0 text-red-500 hover:text-red-700 transition">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Campo de Descripci√≥n -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Descripci√≥n (Opcional)</label>
                                <textarea 
                                    id="fileDescription" 
                                    rows="3" 
                                    class="form-input w-full" 
                                    placeholder="Agrega una descripci√≥n o instrucciones sobre este archivo..."
                                ></textarea>
                            </div>

                            <!-- Barra de Progreso -->
                            <div id="uploadProgress" class="hidden">
                                <div class="mb-2 flex justify-between text-sm">
                                    <span class="font-semibold text-gray-700">Subiendo archivo...</span>
                                    <span id="uploadPercent" class="font-bold text-indigo-600">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div id="uploadProgressBar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="flex gap-3">
                                <button 
                                    type="button" 
                                    id="cancelUploadFile" 
                                    class="flex-1 btn bg-gray-200 hover:bg-gray-300 text-gray-700">
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    id="confirmUploadFile" 
                                    class="flex-1 btn btn-primary shadow-lg hover:shadow-xl transform hover:scale-105 transition">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Subir Archivo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ========== MODAL: ASIGNAR LECCIONES ========== -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="assignLessonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto" style="z-index: 1000;">
                <div class="min-h-screen px-4 flex items-center justify-center py-8">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full transform transition-all">
                        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-6 rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    Asignar Lecciones al Grupo
                                </h3>
                                <button id="closeAssignLessonModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-8 space-y-6">
                            <!-- Barra de b√∫squeda -->
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input 
                                    type="text" 
                                    id="searchLessons" 
                                    class="form-input pl-10 w-full" 
                                    placeholder="Buscar lecciones por t√≠tulo o tema..."
                                >
                            </div>

                            <!-- Contador de seleccionadas -->
                            <div id="selectedLessonsCount" class="hidden bg-indigo-50 border-2 border-indigo-200 rounded-lg p-3 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="font-semibold text-indigo-700"><span id="selectedCount">0</span> lecci√≥n(es) seleccionada(s)</span>
                                </div>
                                <button id="clearSelection" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                    Limpiar selecci√≥n
                                </button>
                            </div>

                            <!-- Cat√°logo de lecciones disponibles -->
                            <div class="border-2 border-gray-200 rounded-xl overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                    <h4 class="font-semibold text-gray-700">Cat√°logo de Lecciones Disponibles</h4>
                                </div>
                                <div id="availableLessonsList" class="max-h-96 overflow-y-auto divide-y divide-gray-200">
                                    <!-- Lecciones se cargar√°n aqu√≠ -->
                                    <div class="p-8 text-center text-gray-400">
                                        <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                        <p class="font-medium">Cargando lecciones...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="flex gap-3 pt-4 border-t border-gray-200">
                                <button 
                                    type="button" 
                                    id="cancelAssignLesson" 
                                    class="flex-1 btn bg-gray-200 hover:bg-gray-300 text-gray-700">
                                    Cancelar
                                </button>
                                <button 
                                    type="button" 
                                    id="confirmAssignLesson" 
                                    class="flex-1 btn btn-primary shadow-lg hover:shadow-xl transform hover:scale-105 transition">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Asignar Seleccionadas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de perfil de usuario -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="userProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">Perfil de Usuario</h3>
                        <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <img id="modalUserAvatar" class="w-20 h-20 rounded-full" alt="Avatar">
                        <div>
                            <div id="modalUserName" class="text-lg font-bold"></div>
                            <div id="modalUserRole" class="text-sm text-gray-500"></div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="modalChatBtn" class="btn btn-primary flex-1 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                            </svg>
                            <span>Enviar Mensaje</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n CHATS -->
            <section id="section-chats" class="hidden" data-section>
                <div class="grid lg:grid-cols-4 gap-4 h-full" style="min-height: 60vh;">
                    <!-- Lista de Conversaciones -->
                    <div class="lg:col-span-1 card p-0 flex flex-col">
                        <div class="p-3 border-b text-xs font-semibold text-gray-500 flex items-center justify-between">
                            <span>Mensajes</span>
                            <button id="newChatBtn" class="text-indigo-600 hover:text-indigo-800" title="Nuevo chat" onclick="showNewChatModal && showNewChatModal()">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="chatConversations" class="flex-1 overflow-y-auto">
                            <!-- Conversaciones cargadas din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- √Årea de Mensajes -->
                    <div class="lg:col-span-3 card p-0 flex flex-col">
                        <div id="chatHeader" class="p-3 border-b flex items-center justify-between hidden">
                            <div class="flex items-center gap-2">
                                <img id="chatRecipientAvatar" class="w-8 h-8 rounded-full" alt="Avatar">
                                <div>
                                    <div class="text-sm font-semibold" id="chatRecipientName"></div>
                                    <div class="text-xs text-gray-500" id="chatRecipientRole"></div>
                                </div>
                            </div>
                        </div>
                        <div id="chatMessagesArea" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            <div class="text-center text-gray-400 py-8 flex flex-col items-center gap-3">
                                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                                <span>Selecciona una conversaci√≥n o inicia un chat nuevo</span>
                            </div>
                        </div>
                        <div id="chatInputArea" class="p-3 border-t flex gap-2 hidden">
                            <input id="chatMessageInput" class="form-input flex-1" placeholder="Escribe un mensaje..." />
                            <button id="chatSendBtn" class="btn btn-primary">Enviar</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Racha -->
            <section id="section-racha" class="hidden" data-section>
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <svg class="w-7 h-7 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"></path>
                    </svg>
                    <span>Tu Racha</span>
                </h2>
                <div id="streakCalendar" class="grid grid-cols-7 gap-2 mb-6"></div>
                <p class="text-sm text-gray-600">M√°xima racha: <span id="maxStreak">0</span> d√≠as</p>
            </section>

            <!-- Secci√≥n Tareas -->
            <section id="section-tareas" class="hidden" data-section>
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <span>Tareas</span>
                        </h2>
                        <p class="text-gray-600 mt-1">Crea y gestiona tareas para tus estudiantes</p>
                    </div>
                    <button id="btnCreateTask" class="btn btn-primary flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Nueva Tarea
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="mb-6 flex gap-3">
                    <select id="filterTaskGroup" class="form-input max-w-xs">
                        <option value="">Todos los grupos</option>
                    </select>
                    <select id="filterTaskStatus" class="form-input max-w-xs">
                        <option value="">Todos los estados</option>
                        <option value="active">Activas</option>
                        <option value="past">Vencidas</option>
                    </select>
                </div>
                
                <!-- Grid de Tareas -->
                <div id="tasksGrid" class="space-y-4">
                    <div class="text-center text-gray-400 py-12">
                        <div class="text-6xl mb-4">
                            <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                        <p class="text-lg mb-2">No hay tareas creadas</p>
                        <p class="text-sm">Crea tu primera tarea para tus estudiantes</p>
                    </div>
                </div>
            </section>

            <!-- Modal: Crear/Editar Tarea -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <h3 id="taskModalTitle" class="text-2xl font-bold text-gray-800">Nueva Tarea</h3>
                        <button id="closeTaskModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <form id="taskForm" class="p-6 space-y-4">
                        <div>
                            <label class="form-label">T√≠tulo de la Tarea *</label>
                            <input type="text" id="taskTitle" class="form-input" placeholder="Ej: Ejercicios de Python - M√≥dulo 1" required>
                        </div>
                        
                        <div>
                            <label class="form-label">Descripci√≥n</label>
                            <textarea id="taskDescription" class="form-input" rows="2" placeholder="Descripci√≥n breve de la tarea"></textarea>
                        </div>
                        
                        <div>
                            <label class="form-label">Instrucciones *</label>
                            <textarea id="taskInstructions" class="form-input" rows="4" placeholder="Instrucciones detalladas para completar la tarea..." required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Asignar a Grupo *</label>
                                <select id="taskGroup" class="form-input" required>
                                    <option value="">Selecciona un grupo...</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Fecha de Entrega *</label>
                                <input type="datetime-local" id="taskDueDate" class="form-input" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Puntos M√°ximos *</label>
                                <input type="number" id="taskMaxPoints" class="form-input" min="1" max="100" value="100" required>
                            </div>
                            <div>
                                <label class="form-label">Archivo de Referencia (Opcional)</label>
                                <input type="file" id="taskAttachment" class="form-input">
                                <p class="text-xs text-gray-500 mt-1">PDF, DOCX, ZIP (Max 10MB)</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 pt-4 border-t border-gray-200">
                            <button type="submit" class="btn btn-primary flex-1">
                                <span id="taskSubmitText">Crear Tarea</span>
                            </button>
                            <button type="button" id="cancelTaskModal" class="btn bg-gray-300 hover:bg-gray-400">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal: Ver Detalles de Tarea y Entregas -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="taskDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <div>
                            <h3 id="taskDetailTitle" class="text-2xl font-bold text-gray-800"></h3>
                            <p id="taskDetailGroup" class="text-gray-600"></p>
                        </div>
                        <button id="closeTaskDetailModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Informaci√≥n de la tarea -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="card text-center">
                                <div class="text-3xl font-bold text-indigo-600" id="taskDetailSubmitted">0</div>
                                <div class="text-sm text-gray-600 mt-1">Entregadas</div>
                            </div>
                            <div class="card text-center">
                                <div class="text-3xl font-bold text-orange-600" id="taskDetailPending">0</div>
                                <div class="text-sm text-gray-600 mt-1">Pendientes</div>
                            </div>
                            <div class="card text-center">
                                <div class="text-3xl font-bold text-green-600" id="taskDetailGraded">0</div>
                                <div class="text-sm text-gray-600 mt-1">Calificadas</div>
                            </div>
                            <div class="card text-center">
                                <div class="text-3xl font-bold text-purple-600" id="taskDetailAverage">-</div>
                                <div class="text-sm text-gray-600 mt-1">Promedio</div>
                            </div>
                        </div>
                        
                        <!-- Descripci√≥n e instrucciones -->
                        <div class="card mb-6">
                            <h4 class="font-bold text-gray-800 mb-2">Instrucciones</h4>
                            <p id="taskDetailInstructions" class="text-gray-700 whitespace-pre-wrap"></p>
                            <div class="mt-3 text-sm text-gray-600">
                                <span class="font-semibold">Fecha l√≠mite:</span> <span id="taskDetailDueDate"></span>
                                <span class="ml-4 font-semibold">Puntos:</span> <span id="taskDetailPoints"></span>
                            </div>
                        </div>
                        
                        <!-- Entregas de estudiantes -->
                        <div>
                            <h4 class="text-lg font-bold text-gray-800 mb-3">Entregas de Estudiantes</h4>
                            <div id="taskSubmissionsList" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">No hay entregas a√∫n</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal: Calificar Entrega -->
            <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
            <div id="gradeSubmissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 1000;">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">Calificar Entrega</h3>
                            <p id="gradeStudentName" class="text-gray-600"></p>
                        </div>
                        <button id="closeGradeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Informaci√≥n de la entrega -->
                        <div class="card mb-4">
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="font-semibold">Entregado:</span> <span id="gradeSubmittedAt"></span>
                            </div>
                            <div id="gradeSubmissionContent" class="text-gray-700"></div>
                        </div>
                        
                        <!-- Formulario de calificaci√≥n -->
                        <form id="gradeForm" class="space-y-4">
                            <div>
                                <label class="form-label">Calificaci√≥n *</label>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="gradePoints" class="form-input" min="0" required>
                                    <span class="text-gray-600">/ <span id="gradeMaxPoints"></span> puntos</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label">Comentarios</label>
                                <textarea id="gradeFeedback" class="form-input" rows="4" placeholder="Escribe comentarios para el estudiante..."></textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4 border-t border-gray-200">
                                <button type="submit" class="btn btn-primary flex-1">
                                    Guardar Calificaci√≥n
                                </button>
                                <button type="button" id="cancelGradeModal" class="btn bg-gray-300 hover:bg-gray-400">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="../js/global-ui.js"></script>
    <script type="module">
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc, collection, query, where, getDocs, limit, orderBy, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { addXP, updateGamificationHeader } from '../js/gamification.js';
        
        // Hacer addXP global para que las funciones inline puedan usarlo
        window.addXP = addXP;

        let currentUserData = null;

        // Verificar autenticaci√≥n
        onAuthStateChanged(window.auth, async (user) => {
            if (!user) {
                // No redirigir aqu√≠: deja que initAuth gestione las redirecciones para evitar expulsi√≥n temprana
                return;
            }
            
            window.currentUser = user; // Asegurar que est√° disponible globalmente
            
            // Cargar datos del usuario
            await loadUserData(user.uid);
            await loadDashboardData();
            
            // RECARGAR GRUPOS SI LA SECCI√ìN YA EST√Å INICIALIZADA
            if (initialized.grupos) {
                console.log('üîÑ Recargando grupos despu√©s de autenticaci√≥n');
                await loadTeacherGroups();
            }
            
            // INICIALIZAR BUSCADOR SOLO CUANDO EL USUARIO EST√â AUTENTICADO
            console.log('‚úÖ Usuario autenticado - habilitando b√∫squeda');
            window.searchEnabled = true;
        });

        // Cargar datos del usuario
        async function loadUserData(uid) {
            const userDoc = await getDoc(doc(window.db, 'users', uid));
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                // NO llamar a updateUI aqu√≠ - initAuth se encarga de todo
                // updateUI(currentUserData);
                console.log('üìä loadUserData (vieja funci√≥n) - datos cargados pero NO actualizando UI');
            }
        }

        // Actualizar UI con datos del usuario
        function updateUI(userData) {
            document.getElementById('userName').textContent = userData.displayName || 'Usuario';
            document.getElementById('welcomeName').textContent = userData.displayName || 'Estudiante';
            document.getElementById('userRole').textContent = capitalizeFirst(userData.rol || 'estudiante');
            
            // NO sobrescribir userLevel y userXP - gamification.js se encarga de eso
            // document.getElementById('userLevel').textContent = `Nivel ${userData.nivel || 1}`;
            // document.getElementById('userXP').textContent = `${userData.xp || 0} XP`;
            
            // Avatar
            const avatar = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'Usuario')}&background=667eea&color=fff`;
            document.getElementById('userAvatar').src = avatar;

            // Racha
            const streak = userData.racha || 0;
            document.getElementById('streakDays').textContent = streak;
            document.getElementById('streakProgress').style.width = `${Math.min(streak * 10, 100)}%`;

            // Estad√≠sticas
            const progreso = userData.progreso || {};
            document.getElementById('statsLessons').textContent = progreso.leccionesCompletadas || 0;
            document.getElementById('statsGames').textContent = progreso.juegosJugados || 0;
            document.getElementById('statsBadges').textContent = (userData.insignias || []).length;
            document.getElementById('statsTime').textContent = `${Math.round((progreso.tiempoTotal || 0) / 60)}h`;

            // Progreso visual
            const totalLessons = 20; // Total de lecciones disponibles
            const completedLessons = progreso.leccionesCompletadas || 0;
            document.getElementById('progressLessons').style.width = `${(completedLessons / totalLessons) * 100}%`;
            
            const totalGames = 10;
            const playedGames = progreso.juegosJugados || 0;
            document.getElementById('progressGames').style.width = `${(playedGames / totalGames) * 100}%`;
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            await loadNextLessons();
            await loadBadges();
        }

        // Cargar pr√≥ximas lecciones
        async function loadNextLessons() {
            const container = document.getElementById('lessonsContainer');
            
            try {
                // Obtener lecciones de Firestore
                const lessonsRef = collection(window.db, 'lecciones');
                const q = query(lessonsRef, orderBy('orden'), limit(3));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <p class="text-gray-500">No hay lecciones disponibles a√∫n.</p>
                            <p class="text-sm text-gray-400 mt-2">Tu profesor agregar√° lecciones pronto.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const lesson = doc.data();
                    container.innerHTML += createLessonCard(lesson, doc.id);
                });
            } catch (error) {
                console.error('Error cargando lecciones:', error);
                container.innerHTML = `
                    <div class="col-span-3 text-center py-12">
                        <p class="text-red-500">Error al cargar lecciones</p>
                    </div>
                `;
            }
        }

        // Crear tarjeta de lecci√≥n
        function createLessonCard(lesson, id) {
            const completada = currentUserData?.leccionesCompletadas?.includes(id) || false;
            
            return `
                <div class="card hover-lift cursor-pointer" onclick="window.location.href='lecciones.html?id=${id}'">
                    <div class="flex items-center justify-between mb-3">
                        <span class="badge badge-primary">${lesson.categoria || 'Python'}</span>
                        ${completada ? '<span class="badge badge-success">‚úì Completada</span>' : ''}
                    </div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${lesson.titulo || 'Lecci√≥n'}</h3>
                    <p class="text-gray-600 text-sm mb-4">${lesson.descripcion || 'Descripci√≥n de la lecci√≥n'}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span>‚è±Ô∏è ${lesson.duracion || '10'} min</span>
                        <span>‚≠ê ${lesson.dificultad || 'F√°cil'}</span>
                    </div>
                    <div class="mt-4">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${completada ? 100 : lesson.progreso || 0}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Cargar insignias
        async function loadBadges() {
            const container = document.getElementById('badgesContainer');
            const badges = currentUserData?.insignias || [];

            const allBadges = [
                { id: 'first_lesson', name: 'Primera Lecci√≥n', icon: 'üìö', unlocked: badges.includes('first_lesson') },
                { id: 'streak_7', name: 'Racha 7 d√≠as', icon: 'üî•', unlocked: badges.includes('streak_7') },
                { id: 'game_master', name: 'Maestro Jugador', icon: 'üéÆ', unlocked: badges.includes('game_master') },
                { id: 'code_ninja', name: 'Code Ninja', icon: 'ü•∑', unlocked: badges.includes('code_ninja') }
            ];

            container.innerHTML = allBadges.map(badge => `
                <div class="achievement-card ${badge.unlocked ? 'unlocked' : 'locked'}">
                    <div class="text-4xl mb-2">${badge.icon}</div>
                    <p class="font-semibold text-sm">${badge.name}</p>
                    ${badge.unlocked ? '<span class="badge badge-success mt-2">‚úì Desbloqueada</span>' : '<span class="badge mt-2" style="background: #cbd5e1; color: #64748b;">üîí Bloqueada</span>'}
                </div>
            `).join('');
        }

        // Toggle menu de perfil
        window.toggleProfileMenu = function() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        };

        // Abrir Configuraci√≥n (GlobalSettings modal)
        document.getElementById('btnOpenSettings')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.openGlobalSettings) window.openGlobalSettings(e.currentTarget);
        });

        // Cerrar sesi√≥n
        window.logout = async function() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                try {
                    try { localStorage.removeItem('codekids_user_state'); } catch(_){ }
                    await signOut(window.auth);
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('Error al cerrar sesi√≥n:', error);
                    alert('Error al cerrar sesi√≥n');
                }
            }
        };

        // Funci√≥n helper
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Cargar avatar desde state manager si existe
        (function initAvatarFromState(){
            try {
                if (window.userState?.state?.photoURL) {
                    document.getElementById('userAvatar').src = window.userState.state.photoURL;
                }
            } catch(_){}
        })();

        // Cargar nueva foto desde input y persistir
        function bindAvatarUpload(){
            const fileInput = document.getElementById('avatarUpload');
            if (!fileInput) return;
            fileInput.addEventListener('change', async (e)=>{
                const file = e.target.files?.[0];
                if (!file) return;
                try {
                    const base64 = await window.userState.setProfilePhoto(file);
                    document.getElementById('userAvatar').src = base64;
                    alert('Foto de perfil actualizada.');
                } catch (err){ console.error(err); alert('No se pudo actualizar la foto'); }
            });
        }

        // Toggle men√∫ de configuraci√≥n al clicar engranaje
        document.getElementById('settingsBtn')?.addEventListener('click', (e)=>{
            e.stopPropagation();
            const menu = document.getElementById('settingsMenu');
            menu?.classList.toggle('hidden');
        });
        // Router por hash con iframe para m√≥dulos
        const routes = {
            inicio: 'section-inicio',
            calificaciones: 'section-calificaciones',
            tareas: 'section-tareas',
            estadisticas: 'section-estadisticas',
            grupos: 'section-grupos',
            chats: 'section-chats'
        };

        function setActive(route){
            document.querySelectorAll('.sidebar .sidebar-item').forEach(a=>{
                if (a.getAttribute('data-route')===route) a.classList.add('active');
                else a.classList.remove('active');
            });
        }

        function showRoute(){
            const hash = window.location.hash.replace('#','') || 'inicio';
            const targetId = routes[hash];
            document.querySelectorAll('[data-section]').forEach(sec=>{
                if (sec.id === targetId) sec.classList.remove('hidden'); else sec.classList.add('hidden');
            });
            setActive(hash);
            ensureInit(hash);
        }
        window.addEventListener('hashchange', showRoute);
        
        // ============ THEME TOGGLE FUNCTIONALITY ============
        const themeToggle = document.getElementById('themeToggle');
        
        // Funci√≥n para actualizar tema visual
        function updateThemeUI(isDark) {
            if (themeToggle) {
                if (isDark) {
                    themeToggle.classList.remove('theme-off');
                    themeToggle.classList.add('theme-on');
                    themeToggle.setAttribute('aria-pressed', 'true');
                } else {
                    themeToggle.classList.remove('theme-on');
                    themeToggle.classList.add('theme-off');
                    themeToggle.setAttribute('aria-pressed', 'false');
                }
            }
        }
        
        // Cargar tema guardado
        const currentTheme = localStorage.getItem('app-theme') || 'light';
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark', 'theme-dark');
            document.body.classList.add('dark', 'theme-dark');
            updateThemeUI(true);
        } else {
            updateThemeUI(false);
        }
        
        // Toggle desde el bot√≥n del header
        themeToggle?.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                // Cambiar a modo claro
                document.documentElement.classList.remove('dark', 'theme-dark');
                document.body.classList.remove('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'light');
                updateThemeUI(false);
            } else {
                // Cambiar a modo oscuro
                document.documentElement.classList.add('dark', 'theme-dark');
                document.body.classList.add('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'dark');
                updateThemeUI(true);
            }
        });
        
        document.addEventListener('DOMContentLoaded', showRoute);

        // Inicializadores por secci√≥n (one-time)
        const initialized = { inicio:false, calificaciones:false, estadisticas:false, grupos:false, chats:false, tareas:false };

        function ensureInit(route){
            if (initialized[route]) return;
            switch(route){
                case 'inicio': initInicio(); break;
                case 'calificaciones': initCalificaciones(); break;
                case 'estadisticas': initEstadisticas(); break;
                case 'grupos': initGrupos(); break;
                case 'chats': initChats(); break;
                case 'tareas': initTareas(); break;
            }
            initialized[route] = true;
        }

        // Inicio: continuar aprendiendo
        function initInicio(){
            renderContinueLearning();
            try { window.userState?.subscribe(renderContinueLearning); } catch(_){ }
        }

        function renderContinueLearning(){
            const el = document.getElementById('continueLearning');
            if (!el) return;
            const last = window.userState?.state?.lastLesson;
            if (last){
                el.innerHTML = `<div class="flex items-center justify-between"><div><div class="font-semibold">${last.title||'Tu √∫ltima lecci√≥n'}</div><div class="text-xs text-gray-500">${last.course||''} ¬∑ Paso ${last.step||''}</div></div><a href="#lecciones" class="text-indigo-600 text-sm hover:underline">Continuar ‚Üí</a></div>`;
            } else {
                el.innerHTML = `<p class="text-gray-600 text-sm">A√∫n no has comenzado. Ve a <a class='text-indigo-600 hover:underline' href='#lecciones'>Lecciones</a>.</p>`;
            }
        }

        // Lecciones maestro-detalle (simulado)
        const COURSES = [
            { id:'python', title:'Python B√°sico', steps:[
                { id:'py1', title:'Print y variables' },
                { id:'py2', title:'Condicionales' },
                { id:'py3', title:'Bucles' },
                { id:'py4', title:'Funciones' },
                { id:'py5', title:'Listas y diccionarios' }
            ]}
        ];

        function initLecciones(){
            const courseList = document.getElementById('courseList');
            if (!courseList) return;
            courseList.innerHTML = COURSES.map(c=>`<button data-id="${c.id}" class="w-full text-left card">${c.title}</button>`).join('');
            courseList.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>openCourse(b.getAttribute('data-id'))));
            const last = window.userState?.state?.lastLesson; if (last?.courseId) openCourse(last.courseId); else openCourse(COURSES[0].id);
        }

        function openCourse(courseId){
            const course = COURSES.find(c=>c.id===courseId) || COURSES[0];
            const stepsEl = document.getElementById('lessonSteps');
            const player = document.getElementById('lessonPlayerContainer');
            const completed = new Set(window.userState?.state?.completedLessons||[]);
            if (player) player.innerHTML = `<div class='aspect-video'><iframe class='w-full h-full' src='https://www.youtube.com/embed/8ext9G7xspg' allowfullscreen></iframe></div>`;
            stepsEl.innerHTML = course.steps.map((s,idx)=>{
                const done = completed.has(s.id);
                return `<li class="flex items-center justify-between p-2 border rounded ${done?'bg-green-50':''}">
                    <div class="text-sm"><span class="font-semibold">Paso ${idx+1}:</span> ${s.title} ${done?'<span class=\"ml-2 text-green-600 text-xs\">‚úì</span>':''}</div>
                    <div class="flex gap-2">
                        <button class="text-xs px-2 py-1 border rounded" data-view="${s.id}">Ver</button>
                        <button class="text-xs px-2 py-1 border rounded" data-complete="${s.id}">Marcar 90%</button>
                    </div>
                </li>`;
            }).join('');
            stepsEl.querySelectorAll('[data-view]').forEach(btn=>btn.addEventListener('click',()=>{
                const sid = btn.getAttribute('data-view');
                window.userState?.setLastLesson({ courseId: course.id, course: course.title, step: (course.steps.findIndex(s=>s.id===sid)+1), stepId: sid, title: course.title+': '+(course.steps.find(s=>s.id===sid)?.title||'') });
                renderContinueLearning();
            }));
            stepsEl.querySelectorAll('[data-complete]').forEach(btn=>btn.addEventListener('click', async ()=>{
                const sid = btn.getAttribute('data-complete');
                window.userState?.completeLesson(sid);
                await addXP(100, 'lesson');
                updateGamificationHeader(window.userState?.state?.xp||0);
                openCourse(course.id); // re-render
                renderContinueLearning();
                alert('¬°Lecci√≥n completada! +100 XP');
            }));
        }

        // Laboratorio
        function initLaboratorio(){
            // Blocky
            const grid = document.getElementById('blockyGrid');
            const status = document.getElementById('blockyStatus');
            const SIZE=5; const GOAL={x:4,y:4}; let pos={x:0,y:0}; let dir=0; // 0E 1S 2O 3N
            function draw(){
                grid.innerHTML='';
                for(let y=0;y<SIZE;y++){
                    for(let x=0;x<SIZE;x++){
                        const cell=document.createElement('div');
                        cell.className='aspect-square rounded flex items-center justify-center text-xs border';
                        if (x===GOAL.x && y===GOAL.y) { cell.classList.add('bg-green-100'); cell.textContent='üèÅ'; }
                        if (x===pos.x && y===pos.y) { cell.classList.add('bg-indigo-100'); cell.textContent = ['‚Üí','‚Üì','‚Üê','‚Üë'][dir]; }
                        grid.appendChild(cell);
                    }
                }
                status.textContent = `Pos (${pos.x},${pos.y}) ¬∑ Dir ${['E','S','O','N'][dir]}`;
            }
            function reset(){ pos={x:0,y:0}; dir=0; draw(); }
            function move(){ const nx=pos.x + (dir===0?1:dir===2?-1:0); const ny=pos.y + (dir===1?1:dir===3?-1:0); if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) return; pos={x:nx,y:ny}; draw(); check(); }
            function turn(){ dir=(dir+1)%4; draw(); }
            function check(){ if (pos.x===GOAL.x && pos.y===GOAL.y){ window.userState?.completeGame('blocky', 100); addXP(25,'blocky'); updateGamificationHeader(window.userState?.state?.xp||0); alert('¬°Ganaste Blocky! +25 XP'); reset(); } }
            document.getElementById('btnMove')?.addEventListener('click', move);
            document.getElementById('btnTurn')?.addEventListener('click', turn);
            document.getElementById('btnResetBlocky')?.addEventListener('click', reset);
            draw();

            // Typo Racer
            const targets = [ 'print("Hola")', 'for i in range(5):', 'if x == 10:', 'def suma(a,b):' ];
            let tStart=0; let target='';
            const tEl = document.getElementById('typoTarget');
            const inEl = document.getElementById('typoInput');
            const accEl = document.getElementById('typoAccuracy');
            const wpmEl = document.getElementById('typoWpm');
            const stEl = document.getElementById('typoStatus');
            function newTarget(){ target = targets[Math.floor(Math.random()*targets.length)]; tEl.textContent = target; inEl.value=''; inEl.focus(); tStart=Date.now(); stEl.textContent='Escribe la l√≠nea...'; accEl.textContent='Precisi√≥n: 0%'; wpmEl.textContent='WPM: 0'; }
            function compute(){
                const val = inEl.value;
                const len = Math.max(val.length, target.length);
                let ok=0; for(let i=0;i<Math.min(val.length,target.length);i++){ if(val[i]===target[i]) ok++; }
                const acc = Math.round((ok/len)*100);
                const mins = (Date.now()-tStart)/60000;
                const wpm = Math.max(0, Math.round((val.length/5)/Math.max(mins, 0.01)));
                accEl.textContent = `Precisi√≥n: ${isFinite(acc)?acc:0}%`;
                wpmEl.textContent = `WPM: ${isFinite(wpm)?wpm:0}`;
                if (val === target) {
                    // Guardar en Firestore
                    (async () => {
                        try {
                            const user = window.currentUser || window.auth?.currentUser;
                            if (user && window.db) {
                                const userRef = doc(window.db, 'users', user.uid);
                                const userDoc = await getDoc(userRef);
                                const userData = userDoc.exists() ? userDoc.data() : {};
                                const gameScores = userData.studentProfile?.gameScores || {};
                                gameScores['typo_racer'] = (gameScores['typo_racer'] || 0) + 1;
                                
                                await updateDoc(userRef, {
                                    'studentProfile.gameScores': gameScores
                                });
                            }
                        } catch (err) { console.error('Error guardando typo-racer:', err); }
                    })();
                    
                    addXP(15,'typo-racer'); 
                    window.userState?.completeGame('typo', wpm); 
                    updateGamificationHeader(window.userState?.state?.xp||0); 
                    stEl.textContent='¬°Perfecto! +15 XP'; 
                    setTimeout(newTarget, 700); 
                }
            }
            inEl.addEventListener('input', compute);
            newTarget();
        }

        // Grupos feed
        // ========== GRUPOS - FEED SOCIAL REAL ==========
        let postsUnsubscribe = null;
        
        // ========== GESTI√ìN DE GRUPOS ==========
        let currentGroupId = null;
        let selectedStudents = [];
        
        async function initGrupos() {
            console.log('üë• Inicializando gesti√≥n de grupos');
            
            // Event listeners para botones
            document.getElementById('btnCreateGroup')?.addEventListener('click', () => openGroupModal());
            document.getElementById('closeGroupModal')?.addEventListener('click', () => closeGroupModal());
            document.getElementById('cancelGroupModal')?.addEventListener('click', () => closeGroupModal());
            document.getElementById('groupForm')?.addEventListener('submit', handleGroupSubmit);
            
            document.getElementById('closeGroupDetailModal')?.addEventListener('click', () => closeGroupDetailModal());
            
            // Cerrar modal al hacer clic fuera del contenido
            document.getElementById('groupDetailModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'groupDetailModal') {
                    closeGroupDetailModal();
                }
            });
            
            // Manejo de selector de color
            document.querySelectorAll('.color-option input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remover borde de todos
                    document.querySelectorAll('.color-option div').forEach(div => {
                        div.classList.remove('ring-4', 'ring-offset-2');
                        div.classList.add('border-2', 'border-transparent');
                    });
                    // Agregar borde al seleccionado
                    if (this.checked) {
                        const colorDiv = this.nextElementSibling;
                        colorDiv.classList.remove('border-2', 'border-transparent');
                        colorDiv.classList.add('ring-4', 'ring-offset-2');
                        colorDiv.style.setProperty('--tw-ring-color', this.value);
                    }
                });
            });
            
            // Previsualizaci√≥n de imagen del grupo
            document.getElementById('groupIconFile')?.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tama√±o (2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('‚ö†Ô∏è La imagen debe ser menor a 2MB');
                        this.value = '';
                        return;
                    }
                    
                    // Mostrar previsualizaci√≥n
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const preview = document.getElementById('groupIconPreview');
                        preview.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-cover rounded-lg" alt="Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Event listeners para pesta√±as de grupos
            document.querySelectorAll('.group-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchGroupTab(tabName);
                });
            });
            
            // Event listeners para modales (estos s√≠ existen desde el inicio)
            document.getElementById('closeAddStudentsModal')?.addEventListener('click', () => closeAddStudentsModal());
            document.getElementById('cancelAddStudents')?.addEventListener('click', () => closeAddStudentsModal());
            document.getElementById('confirmAddStudents')?.addEventListener('click', () => confirmAddStudents());
            document.getElementById('searchStudents')?.addEventListener('input', (e) => filterStudents(e.target.value));
            
            document.getElementById('closePublishAnnouncementModal')?.addEventListener('click', closePublishAnnouncementModal);
            document.getElementById('cancelPublishAnnouncement')?.addEventListener('click', closePublishAnnouncementModal);
            document.getElementById('announcementForm')?.addEventListener('submit', publishAnnouncement);
            
            // Event listeners para modal de subida de archivos
            document.getElementById('closeUploadFileModal')?.addEventListener('click', closeUploadFileModal);
            document.getElementById('cancelUploadFile')?.addEventListener('click', closeUploadFileModal);
            document.getElementById('uploadFileForm')?.addEventListener('submit', uploadFile);
            
            // Input de archivo
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        handleFileSelect(e.target.files[0]);
                    }
                });
            }
            
            // Drag & Drop
            const dropZone = document.getElementById('fileDropZone');
            if (dropZone) {
                dropZone.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        handleFileSelect(e.dataTransfer.files[0]);
                    }
                });
            }
            
            // Bot√≥n para remover archivo seleccionado
            document.getElementById('removeFile')?.addEventListener('click', () => {
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('filePreview').classList.add('hidden');
                document.getElementById('fileDropZone').classList.remove('hidden');
            });
            
            // Event listener para contador de caracteres
            document.getElementById('announcementContent')?.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('contentCharCount').textContent = count;
            });
            
            // Event listener para zona de arrastre de archivos
            document.getElementById('attachmentDropZone')?.addEventListener('click', function() {
                document.getElementById('announcementAttachment').click();
            });
            
            // Cargar grupos del profesor
            await loadTeacherGroups();
        }
        
        async function loadTeacherGroups() {
            // Esperar a que el usuario est√© autenticado
            let user = window.currentUser || window.auth?.currentUser;
            
            if (!user) {
                console.log('‚è≥ Esperando autenticaci√≥n del usuario...');
                // Esperar hasta 5 segundos por la autenticaci√≥n
                for (let i = 0; i < 50; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    user = window.currentUser || window.auth?.currentUser;
                    if (user) break;
                }
                
                if (!user) {
                    console.warn('‚ö†Ô∏è No se pudo autenticar el usuario despu√©s de esperar');
                    return;
                }
            }
            
            try {
                console.log('üîç Cargando grupos del profesor:', user.uid);
                const groupsRef = collection(window.db, 'groups');
                const q = query(groupsRef, where('teacherId', '==', user.uid));
                const snapshot = await getDocs(q);
                
                console.log('üìä Grupos encontrados:', snapshot.size);
                
                const grid = document.getElementById('groupsGrid');
                if (!grid) {
                    console.error('‚ùå No se encontr√≥ el elemento groupsGrid');
                    return;
                }
                
                grid.innerHTML = '';
                
                if (snapshot.empty) {
                    grid.innerHTML = `
                        <div class="text-center text-gray-400 py-12 col-span-full">
                            <div class="text-6xl mb-4">
                                <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <p class="text-lg mb-2">No tienes grupos creados</p>
                            <p class="text-sm">Crea tu primer grupo para comenzar</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar manualmente por fecha
                const groups = [];
                snapshot.forEach(doc => {
                    groups.push({ id: doc.id, ...doc.data() });
                });
                groups.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                groups.forEach(group => {
                    const groupCard = createGroupCard(group.id, group);
                    grid.insertAdjacentHTML('beforeend', groupCard);
                });
                
                console.log('‚úÖ Grupos renderizados');
                
                // Agregar event listeners a las tarjetas
                grid.querySelectorAll('.group-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const groupId = card.dataset.groupId;
                        openGroupDetail(groupId);
                    });
                });
            } catch (error) {
                console.error('‚ùå Error cargando grupos:', error);
                const grid = document.getElementById('groupsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="text-center text-red-400 py-12 col-span-full">
                            <p class="text-lg mb-2">Error cargando grupos</p>
                            <p class="text-sm">${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        function createGroupCard(groupId, group) {
            const studentCount = group.studentIds?.length || 0;
            const groupColor = group.colorIdentifier || '#6f42c1'; // Color por defecto
            
            return `
                <div class="group-card card hover-lift cursor-pointer transition-all overflow-hidden" data-group-id="${groupId}">
                    <!-- Barra de color superior -->
                    <div class="h-2 w-full mb-4" style="background-color: ${groupColor};"></div>
                    
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3 flex-1">
                            ${group.iconURL ? 
                                `<img src="${group.iconURL}" class="w-12 h-12 rounded-lg object-cover border-2" style="border-color: ${groupColor};" alt="${group.name}">` :
                                `<div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xl" style="background-color: ${groupColor};">${group.name.charAt(0).toUpperCase()}</div>`
                            }
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-1">${group.name}</h3>
                                <p class="text-sm text-gray-600">${group.subject || 'Sin materia'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full" style="background-color: ${groupColor}20; color: ${groupColor};">
                            ${group.level}
                        </span>
                    </div>
                    
                    ${group.groupCode ? `
                        <div class="mb-3 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-600">C√≥digo de clase:</span>
                                <span class="text-sm font-mono font-bold" style="color: ${groupColor};">${group.groupCode}</span>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <span>${studentCount} estudiante${studentCount !== 1 ? 's' : ''}</span>
                        </div>
                        ${group.period ? `<div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>${group.period}</span>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function openGroupModal(groupId = null) {
            currentGroupId = groupId;
            const modal = document.getElementById('groupModal');
            const form = document.getElementById('groupForm');
            
            if (groupId) {
                document.getElementById('groupModalTitle').textContent = 'Editar Grupo';
                document.getElementById('groupSubmitText').textContent = 'Guardar Cambios';
                // Cargar datos del grupo
                loadGroupDataToForm(groupId);
            } else {
                document.getElementById('groupModalTitle').textContent = 'Crear Nuevo Grupo';
                document.getElementById('groupSubmitText').textContent = 'Crear Grupo';
                form.reset();
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeGroupModal() {
            document.getElementById('groupModal').classList.add('hidden');
            document.getElementById('groupForm').reset();
            currentGroupId = null;
        }
        
        async function handleGroupSubmit(e) {
            e.preventDefault();
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para crear un grupo');
                return;
            }
            
            // Obtener color seleccionado
            const selectedColor = document.querySelector('input[name="groupColor"]:checked');
            if (!selectedColor) {
                alert('‚ö†Ô∏è Debes seleccionar un color para el grupo');
                return;
            }
            
            const groupData = {
                name: document.getElementById('groupName').value.trim(),
                subject: document.getElementById('groupSubject').value.trim(),
                level: document.getElementById('groupLevel').value,
                period: document.getElementById('groupPeriod').value.trim(),
                description: document.getElementById('groupDescription').value.trim(),
                colorIdentifier: selectedColor.value,
                teacherId: user.uid,
                teacherName: window.currentUser?.name || user.displayName || 'Profesor',
                updatedAt: new Date()
            };
            
            // Manejar la imagen del grupo (si se subi√≥)
            const iconFile = document.getElementById('groupIconFile').files[0];
            if (iconFile) {
                try {
                    // Convertir imagen a Base64 para almacenar en Firestore
                    const reader = new FileReader();
                    groupData.iconURL = await new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(iconFile);
                    });
                } catch (error) {
                    console.error('Error procesando imagen:', error);
                }
            }
            
            try {
                if (currentGroupId) {
                    // Actualizar grupo existente
                    await updateDoc(doc(window.db, 'groups', currentGroupId), groupData);
                    
                    // Mostrar notificaci√≥n de √©xito
                    showNotification('success', '‚úÖ Grupo actualizado correctamente');
                } else {
                    // ======= CREAR NUEVO GRUPO CON C√ìDIGO √öNICO =======
                    
                    // 1. Generar c√≥digo √∫nico de 6 caracteres
                    groupData.groupCode = await generateUniqueGroupCode();
                    
                    // 2. Inicializar arrays
                    groupData.createdAt = new Date();
                    groupData.studentIds = [];
                    groupData.members = [user.uid]; // Profesor es miembro por defecto
                    
                    // 3. Crear documento en Firestore
                    const newGroupRef = await addDoc(collection(window.db, 'groups'), groupData);
                    
                    // 4. Mostrar notificaci√≥n de √©xito con c√≥digo
                    showNotification('success', `‚úÖ Grupo creado. C√≥digo: ${groupData.groupCode}`);
                    
                    // 5. Redirigir a la vista interna del grupo
                    setTimeout(() => {
                        openGroupDetail(newGroupRef.id);
                    }, 1500);
                }
                
                // Cerrar modal y recargar lista
                closeGroupModal();
                await loadTeacherGroups();
                
            } catch (error) {
                console.error('Error guardando grupo:', error);
                showNotification('error', '‚ùå Error al guardar el grupo: ' + error.message);
            }
        }
        
        /**
         * Genera un c√≥digo alfanum√©rico √∫nico de 6 caracteres
         * Valida contra la base de datos para garantizar singularidad
         */
        async function generateUniqueGroupCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const codeLength = 6;
            let code = '';
            let isUnique = false;
            let attempts = 0;
            const maxAttempts = 50; // Prevenir loops infinitos
            
            while (!isUnique && attempts < maxAttempts) {
                // Generar c√≥digo aleatorio
                code = '';
                for (let i = 0; i < codeLength; i++) {
                    code += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                
                // Verificar si el c√≥digo ya existe
                const groupsRef = collection(window.db, 'groups');
                const q = query(groupsRef, where('groupCode', '==', code));
                const snapshot = await getDocs(q);
                
                isUnique = snapshot.empty; // Si est√° vac√≠o, el c√≥digo es √∫nico
                attempts++;
            }
            
            if (!isUnique) {
                throw new Error('No se pudo generar un c√≥digo √∫nico despu√©s de ' + maxAttempts + ' intentos');
            }
            
            console.log(`‚úÖ C√≥digo √∫nico generado: ${code} (intentos: ${attempts})`);
            return code;
        }
        
        /**
         * Muestra una notificaci√≥n temporal en la pantalla
         */
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-[10000] px-6 py-4 rounded-lg shadow-xl transition-all transform translate-x-0 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white font-semibold`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        /**
         * Cambiar entre pesta√±as del grupo
         */
        function switchGroupTab(tabName) {
            // Actualizar pesta√±as activas
            document.querySelectorAll('.group-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active', 'border-indigo-600', 'text-indigo-600');
                    tab.classList.remove('border-transparent', 'text-gray-600');
                } else {
                    tab.classList.remove('active', 'border-indigo-600', 'text-indigo-600');
                    tab.classList.add('border-transparent', 'text-gray-600');
                }
            });
            
            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `tab-${tabName}`) {
                    content.classList.remove('hidden');
                    content.classList.add('active');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('active');
                }
            });
            
            // Cargar contenido espec√≠fico seg√∫n la pesta√±a
            if (tabName === 'archivos' && currentGroupId) {
                loadGroupFiles(currentGroupId);
            }
        }
        
        /**
         * Copiar c√≥digo del grupo al portapapeles
         */
        function copyGroupCode() {
            const codeElement = document.getElementById('groupDetailCode');
            const code = codeElement.textContent;
            
            if (code && code !== '------') {
                navigator.clipboard.writeText(code).then(() => {
                    showNotification('success', '‚úÖ C√≥digo copiado: ' + code);
                }).catch(err => {
                    console.error('Error copiando c√≥digo:', err);
                    showNotification('error', '‚ùå Error al copiar c√≥digo');
                });
            }
        }
        
        async function openGroupDetail(groupId) {
            currentGroupId = groupId;
            
            try {
                const groupDoc = await getDoc(doc(window.db, 'groups', groupId));
                if (!groupDoc.exists()) {
                    showNotification('error', '‚ùå Grupo no encontrado');
                    return;
                }
                
                const group = groupDoc.data();
                const groupColor = group.colorIdentifier || '#6f42c1';
                
                // Prevenir scroll del body cuando el modal est√° abierto
                document.body.style.overflow = 'hidden';
                
                // Actualizar header con color del grupo
                const header = document.getElementById('groupDetailHeader');
                header.style.borderColor = groupColor;
                
                // Actualizar √≠cono
                const iconEl = document.getElementById('groupDetailIcon');
                if (group.iconURL) {
                    iconEl.innerHTML = `<img src="${group.iconURL}" class="w-full h-full object-cover rounded-lg" alt="${group.name}">`;
                    iconEl.style.backgroundColor = 'transparent';
                } else {
                    iconEl.textContent = group.name.charAt(0).toUpperCase();
                    iconEl.style.backgroundColor = groupColor;
                }
                
                // Actualizar informaci√≥n b√°sica
                document.getElementById('groupDetailName').textContent = group.name;
                document.getElementById('groupDetailSubject').textContent = group.subject || 'Sin materia';
                
                // Actualizar KPIs
                document.getElementById('groupDetailStudentCount').textContent = group.studentIds?.length || 0;
                document.getElementById('groupDetailLevel').textContent = group.level || '-';
                document.getElementById('groupDetailPeriod').textContent = group.period || '-';
                
                // Mostrar c√≥digo del grupo
                const codeCard = document.getElementById('groupCodeCard');
                if (group.groupCode) {
                    document.getElementById('groupDetailCode').textContent = group.groupCode;
                    codeCard.style.borderColor = groupColor;
                    codeCard.style.backgroundColor = `${groupColor}10`;
                } else {
                    document.getElementById('groupDetailCode').textContent = '------';
                }
                
                // Cargar lista de estudiantes
                await loadGroupStudents(group.studentIds || []);
                
                // Cargar anuncios del grupo
                await loadGroupAnnouncements(groupId);
                
                // Cargar archivos compartidos
                await loadGroupFiles(groupId);
                
                // Cargar lecciones asignadas
                await loadAssignedLessons(groupId);
                
                // Reiniciar a la pesta√±a General
                switchGroupTab('general');
                
                // Mostrar modal PRIMERO
                document.getElementById('groupDetailModal').classList.remove('hidden');
                
                // Registrar event listeners para botones de acci√≥n
                registerGroupActionButtons();
            } catch (error) {
                console.error('Error cargando detalle del grupo:', error);
                showNotification('error', '‚ùå Error al cargar el grupo');
            }
        }
        
        function closeGroupDetailModal() {
            document.getElementById('groupDetailModal').classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restaurar scroll del body
            currentGroupId = null;
        }
        
        /**
         * SISTEMA SIMPLIFICADO: Registro directo de Event Listeners
         * Sin complejidad innecesaria - enfoque directo y efectivo
         */
        function registerGroupActionButtons() {
            console.log('üîß Registrando botones de acci√≥n...');
            
            // Esperar un momento para que el DOM est√© listo
            setTimeout(() => {
                // Bot√≥n A√±adir Estudiantes
                const btnAdd = document.getElementById('btnAddStudents');
                if (btnAdd) {
                    btnAdd.onclick = function(e) {
                        e.preventDefault();
                        console.log('üë• Click: A√±adir Estudiantes');
                        if (!currentGroupId) {
                            showNotification('error', 'No hay grupo seleccionado');
                            return;
                        }
                        openAddStudentsModal();
                    };
                    console.log('‚úì A√±adir Estudiantes configurado');
                }
                
                // Bot√≥n Publicar Anuncio
                const btnAnnounce = document.getElementById('btnPublishAnnouncement');
                if (btnAnnounce) {
                    btnAnnounce.onclick = function(e) {
                        e.preventDefault();
                        console.log('üì¢ Click: Publicar Anuncio');
                        if (!currentGroupId) {
                            showNotification('error', 'No hay grupo seleccionado');
                            return;
                        }
                        openPublishAnnouncementModal();
                    };
                    console.log('‚úì Publicar Anuncio configurado');
                }
                
                // Bot√≥n Subir Archivo
                const btnUpload = document.getElementById('btnUploadFile');
                if (btnUpload) {
                    btnUpload.onclick = function(e) {
                        e.preventDefault();
                        console.log('üìÅ Click: Subir Archivo');
                        if (!currentGroupId) {
                            showNotification('error', 'No hay grupo seleccionado');
                            return;
                        }
                        openUploadFileModal();
                    };
                    console.log('‚úì Subir Archivo configurado');
                }
                
                // Bot√≥n Asignar Lecci√≥n
                const btnAssignLesson = document.getElementById('btnAssignLesson');
                if (btnAssignLesson) {
                    btnAssignLesson.onclick = function(e) {
                        e.preventDefault();
                        console.log('üìö Click: Asignar Lecci√≥n');
                        if (!currentGroupId) {
                            showNotification('error', 'No hay grupo seleccionado');
                            return;
                        }
                        openAssignLessonModal();
                    };
                    console.log('‚úì Asignar Lecci√≥n configurado');
                }
                
                // Bot√≥n Eliminar
                const btnDelete = document.getElementById('btnDeleteGroup');
                if (btnDelete) {
                    btnDelete.onclick = function(e) {
                        e.preventDefault();
                        console.log('üóëÔ∏è Click: Eliminar Grupo');
                        if (!currentGroupId) {
                            showNotification('error', 'No hay grupo seleccionado');
                            return;
                        }
                        deleteCurrentGroup();
                    };
                    console.log('‚úì Eliminar configurado');
                }
                
                console.log('‚úÖ Todos los botones configurados\n');
            }, 100);
        }
        
        async function loadGroupStudents(studentIds) {
            const container = document.getElementById('groupStudentsList');
            
            if (studentIds.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay estudiantes en este grupo</p>';
                return;
            }
            
            container.innerHTML = '';
            
            for (const studentId of studentIds) {
                try {
                    const studentDoc = await getDoc(doc(window.db, 'users', studentId));
                    if (studentDoc.exists()) {
                        const student = studentDoc.data();
                        const studentCard = `
                            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                                <div class="flex items-center gap-3">
                                    <img src="${student.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.displayName || 'Estudiante')}&background=667eea&color=fff`}" 
                                         class="w-10 h-10 rounded-full">
                                    <div>
                                        <div class="font-semibold text-gray-800">${student.displayName || student.email}</div>
                                        <div class="text-xs text-gray-500">${student.email}</div>
                                    </div>
                                </div>
                                <button onclick="removeStudentFromGroup('${studentId}')" class="text-red-500 hover:text-red-700 p-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', studentCard);
                    }
                } catch (error) {
                    console.error('Error cargando estudiante:', error);
                }
            }
        }
        
        async function openAddStudentsModal() {
            selectedStudents = [];
            await loadAvailableStudents();
            
            const modal = document.getElementById('addStudentsModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                console.error('Modal addStudentsModal no encontrado');
                showNotification('error', 'Error al abrir modal');
            }
        }
        
        function closeAddStudentsModal() {
            const modal = document.getElementById('addStudentsModal');
            if (modal) modal.classList.add('hidden');
            selectedStudents = [];
        }
        
        async function loadAvailableStudents() {
            const container = document.getElementById('availableStudentsList');
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando estudiantes...</p>';
            
            try {
                // Obtener grupo actual
                const groupDoc = await getDoc(doc(window.db, 'groups', currentGroupId));
                const currentStudentIds = groupDoc.exists() ? (groupDoc.data().studentIds || []) : [];
                
                // Obtener todos los estudiantes
                const usersRef = collection(window.db, 'users');
                const q = query(usersRef, where('rol', '==', 'estudiante'));
                const snapshot = await getDocs(q);
                
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    // No mostrar estudiantes que ya est√°n en el grupo
                    if (currentStudentIds.includes(studentId)) return;
                    
                    const studentItem = `
                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition cursor-pointer">
                            <div class="flex items-center gap-3">
                                <img src="${student.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.displayName || 'Estudiante')}&background=667eea&color=fff`}" 
                                     class="w-10 h-10 rounded-full">
                                <div>
                                    <div class="font-semibold text-gray-800">${student.displayName || student.email}</div>
                                    <div class="text-xs text-gray-500">${student.email}</div>
                                </div>
                            </div>
                            <input type="checkbox" value="${studentId}" class="student-checkbox w-5 h-5 text-indigo-600">
                        </label>
                    `;
                    container.insertAdjacentHTML('beforeend', studentItem);
                });
                
                if (container.children.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay estudiantes disponibles</p>';
                }
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar estudiantes</p>';
            }
        }
        
        function filterStudents(searchTerm) {
            const items = document.querySelectorAll('#availableStudentsList label');
            searchTerm = searchTerm.toLowerCase();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        async function confirmAddStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const studentIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (studentIds.length === 0) {
                alert('Selecciona al menos un estudiante');
                return;
            }
            
            try {
                const groupRef = doc(window.db, 'groups', currentGroupId);
                const groupDoc = await getDoc(groupRef);
                const currentStudents = groupDoc.data().studentIds || [];
                
                await updateDoc(groupRef, {
                    studentIds: [...currentStudents, ...studentIds]
                });
                
                alert(`‚úÖ ${studentIds.length} estudiante(s) a√±adido(s) correctamente`);
                closeAddStudentsModal();
                await openGroupDetail(currentGroupId); // Recargar detalles
            } catch (error) {
                console.error('Error a√±adiendo estudiantes:', error);
                alert('‚ùå Error al a√±adir estudiantes');
            }
        }
        
        window.removeStudentFromGroup = async function(studentId) {
            if (!confirm('¬øEst√°s seguro de remover este estudiante del grupo?')) return;
            
            try {
                const groupRef = doc(window.db, 'groups', currentGroupId);
                const groupDoc = await getDoc(groupRef);
                const currentStudents = groupDoc.data().studentIds || [];
                
                await updateDoc(groupRef, {
                    studentIds: currentStudents.filter(id => id !== studentId)
                });
                
                alert('‚úÖ Estudiante removido correctamente');
                await openGroupDetail(currentGroupId); // Recargar detalles
            } catch (error) {
                console.error('Error removiendo estudiante:', error);
                alert('‚ùå Error al remover estudiante');
            }
        };
        
        async function editCurrentGroup() {
            closeGroupDetailModal();
            openGroupModal(currentGroupId);
        }
        
        async function deleteCurrentGroup() {
            if (!confirm('¬øEst√°s seguro de eliminar este grupo? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(window.db, 'groups', currentGroupId));
                showNotification('success', '‚úÖ Grupo eliminado');
                closeGroupDetailModal();
                await loadTeacherGroups();
            } catch (error) {
                console.error('Error eliminando grupo:', error);
                showNotification('error', '‚ùå Error al eliminar');
            }
        }

        // ========== SISTEMA DE ANUNCIOS ==========
        
        let currentAnnouncementGroupId = null;
        let attachedFiles = [];

        async function openPublishAnnouncementModal() {
            try {
                const groupDoc = await getDoc(doc(window.db, 'groups', currentGroupId));
                if (!groupDoc.exists()) {
                    showNotification('error', '‚ùå Grupo no encontrado');
                    return;
                }

                const group = groupDoc.data();
                currentAnnouncementGroupId = currentGroupId;
                attachedFiles = [];

                // Actualizar informaci√≥n del grupo
                const iconEl = document.getElementById('announcementGroupIcon');
                if (group.iconURL) {
                    iconEl.innerHTML = `<img src="${group.iconURL}" class="w-full h-full object-cover rounded-lg" alt="${group.name}">`;
                } else {
                    iconEl.textContent = group.name.charAt(0).toUpperCase();
                    iconEl.style.backgroundColor = group.colorIdentifier || '#6f42c1';
                }
                
                document.getElementById('announcementGroupName').textContent = group.name;
                document.getElementById('announcementForm').reset();
                document.getElementById('contentCharCount').textContent = '0';
                document.getElementById('attachmentList').innerHTML = '';

                const modal = document.getElementById('publishAnnouncementModal');
                if (modal) {
                    modal.classList.remove('hidden');
                } else {
                    console.error('Modal publishAnnouncementModal no encontrado');
                }
            } catch (error) {
                console.error('Error abriendo modal de anuncio:', error);
                showNotification('error', '‚ùå Error al abrir el modal');
            }
        }

        function closePublishAnnouncementModal() {
            const modal = document.getElementById('publishAnnouncementModal');
            if (modal) modal.classList.add('hidden');
            currentAnnouncementGroupId = null;
            attachedFiles = [];
        }

        async function publishAnnouncement(e) {
            e.preventDefault();

            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const typeRadio = document.querySelector('input[name="announcementType"]:checked');
            
            if (!typeRadio) {
                showNotification('error', '‚ùå Selecciona un tipo de anuncio');
                return;
            }
            
            const type = typeRadio.value;

            if (!content) {
                showNotification('error', '‚ùå El contenido del mensaje es requerido');
                return;
            }

            if (!currentAnnouncementGroupId) {
                showNotification('error', '‚ùå No hay grupo seleccionado');
                return;
            }

            try {
                const user = window.auth.currentUser;
                if (!user) {
                    showNotification('error', '‚ùå Debes estar autenticado');
                    return;
                }

                console.log('üìù Publicando anuncio...', {
                    groupId: currentAnnouncementGroupId,
                    type,
                    title,
                    contentLength: content.length
                });

                // Crear el anuncio en Firestore
                const announcementData = {
                    groupId: currentAnnouncementGroupId,
                    publishedBy: user.uid,
                    publisherName: user.displayName || user.email || 'Profesor',
                    publisherPhoto: user.photoURL || null,
                    title: title || null,
                    content: content,
                    type: type,
                    attachments: attachedFiles.map(f => ({ name: f.name, url: f.url, type: f.type })),
                    createdAt: serverTimestamp(),
                    timestamp: new Date().toISOString()
                };

                console.log('üíæ Guardando en Firestore...', announcementData);
                
                const announcementRef = await addDoc(collection(window.db, 'announcements'), announcementData);

                console.log('‚úÖ Anuncio guardado con ID:', announcementRef.id);
                
                showNotification('success', '‚úÖ Anuncio publicado exitosamente');
                closePublishAnnouncementModal();

                // Recargar anuncios del grupo
                await loadGroupAnnouncements(currentAnnouncementGroupId);

            } catch (error) {
                console.error('‚ùå Error publicando anuncio:', error);
                console.error('Error details:', { 
                    code: error.code, 
                    message: error.message,
                    stack: error.stack 
                });
                showNotification('error', `‚ùå Error al publicar: ${error.message}`);
            }
        }

        async function loadGroupAnnouncements(groupId) {
            const container = document.getElementById('groupAnnouncements');
            
            if (!container) {
                console.error('‚ùå Contenedor de anuncios no encontrado');
                return;
            }
            
            try {
                console.log('üì¢ Cargando anuncios del grupo:', groupId);
                
                // Query simple sin orderBy para evitar problemas de √≠ndice
                const q = query(
                    collection(window.db, 'announcements'),
                    where('groupId', '==', groupId)
                );

                const snapshot = await getDocs(q);

                console.log('üìä Anuncios encontrados:', snapshot.size);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                            <p class="font-medium text-gray-500">No hay anuncios publicados</p>
                            <p class="text-sm mt-2">Usa el bot√≥n "Publicar Anuncio" para compartir informaci√≥n con el grupo</p>
                        </div>
                    `;
                    return;
                }

                // Ordenar anuncios manualmente por timestamp
                const announcements = [];
                snapshot.forEach(doc => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });
                
                announcements.sort((a, b) => {
                    const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                    const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                    return dateB - dateA; // M√°s recientes primero
                });

                container.innerHTML = '';

                announcements.forEach(announcement => {
                    const announcementCard = createAnnouncementCard(announcement, announcement.id);
                    container.insertAdjacentHTML('beforeend', announcementCard);
                });

            } catch (error) {
                console.error('Error cargando anuncios:', error);
                container.innerHTML = `
                    <div class="text-center text-red-500 py-8 bg-red-50 rounded-lg border-2 border-red-200">
                        <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="font-medium">Error al cargar los anuncios</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function createAnnouncementCard(announcement, announcementId) {
            const typeColors = {
                general: { bg: 'bg-blue-50', border: 'border-blue-200', icon: 'text-blue-600', iconBg: 'bg-blue-100' },
                task: { bg: 'bg-orange-50', border: 'border-orange-200', icon: 'text-orange-600', iconBg: 'bg-orange-100' },
                reminder: { bg: 'bg-yellow-50', border: 'border-yellow-200', icon: 'text-yellow-600', iconBg: 'bg-yellow-100' },
                important: { bg: 'bg-red-50', border: 'border-red-200', icon: 'text-red-600', iconBg: 'bg-red-100' }
            };

            const typeIcons = {
                general: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
                task: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>',
                reminder: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
                important: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>'
            };

            const colors = typeColors[announcement.type] || typeColors.general;
            const icon = typeIcons[announcement.type] || typeIcons.general;

            const timeAgo = announcement.timestamp ? formatTimeAgo(new Date(announcement.timestamp)) : 'Hace un momento';

            let attachmentsHTML = '';
            if (announcement.attachments && announcement.attachments.length > 0) {
                attachmentsHTML = `
                    <div class="mt-3 space-y-2">
                        ${announcement.attachments.map(att => `
                            <a href="${att.url}" target="_blank" class="flex items-center gap-2 text-sm text-gray-700 hover:text-indigo-600 p-2 bg-white rounded border border-gray-200 hover:border-indigo-300 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                                <span class="flex-1 truncate">${att.name}</span>
                            </a>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div class="border-2 ${colors.border} ${colors.bg} rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-10 h-10 ${colors.iconBg} rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 ${colors.icon}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${icon}
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <img src="${announcement.publisherPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(announcement.publisherName)}&background=667eea&color=fff`}" 
                                         class="w-6 h-6 rounded-full">
                                    <span class="font-semibold text-gray-800 text-sm">${announcement.publisherName}</span>
                                </div>
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                            </div>
                            ${announcement.title ? `<h4 class="font-bold text-gray-800 mb-2">${announcement.title}</h4>` : ''}
                            <p class="text-gray-700 text-sm whitespace-pre-wrap">${announcement.content}</p>
                            ${attachmentsHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Hace un momento';
            if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)} h`;
            if (seconds < 604800) return `Hace ${Math.floor(seconds / 86400)} d√≠as`;
            
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }
        
        async function loadGroupDataToForm(groupId) {
            try {
                const groupDoc = await getDoc(doc(window.db, 'groups', groupId));
                if (!groupDoc.exists()) return;
                
                const group = groupDoc.data();
                document.getElementById('groupName').value = group.name;
                document.getElementById('groupSubject').value = group.subject;
                document.getElementById('groupLevel').value = group.level;
                document.getElementById('groupPeriod').value = group.period || '';
                document.getElementById('groupDescription').value = group.description || '';
            } catch (error) {
                console.error('Error cargando datos del grupo:', error);
            }
        }
        
        // ========== SISTEMA DE ARCHIVOS COMPARTIDOS ==========
        
        let selectedFile = null;
        let currentUploadTask = null;
        
        /**
         * Abrir modal de subida de archivos
         */
        function openUploadFileModal() {
            if (!currentGroupId) {
                showNotification('error', '‚ùå No hay grupo seleccionado');
                return;
            }
            
            // Limpiar formulario
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileDescription').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('fileDropZone').classList.remove('hidden');
            
            // Mostrar modal
            document.getElementById('uploadFileModal').classList.remove('hidden');
        }
        
        /**
         * Cerrar modal de subida
         */
        function closeUploadFileModal() {
            document.getElementById('uploadFileModal').classList.add('hidden');
            selectedFile = null;
            if (currentUploadTask) {
                currentUploadTask.cancel();
                currentUploadTask = null;
            }
        }
        
        /**
         * Manejar selecci√≥n de archivo
         */
        function handleFileSelect(file) {
            if (!file) return;
            
            // Validar tama√±o (10MB m√°ximo)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showNotification('error', '‚ùå El archivo es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            // Validar tipo de archivo
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'application/zip',
                'application/x-rar-compressed',
                'text/plain',
                'image/jpeg',
                'image/png',
                'image/gif'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                showNotification('error', '‚ùå Tipo de archivo no permitido');
                return;
            }
            
            selectedFile = file;
            
            // Mostrar preview
            document.getElementById('fileDropZone').classList.add('hidden');
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
        }
        
        /**
         * Formatear tama√±o de archivo
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        /**
         * Subir archivo a Firebase Storage y guardar referencia en Firestore
         */
        async function uploadFile(e) {
            e.preventDefault();
            
            if (!selectedFile) {
                showNotification('error', '‚ùå Selecciona un archivo');
                return;
            }
            
            if (!currentGroupId) {
                showNotification('error', '‚ùå No hay grupo seleccionado');
                return;
            }
            
            const user = window.auth.currentUser;
            if (!user) {
                showNotification('error', '‚ùå Debes estar autenticado');
                return;
            }
            
            const description = document.getElementById('fileDescription').value.trim();
            
            try {
                // Deshabilitar bot√≥n de env√≠o
                const submitBtn = document.getElementById('confirmUploadFile');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Subiendo...';
                
                // Mostrar progreso
                document.getElementById('uploadProgress').classList.remove('hidden');
                
                // Crear referencia en Storage: /groups/{groupId}/files/{timestamp}_{filename}
                const timestamp = Date.now();
                const fileName = `${timestamp}_${selectedFile.name}`;
                const storageRef = ref(window.storage, `groups/${currentGroupId}/files/${fileName}`);
                
                console.log('üì§ Subiendo archivo:', fileName, 'Tama√±o:', formatFileSize(selectedFile.size));
                
                // Subir archivo con tracking de progreso
                const uploadTask = uploadBytesResumable(storageRef, selectedFile);
                currentUploadTask = uploadTask;
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Actualizar barra de progreso
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('uploadProgressBar').style.width = progress + '%';
                        document.getElementById('uploadPercent').textContent = Math.round(progress) + '%';
                        console.log('‚è≥ Progreso:', Math.round(progress) + '%');
                    },
                    (error) => {
                        // Error en la subida
                        console.error('‚ùå Error subiendo archivo:', error);
                        showNotification('error', `‚ùå Error al subir: ${error.message}`);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Subir Archivo
                        `;
                        document.getElementById('uploadProgress').classList.add('hidden');
                    },
                    async () => {
                        // Subida exitosa - obtener URL de descarga
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            console.log('‚úÖ Archivo subido exitosamente. URL:', downloadURL);
                            
                            // Guardar referencia en Firestore
                            const fileData = {
                                fileId: timestamp.toString(),
                                groupId: currentGroupId,
                                uploadedBy: user.uid,
                                uploaderName: user.displayName || user.email || 'Profesor',
                                uploaderPhoto: user.photoURL || null,
                                fileName: selectedFile.name,
                                fileSize: selectedFile.size,
                                fileType: selectedFile.type,
                                fileUrl: downloadURL,
                                storagePath: `groups/${currentGroupId}/files/${fileName}`,
                                description: description || null,
                                createdAt: serverTimestamp(),
                                timestamp: new Date().toISOString()
                            };
                            
                            console.log('üíæ Guardando metadata en Firestore...');
                            await addDoc(collection(window.db, 'sharedFiles'), fileData);
                            
                            showNotification('success', '‚úÖ Archivo subido correctamente');
                            closeUploadFileModal();
                            
                            // Recargar lista de archivos del grupo
                            await loadGroupFiles(currentGroupId);
                            
                        } catch (error) {
                            console.error('‚ùå Error guardando metadata:', error);
                            showNotification('error', `‚ùå Error al guardar: ${error.message}`);
                        }
                        
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Subir Archivo
                        `;
                    }
                );
                
            } catch (error) {
                console.error('‚ùå Error en proceso de subida:', error);
                showNotification('error', `‚ùå Error: ${error.message}`);
                const submitBtn = document.getElementById('confirmUploadFile');
                submitBtn.disabled = false;
            }
        }
        
        /**
         * Cargar archivos del grupo
         */
        async function loadGroupFiles(groupId) {
            const container = document.getElementById('groupFilesList');
            
            if (!container) {
                console.error('‚ùå Contenedor de archivos no encontrado');
                return;
            }
            
            try {
                console.log('üìÅ Cargando archivos del grupo:', groupId);
                
                const q = query(
                    collection(window.db, 'sharedFiles'),
                    where('groupId', '==', groupId),
                    orderBy('createdAt', 'desc')
                );
                
                const snapshot = await getDocs(q);
                console.log('üìä Archivos encontrados:', snapshot.size);
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-16 col-span-full">
                            <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                            </svg>
                            <p class="font-medium text-gray-500">No hay archivos compartidos</p>
                            <p class="text-sm mt-2">Sube archivos para que los estudiantes puedan acceder a ellos</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const file = doc.data();
                    const fileCard = createFileCard(file, doc.id);
                    container.insertAdjacentHTML('beforeend', fileCard);
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando archivos:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-16 col-span-full">
                        <p class="font-medium">Error al cargar archivos</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        /**
         * Crear tarjeta de archivo
         */
        function createFileCard(file, fileId) {
            const fileIcon = getFileIcon(file.fileType);
            const timeAgo = file.timestamp ? formatTimeAgo(new Date(file.timestamp)) : 'Reci√©n subido';
            
            return `
                <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-indigo-300 hover:shadow-lg transition group">
                    <div class="flex flex-col gap-3">
                        <!-- √çcono y tipo -->
                        <div class="flex items-center justify-between">
                            <div class="w-12 h-12 bg-gradient-to-br ${fileIcon.gradient} rounded-lg flex items-center justify-center text-white text-2xl">
                                ${fileIcon.icon}
                            </div>
                            <button onclick="deleteGroupFile('${fileId}', '${file.storagePath}')" 
                                    class="opacity-0 group-hover:opacity-100 transition text-red-500 hover:text-red-700 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Nombre del archivo -->
                        <div>
                            <h4 class="font-semibold text-gray-800 text-sm truncate" title="${file.fileName}">
                                ${file.fileName}
                            </h4>
                            <p class="text-xs text-gray-500 mt-1">${formatFileSize(file.fileSize)}</p>
                        </div>
                        
                        <!-- Descripci√≥n (si existe) -->
                        ${file.description ? `
                            <p class="text-xs text-gray-600 line-clamp-2">${file.description}</p>
                        ` : ''}
                        
                        <!-- Informaci√≥n del uploader -->
                        <div class="flex items-center gap-2 text-xs text-gray-500 border-t pt-2">
                            <img src="${file.uploaderPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(file.uploaderName)}&background=667eea&color=fff`}" 
                                 class="w-5 h-5 rounded-full">
                            <span class="truncate">${file.uploaderName}</span>
                            <span>‚Ä¢</span>
                            <span>${timeAgo}</span>
                        </div>
                        
                        <!-- Bot√≥n de descarga -->
                        <a href="${file.fileUrl}" target="_blank" download="${file.fileName}"
                           class="w-full btn btn-primary text-sm py-2 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Descargar
                        </a>
                    </div>
                </div>
            `;
        }
        
        /**
         * Obtener √≠cono seg√∫n tipo de archivo
         */
        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) {
                return { icon: 'üìÑ', gradient: 'from-red-500 to-red-600' };
            } else if (fileType.includes('word') || fileType.includes('document')) {
                return { icon: 'üìù', gradient: 'from-blue-500 to-blue-600' };
            } else if (fileType.includes('excel') || fileType.includes('spreadsheet')) {
                return { icon: 'üìä', gradient: 'from-green-500 to-green-600' };
            } else if (fileType.includes('powerpoint') || fileType.includes('presentation')) {
                return { icon: 'üìä', gradient: 'from-orange-500 to-orange-600' };
            } else if (fileType.includes('zip') || fileType.includes('rar')) {
                return { icon: 'üóúÔ∏è', gradient: 'from-purple-500 to-purple-600' };
            } else if (fileType.includes('image')) {
                return { icon: 'üñºÔ∏è', gradient: 'from-pink-500 to-pink-600' };
            } else {
                return { icon: 'üìé', gradient: 'from-gray-500 to-gray-600' };
            }
        }
        
        /**
         * Eliminar archivo del grupo
         */
        async function deleteGroupFile(fileId, storagePath) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este archivo?')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Eliminando archivo:', fileId);
                
                // Eliminar archivo de Storage
                if (storagePath) {
                    const fileRef = ref(window.storage, storagePath);
                    await deleteObject(fileRef);
                    console.log('‚úÖ Archivo eliminado de Storage');
                }
                
                // Eliminar documento de Firestore
                await deleteDoc(doc(window.db, 'sharedFiles', fileId));
                console.log('‚úÖ Metadata eliminada de Firestore');
                
                showNotification('success', '‚úÖ Archivo eliminado correctamente');
                
                // Recargar lista
                if (currentGroupId) {
                    await loadGroupFiles(currentGroupId);
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando archivo:', error);
                showNotification('error', `‚ùå Error al eliminar: ${error.message}`);
            }
        }
        
        // Exponer funciones globalmente
        window.deleteGroupFile = deleteGroupFile;
        
        // ========== SISTEMA DE ASIGNACI√ìN DE LECCIONES ==========
        
        // Cat√°logo de lecciones disponibles (puede expandirse con Firestore)
        const availableLessons = [
            { 
                id: 'lesson-intro-python', 
                title: 'Introducci√≥n a Python', 
                description: 'Fundamentos de Python: variables, tipos de datos y operadores b√°sicos',
                duration: '45 min',
                difficulty: 'Principiante',
                topics: ['Variables', 'Tipos de datos', 'Operadores']
            },
            { 
                id: 'lesson-control-flow', 
                title: 'Estructuras de Control', 
                description: 'Aprende sobre condicionales (if/else) y bucles (for/while)',
                duration: '60 min',
                difficulty: 'Principiante',
                topics: ['Condicionales', 'Bucles', 'Flujo de control']
            },
            { 
                id: 'lesson-functions', 
                title: 'Funciones y Par√°metros', 
                description: 'Crea y utiliza funciones reutilizables en tus programas',
                duration: '50 min',
                difficulty: 'Intermedio',
                topics: ['Funciones', 'Par√°metros', 'Return']
            },
            { 
                id: 'lesson-lists', 
                title: 'Listas y Arreglos', 
                description: 'Manejo de colecciones de datos con listas y m√©todos √∫tiles',
                duration: '55 min',
                difficulty: 'Intermedio',
                topics: ['Listas', 'M√©todos', 'Iteraci√≥n']
            },
            { 
                id: 'lesson-dictionaries', 
                title: 'Diccionarios', 
                description: 'Estructuras clave-valor para organizar informaci√≥n compleja',
                duration: '50 min',
                difficulty: 'Intermedio',
                topics: ['Diccionarios', 'Claves', 'Valores']
            },
            { 
                id: 'lesson-oop', 
                title: 'Programaci√≥n Orientada a Objetos', 
                description: 'Clases, objetos, herencia y encapsulamiento',
                duration: '90 min',
                difficulty: 'Avanzado',
                topics: ['Clases', 'Objetos', 'Herencia']
            },
            { 
                id: 'lesson-files', 
                title: 'Manejo de Archivos', 
                description: 'Lee y escribe archivos de texto y CSV en Python',
                duration: '45 min',
                difficulty: 'Intermedio',
                topics: ['Archivos', 'Lectura', 'Escritura']
            },
            { 
                id: 'lesson-algorithms', 
                title: 'Algoritmos de Ordenamiento', 
                description: 'Implementa bubble sort, selection sort y quick sort',
                duration: '75 min',
                difficulty: 'Avanzado',
                topics: ['Algoritmos', 'Ordenamiento', 'Complejidad']
            }
        ];
        
        let selectedLessonIds = [];
        
        function openAssignLessonModal() {
            console.log('üìö Abriendo modal de asignar lecciones para grupo:', currentGroupId);
            
            const modal = document.getElementById('assignLessonModal');
            if (!modal) {
                console.error('‚ùå Modal assignLessonModal no encontrado');
                return;
            }
            
            // Resetear estado
            selectedLessonIds = [];
            updateSelectedCount();
            
            // Cargar lecciones disponibles
            loadAvailableLessons();
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Event listeners del modal
            setupAssignLessonModalListeners();
        }
        
        function setupAssignLessonModalListeners() {
            // Cerrar modal
            document.getElementById('closeAssignLessonModal')?.addEventListener('click', closeAssignLessonModal);
            document.getElementById('cancelAssignLesson')?.addEventListener('click', closeAssignLessonModal);
            
            // Confirmar asignaci√≥n
            document.getElementById('confirmAssignLesson')?.addEventListener('click', confirmAssignLessons);
            
            // B√∫squeda
            const searchInput = document.getElementById('searchLessons');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterLessons(e.target.value);
                });
            }
            
            // Limpiar selecci√≥n
            document.getElementById('clearSelection')?.addEventListener('click', () => {
                selectedLessonIds = [];
                loadAvailableLessons();
                updateSelectedCount();
            });
        }
        
        function loadAvailableLessons(filter = '') {
            const container = document.getElementById('availableLessonsList');
            if (!container) return;
            
            const filteredLessons = filter 
                ? availableLessons.filter(lesson => 
                    lesson.title.toLowerCase().includes(filter.toLowerCase()) ||
                    lesson.description.toLowerCase().includes(filter.toLowerCase()) ||
                    lesson.topics.some(topic => topic.toLowerCase().includes(filter.toLowerCase()))
                  )
                : availableLessons;
            
            if (filteredLessons.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="font-medium">No se encontraron lecciones</p>
                        <p class="text-sm">Intenta con otros t√©rminos de b√∫squeda</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredLessons.map(lesson => {
                const isSelected = selectedLessonIds.includes(lesson.id);
                const difficultyColors = {
                    'Principiante': 'bg-green-100 text-green-700',
                    'Intermedio': 'bg-yellow-100 text-yellow-700',
                    'Avanzado': 'bg-red-100 text-red-700'
                };
                
                return `
                    <div class="p-4 hover:bg-gray-50 transition cursor-pointer ${isSelected ? 'bg-indigo-50' : ''}" 
                         onclick="toggleLessonSelection('${lesson.id}')">
                        <div class="flex items-start gap-4">
                            <!-- Checkbox -->
                            <div class="flex-shrink-0 mt-1">
                                <input 
                                    type="checkbox" 
                                    id="checkbox-${lesson.id}"
                                    ${isSelected ? 'checked' : ''}
                                    class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                                    onclick="event.stopPropagation(); toggleLessonSelection('${lesson.id}')"
                                >
                            </div>
                            
                            <!-- Contenido -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <h5 class="font-semibold text-gray-900 text-lg">${lesson.title}</h5>
                                    <span class="flex-shrink-0 px-2 py-1 text-xs font-medium rounded-full ${difficultyColors[lesson.difficulty] || 'bg-gray-100 text-gray-700'}">
                                        ${lesson.difficulty}
                                    </span>
                                </div>
                                <p class="text-gray-600 text-sm mb-3">${lesson.description}</p>
                                <div class="flex items-center gap-4 text-xs text-gray-500">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        ${lesson.duration}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                        </svg>
                                        ${lesson.topics.join(', ')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleLessonSelection(lessonId) {
            const index = selectedLessonIds.indexOf(lessonId);
            
            if (index > -1) {
                // Deseleccionar
                selectedLessonIds.splice(index, 1);
            } else {
                // Seleccionar
                selectedLessonIds.push(lessonId);
            }
            
            // Actualizar UI
            loadAvailableLessons();
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            const counterContainer = document.getElementById('selectedLessonsCount');
            
            if (countElement) {
                countElement.textContent = selectedLessonIds.length;
            }
            
            if (counterContainer) {
                if (selectedLessonIds.length > 0) {
                    counterContainer.classList.remove('hidden');
                } else {
                    counterContainer.classList.add('hidden');
                }
            }
        }
        
        function filterLessons(searchTerm) {
            loadAvailableLessons(searchTerm);
        }
        
        async function confirmAssignLessons() {
            if (selectedLessonIds.length === 0) {
                showNotification('warning', '‚ö†Ô∏è Selecciona al menos una lecci√≥n');
                return;
            }
            
            if (!currentGroupId) {
                showNotification('error', '‚ùå No hay grupo seleccionado');
                return;
            }
            
            try {
                console.log('üìö Asignando lecciones al grupo:', currentGroupId);
                console.log('üìù Lecciones seleccionadas:', selectedLessonIds);
                
                const groupRef = doc(window.db, 'groups', currentGroupId);
                
                // Obtener las lecciones actuales del grupo
                const groupSnap = await getDoc(groupRef);
                const currentLessons = groupSnap.exists() && groupSnap.data().assignedLessons 
                    ? groupSnap.data().assignedLessons 
                    : [];
                
                // Combinar sin duplicados
                const updatedLessons = [...new Set([...currentLessons, ...selectedLessonIds])];
                
                // Actualizar en Firestore
                await updateDoc(groupRef, {
                    assignedLessons: updatedLessons,
                    lastModified: new Date()
                });
                
                console.log('‚úÖ Lecciones asignadas correctamente');
                showNotification('success', `‚úÖ ${selectedLessonIds.length} lecci√≥n(es) asignada(s) al grupo`);
                
                // Recargar las lecciones asignadas en la pesta√±a
                await loadAssignedLessons(currentGroupId);
                
                // Cerrar modal
                closeAssignLessonModal();
                
            } catch (error) {
                console.error('‚ùå Error asignando lecciones:', error);
                showNotification('error', `‚ùå Error al asignar: ${error.message}`);
            }
        }
        
        async function loadAssignedLessons(groupId) {
            console.log('üìö Cargando lecciones asignadas del grupo:', groupId);
            
            const container = document.getElementById('groupLessonsList');
            if (!container) {
                console.warn('‚ö†Ô∏è Container groupLessonsList no encontrado');
                return;
            }
            
            try {
                const groupRef = doc(window.db, 'groups', groupId);
                const groupSnap = await getDoc(groupRef);
                
                if (!groupSnap.exists()) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Grupo no encontrado</p>';
                    return;
                }
                
                const assignedLessonIds = groupSnap.data().assignedLessons || [];
                
                if (assignedLessonIds.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <p class="text-gray-500 font-medium">No hay lecciones asignadas a√∫n</p>
                            <p class="text-gray-400 text-sm mt-2">Usa el bot√≥n "Asignar Lecci√≥n" para agregar contenido al grupo</p>
                        </div>
                    `;
                    return;
                }
                
                // Filtrar lecciones v√°lidas del cat√°logo
                const assignedLessons = availableLessons.filter(lesson => 
                    assignedLessonIds.includes(lesson.id)
                );
                
                container.innerHTML = assignedLessons.map(lesson => {
                    const difficultyColors = {
                        'Principiante': 'bg-green-100 text-green-700 border-green-200',
                        'Intermedio': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                        'Avanzado': 'bg-red-100 text-red-700 border-red-200'
                    };
                    
                    return `
                        <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 text-lg">${lesson.title}</h4>
                                        <span class="inline-block px-2 py-1 text-xs font-medium rounded-full border ${difficultyColors[lesson.difficulty] || 'bg-gray-100 text-gray-700'}">
                                            ${lesson.difficulty}
                                        </span>
                                    </div>
                                </div>
                                <button 
                                    onclick="unassignLesson('${groupId}', '${lesson.id}')"
                                    class="text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg p-2 transition"
                                    title="Desasignar lecci√≥n">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-gray-600 mb-4">${lesson.description}</p>
                            <div class="flex items-center justify-between text-sm text-gray-500">
                                <span class="flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    ${lesson.duration}
                                </span>
                                <div class="flex gap-1">
                                    ${lesson.topics.map(topic => `
                                        <span class="px-2 py-1 bg-gray-100 rounded text-xs">${topic}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log(`‚úÖ ${assignedLessons.length} lecciones cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando lecciones asignadas:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">Error al cargar lecciones</p>';
            }
        }
        
        async function unassignLesson(groupId, lessonId) {
            if (!confirm('¬øDeseas desasignar esta lecci√≥n del grupo?')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Desasignando lecci√≥n:', lessonId);
                
                const groupRef = doc(window.db, 'groups', groupId);
                const groupSnap = await getDoc(groupRef);
                
                if (!groupSnap.exists()) {
                    showNotification('error', '‚ùå Grupo no encontrado');
                    return;
                }
                
                const currentLessons = groupSnap.data().assignedLessons || [];
                const updatedLessons = currentLessons.filter(id => id !== lessonId);
                
                await updateDoc(groupRef, {
                    assignedLessons: updatedLessons,
                    lastModified: new Date()
                });
                
                console.log('‚úÖ Lecci√≥n desasignada');
                showNotification('success', '‚úÖ Lecci√≥n desasignada correctamente');
                
                // Recargar lista
                await loadAssignedLessons(groupId);
                
            } catch (error) {
                console.error('‚ùå Error desasignando lecci√≥n:', error);
                showNotification('error', `‚ùå Error: ${error.message}`);
            }
        }
        
        function closeAssignLessonModal() {
            const modal = document.getElementById('assignLessonModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Limpiar b√∫squeda
            const searchInput = document.getElementById('searchLessons');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Resetear selecci√≥n
            selectedLessonIds = [];
            updateSelectedCount();
        }
        
        // Exponer funciones globalmente
        window.openAssignLessonModal = openAssignLessonModal;
        window.toggleLessonSelection = toggleLessonSelection;
        window.unassignLesson = unassignLesson;
        window.loadAssignedLessons = loadAssignedLessons;
        
    // Exponer funciones del chat para uso inline/fallback
    window.showNewChatModal = showNewChatModal;
    window.openChat = openChat;


        // Chats
        // ========== CHAT EN TIEMPO REAL CON FIRESTORE ==========
        let activeChat = null;
        let chatUnsubscribe = null;
        
        async function initChats() {
            console.log('üí¨ Inicializando chat...');
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) {
                console.error('‚ùå No hay usuario en initChats');
                return;
            }
            
            console.log('‚úÖ Usuario detectado:', user.uid, user.displayName);
            
            // Cargar conversaciones del usuario
            await loadConversations(user.uid);
            
            // Bot√≥n para nuevo chat
            const newChatBtn = document.getElementById('newChatBtn');
            if (newChatBtn) {
                newChatBtn.onclick = () => showNewChatModal();
                console.log('‚úÖ Bot√≥n nuevo chat configurado');
            }
            
            // Enviar mensaje
            const sendBtn = document.getElementById('chatSendBtn');
            const input = document.getElementById('chatMessageInput');
            
            if (sendBtn) {
                sendBtn.onclick = () => sendMessage();
            }
            
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            console.log('‚úÖ Chat inicializado completamente');
        }
        
        async function loadConversations(userId) {
            console.log('üìã Cargando conversaciones para:', userId);
            
            const conversationsEl = document.getElementById('chatConversations');
            if (!conversationsEl) {
                console.error('‚ùå No se encontr√≥ #chatConversations');
                return;
            }
            
            conversationsEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Cargando...</div>';
            
            try {
                if (!window.db) {
                    throw new Error('window.db no est√° definido');
                }
                
                // Buscar chats donde el usuario sea participante
                const chatsRef = collection(window.db, 'chats');
                const q = query(chatsRef, where('participants', 'array-contains', userId));
                const snapshot = await getDocs(q);
                
                console.log('üìä Chats encontrados:', snapshot.size);
                
                if (snapshot.empty) {
                    conversationsEl.innerHTML = `
                        <div class="p-6 text-center">
                            <div class="text-4xl mb-2">
                                <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-400 text-sm mb-3">No hay conversaciones</p>
                            <button onclick="showNewChatModal && showNewChatModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium flex items-center justify-center gap-2 mx-auto">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                </svg>
                                <span>Iniciar Chat</span>
                            </button>
                        </div>
                    `;
                    return;
                }
                
                conversationsEl.innerHTML = '';
                const conversations = [];
                let deletedUsersCount = 0;
                
                console.log('üîÑ Procesando', snapshot.size, 'conversaciones...');
                
                for (const chatDoc of snapshot.docs) {
                    const chatData = chatDoc.data();
                    const otherUserId = chatData.participants.find(p => p !== userId);
                    
                    if (!otherUserId) continue;
                    
                    // ‚úÖ PASO CR√çTICO: Validaci√≥n de Existencia
                    // Solo incluir contactos cuyo usuario existe en la base de datos
                    const otherUserDoc = await getDoc(doc(window.db, 'users', otherUserId));
                    
                    // ‚ùå FILTRO: Si el usuario NO existe, descartar esta conversaci√≥n
                    if (!otherUserDoc.exists()) {
                        deletedUsersCount++;
                        console.warn(`‚ö†Ô∏è Usuario eliminado encontrado: ${otherUserId} - Conversaci√≥n filtrada`);
                        continue; // Saltar esta conversaci√≥n
                    }
                    
                    // ‚úÖ Usuario existe: obtener datos y agregar a la lista
                    const otherUser = otherUserDoc.data();
                    
                    conversations.push({
                        chatId: chatDoc.id,
                        otherUser: {
                            uid: otherUserId,
                            name: otherUser.displayName || 'Usuario',
                            photoURL: otherUser.photoURL,
                            role: otherUser.rol || 'estudiante'
                        },
                        lastMessage: chatData.lastMessage || '',
                        updatedAt: chatData.updatedAt
                    });
                }
                
                // Log de diagn√≥stico
                if (deletedUsersCount > 0) {
                    console.log(`üßπ Referencias hu√©rfanas filtradas: ${deletedUsersCount} usuario(s) eliminado(s)`);
                }
                
                console.log('‚úÖ Conversaciones procesadas:', conversations.length);
                
                // Ordenar por m√°s reciente
                conversations.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
                
                // Renderizar
                conversations.forEach(conv => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 px-3 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 transition';
                    div.innerHTML = `
                        <img src="${conv.otherUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(conv.otherUser.name)}&background=667eea&color=fff`}" 
                             class="w-10 h-10 rounded-full">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-semibold text-gray-800 truncate">${conv.otherUser.name}</div>
                            <div class="text-xs text-gray-500 truncate">${conv.lastMessage || 'Nuevo chat'}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(conv.chatId, conv.otherUser);
                    conversationsEl.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error cargando conversaciones:', error);
                conversationsEl.innerHTML = `
                    <div class="p-4 text-center">
                        <div class="text-red-500 text-sm mb-2">Error al cargar</div>
                        <button onclick="location.reload()" class="btn btn-sm bg-gray-300 hover:bg-gray-400 text-xs">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        async function openChat(chatId, otherUser) {
            console.log('üìñ Abriendo chat:', chatId, 'con', otherUser.name);
            
            activeChat = { chatId, otherUser };
            
            // Mostrar header y √°rea de input
            const chatHeader = document.getElementById('chatHeader');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatMessagesArea = document.getElementById('chatMessagesArea');
            
            if (chatHeader) chatHeader.classList.remove('hidden');
            if (chatInputArea) chatInputArea.classList.remove('hidden');
            
            // Actualizar header con info del destinatario
            if (chatHeader) {
                chatHeader.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${otherUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.name)}&background=667eea&color=fff`}" 
                             class="w-10 h-10 rounded-full border-2 border-white shadow">
                        <div>
                            <div class="font-semibold text-gray-800">${otherUser.name}</div>
                            <div class="text-xs text-gray-500">${otherUser.role === 'profesor' ? 'Profesor' : 'Estudiante'}</div>
                        </div>
                    </div>
                `;
            }
            
            // Limpiar listener anterior
            if (chatUnsubscribe) {
                chatUnsubscribe();
            }
            
            // Escuchar mensajes en tiempo real
            const messagesRef = collection(window.db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                console.log('üì® Mensajes actualizados:', snapshot.size);
                
                if (!chatMessagesArea) return;
                
                chatMessagesArea.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessagesArea.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-gray-400">
                                <div class="text-4xl mb-2">
                                    <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                    </svg>
                                </div>
                                <p class="text-sm">Env√≠a tu primer mensaje</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === (window.currentUser?.uid || window.auth?.currentUser?.uid);
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
                    msgDiv.innerHTML = `
                        <div class="${isMe ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'} rounded-2xl px-4 py-2 max-w-xs shadow-sm">
                            <p class="text-sm whitespace-pre-wrap break-words">${escapeHtml(msg.text)}</p>
                            <p class="text-xs mt-1 ${isMe ? 'text-indigo-200' : 'text-gray-500'}">
                                ${msg.timestamp ? formatTime(msg.timestamp.toDate()) : 'Enviando...'}
                            </p>
                        </div>
                    `;
                    chatMessagesArea.appendChild(msgDiv);
                });
                
                // Scroll al final
                scrollChatToBottom();
            });
        }
        
        function scrollChatToBottom() {
            const messagesArea = document.getElementById('chatMessagesArea');
            if (messagesArea) {
                setTimeout(() => {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);
            }
        }
        
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Ahora';
            if (minutes < 60) return `${minutes}m`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}h`;
            
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function sendMessage() {
            console.log('üì§ Intentando enviar mensaje...');
            
            if (!activeChat) {
                console.error('‚ùå No hay chat activo');
                return;
            }
            
            const input = document.getElementById('chatMessageInput');
            if (!input) {
                console.error('‚ùå No se encontr√≥ el input');
                return;
            }
            
            const text = input.value.trim();
            if (!text) return;
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) {
                console.error('‚ùå No hay usuario');
                return;
            }
            
            console.log('üíæ Guardando mensaje en Firestore...');
            const sendBtn = document.getElementById('chatSendBtn');
            if (sendBtn) sendBtn.disabled = true;

            // Optimistic UI
            const messagesArea = document.getElementById('chatMessagesArea');
            const tempId = 'temp-' + Date.now();
            const optimisticDiv = document.createElement('div');
            optimisticDiv.id = tempId;
            optimisticDiv.className = 'flex justify-end mb-3 opacity-70';
            optimisticDiv.innerHTML = `
                <div class="bg-indigo-300 text-white rounded-2xl px-4 py-2 max-w-xs shadow-sm">
                    <p class="text-sm whitespace-pre-wrap break-words">${escapeHtml(text)}</p>
                    <p class="text-xs mt-1 text-indigo-100">Enviando...</p>
                </div>
            `;
            messagesArea.appendChild(optimisticDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            try {
                // Agregar mensaje a la subcolecci√≥n
                const messagesRef = collection(window.db, 'chats', activeChat.chatId, 'messages');
                console.log('üõ∞Ô∏è Payload:', { chatId: activeChat.chatId, text, sender: user.uid });
                
                await addDoc(messagesRef, {
                    text,
                    senderId: user.uid,
                    timestamp: serverTimestamp()
                });
                
                console.log('‚úÖ Mensaje guardado');
                
                // Actualizar √∫ltimo mensaje en el chat
                await updateDoc(doc(window.db, 'chats', activeChat.chatId), {
                    lastMessage: text,
                    updatedAt: serverTimestamp()
                });
                
                console.log('‚úÖ Chat actualizado');
                
                // Reemplazar estado optimista; lo real vendr√° por snapshot
                input.value = '';
                input.focus();
                setTimeout(()=>{
                    const el = document.getElementById(tempId);
                    if (el) el.remove();
                }, 200); // se espera al snapshot real
                
                if (sendBtn) sendBtn.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error enviando mensaje:', error);
                const el = document.getElementById(tempId);
                if (el) {
                    el.querySelector('p.text-xs').textContent = 'Error';
                    el.classList.remove('opacity-70');
                    el.classList.add('opacity-100');
                    el.firstElementChild.classList.remove('bg-indigo-300');
                    el.firstElementChild.classList.add('bg-red-500');
                }
                if (sendBtn) sendBtn.disabled = false;
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo enviar el mensaje: ' + error.message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            }
        }
        
        async function showNewChatModal() {
               console.log('üîç Abriendo modal de nuevo chat...');
           
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
           
               if (typeof Swal === 'undefined') {
                   console.error('‚ùå SweetAlert2 no est√° cargado, usando fallback con prompt');
                   const term = prompt('Escribe el nombre del usuario para chatear:');
                   if (!term) return;
                   try {
                       const usersRef = collection(window.db, 'users');
                       const snapshot = await getDocs(usersRef);
                       let foundUser = null;
                       snapshot.forEach(docSnap => {
                           const data = docSnap.data();
                           if (docSnap.id !== user.uid && (data.displayName || '').toLowerCase().includes(term.toLowerCase())) {
                               foundUser = { uid: docSnap.id, name: data.displayName || 'Usuario', photoURL: data.photoURL, role: data.rol || 'estudiante' };
                           }
                       });
                       if (!foundUser) { alert('No se encontr√≥ usuario'); return; }
                       const chatId = await getOrCreateChat(user.uid, foundUser.uid);
                       openChat(chatId, foundUser);
                       await loadConversations(user.uid);
                   } catch (e) {
                       alert('Error creando chat: ' + e.message);
                   }
                   return;
               }
            
            const result = await Swal.fire({
                title: 'üí¨ Nuevo Chat',
                html: `
                    <div class="text-left">
                        <input id="searchUserInput" type="text" placeholder="Buscar usuario..." 
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-3">
                        <div id="userSearchResults" class="max-h-60 overflow-y-auto"></div>
                    </div>
                `,
                showCancelButton: false,
                showConfirmButton: false,
                width: '500px',
                didOpen: () => {
                    const input = document.getElementById('searchUserInput');
                    const resultsDiv = document.getElementById('userSearchResults');
                    let searchTimeout;
                    
                    resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe para buscar usuarios...</p>';
                    
                    input.addEventListener('input', async (e) => {
                        clearTimeout(searchTimeout);
                        const searchTerm = e.target.value.trim().toLowerCase();
                        
                        if (searchTerm.length < 2) {
                            resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe al menos 2 letras...</p>';
                            return;
                        }
                        
                        searchTimeout = setTimeout(async () => {
                            resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">üîç Buscando...</p>';
                            
                            try {
                                const usersRef = collection(window.db, 'users');
                                const snapshot = await getDocs(usersRef);
                                
                                const matches = [];
                                snapshot.forEach(docSnap => {
                                    const userData = docSnap.data();
                                    // Construir nombre completo desde Firestore
                                    const fullName = userData.displayName || 
                                                    (userData.nombre ? `${userData.nombre} ${userData.apellidoPaterno || ''} ${userData.apellidoMaterno || ''}`.trim() : '');
                                    const userName = fullName.toLowerCase();
                                    
                                    if (docSnap.id !== user.uid && userName.includes(searchTerm)) {
                                        matches.push({
                                            uid: docSnap.id,
                                            name: fullName || 'Usuario',
                                            photoURL: userData.photoURL,
                                            role: userData.rol || 'estudiante'
                                        });
                                    }
                                });
                                
                                if (matches.length === 0) {
                                    resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">üòï No se encontraron usuarios</p>';
                                    return;
                                }
                                
                                resultsDiv.innerHTML = matches.map(foundUser => `
                                    <div class="flex items-center gap-3 p-3 hover:bg-indigo-50 rounded-lg cursor-pointer transition user-result" data-uid="${foundUser.uid}">
                                        <img src="${foundUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(foundUser.name)}&background=667eea&color=fff`}" 
                                             class="w-10 h-10 rounded-full border-2 border-white shadow">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${foundUser.name}</div>
                                            <div class="text-xs text-gray-500">${foundUser.role === 'profesor' ? 'Profesor' : 'Estudiante'}</div>
                                        </div>
                                        <div class="text-indigo-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                `).join('');
                                
                                // Click en resultado
                                document.querySelectorAll('.user-result').forEach(el => {
                                    el.addEventListener('click', async () => {
                                        const selectedUid = el.dataset.uid;
                                        const selectedUser = matches.find(u => u.uid === selectedUid);
                                        
                                        Swal.close();
                                        
                                        Swal.fire({
                                            title: 'Abriendo chat...',
                                            text: 'Por favor espera',
                                            allowOutsideClick: false,
                                            showConfirmButton: false,
                                            willOpen: () => Swal.showLoading()
                                        });
                                        
                                        try {
                                            const chatId = await getOrCreateChat(user.uid, selectedUid);
                                            openChat(chatId, selectedUser);
                                            await loadConversations(user.uid);
                                            Swal.close();
                                        } catch (error) {
                                            Swal.fire('Error', 'No se pudo abrir el chat', 'error');
                                        }
                                    });
                                });
                                
                            } catch (error) {
                                console.error('Error buscando usuarios:', error);
                                resultsDiv.innerHTML = '<p class="text-sm text-red-500 text-center py-4">‚ùå Error en la b√∫squeda</p>';
                            }
                        }, 400);
                    });
                    
                    input.focus();
                }
            });
        }
        
        async function getOrCreateChat(userId1, userId2) {
            // Buscar chat existente
            const chatsRef = collection(window.db, 'chats');
            const q = query(chatsRef, where('participants', 'array-contains', userId1));
            const snapshot = await getDocs(q);
            
            let existingChatId = null;
            snapshot.forEach(chatDoc => {
                const participants = chatDoc.data().participants;
                if (participants.includes(userId2)) {
                    existingChatId = chatDoc.id;
                }
            });
            
            if (existingChatId) return existingChatId;
            
            // Crear nuevo chat
            const newChat = await addDoc(chatsRef, {
                participants: [userId1, userId2],
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: ''
            });
            
            return newChat.id;
        }

        // Racha
        // ========== RACHA VISUAL - ESTILO GITHUB ==========
        async function initRacha() {
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            renderStreakCalendar(user.uid);
        }
        
        async function renderStreakCalendar(userId) {
            const cal = document.getElementById('streakCalendar');
            const maxEl = document.getElementById('maxStreak');
            
            try {
                // Obtener datos del usuario
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const loginDates = userData.loginDates || [];
                const loginSet = new Set(loginDates.map(d => {
                    if (typeof d === 'string') return d;
                    if (d?.toDate) return d.toDate().toDateString();
                    return new Date(d).toDateString();
                }));
                
                // Calcular racha actual
                let currentStreak = 0;
                let maxStreak = 0;
                let tempStreak = 0;
                const today = new Date();
                
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    
                    if (loginSet.has(checkDate.toDateString())) {
                        tempStreak++;
                        if (i === 0 || i === 1) currentStreak++; // Los √∫ltimos 2 d√≠as cuentan para racha actual
                    } else {
                        if (tempStreak > maxStreak) maxStreak = tempStreak;
                        tempStreak = 0;
                        if (i > 1) break; // Si hace m√°s de 1 d√≠a que no se conecta, la racha se rompe
                    }
                }
                
                if (tempStreak > maxStreak) maxStreak = tempStreak;
                
                // Renderizar calendario de 7 d√≠as (estilo GitHub)
                cal.innerHTML = '';
                cal.className = 'grid grid-cols-7 gap-2';
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const ds = d.toDateString();
                    const hasActivity = loginSet.has(ds);
                    
                    const div = document.createElement('div');
                    div.className = `aspect-square rounded-lg border-2 flex flex-col items-center justify-center text-xs font-semibold transition-all hover:scale-110 ${
                        hasActivity 
                            ? 'bg-gradient-to-br from-green-400 to-green-600 border-green-700 text-white shadow-lg' 
                            : 'bg-gray-50 border-gray-200 text-gray-400'
                    }`;
                    div.title = d.toLocaleDateString('es-MX', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    const dayName = d.toLocaleDateString('es-MX', { weekday: 'short' }).replace('.', '').toUpperCase();
                    const dayNum = d.getDate();
                    
                    div.innerHTML = `
                        <div class="text-[10px]">${dayName}</div>
                        <div class="text-lg font-bold">${dayNum}</div>
                        ${hasActivity ? '<div class="text-[8px]">‚úì</div>' : ''}
                    `;
                    
                    cal.appendChild(div);
                }
                
                // Mostrar racha m√°xima
                maxEl.textContent = maxStreak;
                
                // Actualizar racha en el header
                const streakEl = document.getElementById('userStreak');
                if (streakEl) {
                    streakEl.textContent = currentStreak > 0 ? `üî• ${currentStreak}` : '0';
                }
                
            } catch (error) {
                console.error('Error cargando racha:', error);
                cal.innerHTML = '<div class="col-span-7 text-center text-red-500 text-sm">Error al cargar racha</div>';
            }
        }

        // Calificaciones
        function initCalificaciones(){
            console.log('üìä Inicializando secci√≥n de calificaciones');
            // Esta secci√≥n est√° enlazada a profesor-calificaciones.html
        }

        // Estad√≠sticas
        function initEstadisticas(){
            console.log('üìà Inicializando secci√≥n de estad√≠sticas');
            loadProfessorStats();
        }

        async function loadProfessorStats(){
            try {
                const user = window.currentUser || window.auth?.currentUser;
                if (!user) return;
                
                // Aqu√≠ cargar√≠as las estad√≠sticas reales desde Firestore
                // Por ahora mostramos datos de ejemplo
                document.getElementById('subjectAverages').innerHTML = `
                    <div class="flex justify-between"><span>Python</span><span class="font-bold text-indigo-600">8.5</span></div>
                    <div class="flex justify-between"><span>JavaScript</span><span class="font-bold text-indigo-600">9.0</span></div>
                    <div class="flex justify-between"><span>HTML/CSS</span><span class="font-bold text-indigo-600">8.8</span></div>
                `;
                
                document.getElementById('topStudents').innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>ü•á</span>
                        <span class="flex-1">Mar√≠a L√≥pez</span>
                        <span class="font-bold text-green-600">9.5</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>ü•à</span>
                        <span class="flex-1">Juan P√©rez</span>
                        <span class="font-bold text-green-600">9.2</span>
                    </div>
                `;
                
                document.getElementById('studentsAtRisk').innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                        <span class="flex-1">Carlos G√≥mez</span>
                        <span class="text-red-600 text-xs">6.0</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        // ========== GESTI√ìN DE TAREAS ==========
        let currentTaskId = null;
        let currentTaskData = null;
        
        async function initTareas() {
            console.log('üìù Inicializando gesti√≥n de tareas');
            
            // Event listeners para botones
            document.getElementById('btnCreateTask')?.addEventListener('click', () => openTaskModal());
            document.getElementById('closeTaskModal')?.addEventListener('click', () => closeTaskModal());
            document.getElementById('cancelTaskModal')?.addEventListener('click', () => closeTaskModal());
            document.getElementById('taskForm')?.addEventListener('submit', handleTaskSubmit);
            
            document.getElementById('closeTaskDetailModal')?.addEventListener('click', () => closeTaskDetailModal());
            document.getElementById('btnEditTask')?.addEventListener('click', () => editCurrentTask());
            document.getElementById('btnDeleteTask')?.addEventListener('click', () => deleteCurrentTask());
            
            document.getElementById('closeGradeModal')?.addEventListener('click', () => closeGradeModal());
            document.getElementById('cancelGrade')?.addEventListener('click', () => closeGradeModal());
            document.getElementById('gradeForm')?.addEventListener('submit', handleGradeSubmit);
            
            // Filtros
            document.querySelectorAll('input[name="taskFilter"]').forEach(radio => {
                radio.addEventListener('change', () => loadTeacherTasks());
            });
            
            // Cargar tareas del profesor
            await loadTeacherTasks();
        }
        
        async function loadTeacherTasks() {
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            try {
                const filter = document.querySelector('input[name="taskFilter"]:checked')?.value || 'all';
                const now = new Date();
                
                const tasksRef = collection(window.db, 'tasks');
                const q = query(tasksRef, where('teacherId', '==', user.uid));
                const snapshot = await getDocs(q);
                
                const container = document.getElementById('tasksList');
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <div class="text-6xl mb-4">üìù</div>
                            <p class="text-lg mb-2">No has creado tareas a√∫n</p>
                            <p class="text-sm">Crea tu primera tarea para asignar a tus grupos</p>
                        </div>
                    `;
                    return;
                }
                
                let filteredTasks = [];
                
                for (const doc of snapshot.docs) {
                    const task = doc.data();
                    const dueDate = task.dueDate?.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
                    const isPending = dueDate >= now;
                    
                    // Aplicar filtro
                    if (filter === 'pending' && !isPending) continue;
                    if (filter === 'past' && isPending) continue;
                    
                    filteredTasks.push({ id: doc.id, ...task, dueDate });
                }
                
                // Ordenar manualmente por fecha
                filteredTasks.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return dateB - dateA;
                });
                
                if (filteredTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <p>No hay tareas en esta categor√≠a</p>
                        </div>
                    `;
                    return;
                }
                
                for (const task of filteredTasks) {
                    const taskCard = await createTaskCard(task.id, task);
                    container.insertAdjacentHTML('beforeend', taskCard);
                }
                
                // Event listeners
                container.querySelectorAll('.task-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const taskId = card.dataset.taskId;
                        openTaskDetail(taskId);
                    });
                });
            } catch (error) {
                console.error('Error cargando tareas:', error);
            }
        }
        
        async function createTaskCard(taskId, task) {
            const now = new Date();
            const dueDate = task.dueDate instanceof Date ? task.dueDate : new Date(task.dueDate);
            const isPast = dueDate < now;
            const dueDateStr = dueDate.toLocaleDateString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            // Obtener informaci√≥n del grupo
            let groupName = 'Sin grupo';
            if (task.groupId) {
                try {
                    const groupDoc = await getDoc(doc(window.db, 'groups', task.groupId));
                    if (groupDoc.exists()) {
                        groupName = groupDoc.data().name;
                    }
                } catch (error) {
                    console.error('Error obteniendo grupo:', error);
                }
            }
            
            // Contar entregas
            let submissionsCount = 0;
            try {
                const submissionsRef = collection(window.db, 'tasks', taskId, 'submissions');
                const submissionsSnapshot = await getDocs(submissionsRef);
                submissionsCount = submissionsSnapshot.size;
            } catch (error) {
                console.error('Error contando entregas:', error);
            }
            
            return `
                <div class="task-card card hover-lift cursor-pointer transition-all ${isPast ? 'opacity-75' : ''}" data-task-id="${taskId}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${task.title}</h3>
                            <p class="text-sm text-gray-600 line-clamp-2">${task.description}</p>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${isPast ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-700'}">
                            ${isPast ? 'Vencida' : 'Activa'}
                        </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <span>${groupName}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Vence: ${dueDateStr}</span>
                        </div>
                        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                            <span class="text-indigo-600 font-semibold">${task.maxPoints || 100} pts</span>
                            <span class="text-gray-500">${submissionsCount} entrega${submissionsCount !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function openTaskModal(taskId = null) {
            currentTaskId = taskId;
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            
            if (taskId) {
                document.getElementById('taskModalTitle').textContent = 'Editar Tarea';
                document.getElementById('taskSubmitText').textContent = 'Guardar Cambios';
                loadTaskDataToForm(taskId);
            } else {
                document.getElementById('taskModalTitle').textContent = 'Crear Nueva Tarea';
                document.getElementById('taskSubmitText').textContent = 'Crear Tarea';
                form.reset();
                loadGroupsForSelect();
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('taskForm').reset();
            currentTaskId = null;
        }
        
        async function loadGroupsForSelect() {
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            const select = document.getElementById('taskGroup');
            select.innerHTML = '<option value="">Cargando grupos...</option>';
            
            try {
                const groupsRef = collection(window.db, 'groups');
                const q = query(groupsRef, where('teacherId', '==', user.uid));
                const snapshot = await getDocs(q);
                
                select.innerHTML = '<option value="">Selecciona un grupo</option>';
                
                snapshot.forEach(doc => {
                    const group = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${group.name} - ${group.subject}`;
                    select.appendChild(option);
                });
                
                if (snapshot.empty) {
                    select.innerHTML = '<option value="">No tienes grupos creados</option>';
                }
            } catch (error) {
                console.error('Error cargando grupos:', error);
                select.innerHTML = '<option value="">Error cargando grupos</option>';
            }
        }
        
        async function handleTaskSubmit(e) {
            e.preventDefault();
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            const taskData = {
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                instructions: document.getElementById('taskInstructions').value.trim(),
                dueDate: new Date(document.getElementById('taskDueDate').value),
                maxPoints: parseInt(document.getElementById('taskMaxPoints').value) || 100,
                groupId: document.getElementById('taskGroup').value,
                teacherId: user.uid,
                updatedAt: new Date()
            };
            
            if (!taskData.groupId) {
                alert('Debes seleccionar un grupo');
                return;
            }
            
            try {
                if (currentTaskId) {
                    // Actualizar tarea existente
                    await updateDoc(doc(window.db, 'tasks', currentTaskId), taskData);
                    alert('‚úÖ Tarea actualizada correctamente');
                } else {
                    // Crear nueva tarea
                    taskData.createdAt = new Date();
                    await addDoc(collection(window.db, 'tasks'), taskData);
                    alert('‚úÖ Tarea creada correctamente');
                }
                
                closeTaskModal();
                await loadTeacherTasks();
            } catch (error) {
                console.error('Error guardando tarea:', error);
                alert('‚ùå Error al guardar la tarea');
            }
        }
        
        async function openTaskDetail(taskId) {
            currentTaskId = taskId;
            
            try {
                const taskDoc = await getDoc(doc(window.db, 'tasks', taskId));
                if (!taskDoc.exists()) return;
                
                const task = taskDoc.data();
                currentTaskData = task;
                
                // Obtener nombre del grupo
                let groupName = 'Sin grupo';
                if (task.groupId) {
                    const groupDoc = await getDoc(doc(window.db, 'groups', task.groupId));
                    if (groupDoc.exists()) {
                        groupName = groupDoc.data().name;
                    }
                }
                
                const dueDate = task.dueDate?.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
                
                // Actualizar informaci√≥n
                document.getElementById('taskDetailTitle').textContent = task.title;
                document.getElementById('taskDetailDescription').textContent = task.description;
                document.getElementById('taskDetailInstructions').textContent = task.instructions || 'Sin instrucciones adicionales';
                document.getElementById('taskDetailGroup').textContent = groupName;
                document.getElementById('taskDetailDueDate').textContent = dueDate.toLocaleDateString('es-MX', { 
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                document.getElementById('taskDetailPoints').textContent = task.maxPoints || 100;
                
                // Cargar entregas
                await loadTaskSubmissions(taskId);
                
                // Mostrar modal
                document.getElementById('taskDetailModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error cargando detalle de tarea:', error);
            }
        }
        
        function closeTaskDetailModal() {
            document.getElementById('taskDetailModal').classList.add('hidden');
            currentTaskId = null;
            currentTaskData = null;
        }
        
        async function loadTaskSubmissions(taskId) {
            const container = document.getElementById('submissionsList');
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando entregas...</p>';
            
            try {
                const submissionsRef = collection(window.db, 'tasks', taskId, 'submissions');
                const snapshot = await getDocs(submissionsRef);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay entregas a√∫n</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                for (const subDoc of snapshot.docs) {
                    const submission = subDoc.data();
                    const studentId = subDoc.id;
                    
                    // Obtener datos del estudiante
                    const studentDoc = await getDoc(doc(window.db, 'users', studentId));
                    const student = studentDoc.exists() ? studentDoc.data() : {};
                    
                    const submittedDate = submission.submittedAt?.toDate ? 
                        submission.submittedAt.toDate().toLocaleDateString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 
                        'Fecha desconocida';
                    
                    const statusColor = submission.status === 'graded' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                    const statusText = submission.status === 'graded' ? 'Calificada' : 'Pendiente';
                    
                    const submissionCard = `
                        <div class="flex items-start justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                            <div class="flex items-start gap-3 flex-1">
                                <img src="${student.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.displayName || 'Estudiante')}&background=667eea&color=fff`}" 
                                     class="w-12 h-12 rounded-full">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${student.displayName || student.email}</div>
                                    <div class="text-xs text-gray-500">Entregado: ${submittedDate}</div>
                                    ${submission.attachmentUrl ? `
                                        <a href="${submission.attachmentUrl}" target="_blank" class="text-xs text-indigo-600 hover:underline flex items-center gap-1 mt-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                            </svg>
                                            Ver archivo adjunto
                                        </a>
                                    ` : ''}
                                    ${submission.grade !== undefined ? `
                                        <div class="mt-2">
                                            <span class="text-sm font-semibold text-indigo-600">${submission.grade}/${currentTaskData.maxPoints || 100} pts</span>
                                            ${submission.feedback ? `<p class="text-xs text-gray-600 mt-1">${submission.feedback}</p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                    ${statusText}
                                </span>
                                ${submission.status !== 'graded' ? `
                                    <button onclick="openGradeModal('${studentId}')" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                        Calificar
                                    </button>
                                ` : `
                                    <button onclick="openGradeModal('${studentId}')" class="text-gray-600 hover:text-gray-800 text-sm">
                                        Editar
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', submissionCard);
                }
            } catch (error) {
                console.error('Error cargando entregas:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar entregas</p>';
            }
        }
        
        window.openGradeModal = async function(studentId) {
            try {
                const submissionDoc = await getDoc(doc(window.db, 'tasks', currentTaskId, 'submissions', studentId));
                if (!submissionDoc.exists()) return;
                
                const submission = submissionDoc.data();
                const studentDoc = await getDoc(doc(window.db, 'users', studentId));
                const student = studentDoc.exists() ? studentDoc.data() : {};
                
                document.getElementById('gradeStudentName').textContent = student.displayName || student.email;
                document.getElementById('gradeMaxPoints').textContent = currentTaskData.maxPoints || 100;
                document.getElementById('gradePoints').value = submission.grade || '';
                document.getElementById('gradeFeedback').value = submission.feedback || '';
                document.getElementById('gradeStudentId').value = studentId;
                
                document.getElementById('gradeSubmissionModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error abriendo modal de calificaci√≥n:', error);
            }
        };
        
        function closeGradeModal() {
            document.getElementById('gradeSubmissionModal').classList.add('hidden');
            document.getElementById('gradeForm').reset();
        }
        
        async function handleGradeSubmit(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('gradeStudentId').value;
            const grade = parseInt(document.getElementById('gradePoints').value);
            const feedback = document.getElementById('gradeFeedback').value.trim();
            const maxPoints = currentTaskData.maxPoints || 100;
            
            if (grade < 0 || grade > maxPoints) {
                alert(`La calificaci√≥n debe estar entre 0 y ${maxPoints}`);
                return;
            }
            
            try {
                // Actualizar calificaci√≥n
                await updateDoc(doc(window.db, 'tasks', currentTaskId, 'submissions', studentId), {
                    grade,
                    feedback,
                    status: 'graded',
                    gradedAt: new Date()
                });
                
                // Calcular XP
                const percentage = (grade / maxPoints) * 100;
                let bonusXP = 0;
                if (percentage >= 90) {
                    bonusXP = 30;
                } else if (percentage >= 80) {
                    bonusXP = 20;
                } else if (percentage >= 70) {
                    bonusXP = 10;
                }
                
                const totalXP = 50 + bonusXP; // 50 base por entregar + bonus por calificaci√≥n
                
                // Otorgar XP al estudiante
                const studentRef = doc(window.db, 'users', studentId);
                const studentDoc = await getDoc(studentRef);
                if (studentDoc.exists()) {
                    const currentXP = studentDoc.data().xp || 0;
                    await updateDoc(studentRef, {
                        xp: currentXP + bonusXP // Solo sumar el bonus, el base ya se otorg√≥ al entregar
                    });
                }
                
                // Enviar notificaci√≥n al estudiante
                await addDoc(collection(window.db, 'users', studentId, 'notifications'), {
                    type: 'task_graded',
                    title: '‚úÖ Tarea Calificada',
                    message: `Tu tarea "${currentTaskData.title}" ha sido calificada: ${grade}/${maxPoints} pts${bonusXP > 0 ? ` (+${bonusXP} XP bonus)` : ''}`,
                    taskId: currentTaskId,
                    grade,
                    maxPoints,
                    bonusXP,
                    createdAt: new Date(),
                    read: false
                });
                
                alert(`‚úÖ Calificaci√≥n guardada correctamente. Estudiante gan√≥ +${bonusXP} XP de bonus!`);
                closeGradeModal();
                await loadTaskSubmissions(currentTaskId);
            } catch (error) {
                console.error('Error guardando calificaci√≥n:', error);
                alert('‚ùå Error al guardar la calificaci√≥n');
            }
        }
        
        async function editCurrentTask() {
            closeTaskDetailModal();
            await loadGroupsForSelect();
            openTaskModal(currentTaskId);
        }
        
        async function deleteCurrentTask() {
            if (!confirm('¬øEst√°s seguro de eliminar esta tarea? Se eliminar√°n todas las entregas asociadas.')) return;
            
            try {
                // Eliminar todas las entregas primero
                const submissionsRef = collection(window.db, 'tasks', currentTaskId, 'submissions');
                const submissionsSnapshot = await getDocs(submissionsRef);
                
                const deletePromises = submissionsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                // Eliminar la tarea
                await deleteDoc(doc(window.db, 'tasks', currentTaskId));
                
                alert('‚úÖ Tarea eliminada correctamente');
                closeTaskDetailModal();
                await loadTeacherTasks();
            } catch (error) {
                console.error('Error eliminando tarea:', error);
                alert('‚ùå Error al eliminar la tarea');
            }
        }
        
        async function loadTaskDataToForm(taskId) {
            try {
                const taskDoc = await getDoc(doc(window.db, 'tasks', taskId));
                if (!taskDoc.exists()) return;
                
                const task = taskDoc.data();
                const dueDate = task.dueDate?.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
                
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('taskInstructions').value = task.instructions || '';
                document.getElementById('taskDueDate').value = dueDate.toISOString().slice(0, 16);
                document.getElementById('taskMaxPoints').value = task.maxPoints || 100;
                
                // Cargar grupos y seleccionar el actual
                await loadGroupsForSelect();
                document.getElementById('taskGroup').value = task.groupId;
            } catch (error) {
                console.error('Error cargando datos de tarea:', error);
            }
        }


        // Actividad reciente desde state manager
        function renderRecentActivity(){
            const cont = document.getElementById('recentActivity');
            if (!cont) return;
            const items = window.userState?.state?.activityLog || [];
            if (!items.length){ cont.innerHTML = '<p class="text-gray-500">Sin actividad reciente</p>'; return; }
            cont.innerHTML = items.slice(-10).reverse().map(ev=>{
                const time = new Date(ev.timestamp||Date.now()).toLocaleString('es-MX');
                return `<div class="flex items-start gap-2"><span>‚Ä¢</span><div><p class="text-gray-700">${ev.text||ev.type||'Actividad'}</p><p class="text-[11px] text-gray-400">${time}</p></div></div>`;
            }).join('');
        }
        try { renderRecentActivity(); window.userState?.subscribe(renderRecentActivity); } catch(_){}
    bindAvatarUpload();

    </script>
    
        <!-- Modales: Marcos, Configuraci√≥n, Usuario -->
        <!-- Z-INDEX: 1000 - Modal de Acci√≥n -->
        <div id="framesModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center" style="z-index: 1000;">
                <div class="bg-white rounded-xl p-6 max-w-lg w-[90%] animate-scale-in">
                        <div class="flex items-start justify-between mb-3">
                                <h3 class="text-xl font-bold">Selecciona tu Marco</h3>
                                <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('framesModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Los marcos se desbloquean al subir de nivel. Haz clic en un marco desbloqueado para aplicarlo a tu avatar.</p>
                        <div id="framesGrid" class="grid sm:grid-cols-2 gap-3 text-sm mb-4">
                                <!-- Se llena con JavaScript -->
                        </div>
                        <div class="mt-4 text-right">
                                <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" onclick="document.getElementById('framesModal').classList.add('hidden')">Cerrar</button>
                        </div>
                </div>
        </div>

        <div id="settingsModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
                <div class="bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in">
                        <div class="flex items-start justify-between mb-3">
                                <h3 class="text-xl font-bold">Configuraci√≥n</h3>
                                <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('settingsModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class="space-y-3 text-sm">
                                <label class="flex items-center gap-2">
                                        <input id="toggleDarkMode" type="checkbox" class="form-checkbox" />
                                        <span>Modo Oscuro</span>
                                </label>
                        </div>
                        <div class="mt-4 text-right">
                                <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" onclick="document.getElementById('settingsModal').classList.add('hidden')">Cerrar</button>
                        </div>
                </div>
        </div>

        <div id="userModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center"></div>

        <script>
            // Abrir marcos / settings desde el men√∫
            document.getElementById('openFramesModal')?.addEventListener('click', async ()=>{
                const m = document.getElementById('framesModal'); m.classList.remove('hidden'); m.classList.add('flex');
                document.getElementById('settingsMenu')?.classList.add('hidden');
                await renderFramesGrid();
            });
            
            // Renderizar grid de marcos
            async function renderFramesGrid() {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const nivel = userData.nivel || 1;
                const selectedFrame = userData.selectedFrame || 'none';
                const unlockedFrames = userData.unlockedFrames || [];
                
                const frames = [
                    { id: 'none', name: 'Sin Marco', icon: '‚≠ï', level: 0, class: 'none' },
                    { id: 'marco_bronce', name: 'Marco Bronce', icon: 'ü•â', level: 2, class: 'bronce' },
                    { id: 'marco_plata', name: 'Marco Plata', icon: 'ü•à', level: 5, class: 'plata' },
                    { id: 'marco_oro', name: 'Marco Oro', icon: 'ü•á', level: 8, class: 'oro' },
                    { id: 'marco_diamante', name: 'Marco Diamante', icon: 'üíé', level: 10, class: 'diamante' }
                ];
                
                const grid = document.getElementById('framesGrid');
                grid.innerHTML = frames.map(frame => {
                    const unlocked = nivel >= frame.level || unlockedFrames.includes(frame.id);
                    const isSelected = selectedFrame === frame.id;
                    
                    return `
                        <div 
                            class="p-4 rounded-lg border-2 transition cursor-pointer ${unlocked ? 'hover:bg-indigo-50' : 'opacity-50 cursor-not-allowed'} ${isSelected ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}"
                            onclick="${unlocked ? `selectFrame('${frame.id}', '${frame.class}')` : ''}"
                        >
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">${frame.icon}</div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${frame.name}</div>
                                    <div class="text-xs text-gray-500">${unlocked ? (isSelected ? '‚úì Seleccionado' : 'Click para activar') : `Nivel ${frame.level} requerido`}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Seleccionar marco
            window.selectFrame = async function(frameId, frameClass) {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                try {
                    await updateDoc(doc(window.db, `users/${user.uid}`), {
                        selectedFrame: frameId
                    });
                    
                    // Aplicar el marco al avatar
                    applyFrame(frameClass);
                    
                    // Actualizar el grid
                    await renderFramesGrid();
                    
                    // Cerrar modal
                    setTimeout(() => {
                        document.getElementById('framesModal').classList.add('hidden');
                        document.getElementById('framesModal').classList.remove('flex');
                    }, 300);
                } catch (error) {
                    console.error('Error al seleccionar marco:', error);
                    alert('Error al seleccionar marco');
                }
            };
            
            // Aplicar marco al avatar
            function applyFrame(frameClass) {
                const avatar = document.getElementById('userAvatar');
                if (!avatar) return;
                
                // Remover todas las clases de marco anteriores
                avatar.className = avatar.className.replace(/avatar-frame-\w+/g, '');
                
                // Agregar la nueva clase de marco
                avatar.classList.add(`avatar-frame-${frameClass}`);
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('codekids_selected_frame', frameClass);
            }
            
            // Cargar marco guardado al iniciar
            async function loadSavedFrame() {
                const user = window.auth?.currentUser;
                if (!user) {
                    // Intentar cargar de localStorage temporalmente
                    const savedFrame = localStorage.getItem('codekids_selected_frame');
                    if (savedFrame) {
                        applyFrame(savedFrame);
                    }
                    return;
                }
                
                try {
                    const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const selectedFrame = userData.selectedFrame || 'none';
                        
                        // Mapear ID a clase
                        const frameMap = {
                            'none': 'none',
                            'marco_bronce': 'bronce',
                            'marco_plata': 'plata',
                            'marco_oro': 'oro',
                            'marco_diamante': 'diamante'
                        };
                        
                        const frameClass = frameMap[selectedFrame] || 'none';
                        applyFrame(frameClass);
                    }
                } catch (error) {
                    console.error('Error cargando marco:', error);
                }
            }
            
            document.getElementById('openSettings')?.addEventListener('click', (e)=>{
                e.preventDefault();
                e.stopPropagation();
                // Usar la configuraci√≥n global si est√° disponible
                if (window.openGlobalSettings) { 
                    window.openGlobalSettings(e.currentTarget); 
                } else {
                    alert('Configuraci√≥n no disponible. Por favor recarga la p√°gina.');
                }
                document.getElementById('settingsMenu')?.classList.add('hidden');
            });
            
            // Cerrar sesi√≥n
            document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
                if (window.logout) {
                    window.logout();
                }
            });

            // Modal de usuario para resultados de b√∫squeda
            function openUserModal(userId){
                const data = {
                    prof_alan: { id:'prof_alan', name:'Profesor Alan', role:'Profesor', level:7, avatar:'https://ui-avatars.com/api/?name=Alan&background=6366f1&color=fff' }
                };
                const u = data[userId]; if (!u) return;
                const el = document.getElementById('userModal');
                el.innerHTML = `
                    <div class='bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in'>
                        <div class='flex items-start justify-between mb-3'>
                            <h3 class='text-xl font-bold'>Perfil</h3>
                            <button class='text-gray-500 hover:text-gray-700' onclick="document.getElementById('userModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class='flex items-center gap-3 mb-4'>
                            <img src='${u.avatar}' class='w-12 h-12 rounded-full border'/>
                            <div>
                                <div class='font-semibold'>${u.name}</div>
                                <div class='text-xs text-gray-500'>${u.role} ¬∑ Nivel ${u.level}</div>
                            </div>
                        </div>
                        <div class='text-sm text-gray-600 mb-4'>Mentor en programaci√≥n y ciencias de la computaci√≥n.</div>
                        <div class='text-right'>
                            <button id='btnMsgUser' class='bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700'>Enviar Mensaje</button>
                        </div>
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('btnMsgUser').onclick = ()=>{ document.getElementById('userModal').classList.add('hidden'); window.location.hash = '#chats'; };
            }
            window.openUserModal = openUserModal;
            
            // Modal de usuario con datos reales de Firestore
            function openUserModalReal(user){
                const el = document.getElementById('userModal');
                const roleNames = {
                    'Profesor': 'Profesor',
                    'Estudiante': 'Estudiante',
                    'Admin': 'Administrador'
                };
                const roleName = roleNames[user.role] || user.role;
                
                el.innerHTML = `
                    <div class='bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in'>
                        <div class='flex items-start justify-between mb-3'>
                            <h3 class='text-xl font-bold'>Perfil</h3>
                            <button class='text-gray-500 hover:text-gray-700' onclick="document.getElementById('userModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class='flex items-center gap-3 mb-4'>
                            <img src='${user.avatar}' class='w-16 h-16 rounded-full border-2 border-indigo-200'/>
                            <div>
                                <div class='font-semibold text-lg'>${user.name}</div>
                                <div class='text-sm text-gray-600'>${roleName}</div>
                                <div class='text-xs text-indigo-600 font-semibold mt-1'>Nivel ${user.level} ¬∑ ${user.xp} XP</div>
                            </div>
                        </div>
                        <div class='mb-4'>
                            <div class='flex justify-between text-xs text-gray-500 mb-1'>
                                <span>Progreso al siguiente nivel</span>
                                <span>${Math.min(100, Math.floor((user.xp % 100) / 1))}%</span>
                            </div>
                            <div class='w-full bg-gray-200 rounded-full h-2'>
                                <div class='bg-indigo-600 h-2 rounded-full transition-all' style='width: ${Math.min(100, (user.xp % 100))}%'></div>
                            </div>
                        </div>
                        <div class='text-right'>
                            <button id='btnMsgUser' class='bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition'>Enviar Mensaje</button>
                        </div>
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('btnMsgUser').onclick = ()=>{ 
                    document.getElementById('userModal').classList.add('hidden'); 
                    window.location.hash = '#chats'; 
                };
            }
            window.openUserModalReal = openUserModalReal;
        </script>
        <script src="../js/global-ui.js"></script>
        <script type="module">
            import '../js/firebase-init.js';
            import { initAuth } from '../js/auth.js';
            import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
            import { doc, getDoc, collection, query, where, orderBy, limit, startAfter, getDocs, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
            import { updateGamificationHeader, addXP, loadXPFromFirestore } from '../js/gamification.js';
            
            // Hacer funciones globales
            if (!window.addXP) {
                window.addXP = addXP;
            }
            if (!window.loadXPFromFirestore) {
                window.loadXPFromFirestore = loadXPFromFirestore;
            }
            
            window.logout = async function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    try { await signOut(window.auth); window.location.href = '../index.html'; } catch (e) { alert('Error al cerrar sesi√≥n'); }
                }
            };
            
            // ========== B√öSQUEDA REAL CON FIRESTORE ==========
            const searchInput = document.getElementById('globalSearch');
            const searchBtn = document.getElementById('searchBtn');
            const searchResults = document.getElementById('searchResults');
            
            async function performSearchReal(){
                const q = (searchInput.value||'').toLowerCase().trim();
                if (!q || q.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Buscando...</div>';
                searchResults.classList.remove('hidden');
                
                // Esperar a que window.currentUser est√© disponible (desde firebase-init.js)
                if (!window.currentUser) {
                    // Esperar hasta 3 segundos
                    for (let i = 0; i < 30; i++) {
                        await new Promise(r => setTimeout(r, 100));
                        if (window.currentUser) break;
                    }
                    if (!window.currentUser) {
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Inicia sesi√≥n para buscar</div>';
                        return;
                    }
                }
                
                try {
                    // Verificar que db est√© disponible
                    if (!window.db) {
                        console.error('window.db no est√° disponible');
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Error: Base de datos no inicializada</div>';
                        return;
                    }
                    
                    console.log('Buscando en Firestore:', q);
                    
                    // Buscar usuarios en Firestore
                    const usersRef = collection(window.db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    
                    console.log('Usuarios encontrados:', usersSnapshot.size);
                    
                    const users = [];
                    usersSnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const name = (data.displayName || '').toLowerCase();
                        const searchable = (data.searchableDisplayName || '').toLowerCase();
                        
                        if (name.includes(q) || searchable.includes(q)) {
                            const avatar = data.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.displayName)}&background=6366f1&color=fff`;
                            users.push({
                                id: docSnap.id,
                                name: data.displayName,
                                role: data.role || data.rol,
                                level: data.nivel || 1,
                                xp: data.xp || 0,
                                avatar: avatar
                            });
                        }
                    });
                    
                    console.log('Usuarios que coinciden:', users.length);
                    
                    // Buscar lecciones y juegos
                    const lessons = (window.COURSES||[{id:'python', title:'Python B√°sico'}]).map(c=>({ id:c.id, title:c.title, route:'#lecciones' }));
                    const games = [{ id:'blocky', title:'Blocky', route:'#laboratorio' }, { id:'typo', title:'Typo-Racer', route:'#laboratorio' }];
                    
                    const fL = lessons.filter(l=>l.title.toLowerCase().includes(q));
                    const fG = games.filter(g=>g.title.toLowerCase().includes(q));
                    
                    if (!users.length && !fL.length && !fG.length){
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No se encontraron resultados</div>';
                        return;
                    }
                    
                    const sec = [];
                    if (users.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Usuarios (${users.length})</div>`);
                        sec.push(...users.map(u=>`<button data-user='${u.id}' class='search-user-btn w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-50 transition'>
                            <img src='${u.avatar}' class='w-8 h-8 rounded-full border-2 border-gray-200'/> 
                            <div class='flex-1 text-left'>
                                <div class='font-semibold text-sm'>${u.name}</div>
                                <div class='text-xs text-gray-500'>${u.role}</div>
                            </div>
                            <span class='text-xs text-indigo-600 font-semibold'>Nivel ${u.level}</span>
                        </button>`));
                    }
                    if (fL.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Lecciones</div>`);
                        sec.push(...fL.map(l=>`<button data-route='${l.route}' class='search-route-btn w-full text-left px-4 py-2 hover:bg-gray-50'>${l.title}</button>`));
                    }
                    if (fG.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Juegos</div>`);
                        sec.push(...fG.map(g=>`<button data-route='${g.route}' class='search-route-btn w-full text-left px-4 py-2 hover:bg-gray-50'>${g.title}</button>`));
                    }
                    
                    searchResults.innerHTML = sec.join('');
                    
                    // Eventos para rutas
                    searchResults.querySelectorAll('.search-route-btn').forEach(b=>b.addEventListener('click',()=>{ 
                        window.location.hash = b.getAttribute('data-route'); 
                        searchResults.classList.add('hidden'); 
                    }));
                    
                    // Eventos para usuarios
                    searchResults.querySelectorAll('.search-user-btn').forEach(b=>b.addEventListener('click',()=>{ 
                        const userId = b.getAttribute('data-user'); 
                        const user = users.find(u => u.id === userId);
                        if (user) openUserModalReal(user);
                        searchResults.classList.add('hidden'); 
                    }));
                    
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                    console.error('Error completo:', error.message, error.stack);
                    searchResults.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${error.message}</div>`;
                }
            }
            
            searchBtn?.addEventListener('click', performSearchReal);
            searchInput?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ performSearchReal(); }});
            
            // Cerrar resultados al hacer click fuera
            document.addEventListener('click', (e) => {
                if (searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target) && !searchBtn.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
                // Cerrar men√∫ de configuraci√≥n al hacer click fuera
                const settingsMenu = document.getElementById('settingsMenu');
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsMenu && !settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                    settingsMenu.classList.add('hidden');
                }
            });
            
            // ========== NOTIFICACIONES REALES CON FIRESTORE ==========
            async function loadNotifications(){
                const uid = window.auth.currentUser?.uid;
                if (!uid) return;
                
                try {
                    const notifList = document.getElementById('notificationList');
                    const notifDot = document.getElementById('notificationDot');
                    
                    // Cargar notificaciones desde Firestore
                    const notifRef = collection(window.db, `users/${uid}/notifications`);
                    const q = query(notifRef, orderBy('createdAt', 'desc'), limit(10));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        notifList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No tienes notificaciones</div>';
                        notifDot.classList.add('hidden');
                        return;
                    }
                    
                    notifList.innerHTML = '';
                    let hasUnread = false;
                    
                    snapshot.forEach(docSnap => {
                        const notif = docSnap.data();
                        const isUnread = !notif.read;
                        if (isUnread) hasUnread = true;
                        
                        const item = document.createElement('div');
                        item.className = `p-4 hover:bg-gray-50 cursor-pointer border-b ${isUnread ? 'bg-blue-50' : ''}`;
                        item.innerHTML = `
                            <div class='flex justify-between items-start'>
                                <div class='flex-1'>
                                    <div class='font-semibold text-sm'>${notif.title || 'Notificaci√≥n'}</div>
                                    <div class='text-xs text-gray-500 mt-1'>${notif.message || ''}</div>
                                    <div class='text-xs text-gray-400 mt-1'>${formatRelative(notif.createdAt)}</div>
                                </div>
                                ${isUnread ? '<span class="ml-2 w-2 h-2 bg-blue-600 rounded-full"></span>' : ''}
                            </div>
                        `;
                        
                        // Marcar como le√≠da al hacer clic
                        item.addEventListener('click', async () => {
                            if (isUnread) {
                                await updateDoc(doc(window.db, `users/${uid}/notifications/${docSnap.id}`), { read: true });
                                item.classList.remove('bg-blue-50');
                                item.querySelector('.w-2')?.remove();
                                loadNotifications(); // Recargar para actualizar el dot
                            }
                        });
                        
                        notifList.appendChild(item);
                    });
                    
                    // Mostrar/ocultar el punto rojo
                    if (hasUnread) {
                        notifDot.classList.remove('hidden');
                    } else {
                        notifDot.classList.add('hidden');
                    }
                    
                } catch (error) {
                    console.error('Error cargando notificaciones:', error);
                }
            }
            
            // Event listener para el bot√≥n de notificaciones
            const notifBtn = document.getElementById('notificationBtn');
            const notifDropdown = document.getElementById('notificationDropdown');
            
            notifBtn?.addEventListener('click', () => {
                const isHidden = notifDropdown.classList.contains('hidden');
                if (isHidden) {
                    loadNotifications(); // Cargar al abrir
                }
                notifDropdown.classList.toggle('hidden');
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (notifDropdown && !notifDropdown.classList.contains('hidden') && !notifDropdown.contains(e.target) && !notifBtn?.contains(e.target)) {
                    notifDropdown.classList.add('hidden');
                }
            });
            
            // Cerrar men√∫ de perfil al hacer clic fuera
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('profileMenu');
                const profileBtn = menu?.previousElementSibling;
                
                if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !profileBtn?.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
            
            // ========== FORMATO DE TIEMPO ==========
            function formatRelative(ts){
                try { const d = ts.toDate(); const diff = (Date.now()-d.getTime())/1000; if (diff<60) return 'Hace segundos'; if (diff<3600) return `Hace ${Math.floor(diff/60)} min`; if (diff<86400) return `Hace ${Math.floor(diff/3600)} h`; return d.toLocaleDateString('es-MX'); } catch(_) { return ''; }
            }

            let lastAnnDoc = null;
            async function loadAnnouncements({ append=false }={}){
                                        try {
                                            const feed = document.getElementById('announcementsFeed');
                                            if (!feed) return;
                                            
                                            let qRef = query(collection(window.db,'announcements'), orderBy('createdAt','desc'), limit(10));
                                            if (append && lastAnnDoc) qRef = query(collection(window.db,'announcements'), orderBy('createdAt','desc'), startAfter(lastAnnDoc), limit(10));
                                            const snap = await getDocs(qRef);
                                            if (snap.docs.length) lastAnnDoc = snap.docs[snap.docs.length-1];
                                            const frag = document.createDocumentFragment();
                                            snap.forEach(docSnap => { const a = docSnap.data(); const div=document.createElement('div'); div.className=`border-l-4 ${a.authorRole==='Admin'?'border-indigo-600 bg-indigo-50':'border-gray-300 bg-gray-50'} p-3 rounded`; div.innerHTML = `
                                                <div class='flex justify-between items-start'><div><p class='font-semibold text-gray-800'>${a.title||'Anuncio'}</p><p class='text-xs text-gray-500'>Publicado por ${a.authorName||'---'} ¬∑ ${formatRelative(a.createdAt)}</p></div><button data-id='${docSnap.id}' class='markRead text-xs text-indigo-600 hover:underline'>Marcar le√≠do</button></div>
                                                <p class='text-sm mt-2 line-clamp-3'>${a.content||''}</p>
                                                <button data-full='${docSnap.id}' class='openAnnouncement text-xs mt-2 text-gray-700 hover:text-gray-900'>Ver completo</button>`; frag.appendChild(div); });
                                            if (!append) feed.innerHTML=''; feed.appendChild(frag);
                                            // Bind markRead
                                            feed.querySelectorAll('.markRead').forEach(btn=>btn.addEventListener('click', async ()=>{
                                                const id = btn.getAttribute('data-id');
                                                const uid = window.auth.currentUser?.uid; if (!uid) return;
                                                await setDoc(doc(window.db, `users/${uid}/announcementsRead/${id}`), { readAt: new Date() });
                                                btn.textContent = 'Le√≠do'; btn.disabled = true; btn.classList.add('opacity-60');
                                            }));
                                        } catch (error) {
                                            console.warn('‚ö†Ô∏è Error cargando anuncios:', error.message);
                                            const feed = document.getElementById('announcementsFeed');
                                            if (feed) feed.innerHTML = '<p class="text-gray-500 text-sm">No hay anuncios disponibles</p>';
                                        }
                                    }

                        async function loadContinueLearning(userData, user = null){
                            const el = document.getElementById('continueLearning');
                            
                            // Si el elemento no existe (dashboard de profesor), no hacer nada
                            if (!el) {
                                console.log('‚ÑπÔ∏è Elemento continueLearning no encontrado (normal en dashboard profesor)');
                                return;
                            }
                            
                            // Si no se pasa user, intentar obtenerlo de window.dashboardUser
                            if (!user) {
                                user = window.dashboardUser || window.auth?.currentUser || window.currentUser;
                            }
                            
                            if (!user) {
                                console.warn('‚ö†Ô∏è loadContinueLearning: No hay usuario autenticado');
                                el.innerHTML = `<p class="text-gray-600 text-sm">Inicia sesi√≥n para ver tu progreso.</p>`;
                                return;
                            }
                            
                            // Placeholder para profesores
                            el.innerHTML = `<p class="text-gray-600 text-sm">Vista de profesor</p>`;
                        }

                        initAuth(async (user, userData) => {
                                console.log('üîê ========== INICIO DE SESI√ìN ==========');
                                console.log('üë§ Usuario:', user.uid);
                                console.log('üìã Datos:', userData);
                                
                                // CR√çTICO: Guardar user globalmente para acceso posterior
                                window.dashboardUser = user;
                                window.dashboardUserData = userData;
                                
                                // 1. Actualizar nombre y rol
                                document.getElementById('userName').textContent = userData.displayName || 'Usuario';
                                document.getElementById('userRole').textContent = (userData.role || userData.rol || '').toString();
                                document.getElementById('welcomeName').textContent = userData.displayName?.split(' ')[0] || 'Usuario';
                                
                                // 2. Cargar TODOS los datos desde Firestore UNA SOLA VEZ
                                console.log('üìä Cargando datos desde Firestore...');
                                try {
                                    const userDocRef = doc(window.db, `users/${user.uid}`);
                                    const userDoc = await getDoc(userDocRef);
                                    let freshData = {};
                                    
                                    if (userDoc.exists()) {
                                        freshData = userDoc.data();
                                        
                                        // INICIALIZAR xp y nivel si no existen
                                        if (freshData.xp === undefined || freshData.nivel === undefined) {
                                            console.warn('‚ö†Ô∏è Usuario sin XP/nivel - inicializando...');
                                            const { updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                            await updateDoc(userDocRef, { xp: 0, nivel: 1, unlockedFrames: [] });
                                            freshData.xp = 0;
                                            freshData.nivel = 1;
                                            freshData.unlockedFrames = [];
                                        }
                                        
                                        console.log('‚úÖ Datos frescos:', { xp: freshData.xp, nivel: freshData.nivel, selectedFrame: freshData.selectedFrame });
                                        
                                        // 3. Actualizar XP y nivel usando gamification.js
                                        if (window.updateGamificationHeader) {
                                            window.updateGamificationHeader(freshData.xp || 0);
                                            console.log('‚úÖ Header de gamificaci√≥n actualizado');
                                        }
                                        
                                        // 4. Cargar marco guardado
                                        if (freshData.selectedFrame) {
                                            const avatar = document.getElementById('userAvatar');
                                            const frameClass = `avatar-frame-${freshData.selectedFrame.replace('marco_', '')}`;
                                            avatar.className = `w-10 h-10 rounded-full border-2 ${frameClass}`;
                                            console.log('‚úÖ Marco aplicado:', frameClass);
                                        }
                                        
                                        // 5. Actualizar estad√≠sticas del dashboard
                                        await updateDashboardStats(user, freshData);
                                        console.log('‚úÖ Estad√≠sticas actualizadas');
                                        
                                        // 6. Cargar continuar aprendiendo
                                        await loadContinueLearning(userData, user);
                                        console.log('‚úÖ Continuar aprendiendo cargado');
                                        
                                        // 7. Cargar anuncios (no cr√≠tico)
                                        try {
                                            loadAnnouncements();
                                            console.log('‚úÖ Anuncios cargados');
                                        } catch (error) {
                                            console.warn('‚ö†Ô∏è No se pudieron cargar anuncios (no cr√≠tico):', error.message);
                                        }
                                        
                                        console.log('üéâ ========== CARGA COMPLETA ==========');
                                    }
                                } catch (error) {
                                    console.error('‚ùå Error cargando datos:', error);
                                }
                        });
                        
                        // Funci√≥n global para actualizar estad√≠sticas del dashboard
                        window.loadUserData = async function() {
                          const user = window.dashboardUser;
                          if (!user) {
                            console.warn('‚ö†Ô∏è loadUserData: No hay usuario autenticado');
                            return;
                          }
                          
                          // Recargar datos frescos
                          const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                          if (userDoc.exists()) {
                            const freshData = userDoc.data();
                            await updateDashboardStats(user, freshData);
                            window.updateGamificationHeader(freshData.xp || 0);
                          }
                        };
                        
                        async function updateDashboardStats(user, userData = null) {
                          if (!user) {
                            console.warn('‚ö†Ô∏è updateDashboardStats: No user provided');
                            return;
                          }
                          
                          console.log('üìä updateDashboardStats iniciado para profesor:', user.uid);
                          
                          try {
                            // Contar grupos del profesor
                            const groupsRef = collection(window.db, 'groups');
                            const groupsQuery = query(groupsRef, where('teacherId', '==', user.uid));
                            const groupsSnapshot = await getDocs(groupsQuery);
                            const groupsCount = groupsSnapshot.size;
                            
                            // Contar estudiantes √∫nicos en todos los grupos
                            let allStudentIds = new Set();
                            groupsSnapshot.forEach(doc => {
                              const group = doc.data();
                              if (group.studentIds) {
                                group.studentIds.forEach(id => allStudentIds.add(id));
                              }
                            });
                            const studentsCount = allStudentIds.size;
                            
                            // Contar tareas del profesor
                            const tasksRef = collection(window.db, 'tasks');
                            const tasksQuery = query(tasksRef, where('teacherId', '==', user.uid));
                            const tasksSnapshot = await getDocs(tasksQuery);
                            const tasksCount = tasksSnapshot.size;
                            
                            // Calcular promedio (placeholder - requiere m√°s l√≥gica)
                            const average = 0.0;
                            
                            // Actualizar elementos del DOM
                            const statsGroupsEl = document.getElementById('statsGroups');
                            if (statsGroupsEl) {
                              statsGroupsEl.textContent = groupsCount;
                              console.log('‚úÖ statsGroups actualizado a:', groupsCount);
                            }
                            
                            const statsStudentsEl = document.getElementById('statsStudents');
                            if (statsStudentsEl) {
                              statsStudentsEl.textContent = studentsCount;
                              console.log('‚úÖ statsStudents actualizado a:', studentsCount);
                            }
                            
                            const statsTasksEl = document.getElementById('statsTasks');
                            if (statsTasksEl) {
                              statsTasksEl.textContent = tasksCount;
                              console.log('‚úÖ statsTasks actualizado a:', tasksCount);
                            }
                            
                            const statsAverageEl = document.getElementById('statsAverage');
                            if (statsAverageEl) {
                              statsAverageEl.textContent = average.toFixed(1);
                              console.log('‚úÖ statsAverage actualizado a:', average);
                            }
                            
                            console.log('‚úÖ Estad√≠sticas del dashboard actualizadas completamente');
                          } catch (error) {
                            console.error('‚ùå Error actualizando estad√≠sticas:', error);
                          }
                        }
                        
                        function updateRecentActivity(userData) {
                          const activityContainer = document.getElementById('recentActivity');
                          if (!activityContainer) return;
                          
                          // Placeholder - actividad reciente
                          activityContainer.innerHTML = '<p class="text-gray-500">Sin actividad reciente</p>';
                        }
                        
                        document.getElementById('loadMoreAnnouncements').addEventListener('click', ()=>loadAnnouncements({append:true}));
                        document.getElementById('refreshAnnouncements').addEventListener('click', ()=>{ lastAnnDoc=null; loadAnnouncements({append:false}); });
                        
                        // ========== M√ìDULO DE LECCIONES INTEGRADO ==========
                        const COURSES_DASH = [
                          {
                            id: 'python_basico',
                            title: 'Python B√°sico',
                            description: 'Aprende los fundamentos de Python desde cero. Este curso te ense√±ar√° variables, tipos de datos, condicionales, bucles y funciones. Perfecto para principiantes que quieren dar sus primeros pasos en programaci√≥n.',
                            thumbnail: 'https://img.youtube.com/vi/kqtD5dpn9C8/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '45 min',
                            videos: [
                              { id:'v1', title:'Paso 1: Introducci√≥n a Python', ytId:'kqtD5dpn9C8', duration: 300 },
                              { id:'v2', title:'Paso 2: Variables y Tipos', ytId:'x7X9w_GIm1s', duration: 420 },
                              { id:'v3', title:'Paso 3: Condicionales', ytId:'5u0jaA3qAGk', duration: 380 },
                              { id:'v4', title:'Paso 4: Bucles', ytId:'9OK32jb_TdI', duration: 450 },
                              { id:'v5', title:'Paso 5: Funciones', ytId:'NSbOtYzIQI0', duration: 520 }
                            ]
                          },
                          {
                            id: 'javascript_intro',
                            title: 'JavaScript para Principiantes',
                            description: 'Descubre el lenguaje que hace las p√°ginas web interactivas. Aprender√°s a manipular el DOM, crear funciones y trabajar con eventos.',
                            thumbnail: 'https://img.youtube.com/vi/z95mZVUcJ-E/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '1 hora',
                            videos: [
                              { id:'js1', title:'Introducci√≥n a JavaScript', ytId:'z95mZVUcJ-E', duration: 600 },
                              { id:'js2', title:'Variables y Operadores', ytId:'Zlr5rNSpPBo', duration: 480 },
                              { id:'js3', title:'Funciones', ytId:'N8ap4k_1QEQ', duration: 540 }
                            ]
                          },
                          {
                            id: 'html_css_basico',
                            title: 'HTML & CSS B√°sico',
                            description: 'Crea tus primeras p√°ginas web. Aprender√°s la estructura de HTML y c√≥mo darle estilo con CSS.',
                            thumbnail: 'https://img.youtube.com/vi/kN1XP-Bef7w/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '50 min',
                            videos: [
                              { id:'html1', title:'Estructura HTML', ytId:'kN1XP-Bef7w', duration: 400 },
                              { id:'html2', title:'CSS B√°sico', ytId:'wRNinF7YQqQ', duration: 480 },
                              { id:'html3', title:'Flexbox y Grid', ytId:'tXIhdp5R7sc', duration: 520 }
                            ]
                          }
                        ];

                        let currentCourseDash = null;
                        let currentVideoIndexDash = 0;
                        let ytPlayerDash = null;
                        let progressIntervalDash = null;
                        let userProgressDash = {};

                        async function loadUserProgressDash() {
                          const user = window.auth?.currentUser;
                          if (!user) return;
                          try {
                            const progressDoc = await getDoc(doc(window.db, `users/${user.uid}/progress/lessons`));
                            if (progressDoc.exists()) {
                              userProgressDash = progressDoc.data().courses || {};
                            }
                          } catch (error) {
                            console.error('Error cargando progreso:', error);
                          }
                        }

                        async function saveProgressDash() {
                          const user = window.auth?.currentUser;
                          if (!user) return;
                          try {
                            await setDoc(doc(window.db, `users/${user.uid}/progress/lessons`), {
                              courses: userProgressDash,
                              lastUpdated: new Date()
                            }, { merge: true });
                          } catch (error) {
                            console.error('Error guardando progreso:', error);
                          }
                        }

                        function renderCatalogDash() {
                          const grid = document.getElementById('coursesGridDash');
                          if (!grid) return;
                          
                          grid.innerHTML = COURSES_DASH.map(course => {
                            const courseProgress = userProgressDash[course.id] || {};
                            const completedVideos = Object.values(courseProgress).filter(v => v.completed).length;
                            const totalVideos = course.videos.length;
                            const progressPercent = totalVideos > 0 ? Math.round((completedVideos / totalVideos) * 100) : 0;

                            return `
                              <div class="course-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition" data-course-id="${course.id}">
                                <div class="aspect-video bg-gray-200 overflow-hidden">
                                  <img src="${course.thumbnail}" alt="${course.title}" class="w-full h-full object-cover">
                                </div>
                                <div class="p-5">
                                  <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full">${course.level}</span>
                                    <span class="text-xs text-gray-500">‚è±Ô∏è ${course.duration}</span>
                                  </div>
                                  <h3 class="text-lg font-bold text-gray-800 mb-2">${course.title}</h3>
                                  <p class="text-sm text-gray-600 mb-4 line-clamp-2">${course.description.substring(0, 100)}...</p>
                                  
                                  <div class="mb-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>${completedVideos} de ${totalVideos} videos</span>
                                      <span>${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                      <div class="bg-indigo-600 h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                                    </div>
                                  </div>
                                  
                                  <button class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">
                                    ${progressPercent > 0 ? 'Continuar' : 'Comenzar'} ‚Üí
                                  </button>
                                </div>
                              </div>
                            `;
                          }).join('');

                          grid.querySelectorAll('.course-card').forEach(card => {
                            card.addEventListener('click', () => {
                              const courseId = card.getAttribute('data-course-id');
                              openCourseDash(courseId);
                            });
                          });
                        }

                        function openCourseDash(courseId) {
                          currentCourseDash = COURSES_DASH.find(c => c.id === courseId);
                          if (!currentCourseDash) return;

                          if (!userProgressDash[courseId]) {
                            userProgressDash[courseId] = {};
                          }

                          if (!window.YT) {
                            const tag = document.createElement('script');
                            tag.src = "https://www.youtube.com/iframe_api";
                            document.head.appendChild(tag);
                          }

                          renderCourseDetailDash();
                          showDetailDash();
                          
                          const firstIncomplete = currentCourseDash.videos.findIndex((v) => {
                            return !userProgressDash[courseId][v.id]?.completed;
                          });
                          loadVideoDash(firstIncomplete >= 0 ? firstIncomplete : 0);
                        }

                        function renderCourseDetailDash() {
                          document.getElementById('courseTitleDash').textContent = currentCourseDash.title;
                          document.getElementById('courseDescriptionDash').textContent = currentCourseDash.description;
                          updateCourseProgressDash();
                          renderVideosListDash();
                        }

                        function updateCourseProgressDash() {
                          const courseProgress = userProgressDash[currentCourseDash.id] || {};
                          const completedCount = Object.values(courseProgress).filter(v => v.completed).length;
                          const totalCount = currentCourseDash.videos.length;
                          const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                          
                          document.getElementById('courseProgressDash').textContent = `${percent}% completado`;
                          document.getElementById('courseProgressBarDash').style.width = `${percent}%`;
                        }

                        function renderVideosListDash() {
                          const list = document.getElementById('videosListDash');
                          const courseProgress = userProgressDash[currentCourseDash.id] || {};
                          
                          list.innerHTML = currentCourseDash.videos.map((video, index) => {
                            const isCompleted = courseProgress[video.id]?.completed || false;
                            const isLocked = index > 0 && !courseProgress[currentCourseDash.videos[index - 1].id]?.completed;
                            const isCurrent = index === currentVideoIndexDash;
                            
                            return `
                              <div class="video-item ${isCompleted ? 'bg-green-50' : ''} ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-50'} ${isCurrent ? 'border-2 border-indigo-500' : 'border border-gray-200'} rounded-lg p-3 transition" data-video-index="${index}">
                                <div class="flex items-center gap-3">
                                  <div class="flex-shrink-0">
                                    ${isCompleted ? '‚úÖ' : isLocked ? 'üîí' : isCurrent ? '‚ñ∂Ô∏è' : '‚≠ï'}
                                  </div>
                                  <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-800">${video.title}</div>
                                    <div class="text-xs text-gray-500">${Math.floor(video.duration / 60)} min</div>
                                  </div>
                                </div>
                              </div>
                            `;
                          }).join('');

                          list.querySelectorAll('.video-item').forEach((item, index) => {
                            const isLocked = index > 0 && !courseProgress[currentCourseDash.videos[index - 1].id]?.completed;
                            if (!isLocked) {
                              item.addEventListener('click', () => loadVideoDash(index));
                            }
                          });
                        }

                        function loadVideoDash(index) {
                          currentVideoIndexDash = index;
                          const video = currentCourseDash.videos[index];
                          
                          document.getElementById('currentVideoTitleDash').textContent = video.title;
                          document.getElementById('videoProgressDash').textContent = 'Progreso: 0%';
                          document.getElementById('btnMarkCompleteDash').classList.add('hidden');
                          
                          renderVideosListDash();
                          
                          if (ytPlayerDash) {
                            ytPlayerDash.destroy();
                          }

                          const container = document.getElementById('ytPlayerContainerDash');
                          container.innerHTML = '<div id="ytPlayerDash"></div>';
                          
                          if (window.YT && window.YT.Player) {
                            createPlayerDash(video.ytId);
                          } else {
                            window.onYouTubeIframeAPIReady = () => {
                              createPlayerDash(video.ytId);
                            };
                          }
                        }

                        function createPlayerDash(videoId) {
                          ytPlayerDash = new YT.Player('ytPlayerDash', {
                            width: '100%',
                            height: '100%',
                            videoId: videoId,
                            playerVars: { autoplay: 1, rel: 0, modestbranding: 1 },
                            events: {
                              onReady: (event) => {
                                document.getElementById('videoLoadingDash').classList.add('hidden');
                                startProgressTrackingDash();
                              },
                              onStateChange: (event) => {
                                if (event.data === YT.PlayerState.PLAYING) {
                                  startProgressTrackingDash();
                                } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                  stopProgressTrackingDash();
                                }
                              }
                            }
                          });
                        }

                        function startProgressTrackingDash() {
                          stopProgressTrackingDash();
                          progressIntervalDash = setInterval(() => {
                            if (!ytPlayerDash || !ytPlayerDash.getDuration) return;
                            
                            const currentTime = ytPlayerDash.getCurrentTime();
                            const duration = ytPlayerDash.getDuration();
                            const progress = duration > 0 ? (currentTime / duration) * 100 : 0;
                            
                            document.getElementById('videoProgressDash').textContent = `Progreso: ${Math.round(progress)}%`;
                            
                            if (progress >= 90) {
                              const video = currentCourseDash.videos[currentVideoIndexDash];
                              const courseProgress = userProgressDash[currentCourseDash.id] || {};
                              
                              if (!courseProgress[video.id]?.completed) {
                                document.getElementById('btnMarkCompleteDash').classList.remove('hidden');
                                stopProgressTrackingDash();
                              }
                            }
                          }, 1000);
                        }

                        function stopProgressTrackingDash() {
                          if (progressIntervalDash) {
                            clearInterval(progressIntervalDash);
                            progressIntervalDash = null;
                          }
                        }

                        // Funci√≥n global para marcar video como completado
                        window.markVideoCompleteDash = async function() {
                          console.log('üéØ markVideoCompleteDash llamada');
                          try {
                            const video = currentCourseDash.videos[currentVideoIndexDash];
                            console.log('Video actual:', video);
                            
                            if (!userProgressDash[currentCourseDash.id]) {
                              userProgressDash[currentCourseDash.id] = {};
                            }
                            userProgressDash[currentCourseDash.id][video.id] = {
                              completed: true,
                              completedAt: new Date(),
                              progress: 100
                            };
                            
                            console.log('Guardando progreso...');
                            await saveProgressDash();
                            console.log('Progreso guardado');
                            
                            // Dar XP
                            console.log('Dando XP... window.addXP exists?', !!window.addXP);
                            if (window.addXP) {
                              await window.addXP(50);
                              console.log('XP dado: +50');
                            } else {
                              console.error('window.addXP no est√° disponible');
                            }
                            
                            // Actualizar la barra de XP en el header
                            console.log('Actualizando header...');
                            if (window.loadUserData) {
                              await window.loadUserData();
                              console.log('Header actualizado');
                            }
                            
                            updateCourseProgressDash();
                            renderVideosListDash();
                            document.getElementById('btnMarkCompleteDash').classList.add('hidden');
                            
                            if (currentVideoIndexDash < currentCourseDash.videos.length - 1) {
                              const shouldContinue = confirm(`¬°Felicitaciones! üéâ\n\nHas completado: ${video.title}\n+50 XP\n\n¬øQuieres continuar con el siguiente video?`);
                              if (shouldContinue) {
                                console.log('Cargando siguiente video...');
                                loadVideoDash(currentVideoIndexDash + 1);
                              }
                            } else {
                              alert(`üéä ¬°Felicitaciones!\n\nHas completado: ${video.title}\n+50 XP\n\nHas terminado todo el curso.`);
                            }
                          } catch (error) {
                            console.error('‚ùå Error al completar video:', error);
                            alert('Error al completar el video: ' + error.message);
                          }
                        };

                        document.getElementById('btnBackToCatalogDash')?.addEventListener('click', () => {
                          document.getElementById('catalogViewDash').classList.remove('hidden');
                          document.getElementById('detailViewDash').classList.add('hidden');
                          stopProgressTrackingDash();
                          if (ytPlayerDash) {
                            ytPlayerDash.destroy();
                            ytPlayerDash = null;
                          }
                          renderCatalogDash();
                        });

                        function showDetailDash() {
                          document.getElementById('catalogViewDash').classList.add('hidden');
                          document.getElementById('detailViewDash').classList.remove('hidden');
                        }

                        // Inicializar lecciones cuando se muestra la secci√≥n
                        const leccionesSection = document.getElementById('section-lecciones');
                        if (leccionesSection) {
                          const observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                if (!leccionesSection.classList.contains('hidden')) {
                                  loadUserProgressDash().then(() => renderCatalogDash());
                                }
                              }
                            });
                          });
                          observer.observe(leccionesSection, { attributes: true });
                        }

                        // ========== M√ìDULO DE LABORATORIO INTEGRADO ==========
                        let currentGameDash = null;
                        let mazeLevelDash = 0;
                        let playerPosDash = { x: 0, y: 0 };
                        let playerDirectionDash = 0;
                        let commandsDash = [];
                        
                        const mazeLevels = [
                          {
                            grid: [
                              [0, 0, 0, 0, 0],
                              [0, 1, 1, 1, 0],
                              [0, 0, 0, 1, 0],
                              [0, 1, 0, 0, 0],
                              [0, 0, 0, 1, 2]
                            ],
                            start: { x: 0, y: 0 },
                            goal: { x: 4, y: 4 }
                          }
                        ];

                        let typoChallengesDash = [
                          'print("Hola Mundo")',
                          'x = 10',
                          'if x > 5:',
                          'for i in range(10):',
                          'def suma(a, b):',
                          'return a + b',
                          'nombre = input("Tu nombre: ")',
                          'lista = [1, 2, 3, 4, 5]',
                          'while True:',
                          'import random'
                        ];
                        let currentChallengeIndexDash = 0;
                        let startTimeDash = null;
                        let correctCountDash = 0;

                        document.querySelectorAll('#section-laboratorio .game-card').forEach(card => {
                          card.addEventListener('click', () => {
                            const game = card.getAttribute('data-game');
                            openGameDash(game);
                          });
                        });

                        document.getElementById('closeGameBtnDash')?.addEventListener('click', closeGameDash);

                        function openGameDash(gameName) {
                          currentGameDash = gameName;
                          const modal = document.getElementById('gameModalDash');
                          const content = document.getElementById('gameContentDash');
                          
                          if (gameName === 'maze') {
                            content.innerHTML = renderMazeGameDash();
                            initMazeGameDash();
                          } else if (gameName === 'typo') {
                            content.innerHTML = renderTypoGameDash();
                            initTypoGameDash();
                          }
                          
                          modal.classList.remove('hidden');
                        }

                        function closeGameDash() {
                          document.getElementById('gameModalDash').classList.add('hidden');
                          currentGameDash = null;
                          mazeLevelDash = 0;
                          currentChallengeIndexDash = 0;
                          correctCountDash = 0;
                        }

                        function renderMazeGameDash() {
                          return `
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">üß© Laberinto de Bloques - Nivel ${mazeLevelDash + 1}</h2>
                            <p class="text-gray-600 mb-4">Programa al robot (ü§ñ) para llegar a la meta (üéØ).</p>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                              <div>
                                <div id="mazeGridDash" class="inline-grid gap-1 mb-4" style="grid-template-columns: repeat(5, 60px);"></div>
                              </div>
                              
                              <div>
                                <h3 class="font-bold text-gray-800 mb-3">Comandos:</h3>
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                  <button class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700" onclick="window.addCommandDash('forward')">‚¨ÜÔ∏è Avanzar</button>
                                  <button class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700" onclick="window.addCommandDash('turnLeft')">‚Ü™Ô∏è Girar Izq</button>
                                  <button class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700" onclick="window.addCommandDash('turnRight')">‚Ü©Ô∏è Girar Der</button>
                                  <button class="bg-red-600 text-white p-3 rounded-lg hover:bg-red-700" onclick="window.clearCommandsDash()">üóëÔ∏è Limpiar</button>
                                </div>
                                
                                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                                  <h4 class="font-semibold text-gray-700 mb-2">Programa:</h4>
                                  <div id="commandsListDash" class="text-sm space-y-1">Sin comandos</div>
                                </div>
                                
                                <button class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold mb-2" onclick="window.executeCommandsDash()">
                                  ‚ñ∂Ô∏è Ejecutar Programa
                                </button>
                                <button class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition" onclick="window.resetMazeDash()">
                                  üîÑ Reiniciar Nivel
                                </button>
                              </div>
                            </div>
                          `;
                        }

                        function initMazeGameDash() {
                          const level = mazeLevels[mazeLevelDash];
                          playerPosDash = { ...level.start };
                          playerDirectionDash = 0;
                          commandsDash = [];
                          renderMazeDash();
                          updateCommandsListDash();
                        }

                        function renderMazeDash() {
                          const grid = document.getElementById('mazeGridDash');
                          const level = mazeLevels[mazeLevelDash];
                          if (!grid) return;
                          
                          grid.innerHTML = '';
                          
                          for (let y = 0; y < level.grid.length; y++) {
                            for (let x = 0; x < level.grid[0].length; x++) {
                              const cell = document.createElement('div');
                              cell.style.width = '60px';
                              cell.style.height = '60px';
                              cell.style.border = '2px solid #e5e7eb';
                              cell.style.display = 'flex';
                              cell.style.alignItems = 'center';
                              cell.style.justifyContent = 'center';
                              cell.style.fontSize = '2rem';
                              
                              if (level.grid[y][x] === 1) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.textContent = '‚¨õ';
                              } else if (x === playerPosDash.x && y === playerPosDash.y) {
                                const icons = ['‚û°Ô∏è', '‚¨áÔ∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è'];
                                cell.textContent = icons[playerDirectionDash];
                              } else if (x === level.goal.x && y === level.goal.y) {
                                cell.textContent = 'üéØ';
                              }
                              
                              grid.appendChild(cell);
                            }
                          }
                        }

                        window.addCommandDash = function(cmd) {
                          commandsDash.push(cmd);
                          updateCommandsListDash();
                        };

                        window.clearCommandsDash = function() {
                          commandsDash = [];
                          updateCommandsListDash();
                        };

                        function updateCommandsListDash() {
                          const list = document.getElementById('commandsListDash');
                          if (!list) return;
                          if (commandsDash.length === 0) {
                            list.innerHTML = '<p class="text-gray-400">Sin comandos</p>';
                          } else {
                            const labels = {
                              forward: '‚¨ÜÔ∏è Avanzar',
                              turnLeft: '‚Ü™Ô∏è Girar Izquierda',
                              turnRight: '‚Ü©Ô∏è Girar Derecha'
                            };
                            list.innerHTML = commandsDash.map((cmd, i) => `<div>${i + 1}. ${labels[cmd]}</div>`).join('');
                          }
                        }

                        window.executeCommandsDash = async function() {
                          const level = mazeLevels[mazeLevelDash];
                          playerPosDash = { ...level.start };
                          playerDirectionDash = 0;
                          
                          for (let cmd of commandsDash) {
                            if (cmd === 'forward') {
                              const directions = [
                                { dx: 1, dy: 0 },
                                { dx: 0, dy: 1 },
                                { dx: -1, dy: 0 },
                                { dx: 0, dy: -1 }
                              ];
                              const dir = directions[playerDirectionDash];
                              const newX = playerPosDash.x + dir.dx;
                              const newY = playerPosDash.y + dir.dy;
                              
                              if (newX >= 0 && newX < level.grid[0].length && 
                                  newY >= 0 && newY < level.grid.length && 
                                  level.grid[newY][newX] !== 1) {
                                playerPosDash.x = newX;
                                playerPosDash.y = newY;
                              }
                            } else if (cmd === 'turnLeft') {
                              playerDirectionDash = (playerDirectionDash + 3) % 4;
                            } else if (cmd === 'turnRight') {
                              playerDirectionDash = (playerDirectionDash + 1) % 4;
                            }
                            
                            renderMazeDash();
                            await new Promise(resolve => setTimeout(resolve, 500));
                          }
                          
                          if (playerPosDash.x === level.goal.x && playerPosDash.y === level.goal.y) {
                            console.log('üéØ ¬°Llegaste a la meta!');
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            try {
                              // Guardar juego completado en Firestore
                              const user = window.currentUser || window.auth?.currentUser;
                              if (user && window.db) {
                                const userRef = doc(window.db, 'users', user.uid);
                                const userDoc = await getDoc(userRef);
                                const userData = userDoc.exists() ? userDoc.data() : {};
                                const gameScores = userData.studentProfile?.gameScores || {};
                                gameScores['maze_runner'] = (gameScores['maze_runner'] || 0) + 1;
                                
                                await updateDoc(userRef, {
                                  'studentProfile.gameScores': gameScores
                                });
                                console.log('‚úÖ Juego guardado en Firestore');
                              }
                              
                              // Dar XP
                              console.log('Dando XP del laberinto... window.addXP exists?', !!window.addXP);
                              if (window.addXP) {
                                await window.addXP(30);
                                console.log('‚úÖ XP dado: +30');
                              } else {
                                console.error('‚ùå window.addXP no disponible');
                              }
                              
                              // Actualizar barra de XP
                              console.log('Actualizando barra de XP...');
                              if (window.loadUserData) {
                                await window.loadUserData();
                                console.log('‚úÖ Barra actualizada');
                              }
                              
                              alert('üéâ ¬°Felicitaciones!\n\nHas completado el nivel.\n+30 XP');
                              closeGameDash();
                            } catch (error) {
                              console.error('‚ùå Error en laberinto:', error);
                              alert('Error: ' + error.message);
                            }
                          } else {
                            alert('‚ùå No llegaste a la meta.\n\nIntenta de nuevo.');
                          }
                        };

                        window.resetMazeDash = function() {
                          initMazeGameDash();
                        };

                        function renderTypoGameDash() {
                          return `
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚å®Ô∏è Typo-Racer: Python Edition</h2>
                            <p class="text-gray-600 mb-4">Escribe el c√≥digo exactamente como aparece.</p>
                            
                            <div class="mb-6">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">Progreso:</span>
                                <span id="typoProgressDash" class="text-sm text-gray-600">0/10</span>
                              </div>
                              <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="typoProgressBarDash" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                              </div>
                            </div>
                            
                            <div class="p-4 rounded bg-gray-900 text-green-400 font-mono text-xl mb-4" id="typoChallengeDash">
                              print("Hola Mundo")
                            </div>
                            
                            <input 
                              type="text" 
                              id="typoInputDash" 
                              class="w-full p-3 font-mono text-lg bg-gray-800 text-blue-400 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 mb-4" 
                              placeholder="Escribe el c√≥digo aqu√≠..."
                              autocomplete="off"
                              spellcheck="false"
                            >
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                              <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-3xl font-bold text-blue-600" id="typoCorrectDash">0</div>
                                <div class="text-sm text-gray-600">Correctos</div>
                              </div>
                              <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-3xl font-bold text-purple-600" id="typoTimeDash">0s</div>
                                <div class="text-sm text-gray-600">Tiempo</div>
                              </div>
                            </div>
                            
                            <div id="typoFeedbackDash" class="text-center text-sm"></div>
                          `;
                        }

                        function initTypoGameDash() {
                          currentChallengeIndexDash = 0;
                          correctCountDash = 0;
                          startTimeDash = Date.now();
                          
                          typoChallengesDash = typoChallengesDash.sort(() => Math.random() - 0.5);
                          
                          showNextChallengeDash();
                          
                          const input = document.getElementById('typoInputDash');
                          if (input) {
                            input.focus();
                            input.addEventListener('input', checkTypoInputDash);
                          }
                          
                          setInterval(updateTimerDash, 100);
                        }

                        function showNextChallengeDash() {
                          if (currentChallengeIndexDash >= 10) {
                            const totalTime = ((Date.now() - startTimeDash) / 1000).toFixed(1);
                            (async () => {
                              // Dar XP
                              if (window.addXP) {
                                await window.addXP(20);
                              }
                              
                              // Actualizar barra de XP
                              if (window.loadUserData) {
                                await window.loadUserData();
                              }
                              
                              alert(`üéä ¬°Juego completado!\n\nC√≥digos correctos: ${correctCountDash}/10\nTiempo: ${totalTime}s\n+20 XP`);
                              closeGameDash();
                            })();
                            return;
                          }
                          
                          const challenge = typoChallengesDash[currentChallengeIndexDash % typoChallengesDash.length];
                          document.getElementById('typoChallengeDash').textContent = challenge;
                          document.getElementById('typoInputDash').value = '';
                          document.getElementById('typoProgressDash').textContent = `${currentChallengeIndexDash}/10`;
                          document.getElementById('typoProgressBarDash').style.width = `${(currentChallengeIndexDash / 10) * 100}%`;
                          document.getElementById('typoInputDash').focus();
                        }

                        function checkTypoInputDash(e) {
                          const input = e.target.value;
                          const challenge = typoChallengesDash[currentChallengeIndexDash % typoChallengesDash.length];
                          const feedback = document.getElementById('typoFeedbackDash');
                          
                          if (input === challenge) {
                            feedback.innerHTML = '<span class="text-green-600 font-semibold">‚úì ¬°Correcto!</span>';
                            correctCountDash++;
                            document.getElementById('typoCorrectDash').textContent = correctCountDash;
                            
                            setTimeout(() => {
                              currentChallengeIndexDash++;
                              showNextChallengeDash();
                              feedback.innerHTML = '';
                            }, 300);
                          } else if (challenge.startsWith(input)) {
                            feedback.innerHTML = '<span class="text-gray-500">Sigue escribiendo...</span>';
                          } else {
                            feedback.innerHTML = '<span class="text-red-600">‚úó Error</span>';
                          }
                        }

                        function updateTimerDash() {
                          if (!startTimeDash || currentGameDash !== 'typo') return;
                          const elapsed = ((Date.now() - startTimeDash) / 1000).toFixed(1);
                          const timeEl = document.getElementById('typoTimeDash');
                          if (timeEl) {
                            timeEl.textContent = elapsed + 's';
                          }
                        }
        </script>
</body>
</html>
