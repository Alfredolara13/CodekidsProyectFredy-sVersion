<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Espacio - CodeKids</title>
        <script>
            // Preaplicar tema oscuro en p√°ginas internas
            try { const t = localStorage.getItem('app-theme'); if (t==='dark'){ document.documentElement.classList.add('theme-dark','dark'); } } catch(_){ }
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
           <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/dashboard-enhancements.css">
        <link rel="stylesheet" href="../css/lecciones-enhancements.css">
        <link rel="stylesheet" href="../css/tareas-enhancements.css">
        <link rel="stylesheet" href="../css/laboratorio-enhancements.css">
        <style>
            /* Estilos para marcos de avatar */
            .avatar-frame-none {
                border: 2px solid transparent !important;
            }
            .avatar-frame-bronce {
                border: 3px solid #CD7F32 !important;
                box-shadow: 0 0 12px rgba(205, 127, 50, 0.6);
            }
            .avatar-frame-plata {
                border: 3px solid #C0C0C0 !important;
                box-shadow: 0 0 12px rgba(192, 192, 192, 0.8);
            }
            .avatar-frame-oro {
                border: 3px solid #FFD700 !important;
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            }
            .avatar-frame-diamante {
                border: 3px solid #B9F2FF !important;
                box-shadow: 0 0 18px rgba(185, 242, 255, 1), 0 0 25px rgba(0, 191, 255, 0.6);
                animation: diamondPulse 2s ease-in-out infinite;
            }
            @keyframes diamondPulse {
                0%, 100% { box-shadow: 0 0 18px rgba(185, 242, 255, 1), 0 0 25px rgba(0, 191, 255, 0.6); }
                50% { box-shadow: 0 0 25px rgba(185, 242, 255, 1), 0 0 35px rgba(0, 191, 255, 0.8); }
            }
            @keyframes modalBounceIn {
                0% {
                    opacity: 0;
                    transform: scale(0.3) translateY(-100px);
                }
                50% {
                    transform: scale(1.05);
                }
                70% {
                    transform: scale(0.95);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
            @keyframes wave {
                0%, 100% { transform: rotate(0deg); }
                25% { transform: rotate(-10deg); }
                75% { transform: rotate(10deg); }
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            @keyframes checkmarkPop {
                0% {
                    opacity: 0;
                    transform: scale(0);
                }
                50% {
                    transform: scale(1.2);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            /* Estilos para temas del dashboard */
            .theme-ocean-blue,
            .theme-ocean-deep,
            .theme-ocean-tropical,
            .theme-space-purple,
            .theme-space-galaxy,
            .theme-space-aurora,
            .theme-solid-purple,
            .theme-solid-cyan,
            .theme-solid-orange,
            .theme-abstract-sunset,
            .theme-abstract-rainbow,
            .theme-abstract-fire {
                min-height: calc(100vh - 4rem);
                transition: background 0.5s ease-in-out, color 0.3s ease-in-out;
            }
            
            /* ========================================
               CONTRASTE AUTOM√ÅTICO PARA TEMAS OSCUROS
               ======================================== */
            
            /* Contenedor principal y color base de texto */
            .theme-dark,
            .theme-dark .dashboard-container {
                color: #F8F8F8 !important; /* Gris muy claro para texto general */
            }
            
            /* T√≠tulos principales y texto de bienvenida */
            .theme-dark h1,
            .theme-dark h2,
            .theme-dark .welcome-text,
            .theme-dark .dashboard-welcome h1,
            .theme-dark .greeting {
                color: white !important; /* Blanco puro para m√°xima visibilidad */
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Sombra para mejor legibilidad */
            }
            
            /* Texto secundario (descripciones y subt√≠tulos) */
            .theme-dark .subheading,
            .theme-dark .card-description,
            .theme-dark p,
            .theme-dark .text-gray-600,
            .theme-dark .text-gray-700,
            .theme-dark .subtitle {
                color: #B0B0B0 !important; /* Gris m√°s suave para diferenciaci√≥n */
            }
            
            /* Texto extra claro para elementos importantes */
            .theme-dark .mission-title,
            .theme-dark .course-title,
            .theme-dark .section-title {
                color: #FFFFFF !important;
            }
            
            /* Cards con fondo blanco mantienen texto oscuro */
            .theme-dark .card.bg-white,
            .theme-dark .bg-white {
                color: #1f2937 !important; /* Texto oscuro para cards blancos */
            }
            
            .theme-dark .card.bg-white h1,
            .theme-dark .card.bg-white h2,
            .theme-dark .card.bg-white h3,
            .theme-dark .card.bg-white p,
            .theme-dark .bg-white h1,
            .theme-dark .bg-white h2,
            .theme-dark .bg-white h3,
            .theme-dark .bg-white p {
                color: #1f2937 !important; /* Asegurar texto oscuro en cards blancos */
                text-shadow: none !important; /* Sin sombra en texto oscuro */
            }
            
            /* Cards con fondos de colores mantienen su texto */
            .theme-dark .card.bg-purple-500,
            .theme-dark .card.bg-purple-600,
            .theme-dark .card.bg-indigo-500,
            .theme-dark .card.bg-indigo-600,
            .theme-dark .card.bg-cyan-500,
            .theme-dark .card.bg-cyan-600 {
                color: white !important; /* Mantener texto blanco en cards de colores */
            }
            
            /* Badges y elementos peque√±os */
            .theme-dark .badge,
            .theme-dark .tag {
                color: inherit; /* Heredar del badge/tag espec√≠fico */
            }
            
            /* Iconos en tema oscuro */
            .theme-dark svg,
            .theme-dark .icon {
                filter: brightness(1.2); /* Aumentar brillo de iconos */
            }
            
            /* Links y botones de texto */
            .theme-dark a:not(.btn) {
                color: #93c5fd !important; /* Azul claro para links */
            }
            
            .theme-dark a:not(.btn):hover {
                color: #bfdbfe !important; /* Azul m√°s claro en hover */
            }
            
            /* Bordes en tema oscuro */
            .theme-dark .border,
            .theme-dark .border-gray-200,
            .theme-dark .border-gray-300 {
                border-color: rgba(255, 255, 255, 0.1) !important;
            }
            
            /* Input fields en tema oscuro */
            .theme-dark input:not([type="submit"]):not([type="button"]),
            .theme-dark textarea,
            .theme-dark select {
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
                border-color: rgba(255, 255, 255, 0.2);
            }
            
            .theme-dark input::placeholder,
            .theme-dark textarea::placeholder {
                color: rgba(255, 255, 255, 0.5);
            }
            
            /* Estilos para Modal Overlay - M√°xima prioridad absoluta */
            .modal-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 9999 !important;
                background: rgba(0, 0, 0, 0.85) !important;
            }
            
            .modal-content {
                position: relative !important;
                z-index: 10000 !important;
            }
            
            /* Bloqueo de scroll cuando modal est√° abierto */
            body.modal-open {
                overflow: hidden !important;
            }
            
            /* ========================================
               RESTAURACI√ìN DE COLORES EN MODO CLARO
               ======================================== */
            
            /* Restaurar texto oscuro cuando NO est√° en modo oscuro */
            body:not(.dark) {
                color: #1f2937; /* Gris oscuro para texto base */
            }
            
            body:not(.dark) h1,
            body:not(.dark) h2,
            body:not(.dark) h3,
            body:not(.dark) .greeting,
            body:not(.dark) .welcome-text {
                color: #1f2937 !important; /* Texto oscuro para t√≠tulos */
                text-shadow: none !important; /* Sin sombra en modo claro */
            }
            
            body:not(.dark) .subtitle,
            body:not(.dark) .text-gray-600,
            body:not(.dark) .text-gray-500 {
                color: #6b7280 !important; /* Gris medio para subt√≠tulos */
            }
            
            /* Cards mantienen sus colores originales en modo claro */
            body:not(.dark) .stat-card-enhanced {
                /* Los gradientes se mantienen de dashboard-enhancements.css */
            }
            
            body:not(.dark) .stat-card-enhanced .stat-label,
            body:not(.dark) .stat-card-enhanced .stat-number {
                color: white !important; /* Texto blanco en cards coloridos */
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }
        </style>
</head>
<body class="bg-gray-50"
    
    <!-- Inicializar State Manager y Firebase PRIMERO -->
    <script src="../js/state-manager.js"></script>
    <script type="module" src="../js/firebase-init.js"></script>
    
    <!-- Header Global - Sticky permanente -->
    <header id="mainHeader" class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-6 py-4">
            <!-- Logo -->
            <div class="flex items-center space-x-2">
                <span class="text-xl font-extrabold text-gray-800">Code Kids</span>
            </div>

            <!-- B√∫squeda Inteligente -->
            <div class="flex-1 max-w-2xl mx-6">
                <div class="relative">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </span>
                        <input 
                            type="text" 
                            id="globalSearch"
                            placeholder="Buscar usuarios, lecciones, juegos..." 
                            class="w-full pl-10 pr-4 py-2.5 text-sm border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:outline-none transition-all duration-200 bg-gray-50 focus:bg-white"
                            autocomplete="off"
                        >
                    </div>
                    <!-- Resultados de b√∫squeda flotantes -->
                    <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl border border-gray-200 max-h-[32rem] overflow-y-auto z-[9999]">
                        <!-- Los resultados se cargan din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Controles Globales + Perfil -->
            <div class="flex items-center space-x-3">
                <!-- Nivel y XP -->
                <div class="hidden md:flex flex-col items-end">
                    <div class="flex items-center space-x-1">
                            <div class="level-badge-enhanced cursor-pointer hover:scale-105 transition-transform" id="userLevel" style="padding: 6px 16px; font-size: 0.9rem;" title="Ver progreso de nivel">
                            <span class="level-star" style="font-size: 1rem;" aria-hidden="true"></span>
                            <span>Nivel 1</span>
                        </div>
                    </div>
                    <div class="w-40 mt-1">
                        <div class="flex justify-between text-xs text-gray-500 mb-0.5 font-semibold">
                            <span id="currentXP">0</span>
                            <span id="nextLevelXP">100</span>
                        </div>
                        <div class="xp-bar-container" style="height: 8px;">
                            <div id="userXP" class="xp-bar-fill" style="width: 0%; height: 8px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Notificaciones -->
                <div class="relative">
                    <button id="notificationBtn" class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors group">
                        <svg class="w-6 h-6 text-gray-700 group-hover:text-purple-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <!-- Badge contador -->
                        <span id="notificationBadge" class="hidden absolute -top-1 -right-1 min-w-[20px] h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center px-1.5 shadow-lg">0</span>
                    </button>
                </div>

                <!-- Bot√≥n de Configuraci√≥n -->
                <div class="relative">
                    <button id="settingsBtn" class="p-1.5 hover:bg-gray-100 rounded-lg transition group" title="Configuraci√≥n">
                        <svg class="w-5 h-5 text-gray-700 group-hover:text-purple-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                    <!-- Dropdown de configuraci√≥n -->
                    <div id="settingsDropdown" class="hidden absolute top-full right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden z-50">
                        <!-- Header con gradiente -->
                        <div class="px-5 py-4 bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-700">
                            <h3 class="font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                </svg>
                                Configuraci√≥n General
                            </h3>
                            <p class="text-purple-100 text-xs mt-1">Personaliza tu experiencia</p>
                        </div>
                        
                        <!-- Opciones del men√∫ -->
                        <div class="py-2">
                            <!-- Cambiar Foto -->
                            <button id="changePhotoBtn" class="w-full text-left px-5 py-3.5 hover:bg-purple-50 transition-all duration-200 text-gray-700 flex items-center gap-4 group border-l-4 border-transparent hover:border-purple-600">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-100 to-indigo-100 flex items-center justify-center group-hover:from-purple-200 group-hover:to-indigo-200 transition-all">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 group-hover:text-purple-700 transition-colors">Cambiar Foto</div>
                                    <div class="text-xs text-gray-500">Actualiza tu imagen de perfil</div>
                                </div>
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-purple-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>

                            <!-- Temas y Fondos -->
                            <button id="themesBtn" class="w-full text-left px-5 py-3.5 hover:bg-indigo-50 transition-all duration-200 text-gray-700 flex items-center gap-4 group border-l-4 border-transparent hover:border-indigo-600">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-blue-100 flex items-center justify-center group-hover:from-indigo-200 group-hover:to-blue-200 transition-all">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 group-hover:text-indigo-700 transition-colors">Temas y Fondos</div>
                                    <div class="text-xs text-gray-500">Personaliza la apariencia</div>
                                </div>
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-indigo-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>

                            <!-- Agregar Marco -->
                            <button id="openFramesModalSettings" class="w-full text-left px-5 py-3.5 hover:bg-emerald-50 transition-all duration-200 text-gray-700 flex items-center gap-4 group border-l-4 border-transparent hover:border-emerald-600">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-100 to-teal-100 flex items-center justify-center group-hover:from-emerald-200 group-hover:to-teal-200 transition-all">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 group-hover:text-emerald-700 transition-colors">Marcos de Perfil</div>
                                    <div class="text-xs text-gray-500">Personaliza tu foto con marcos</div>
                                </div>
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-emerald-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>

                            <!-- Reportar Problema -->
                            <button id="reportProblemBtn" class="w-full text-left px-5 py-3.5 hover:bg-amber-50 transition-all duration-200 text-gray-700 flex items-center gap-4 group border-l-4 border-transparent hover:border-amber-500">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center group-hover:from-amber-200 group-hover:to-orange-200 transition-all">
                                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800 group-hover:text-amber-700 transition-colors">Reportar Problema</div>
                                    <div class="text-xs text-gray-500">Env√≠a tus comentarios</div>
                                </div>
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-amber-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>

                            <!-- Separador para Cerrar Sesi√≥n -->
                            <div class="my-3 border-t-4 border-gray-200"></div>

                            <!-- Cerrar Sesi√≥n -->
                            <button id="logoutBtnSettings" class="w-full text-left px-5 py-3.5 hover:bg-red-50 transition-all duration-200 text-red-600 flex items-center gap-4 group border-l-4 border-transparent hover:border-red-600">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-100 to-rose-100 flex items-center justify-center group-hover:from-red-200 group-hover:to-rose-200 transition-all">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-red-600 group-hover:text-red-700 transition-colors">Cerrar Sesi√≥n</div>
                                    <div class="text-xs text-red-500">Salir de tu cuenta</div>
                                </div>
                                <svg class="w-4 h-4 text-red-400 group-hover:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de Tema Claro/Oscuro -->
                <button id="themeToggle" class="p-1.5 hover:bg-gray-100 rounded-lg transition cursor-pointer" title="Cambiar tema" style="cursor: pointer;">
                    <svg id="themeIconLight" class="w-5 h-5 text-gray-700 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="themeIconDark" class="w-5 h-5 text-gray-700 hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>

                <!-- Perfil -->
                <div class="relative">
                    <!-- Avatar como elemento est√°tico de informaci√≥n -->
                    <div class="flex items-center space-x-1.5 rounded-lg p-1.5" id="profileInfo">
                        <div class="avatar-container" style="width: 40px; height: 40px;">
                            <div class="avatar-ring"></div>
                            <div class="avatar-glow"></div>
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=Usuario&background=667eea&color=fff" class="w-full h-full rounded-full border-2 border-transparent" alt="Perfil">
                        </div>
                        <div class="hidden md:block">
                            <p id="userName" class="text-sm font-semibold text-gray-800">Cargando...</p>
                            <p id="userRole" class="text-xs text-gray-500">Estudiante</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Layout Principal -->
    <div class="flex pt-16" style="min-height: calc(100vh - 4rem);">
        
        <!-- Sidebar -->
        <aside class="sidebar w-64 fixed left-0 h-full overflow-y-auto bg-white shadow-lg" style="top: 4rem;">
            <div class="p-4">
                <nav class="space-y-1">
                    <a href="#inicio" class="sidebar-item active" data-route="inicio">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Inicio</span>
                    </a>
                    
                    <a href="#lecciones" class="sidebar-item" data-route="lecciones">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span>Lecciones</span>
                    </a>

                    <a href="#tareas" class="sidebar-item" data-route="tareas">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <span>Tareas</span>
                    </a>

                    <a href="#laboratorio" class="sidebar-item" data-route="laboratorio">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Laboratorio</span>
                    </a>

                    <a href="#coleccion" class="sidebar-item" data-route="coleccion">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <span>Mi Colecci√≥n</span>
                    </a>

                    <a href="#grupos" class="sidebar-item" data-route="grupos">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>Mis Grupos</span>
                    </a>

                    <a href="#chats" class="sidebar-item" data-route="chats">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>Chats</span>
                        <span id="chatBadge" class="hidden ml-auto badge badge-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">0</span>
                    </a>

                    <a href="#racha" class="sidebar-item" data-route="racha">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                        </svg>
                        <span>Racha</span>
                    </a>
                </nav>

                <!-- Widget de Racha en Sidebar -->
                <div class="streak-widget-enhanced">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="streak-flame">üî•</span>
                            <span class="font-bold text-lg">Racha</span>
                        </div>
                        <div class="streak-number" id="streakDays">0</div>
                    </div>
                    <div class="text-sm opacity-90 mb-2">¬°Est√°s encendido! Sigue as√≠</div>
                    <div class="streak-progress-bar">
                        <div class="streak-progress-fill" style="width: 0%" id="streakProgress"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-0 md:ml-64 p-6">
            <!-- Secci√≥n INICIO (visible por defecto) -->
            <section id="section-inicio" class="block" data-section>
            <!-- Grid principal 2 columnas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Columna Izquierda (70%) -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Bienvenida -->
                    <div class="animate-fade-in dashboard-welcome">
                        <div class="greeting-container mb-4">
                            <h1 class="text-2xl font-bold text-gray-800 greeting">
                                <span class="greeting-text">Hola,</span> <span id="welcomeName">Estudiante</span>
                            </h1>
                            <span class="wave-emoji" aria-hidden="true"></span>
                        </div>
                        <p class="text-gray-600 text-lg subtitle">¬°Listo para programar! Tu centro de aprendizaje</p>
                    </div>

                    <!-- Estad√≠sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="stat-card-enhanced stat-card-lecciones text-white">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <p class="text-sm font-semibold opacity-90 uppercase">Lecciones Completadas</p>
                                    <p id="statsLessons" class="text-5xl font-bold mt-2">0</p>
                                </div>
                                <div class="stat-icon-lecciones text-5xl" aria-hidden="true">
                                    <!-- Cohete de Aprendizaje üöÄ: Dise√±o profesional y llamativo -->
                                    <svg class="stat-svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <!-- Cuerpo del cohete -->
                                        <path d="M12 2L8 6v8l4 4 4-4V6z"/>
                                        <!-- Ventana del cohete -->
                                        <circle cx="12" cy="10" r="2" fill="white" stroke="white"/>
                                        <!-- Aletas izquierda y derecha -->
                                        <path d="M8 10L6 14l2 2"/>
                                        <path d="M16 10l2 4-2 2"/>
                                        <!-- Llamas del cohete -->
                                        <path d="M10 18v3" stroke-width="3"/>
                                        <path d="M12 18v4" stroke-width="3"/>
                                        <path d="M14 18v3" stroke-width="3"/>
                                        <!-- Detalles de velocidad -->
                                        <path d="M5 8h2" stroke-width="2"/>
                                        <path d="M4 11h2" stroke-width="2"/>
                                        <path d="M17 8h2" stroke-width="2"/>
                                        <path d="M18 11h2" stroke-width="2"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="w-full bg-white/30 rounded-full h-3">
                                    <div id="progressLessons" class="h-3 bg-white rounded-full transition-all" style="width:0%"></div>
                                </div>
                                <p class="text-xs mt-2 opacity-80">¬°Sigue aprendiendo!</p>
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced stat-card-juegos text-white">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <p class="text-sm font-semibold opacity-90 uppercase">Juegos Jugados</p>
                                    <p id="statsGames" class="text-5xl font-bold mt-2">0</p>
                                </div>
                                <div class="stat-icon-juegos text-5xl" aria-hidden="true">
                                    <!-- Mando de Batalla Estilizado üéÆ: Control con energ√≠a -->
                                    <svg class="stat-svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <!-- Cuerpo del control -->
                                        <path d="M6 11c-1.5 0-2.5 1-2.5 2.5v2c0 1.5 1 2.5 2.5 2.5h2c1 0 1.5-.5 2-1.5l2-4c.5-1 1-1.5 2-1.5h2c1.5 0 2.5 1 2.5 2.5v2c0 1.5-1 2.5-2.5 2.5h-2"/>
                                        <!-- Cruz direccional izquierda -->
                                        <path d="M7 14h2"/>
                                        <path d="M8 13v2"/>
                                        <!-- Botones derecha -->
                                        <circle cx="16" cy="13" r="1" fill="white"/>
                                        <circle cx="18" cy="15" r="1" fill="white"/>
                                        <!-- Escudo de batalla (fondo) -->
                                        <path d="M12 3v3" stroke-width="2"/>
                                        <path d="M8 4l2 2" stroke-width="2"/>
                                        <path d="M16 4l-2 2" stroke-width="2"/>
                                        <!-- L√≠neas de energ√≠a -->
                                        <path d="M3 9l2 1" stroke-width="1.5" opacity="0.7"/>
                                        <path d="M21 9l-2 1" stroke-width="1.5" opacity="0.7"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="w-full bg-white/30 rounded-full h-3">
                                    <div id="progressGames" class="h-3 bg-white rounded-full transition-all" style="width:0%"></div>
                                </div>
                                <p class="text-xs mt-2 opacity-80">¬°Hora de jugar!</p>
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced stat-card-marcos text-white">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <p class="text-sm font-semibold opacity-90 uppercase">Marcos Desbloqueados</p>
                                    <p id="statsFrames" class="text-5xl font-bold mt-2">0/5</p>
                                </div>
                                <div class="stat-icon-marcos text-5xl" aria-hidden="true">
                                    <!-- Tesoro Desbloqueado üóùÔ∏è: Cofre con destello brillante -->
                                    <svg class="stat-svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <!-- Base del cofre -->
                                        <rect x="4" y="12" width="16" height="8" rx="2"/>
                                        <!-- Tapa del cofre -->
                                        <path d="M4 12V10c0-1 1-2 2-2h12c1 0 2 1 2 2v2"/>
                                        <!-- Cerradura central -->
                                        <rect x="11" y="14" width="2" height="3" rx="0.5"/>
                                        <circle cx="12" cy="14" r="1.5" fill="white"/>
                                        <!-- Llave dorada (parte superior) -->
                                        <circle cx="12" cy="5" r="2" stroke-width="2.5"/>
                                        <path d="M12 7v1" stroke-width="2.5"/>
                                        <!-- Destellos brillantes -->
                                        <path d="M7 6l-1.5-1.5" stroke-width="2" opacity="0.8"/>
                                        <path d="M17 6l1.5-1.5" stroke-width="2" opacity="0.8"/>
                                        <path d="M12 2v2" stroke-width="2" opacity="0.8"/>
                                        <path d="M5 10l-2-1" stroke-width="1.5" opacity="0.6"/>
                                        <path d="M19 10l2-1" stroke-width="1.5" opacity="0.6"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm font-semibold">¬°Sube de Nivel para Desbloquear m√°s Tesoros!</p>
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced stat-card-tiempo text-white">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <p class="text-sm font-semibold opacity-90 uppercase">Tiempo Total</p>
                                    <p id="statsTime" class="text-5xl font-bold mt-2">00:00</p>
                                </div>
                                <div class="stat-icon-tiempo text-5xl" aria-hidden="true">
                                    <!-- Portal de Tiempo ‚åõ: Portal circular con l√≠neas de velocidad -->
                                    <svg class="stat-svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <!-- Portal exterior -->
                                        <circle cx="12" cy="12" r="9"/>
                                        <!-- Portal interior (energ√≠a) -->
                                        <circle cx="12" cy="12" r="6" stroke-width="2"/>
                                        <!-- Reloj de arena estilizado -->
                                        <path d="M12 8v8" stroke-width="3"/>
                                        <path d="M10 9l2-1 2 1" fill="white"/>
                                        <path d="M10 15l2 1 2-1" fill="white"/>
                                        <!-- L√≠neas de velocidad (movimiento) -->
                                        <path d="M2 12h3" stroke-width="2" opacity="0.7"/>
                                        <path d="M19 12h3" stroke-width="2" opacity="0.7"/>
                                        <path d="M5 7l2 2" stroke-width="2" opacity="0.6"/>
                                        <path d="M17 17l2 2" stroke-width="2" opacity="0.6"/>
                                        <path d="M5 17l2-2" stroke-width="2" opacity="0.6"/>
                                        <path d="M17 7l2-2" stroke-width="2" opacity="0.6"/>
                                        <!-- Part√≠culas de energ√≠a -->
                                        <circle cx="12" cy="4" r="1" fill="white" opacity="0.8"/>
                                        <circle cx="12" cy="20" r="1" fill="white" opacity="0.8"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-xs opacity-80">¬°Cada minuto cuenta!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Feed de Anuncios -->
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800 section-title">Anuncios</h2>
                            <button id="refreshAnnouncements" class="text-sm px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                Actualizar
                            </button>
                        </div>
                        <div id="announcementsFeed" class="space-y-3 max-h-96 overflow-y-auto"></div>
                        <div class="mt-4 text-center">
                            <button id="loadMoreAnnouncements" class="text-sm text-indigo-600 hover:underline">Cargar m√°s</button>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha (30%) -->
                <div class="space-y-6">
                    <!-- Continuar Aprendiendo -->
                    <div class="card">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center section-title">
                            <svg class="medal-badge mr-3 w-7 h-7 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="9" r="4" fill="currentColor"/>
                                <path d="M12 13v6" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 20l4-3 4 3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Continuar Aprendiendo
                        </h2>
                        <div id="continueLearning" class="text-sm text-gray-600">
                            <div class="mb-4">
                                    <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">‚úì</span>
                                    <span class="font-semibold text-green-600">HTML & CSS B√°sico completado</span>
                                </div>
                                <p class="text-gray-500 text-xs ml-8">Ver m√°s cursos</p>
                            </div>
                            <button class="continue-learning-btn w-full">
                                <span>¬°Empieza tu pr√≥xima aventura!</span>
                            </button>
                        </div>
                    </div>

                    <!-- Pr√≥ximas Tareas -->
                    <div class="card">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            Actividad Tareas
                        </h2>
                        <div id="upcomingTasks" class="space-y-3 text-sm">
                            <div class="empty-tasks-message">
                                <div class="empty-tasks-icon" aria-hidden="true">
                                    <svg class="w-16 h-16 mx-auto text-indigo-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <rect x="6" y="3" width="12" height="14" rx="2" fill="currentColor" opacity="0.12"/>
                                        <path d="M9 7h6" stroke="currentColor"/>
                                        <path d="M9 11h6" stroke="currentColor"/>
                                        <path d="M10 17v2" stroke="currentColor"/>
                                        <path d="M14 17v2" stroke="currentColor"/>
                                    </svg>
                                </div>
                                <p class="font-bold text-lg mt-2">¬°Buen trabajo, explorador!</p>
                                <p class="text-sm mt-2">Tus pr√≥ximas tareas aparecer√°n pronto</p>
                                <p class="text-sm mt-1">¬°Explora nuevas lecciones mientras esperas!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actividad Reciente -->
                    <div class="card">
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                            Actividad Reciente
                        </h2>
                        <div id="recentActivity" class="space-y-2 text-xs text-gray-600">
                            <p class="text-gray-500">Sin actividad reciente</p>
                        </div>
                    </div>
                </div>
            </div>
            </section>

            <!-- Secci√≥n LECCIONES -->
            <section id="section-lecciones" class="hidden" data-section>
                <!-- Vista de Cat√°logo -->
                    <div id="catalogViewDash" class="mb-6 missions-container">
                    <div class="missions-header">
                        <h1 class="missions-title">¬°Tus Misiones de C√≥digo!</h1>
                        <p class="missions-subtitle">¬°Elige con qu√© lenguaje m√°gico quieres programar!</p>
                    </div>
                    
                    <div id="coursesGridDash" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Las tarjetas se cargar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Vista de Detalle del Curso -->
                <div id="detailViewDash" class="hidden">
                    <button id="btnBackToCatalogDash" class="mb-4 flex items-center gap-2 text-indigo-600 hover:text-indigo-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Volver al cat√°logo
                    </button>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Barra lateral con lista de videos -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow p-4">
                            <div class="mb-4">
                                <h2 id="courseTitleDash" class="text-xl font-bold text-gray-800 mb-2 course-title"></h2>
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span id="courseProgressDash">0% completado</span>
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div id="courseProgressBarDash" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="videosListDash" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Videos se cargar√°n aqu√≠ -->
                            </div>
                        </div>

                        <!-- Reproductor y descripci√≥n -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Reproductor -->
                            <div class="bg-white rounded-xl shadow overflow-hidden">
                                <div class="aspect-video bg-black relative">
                                    <div id="ytPlayerContainerDash"></div>
                                    <div id="videoLoadingDash" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75">
                                        <div class="text-white text-center">
                                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                                            <p>Cargando video...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <h3 id="currentVideoTitleDash" class="text-xl font-bold text-gray-800 mb-2 section-title">Selecciona un video</h3>
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-gray-600">
                                            <span id="videoProgressDash">Progreso: 0%</span>
                                        </div>
                                        <button id="btnMarkCompleteDash" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition" onclick="window.markVideoCompleteDash()">
                                            ‚úì Completar y continuar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Descripci√≥n del curso -->
                            <div class="bg-white rounded-xl shadow p-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">üìñ Sobre este curso</h3>
                                <p id="courseDescriptionDash" class="text-gray-600 leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n LABORATORIO -->
            <section id="section-laboratorio" class="hidden" data-section>
                <!-- Header Arcade -->
                <div class="arcade-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="arcade-title">¬°ZONA ARCADE DE C√ìDIGO!</h1>
                            <p class="arcade-subtitle">
                                <span class="arcade-robot" aria-hidden="true">
                                    <svg class="w-8 h-8 md:w-20 md:h-20 text-pink-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <rect x="4" y="6" width="16" height="12" rx="2" fill="currentColor" opacity="0.12"/>
                                        <circle cx="9" cy="11" r="1" fill="currentColor"/>
                                        <circle cx="15" cy="11" r="1" fill="currentColor"/>
                                        <path d="M8 16c1-1 3-1 4 0s3 1 4 0" stroke="currentColor"/>
                                        <path d="M7 4v2" stroke="currentColor"/>
                                        <path d="M17 4v2" stroke="currentColor"/>
                                    </svg>
                                </span>
                                ¬°Vamos a jugar y programar! Gana XP mientras te diviertes
                            </p>
                        </div>
                        <div class="arcade-robot hidden md:block" style="font-size: 5rem;" aria-hidden="true">
                            <svg class="w-20 h-20 text-pink-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="5" width="18" height="14" rx="3" fill="currentColor" opacity="0.08"/>
                                <circle cx="9" cy="11" r="1.4" fill="currentColor"/>
                                <circle cx="15" cy="11" r="1.4" fill="currentColor"/>
                                <path d="M8 17c1-1 3-1 4 0s3 1 4 0" stroke="currentColor"/>
                                <path d="M6 3v3" stroke="currentColor"/>
                                <path d="M18 3v3" stroke="currentColor"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filtros de Categor√≠a -->
                <div class="arcade-filters">
                    <button class="arcade-filter-btn active" data-category="all">Todos</button>
                    <button class="arcade-filter-btn" data-category="velocidad">Velocidad</button>
                    <button class="arcade-filter-btn" data-category="logica">L√≥gica</button>
                    <button class="arcade-filter-btn" data-category="programacion">Programaci√≥n</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="gamesGridDash">
                    <!-- Juego 1: Laberinto de Bloques -->
                    <div class="arcade-game-card" data-game="maze" data-category="logica">
                        <div class="arcade-card-banner maze">
                            <div class="arcade-game-icon" aria-hidden="true">
                                <svg class="w-12 h-12 text-yellow-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <rect x="3" y="6" width="18" height="12" rx="2" fill="currentColor" opacity="0.08"/>
                                    <circle cx="9" cy="11" r="1.4" fill="currentColor"/>
                                    <path d="M15 10h.01" stroke="currentColor"/>
                                    <path d="M7 16h10" stroke="currentColor"/>
                                </svg>
                            </div>
                        </div>
                        <div class="arcade-card-content">
                            <div class="arcade-game-title">
                                <span>Laberinto de Bloques</span>
                                <div class="arcade-xp-badge">
                                    <span class="xp-star" aria-hidden="true">
                                        <svg class="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <path d="M12 2l2.6 6.6L21 9l-5 3.6L17.2 21 12 17.8 6.8 21 8 12.6 3 9l6.4-0.4L12 2z" fill="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>+30 XP</span>
                                </div>
                            </div>
                            <p class="arcade-game-description">
                                Programa los movimientos del robot para escapar del laberinto. Usa comandos de movimiento y l√≥gica.
                            </p>
                            <div class="arcade-game-meta">
                                <div class="meta-item">
                                    <span class="meta-icon" aria-hidden="true">
                                        <svg class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                            <path d="M12 8v5l3 2" stroke="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>5 min</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon" aria-hidden="true">
                                        <svg class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                            <path d="M12 8v5l3 2" stroke="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>F√°cil</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon" aria-hidden="true">
                                        <svg class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                            <path d="M12 8v5l3 2" stroke="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>L√≥gica</span>
                                </div>
                            </div>
                            <button class="arcade-play-button">
                                ¬°Insertar Ficha y Jugar!
                            </button>
                        </div>
                    </div>

                    <!-- Juego 2: Typo-Racer -->
                    <div class="arcade-game-card" data-game="typo" data-category="velocidad">
                            <div class="arcade-card-banner typo">
                            <div class="arcade-game-icon" aria-hidden="true">
                                <svg class="w-12 h-12 text-yellow-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <rect x="3" y="6" width="18" height="12" rx="2" fill="currentColor" opacity="0.08"/>
                                    <circle cx="9" cy="11" r="1.4" fill="currentColor"/>
                                    <path d="M15 10h.01" stroke="currentColor"/>
                                    <path d="M7 16h10" stroke="currentColor"/>
                                </svg>
                            </div>
                        </div>
                        <div class="arcade-card-content">
                            <div class="arcade-game-title">
                                <span>Typo-Racer Code</span>
                                <div class="arcade-xp-badge">
                                    <span class="xp-star" aria-hidden="true">
                                        <svg class="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <path d="M12 2l2.6 6.6L21 9l-5 3.6L17.2 21 12 17.8 6.8 21 8 12.6 3 9l6.4-0.4L12 2z" fill="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>+20 XP</span>
                                </div>
                            </div>
                            <p class="arcade-game-description">
                                Escribe c√≥digo Python a m√°xima velocidad. Compite contra el tiempo y mejora tu precisi√≥n.
                            </p>
                            <div class="arcade-game-meta">
                                <div class="meta-item">
                                    <span class="meta-icon">‚è±Ô∏è</span>
                                    <span>3 min</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon" aria-hidden="true">
                                        <svg class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                            <path d="M12 8v5l3 2" stroke="currentColor"/>
                                        </svg>
                                    </span>
                                    <span>F√°cil</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-icon" aria-hidden="true"></span>
                                    <span>Velocidad</span>
                                </div>
                            </div>
                            <button class="arcade-play-button green">
                                ¬°Empezar Partida!
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal del juego -->
                <div id="gameModalDash" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl w-full max-w-4xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                        <button id="closeGameBtnDash" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        <div id="gameContentDash"></div>
                    </div>
                </div>
            </section>

            <!-- Modal de Cierre de Sesi√≥n -->
            <div id="logoutModal" class="hidden fixed inset-0 bg-gradient-to-br from-purple-900/40 to-blue-900/40 flex items-center justify-center z-[60] p-4" style="backdrop-filter: blur(8px);">
                <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all" style="animation: modalBounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 p-6 text-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.1) 10px, rgba(255,255,255,.1) 20px);"></div>
                        <div class="relative">
                            <div class="text-6xl mb-2" style="animation: wave 1s ease-in-out infinite;" aria-hidden="true">
                                <svg class="w-16 h-16 mx-auto text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M2 12c2 2 4 4 7 4s5-2 7-4 4-4 7-4" stroke="currentColor"/>
                                    <circle cx="12" cy="8" r="2" fill="currentColor"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-white drop-shadow-lg">¬°Hasta Pronto!</h3>
                        </div>
                    </div>
                    
                    <!-- Contenido -->
                    <div class="p-8 text-center">
                        <p class="text-gray-700 text-lg mb-2 font-medium">¬øYa te vas?</p>
                        <p class="text-gray-500 mb-6">¬°Nos vemos pronto para seguir<br>programando juntos!</p>
                        
                        <div class="flex gap-3">
                            <button id="cancelLogoutBtn" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95">
                                No, me quedo
                            </button>
                            <button id="confirmLogoutBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg">
                                S√≠, salir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Progreso de Nivel Mejorado -->
            <!-- Capa de oscurecimiento (Modal Overlay) - M√°xima prioridad -->
            <div id="levelProgressModal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; padding: 1rem;">
                <!-- Contenido del Modal -->
                <div class="modal-content" style="position: relative; z-index: 10000; background: white; border-radius: 32px; width: 100%; max-width: 32rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    
                    <!-- Header con gradiente vibrante -->
                    <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-cyan-500 p-8 text-center relative overflow-hidden">
                        <!-- Patr√≥n de fondo -->
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 15px, rgba(255,255,255,.15) 15px, rgba(255,255,255,.15) 30px);"></div>
                        
                        <!-- Contenido del header -->
                        <div class="relative z-10">
                            <!-- Estrella animada -->
                            <div class="inline-block mb-3">
                                <svg class="w-20 h-20 text-yellow-300 drop-shadow-lg" style="filter: drop-shadow(0 0 12px rgba(253, 224, 71, 0.6)); animation: pulse 2s ease-in-out infinite;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </div>
                            
                            <!-- Nivel actual -->
                            <h2 class="text-5xl font-extrabold text-white drop-shadow-lg mb-2" id="modalCurrentLevel">Nivel 2</h2>
                            
                            <!-- Mensaje motivacional -->
                            <p class="text-white/90 text-base font-medium drop-shadow-md">¬°Excelente trabajo! Tu dedicaci√≥n est√°<br>construyendo grandes cosas.</p>
                        </div>
                    </div>

                    <!-- Contenido principal -->
                    <div class="p-8">
                        
                        <!-- Secci√≥n de Progreso de XP -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-bold text-gray-700">Progreso de XP</span>
                                <span class="text-sm font-bold text-indigo-600" id="modalXPPercentage">50%</span>
                            </div>
                            
                            <!-- Barra de progreso con degradado -->
                            <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden shadow-inner mb-2">
                                <!-- Barra llena con degradado -->
                                <div id="modalXPBar" class="h-full bg-gradient-to-r from-purple-500 via-indigo-500 to-cyan-400 rounded-full transition-all duration-700 ease-out flex items-center justify-center" style="width: 50%;">
                                    <span class="text-white text-xs font-bold drop-shadow-sm" id="modalXPBarText">50/100 XP</span>
                                </div>
                            </div>
                            
                            <!-- Mensaje de progreso motivacional -->
                            <p class="text-sm text-center mt-3">
                                <span class="text-gray-600">Te faltan </span>
                                <span class="font-bold text-indigo-600" id="modalXPRemaining">50 XP</span>
                                <span class="text-gray-600"> para alcanzar el </span>
                                <span class="font-bold text-purple-600" id="modalNextLevel">Nivel 3</span>
                            </p>
                        </div>

                        <!-- Secci√≥n de Recompensas del Pr√≥ximo Nivel -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-purple-700 mb-4 flex items-center gap-2">
                                <svg class="w-6 h-6 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                </svg>
                                Recompensas del <span id="modalRewardsLevel">Nivel 3</span>
                            </h3>
                            
                            <!-- Cards de recompensas -->
                            <div class="space-y-3">
                                <!-- Recompensa 1: Marco de Avatar -->
                                <div class="bg-gradient-to-br from-yellow-50 to-amber-50 border-2 border-amber-200 rounded-2xl p-4 flex items-start gap-4 shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-md">
                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-800 text-base mb-1">Marco de Avatar: Bronce</h4>
                                        <p class="text-sm text-gray-600">A√±ade un marco dorado a tu foto de perfil</p>
                                    </div>
                                </div>

                                <!-- Recompensa 2: XP Adicional -->
                                <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-2xl p-4 flex items-start gap-4 shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-800 text-base mb-1">Bonus: +50 XP</h4>
                                        <p class="text-sm text-gray-600">Puntos de experiencia adicionales</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√≥n de cierre con degradado llamativo -->
                        <button id="closeLevelModalBtn" class="w-full bg-gradient-to-r from-orange-500 via-pink-500 to-rose-500 hover:from-orange-600 hover:via-pink-600 hover:to-rose-600 text-white font-bold text-lg py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95 flex items-center justify-center gap-3 shadow-xl">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                            </svg>
                            ¬°Entendido!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal de Notificaciones -->
            <div id="notificationsModal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; padding: 1rem;">
                <!-- Contenido del Modal -->
                <div class="modal-content" style="position: relative; z-index: 10000; background: white; border-radius: 32px; width: 100%; max-width: 36rem; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    
                    <!-- Header con gradiente vibrante -->
                    <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-500 p-8 text-center relative overflow-hidden">
                        <!-- Patr√≥n de fondo -->
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 15px, rgba(255,255,255,.15) 15px, rgba(255,255,255,.15) 30px);"></div>
                        
                        <!-- Contenido del header -->
                        <div class="relative z-10">
                            <!-- Campana animada -->
                            <div class="inline-block mb-3">
                                <svg class="w-20 h-20 text-yellow-300 drop-shadow-lg" style="filter: drop-shadow(0 0 12px rgba(253, 224, 71, 0.6)); animation: wave 2s ease-in-out infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                            </div>
                            
                            <!-- T√≠tulo -->
                            <h2 class="text-4xl font-extrabold text-white drop-shadow-lg mb-2">Tus Alertas</h2>
                            
                            <!-- Contador global -->
                            <p class="text-white/90 text-lg font-medium drop-shadow-md">
                                Tienes <span id="modalNotificationCount" class="font-bold text-yellow-300">3</span> alertas nuevas
                            </p>
                            
                            <!-- Bot√≥n marcar todo como le√≠do -->
                            <button id="markAllReadBtn" class="mt-4 px-6 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold rounded-full transition-all duration-200 text-sm border border-white/30">
                                ‚úì Marcar todo como le√≠do
                            </button>
                        </div>
                    </div>

                    <!-- Contenido principal - Lista de notificaciones -->
                    <div class="overflow-y-auto" style="max-height: 50vh;">
                        <div id="notificationsList" class="divide-y divide-gray-100">
                            <!-- Las notificaciones se cargan din√°micamente aqu√≠ -->
                        </div>
                    </div>

                    <!-- Bot√≥n de cierre -->
                    <div class="p-6 bg-gray-50 border-t border-gray-200">
                        <button id="closeNotificationsBtn" class="w-full bg-gradient-to-r from-orange-500 via-pink-500 to-rose-500 hover:from-orange-600 hover:via-pink-600 hover:to-rose-600 text-white font-bold text-lg py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95 flex items-center justify-center gap-3 shadow-xl">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Entendido
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal de Cambiar Foto -->
            <div id="changePhotoModal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; padding: 1rem;">
                <div class="modal-content" style="position: relative; z-index: 10000; background: white; border-radius: 32px; width: 100%; max-width: 32rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-700 p-8 text-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 15px, rgba(255,255,255,.15) 15px, rgba(255,255,255,.15) 30px);"></div>
                        
                        <div class="relative z-10">
                            <div class="inline-block mb-3">
                                <svg class="w-20 h-20 text-yellow-300 drop-shadow-lg" style="filter: drop-shadow(0 0 12px rgba(253, 224, 71, 0.6));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <h2 class="text-4xl font-extrabold text-white drop-shadow-lg mb-2">Cambiar Foto</h2>
                            <p class="text-white/90 text-lg font-medium drop-shadow-md">Actualiza tu imagen de perfil</p>
                        </div>
                    </div>

                    <!-- Contenido principal -->
                    <div class="p-8">
                        <!-- Preview de la foto actual -->
                        <div class="flex flex-col items-center mb-6">
                            <div class="relative mb-4">
                                <img id="photoPreview" class="w-32 h-32 rounded-full object-cover border-4 border-purple-200 shadow-lg" src="../images/default-avatar.png" alt="Preview">
                                <div class="absolute bottom-0 right-0 bg-purple-600 text-white rounded-full p-2 shadow-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-gray-500 text-sm text-center">Elige una nueva imagen desde tu dispositivo</p>
                        </div>

                        <!-- Input de archivo estilizado -->
                        <label for="photoInput" class="block w-full cursor-pointer mb-4">
                            <div class="w-full bg-gradient-to-r from-purple-100 to-indigo-100 hover:from-purple-200 hover:to-indigo-200 border-2 border-dashed border-purple-300 rounded-2xl p-6 text-center transition-all duration-200">
                                <svg class="w-12 h-12 text-purple-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-purple-700 font-semibold">Haz clic para seleccionar</p>
                                <p class="text-purple-600 text-xs mt-1">JPG, PNG o GIF (max. 5MB)</p>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" class="hidden">
                        </label>

                        <!-- Botones de acci√≥n -->
                        <div class="flex gap-3">
                            <button id="cancelPhotoBtn" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95">
                                Cancelar
                            </button>
                            <button id="savePhotoBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Temas y Fondos -->
            <div id="themesModal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; padding: 1rem;">
                <div class="modal-content" style="position: relative; z-index: 10000; background: white; border-radius: 32px; width: 100%; max-width: 48rem; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-500 p-8 text-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 15px, rgba(255,255,255,.15) 15px, rgba(255,255,255,.15) 30px);"></div>
                        
                        <div class="relative z-10">
                            <div class="inline-block mb-3">
                                <svg class="w-20 h-20 text-yellow-300 drop-shadow-lg" style="filter: drop-shadow(0 0 12px rgba(253, 224, 71, 0.6));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                </svg>
                            </div>
                            <h2 class="text-4xl font-extrabold text-white drop-shadow-lg mb-2">Temas y Fondos</h2>
                            <p class="text-white/90 text-lg font-medium drop-shadow-md">Personaliza la apariencia de tu dashboard</p>
                        </div>
                    </div>

                    <!-- Contenido principal -->
                    <div class="overflow-y-auto p-8" style="max-height: 60vh;">
                        <!-- Categor√≠a: Fondo Original (Predeterminado) -->
                        <div class="mb-8 pb-6 border-b-2 border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <svg class="w-7 h-7 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                </svg>
                                <span>Fondo Original</span>
                                <span class="text-xs font-semibold bg-green-100 text-green-700 px-3 py-1 rounded-full">Recomendado</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-md">
                                <button class="theme-option group relative" data-theme="default" data-theme-name="Fondo Code Kids">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(to bottom right, #f9fafb 0%, #f3f4f6 100%);">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <svg class="w-16 h-16 text-indigo-400 opacity-30" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                            </svg>
                                        </div>
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700 text-center">Predeterminado Code Kids</p>
                                </button>
                            </div>
                        </div>

                        <!-- Categor√≠a: Ocean (Oc√©ano) -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/>
                                </svg>
                                Oc√©ano
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <button class="theme-option group relative" data-theme="ocean-blue" data-theme-name="Azul Oc√©ano">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Azul Oc√©ano</p>
                                </button>
                                <button class="theme-option group relative" data-theme="ocean-deep" data-theme-name="Oc√©ano Profundo">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="absolute bottom-0 left-0 right-0 bg-black/40 backdrop-blur-sm px-2 py-1">
                                            <p class="text-xs italic text-white/90 text-center">Solo con modo oscuro</p>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Oc√©ano Profundo</p>
                                </button>
                                <button class="theme-option group relative" data-theme="ocean-tropical" data-theme-name="Tropical">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Tropical</p>
                                </button>
                            </div>
                        </div>

                        <!-- Categor√≠a: Space (Espacio) -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                                Espacio
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <button class="theme-option group relative" data-theme="space-purple" data-theme-name="Nebulosa P√∫rpura">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="absolute bottom-0 left-0 right-0 bg-black/40 backdrop-blur-sm px-2 py-1">
                                            <p class="text-xs italic text-white/90 text-center">Solo con modo oscuro</p>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Nebulosa P√∫rpura</p>
                                </button>
                                <button class="theme-option group relative" data-theme="space-galaxy" data-theme-name="Galaxia">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="absolute bottom-0 left-0 right-0 bg-black/40 backdrop-blur-sm px-2 py-1">
                                            <p class="text-xs italic text-white/90 text-center">Solo con modo oscuro</p>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Galaxia</p>
                                </button>
                                <button class="theme-option group relative" data-theme="space-aurora" data-theme-name="Aurora Boreal">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #13547a 0%, #80d0c7 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="absolute bottom-0 left-0 right-0 bg-black/40 backdrop-blur-sm px-2 py-1">
                                            <p class="text-xs italic text-white/90 text-center">Solo con modo oscuro</p>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Aurora Boreal</p>
                                </button>
                            </div>
                        </div>

                        <!-- Categor√≠a: Solid (S√≥lidos) -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                </svg>
                                Colores S√≥lidos
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <button class="theme-option group relative" data-theme="solid-purple" data-theme-name="P√∫rpura CodeKids">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">P√∫rpura</p>
                                </button>
                                <button class="theme-option group relative" data-theme="solid-cyan" data-theme-name="Cyan CodeKids">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Cyan</p>
                                </button>
                                <button class="theme-option group relative" data-theme="solid-orange" data-theme-name="Naranja CodeKids">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Naranja</p>
                                </button>
                            </div>
                        </div>

                        <!-- Categor√≠a: Abstract (Abstracto) -->
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                                </svg>
                                Dise√±os Abstractos
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <button class="theme-option group relative" data-theme="abstract-sunset" data-theme-name="Atardecer">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Atardecer</p>
                                </button>
                                <button class="theme-option group relative" data-theme="abstract-rainbow" data-theme-name="Arco√≠ris">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Arco√≠ris</p>
                                </button>
                                <button class="theme-option group relative" data-theme="abstract-fire" data-theme-name="Fuego">
                                    <div class="theme-preview w-full aspect-video rounded-xl shadow-lg group-hover:shadow-xl transition-all duration-200 group-hover:scale-105 border-4 border-transparent relative overflow-hidden" style="background: linear-gradient(135deg, #f12711 0%, #f5af19 100%);">
                                        <div class="theme-checkmark hidden absolute top-2 right-2 bg-white rounded-full p-1.5 shadow-lg">
                                            <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-sm font-semibold text-gray-700">Fuego</p>
                                </button>
                            </div>
                        </div>

                        <!-- Tema actual seleccionado -->
                        <div class="mt-6 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                            <p class="text-sm text-gray-600">Tema actual: <span id="currentThemeName" class="font-bold text-indigo-700">Fondo Code Kids</span></p>
                        </div>
                    </div>

                    <!-- Bot√≥n de cierre -->
                    <div class="p-6 bg-gray-50 border-t border-gray-200">
                        <button id="closeThemesBtn" class="w-full bg-gradient-to-r from-orange-500 via-pink-500 to-rose-500 hover:from-orange-600 hover:via-pink-600 hover:to-rose-600 text-white font-bold text-lg py-4 rounded-2xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl active:scale-95 flex items-center justify-center gap-3 shadow-xl">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal de Reportar Problema -->
            <div id="reportProblemModal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; padding: 1rem;">
                <div class="modal-content" style="position: relative; z-index: 10000; background: white; border-radius: 32px; width: 100%; max-width: 36rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    
                    <!-- Header con gradiente -->
                    <div class="bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 p-8 text-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-20" style="background: repeating-linear-gradient(45deg, transparent, transparent 15px, rgba(255,255,255,.15) 15px, rgba(255,255,255,.15) 30px);"></div>
                        
                        <div class="relative z-10">
                            <div class="inline-block mb-3">
                                <svg class="w-20 h-20 text-yellow-100 drop-shadow-lg" style="filter: drop-shadow(0 0 12px rgba(254, 243, 199, 0.6));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                            <h2 class="text-4xl font-extrabold text-white drop-shadow-lg mb-2">Reportar Problema</h2>
                            <p class="text-white/90 text-lg font-medium drop-shadow-md">Tu opini√≥n nos ayuda a mejorar</p>
                        </div>
                    </div>

                    <!-- Contenido principal -->
                    <div class="p-8">
                        <!-- Categor√≠a del problema -->
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-3">Categor√≠a del problema</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="report-category-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-amber-500 hover:bg-amber-50 transition-all duration-200 text-left font-medium text-gray-700" data-category="error">
                                    <span class="text-xl mr-2">üêõ</span> Error t√©cnico
                                </button>
                                <button class="report-category-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 text-left font-medium text-gray-700" data-category="sugerencia">
                                    <span class="text-xl mr-2">üí°</span> Sugerencia
                                </button>
                                <button class="report-category-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all duration-200 text-left font-medium text-gray-700" data-category="contenido">
                                    <span class="text-xl mr-2">üìö</span> Contenido
                                </button>
                                <button class="report-category-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all duration-200 text-left font-medium text-gray-700" data-category="otro">
                                    <span class="text-xl mr-2">‚ùì</span> Otro
                                </button>
                            </div>
                        </div>

                        <!-- Descripci√≥n del problema -->
                        <div class="mb-6">
                            <label for="problemDescription" class="block text-gray-700 font-semibold mb-3">Describe el problema</label>
                            <textarea id="problemDescription" rows="5" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:outline-none transition-colors resize-none" placeholder="Cu√©ntanos qu√© sucedi√≥ o qu√© te gustar√≠a mejorar..."></textarea>
                            <p class="text-xs text-gray-500 mt-2">M√≠nimo 10 caracteres</p>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="flex gap-3">
                            <button id="cancelReportBtn" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95">
                                Cancelar
                            </button>
                            <button id="sendReportBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Enviar Reporte
                            </button>
                        </div>

                        <!-- Mensaje de √©xito (oculto por defecto) -->
                        <div id="reportSuccessMessage" class="hidden mt-4 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                            <p class="text-green-700 font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                ¬°Reporte enviado con √©xito!
                            </p>
                            <p class="text-green-600 text-sm mt-1">Gracias por ayudarnos a mejorar üöÄ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n COLECCI√ìN DE ROBOTS -->
            <section id="section-coleccion" class="hidden" data-section>
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Mi Colecci√≥n de Robots
                    </h2>
                    <p class="text-gray-600">Colecciona robots √∫nicos completando lecciones y desaf√≠os. ¬°Desbloquea cofres especiales!</p>
                </div>

                <!-- Estad√≠sticas de Colecci√≥n -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold opacity-90">Total Coleccionados</span>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="robotsCollected">0</div>
                        <div class="text-xs opacity-75 mt-1">de 50 robots</div>
                    </div>

                    <div class="bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold opacity-90">Cofres Disponibles</span>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="chestsAvailable">0</div>
                        <div class="text-xs opacity-75 mt-1">listos para abrir</div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold opacity-90">Robots Legendarios</span>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="legendaryRobots">0</div>
                        <div class="text-xs opacity-75 mt-1">de 5 legendarios</div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-teal-600 rounded-xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold opacity-90">Nivel de Colecci√≥n</span>
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-3xl font-bold" id="collectionLevel">1</div>
                        <div class="text-xs opacity-75 mt-1">Coleccionista Novato</div>
                    </div>
                </div>

                <!-- Filtros de Colecci√≥n -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold transition hover:bg-purple-700 collection-filter active" data-filter="all">Todos</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="comun">Com√∫n</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="raro">Raro</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="especial">Especial</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="epico">√âpico</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="legendario">Legendario</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold transition hover:bg-gray-300 collection-filter" data-filter="one-in-million">One in a Million</button>
                </div>

                <!-- Grid de Robots -->
                <div id="robotsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- Los robots se cargar√°n din√°micamente aqu√≠ -->
                    <div class="text-center py-12 col-span-full text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                        <p class="text-lg font-semibold mb-2">Tu colecci√≥n est√° vac√≠a</p>
                        <p class="text-sm">Completa lecciones y desaf√≠os para desbloquear robots</p>
                    </div>
                </div>

                <!-- Modal de Cofre -->
                <div id="chestModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl w-full max-w-md p-8 shadow-2xl relative text-center">
                        <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl" onclick="document.getElementById('chestModal').classList.add('hidden')">‚úï</button>
                        <div id="chestContent">
                            <!-- Contenido del cofre se cargar√° aqu√≠ -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n GRUPOS -->
            <section id="section-grupos" class="hidden" data-section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold flex items-center gap-2 section-title">Mis Grupos</h2>
                    <button id="btnNewPost" class="btn btn-primary">Nuevo Post</button>
                </div>
                
                <!-- Formulario para nuevo post -->
                <div id="newPostForm" class="hidden card mb-4 p-4">
                    <textarea id="newPostContent" class="form-input mb-2" rows="3" placeholder="¬øQu√© quieres compartir con tu grupo?"></textarea>
                    <div class="flex gap-2">
                        <button id="submitPost" class="btn btn-primary">Publicar</button>
                        <button id="cancelPost" class="btn bg-gray-300 hover:bg-gray-400">Cancelar</button>
                    </div>
                </div>
                
                <!-- Feed de posts -->
                <div id="groupsFeed" class="space-y-4">
                    <div class="text-center text-gray-400 py-8">Cargando posts...</div>
                </div>
            </section>

            <!-- Modal de perfil de usuario -->
            <div id="userProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">Perfil de Usuario</h3>
                        <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <img id="modalUserAvatar" class="w-20 h-20 rounded-full" alt="Avatar">
                        <div>
                            <div id="modalUserName" class="text-lg font-bold"></div>
                            <div id="modalUserRole" class="text-sm text-gray-500"></div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="modalChatBtn" class="btn btn-primary flex-1">Enviar Mensaje</button>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n CHATS -->
            <section id="section-chats" class="hidden" data-section>
                <div class="grid lg:grid-cols-4 gap-4 h-full" style="min-height: 60vh;">
                    <!-- Lista de Conversaciones -->
                    <div class="lg:col-span-1 card p-0 flex flex-col">
                        <div class="p-3 border-b text-xs font-semibold text-gray-500 flex items-center justify-between">
                            <span>Mensajes</span>
                            <button id="newChatBtn" class="text-indigo-600 hover:text-indigo-800" title="Nuevo chat" onclick="showNewChatModal && showNewChatModal()">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="chatConversations" class="flex-1 overflow-y-auto">
                            <!-- Conversaciones cargadas din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- √Årea de Mensajes -->
                    <div class="lg:col-span-3 card p-0 flex flex-col">
                        <div id="chatHeader" class="p-3 border-b flex items-center justify-between hidden">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <img id="chatRecipientAvatar" class="w-10 h-10 rounded-full" alt="Avatar">
                                    <div id="chatPresenceIndicator" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full" title="En l√≠nea"></div>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold" id="chatRecipientName"></div>
                                    <div class="text-xs text-gray-500" id="chatRecipientStatus">En l√≠nea</div>
                                </div>
                            </div>
                        </div>
                        <div id="chatMessagesArea" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            <div class="text-center text-gray-400 py-8">
                                Selecciona una conversaci√≥n o inicia un chat nuevo
                            </div>
                        </div>
                        <div id="chatInputArea" class="p-4 border-t bg-white hidden">
                            <div class="flex items-center gap-2">
                                <!-- Bot√≥n Emojis -->
                                <button id="emojiBtn" class="chat-action-btn" title="Enviar Emoji" aria-label="Seleccionar emoji">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                                
                                <!-- Bot√≥n Fotos -->
                                <button id="photoBtn" class="chat-action-btn" title="Enviar Foto" aria-label="Adjuntar imagen">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="file" id="photoInput" accept="image/*" class="hidden">
                                
                                <!-- Bot√≥n Audio -->
                                <button id="audioBtn" class="chat-action-btn" title="Grabar Audio" aria-label="Grabar mensaje de voz">
                                    <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                    <svg id="stopIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 6h12v12H6z"></path>
                                    </svg>
                                </button>
                                <span id="recordingTimer" class="text-sm text-red-600 font-semibold hidden">0:00</span>
                                
                                <!-- Campo de texto -->
                                <input id="chatMessageInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Escribe un mensaje..." />
                                
                                <!-- Bot√≥n Enviar -->
                                <button id="chatSendBtn" class="chat-send-btn disabled" disabled aria-label="Enviar mensaje">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Panel de Emojis -->
                            <div id="emojiPicker" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border">
                                <div class="text-xs text-gray-500 mb-2 font-semibold">Emojis Frecuentes</div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="emoji-btn">üòÄ</button>
                                    <button class="emoji-btn">üòÇ</button>
                                    <button class="emoji-btn">üòç</button>
                                    <button class="emoji-btn">üòé</button>
                                    <button class="emoji-btn">üòâ</button>
                                    <button class="emoji-btn">üòä</button>
                                    <button class="emoji-btn">ü§î</button>
                                    <button class="emoji-btn">üò¢</button>
                                    <button class="emoji-btn">üò≠</button>
                                    <button class="emoji-btn">üò±</button>
                                    <button class="emoji-btn">üò°</button>
                                    <button class="emoji-btn">üëç</button>
                                    <button class="emoji-btn">üëé</button>
                                    <button class="emoji-btn">üëè</button>
                                    <button class="emoji-btn">üëå</button>
                                    <button class="emoji-btn">‚ù§Ô∏è</button>
                                    <button class="emoji-btn">üíî</button>
                                    <button class="emoji-btn">üî•</button>
                                    <button class="emoji-btn">‚≠ê</button>
                                    <button class="emoji-btn">üéâ</button>
                                    <button class="emoji-btn">üéà</button>
                                    <button class="emoji-btn">üéÅ</button>
                                    <button class="emoji-btn">üèÜ</button>
                                    <button class="emoji-btn">üí™</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Racha -->
            <section id="section-racha" class="hidden" data-section>
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><span>üî•</span> Tu Racha</h2>
                <div id="streakCalendar" class="grid grid-cols-7 gap-2 mb-6"></div>
                <p class="text-sm text-gray-600">M√°xima racha: <span id="maxStreak">0</span> d√≠as</p>
            </section>

            <!-- Secci√≥n Tareas -->
            <section id="section-tareas" class="hidden" data-section>
                <!-- Header de Misiones -->
                <div class="missions-header-tareas">
                    <h1 class="missions-title-tareas">¬°Tus Misiones Pendientes!</h1>
                    <p class="missions-subtitle-tareas">Completa los desaf√≠os y gana incre√≠bles recompensas</p>
                </div>

                <!-- Filtros -->
                <div class="mission-filters">
                    <button class="filter-tab active">Todas</button>
                    <button class="filter-tab">Pendientes</button>
                    <button class="filter-tab">Vencidas</button>
                    <button class="filter-tab">Completadas</button>
                </div>

                <!-- Grid de Tareas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: grid !important; visibility: visible !important; opacity: 1 !important;">
                    
                    <!-- Tarea 1: Pendiente Urgente -->
                    <div class="mission-card-tarea urgent" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                        <div class="mission-card-header">
                            <svg class="mission-icon w-10 h-10 text-rose-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M4 6h10v12H4z" fill="currentColor" opacity="0.08"/>
                                <path d="M14 6l6 3-6 3" stroke="currentColor"/>
                                <circle cx="6" cy="12" r="1" fill="currentColor"/>
                            </svg>
                            <div class="mission-status-badge pending">Pendiente</div>
                        </div>
                        
                        <h3 class="mission-title">Desaf√≠o del Bucle Infinito</h3>
                        
                        <p class="mission-description">
                            Encuentra y corrige el error en el bucle que est√° causando que el programa se congele.
                        </p>
                        
                        <div class="mission-timer urgent">
                            <svg class="inline-block w-5 h-5 mr-2 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                <path d="M12 8v5l3 2" stroke="currentColor"/>
                            </svg>
                            <span>¬°Quedan 8 horas!</span>
                        </div>
                        
                        <div class="mission-rewards">
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 2l2.6 6.6L21 9l-5 3.6L17.2 21 12 17.8 6.8 21 8 12.6 3 9l6.4-0.4L12 2z" fill="currentColor"/>
                                </svg>
                                <span>+50 XP</span>
                            </div>
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                                </svg>
                                <span>+10 Monedas</span>
                            </div>
                        </div>
                        
                        <button class="mission-action-btn">
                            ¬°Empezar Desaf√≠o!
                        </button>
                    </div>

                    <!-- Tarea 2: Pendiente Normal -->
                    <div class="mission-card-tarea" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                        <div class="mission-card-header">
                            <svg class="mission-icon w-10 h-10 text-rose-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M4 6h10v12H4z" fill="currentColor" opacity="0.08"/>
                                <path d="M14 6l6 3-6 3" stroke="currentColor"/>
                                <circle cx="6" cy="12" r="1" fill="currentColor"/>
                            </svg>
                            <div class="mission-status-badge pending">Pendiente</div>
                        </div>
                        
                        <h3 class="mission-title">La Variable Perdida</h3>
                        
                        <p class="mission-description">
                            Declara correctamente las variables necesarias para que el programa funcione.
                        </p>
                        
                        <div class="mission-timer">
                            <svg class="inline-block w-5 h-5 mr-2 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                <path d="M12 8v5l3 2" stroke="currentColor"/>
                            </svg>
                            <span>Quedan 3 d√≠as</span>
                        </div>
                        
                        <div class="mission-rewards">
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 2l2.6 6.6L21 9l-5 3.6L17.2 21 12 17.8 6.8 21 8 12.6 3 9l6.4-0.4L12 2z" fill="currentColor"/>
                                </svg>
                                <span>+30 XP</span>
                            </div>
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                                </svg>
                                <span>Insignia Detective</span>
                            </div>
                        </div>
                        
                        <button class="mission-action-btn">
                            ¬°Empezar Desaf√≠o!
                        </button>
                    </div>

                    <!-- Tarea 3: Pendiente -->
                    <div class="mission-card-tarea" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                        <div class="mission-card-header">
                            <svg class="mission-icon w-10 h-10 text-rose-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M4 6h10v12H4z" fill="currentColor" opacity="0.08"/>
                                <path d="M14 6l6 3-6 3" stroke="currentColor"/>
                                <circle cx="6" cy="12" r="1" fill="currentColor"/>
                            </svg>
                            <div class="mission-status-badge pending">Pendiente</div>
                        </div>
                        
                        <h3 class="mission-title">Funci√≥n M√°gica de Colores</h3>
                        
                        <p class="mission-description">
                            Crea una funci√≥n que devuelva el color favorito del usuario.
                        </p>
                        
                        <div class="mission-timer">
                            <svg class="inline-block w-5 h-5 mr-2 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="12" r="7" fill="currentColor" opacity="0.08"/>
                                <path d="M12 8v5l3 2" stroke="currentColor"/>
                            </svg>
                            <span>Quedan 2 d√≠as</span>
                        </div>
                        
                        <div class="mission-rewards">
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 2l2.6 6.6L21 9l-5 3.6L17.2 21 12 17.8 6.8 21 8 12.6 3 9l6.4-0.4L12 2z" fill="currentColor"/>
                                </svg>
                                <span>+40 XP</span>
                            </div>
                            <div class="reward-item">
                                <svg class="inline-block w-4 h-4 mr-1 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                                </svg>
                                <span>+15 Monedas</span>
                            </div>
                        </div>
                        
                        <button class="mission-action-btn">
                            ¬°Empezar Desaf√≠o!
                        </button>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="../js/global-ui.js"></script>
    <script type="module">
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc, collection, query, where, getDocs, limit, orderBy, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { addXP, updateGamificationHeader } from '../js/gamification.js';
        
        // Hacer funciones globales para que las funciones inline puedan usarlas
        window.addXP = addXP;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.onSnapshot = onSnapshot;
        window.updateDoc = updateDoc;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.serverTimestamp = serverTimestamp;

        let currentUserData = null;

        // Verificar autenticaci√≥n
        onAuthStateChanged(window.auth, async (user) => {
            if (!user) {
                // No redirigir aqu√≠: deja que initAuth gestione las redirecciones para evitar expulsi√≥n temprana
                return;
            }
            // Cargar datos del usuario
            await loadUserData(user.uid);
            await loadDashboardData();
            
            // INICIALIZAR BUSCADOR SOLO CUANDO EL USUARIO EST√â AUTENTICADO
            console.log('‚úÖ Usuario autenticado - habilitando b√∫squeda');
            window.searchEnabled = true;
        });

        // Cargar datos del usuario
        async function loadUserData(uid) {
            const userDoc = await getDoc(doc(window.db, 'users', uid));
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                // NO llamar a updateUI aqu√≠ - initAuth se encarga de todo
                // updateUI(currentUserData);
                console.log('üìä loadUserData (vieja funci√≥n) - datos cargados pero NO actualizando UI');
            }
        }

        // Actualizar UI con datos del usuario
        function updateUI(userData) {
            document.getElementById('userName').textContent = userData.displayName || 'Usuario';
            document.getElementById('welcomeName').textContent = userData.displayName || 'Estudiante';
            document.getElementById('userRole').textContent = capitalizeFirst(userData.rol || 'estudiante');
            
            // NO sobrescribir userLevel y userXP - gamification.js se encarga de eso
            // document.getElementById('userLevel').textContent = `Nivel ${userData.nivel || 1}`;
            // document.getElementById('userXP').textContent = `${userData.xp || 0} XP`;
            
            // Avatar
            const avatar = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'Usuario')}&background=667eea&color=fff`;
            document.getElementById('userAvatar').src = avatar;

            // Racha
            const streak = userData.racha || 0;
            document.getElementById('streakDays').textContent = streak;
            document.getElementById('streakProgress').style.width = `${Math.min(streak * 10, 100)}%`;

            // Estad√≠sticas
            const progreso = userData.progreso || {};
            document.getElementById('statsLessons').textContent = progreso.leccionesCompletadas || 0;
            document.getElementById('statsGames').textContent = progreso.juegosJugados || 0;
            document.getElementById('statsBadges').textContent = (userData.insignias || []).length;
            document.getElementById('statsTime').textContent = `${Math.round((progreso.tiempoTotal || 0) / 60)}h`;

            // Progreso visual
            const totalLessons = 20; // Total de lecciones disponibles
            const completedLessons = progreso.leccionesCompletadas || 0;
            document.getElementById('progressLessons').style.width = `${(completedLessons / totalLessons) * 100}%`;
            
            const totalGames = 10;
            const playedGames = progreso.juegosJugados || 0;
            document.getElementById('progressGames').style.width = `${(playedGames / totalGames) * 100}%`;
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            await loadNextLessons();
            await loadBadges();
        }

        // Cargar pr√≥ximas lecciones
        async function loadNextLessons() {
            const container = document.getElementById('lessonsContainer');
            
            try {
                // Obtener lecciones de Firestore
                const lessonsRef = collection(window.db, 'lecciones');
                const q = query(lessonsRef, orderBy('orden'), limit(3));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <p class="text-gray-500">No hay lecciones disponibles a√∫n.</p>
                            <p class="text-sm text-gray-400 mt-2">Tu profesor agregar√° lecciones pronto.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const lesson = doc.data();
                    container.innerHTML += createLessonCard(lesson, doc.id);
                });
            } catch (error) {
                console.error('Error cargando lecciones:', error);
                container.innerHTML = `
                    <div class="col-span-3 text-center py-12">
                        <p class="text-red-500">Error al cargar lecciones</p>
                    </div>
                `;
            }
        }

        // Crear tarjeta de lecci√≥n
        function createLessonCard(lesson, id) {
            const completada = currentUserData?.leccionesCompletadas?.includes(id) || false;
            
            return `
                <div class="card hover-lift cursor-pointer" onclick="window.location.href='lecciones.html?id=${id}'">
                    <div class="flex items-center justify-between mb-3">
                        <span class="badge badge-primary">${lesson.categoria || 'Python'}</span>
                        ${completada ? '<span class="badge badge-success">‚úì Completada</span>' : ''}
                    </div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${lesson.titulo || 'Lecci√≥n'}</h3>
                    <p class="text-gray-600 text-sm mb-4">${lesson.descripcion || 'Descripci√≥n de la lecci√≥n'}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span>${lesson.duracion || '10'} min</span>
                        <span>${lesson.dificultad || 'F√°cil'}</span>
                    </div>
                    <div class="mt-4">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${completada ? 100 : lesson.progreso || 0}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Cargar insignias
        async function loadBadges() {
            const container = document.getElementById('badgesContainer');
            const badges = currentUserData?.insignias || [];

                const allBadges = [
                { id: 'first_lesson', name: 'Primera Lecci√≥n', icon: '', unlocked: badges.includes('first_lesson') },
                { id: 'streak_7', name: 'Racha 7 d√≠as', icon: 'üî•', unlocked: badges.includes('streak_7') },
                { id: 'game_master', name: 'Maestro Jugador', icon: '', unlocked: badges.includes('game_master') },
                { id: 'code_ninja', name: 'Code Ninja', icon: '', unlocked: badges.includes('code_ninja') }
            ];

            container.innerHTML = allBadges.map(badge => `
                <div class="achievement-card ${badge.unlocked ? 'unlocked' : 'locked'}">
                    <div class="text-4xl mb-2" aria-hidden="true">${badge.icon || ''}</div>
                    <p class="font-semibold text-sm">${badge.name}</p>
                    ${badge.unlocked ? '<span class="badge badge-success mt-2">‚úì Desbloqueada</span>' : '<span class="badge mt-2" style="background: #cbd5e1; color: #64748b;">Bloqueada</span>'}
                </div>
            `).join('');
        }

        // Abrir Configuraci√≥n (GlobalSettings modal)
        document.getElementById('btnOpenSettings')?.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.openGlobalSettings) window.openGlobalSettings(e.currentTarget);
        });

        // Cerrar sesi√≥n
        window.logout = function() {
            document.getElementById('logoutModal').classList.remove('hidden');
        };

        // Confirmar cierre de sesi√≥n
        document.getElementById('confirmLogoutBtn')?.addEventListener('click', async () => {
            try {
                document.getElementById('logoutModal').classList.add('hidden');
                try { localStorage.removeItem('codekids_user_state'); } catch(_){ }
                await signOut(window.auth);
                window.location.href = '../auth/login.html';
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('üòÖ ¬°Ups! Algo sali√≥ mal. Intenta cerrar sesi√≥n de nuevo.');
            }
        });

        // Cancelar cierre de sesi√≥n
        document.getElementById('cancelLogoutBtn')?.addEventListener('click', () => {
            document.getElementById('logoutModal').classList.add('hidden');
        });

        // Cerrar modal al hacer clic en el fondo
        document.getElementById('logoutModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'logoutModal') {
                e.target.classList.add('hidden');
            }
        });

        // ===== MODAL DE PROGRESO DE NIVEL =====
        
        // Funci√≥n para abrir el modal con datos din√°micos
        window.showLevelProgressModal = function(currentLevel, currentXP, maxXP, nextLevel) {
            const modal = document.getElementById('levelProgressModal');
            const percentage = Math.round((currentXP / maxXP) * 100);
            const xpRemaining = maxXP - currentXP;
            
            // Actualizar contenido del modal
            document.getElementById('modalCurrentLevel').textContent = `Nivel ${currentLevel}`;
            document.getElementById('modalXPPercentage').textContent = `${percentage}%`;
            document.getElementById('modalXPBar').style.width = `${percentage}%`;
            document.getElementById('modalXPBarText').textContent = `${currentXP}/${maxXP} XP`;
            document.getElementById('modalXPRemaining').textContent = `${xpRemaining} XP`;
            document.getElementById('modalNextLevel').textContent = `Nivel ${nextLevel}`;
            document.getElementById('modalRewardsLevel').textContent = `Nivel ${nextLevel}`;
            
            // Mostrar modal y bloquear scroll
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        };
        
        // Cerrar modal de nivel
        document.getElementById('closeLevelModalBtn')?.addEventListener('click', () => {
            const modal = document.getElementById('levelProgressModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        });
        
        // Cerrar modal al hacer clic en el fondo
        document.getElementById('levelProgressModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'levelProgressModal') {
                e.target.classList.add('hidden');
                e.target.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });
        
        // Funci√≥n auxiliar para abrir el modal al hacer clic en el badge de nivel
        const userLevelBadge = document.getElementById('userLevel');
        if (userLevelBadge) {
            userLevelBadge.addEventListener('click', () => {
                console.log('üéØ Click en badge de nivel detectado');
                
                // Obtener datos actuales del usuario
                const levelText = userLevelBadge.textContent || 'Nivel 1';
                const currentLevel = parseInt(levelText.match(/\d+/)?.[0] || 1);
                const currentXPElement = document.getElementById('currentXP');
                const maxXPElement = document.getElementById('maxXP');
                
                const currentXP = parseInt(currentXPElement?.textContent || 0);
                const maxXP = parseInt(maxXPElement?.textContent || 150);
                const nextLevel = currentLevel + 1;
                
                console.log('üìä Datos del modal:', { currentLevel, currentXP, maxXP, nextLevel });
                
                showLevelProgressModal(currentLevel, currentXP, maxXP, nextLevel);
            });
            
            console.log('‚úÖ Event listener del badge de nivel registrado');
        } else {
            console.warn('‚ö†Ô∏è No se encontr√≥ el elemento userLevel');
        }

        // ===== SISTEMA DE NOTIFICACIONES CON FIRESTORE =====
        
        let notifications = [];
        let notificationsListener = null;

        // Cargar notificaciones desde Firestore
        async function loadNotifications() {
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    console.warn('‚ö†Ô∏è No hay usuario autenticado');
                    return;
                }

                const notificationsRef = collection(window.db, `users/${user.uid}/notifications`);
                const q = query(notificationsRef, orderBy('createdAt', 'desc'), limit(50));
                
                // Si ya existe un listener, cancelarlo
                if (notificationsListener) {
                    notificationsListener();
                }

                // Escuchar cambios en tiempo real
                notificationsListener = onSnapshot(q, (snapshot) => {
                    notifications = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        notifications.push({
                            id: doc.id,
                            type: data.type || 'info',
                            title: data.title || 'Notificaci√≥n',
                            description: data.description || data.message || '',
                            time: formatTimestamp(data.createdAt),
                            read: data.read || false,
                            icon: getNotificationIcon(data.type),
                            metadata: data.metadata || {},
                            createdAt: data.createdAt
                        });
                    });
                    
                    updateNotificationBadge();
                    console.log('üì¨ Notificaciones actualizadas:', notifications.length);
                });

            } catch (error) {
                console.error('‚ùå Error cargando notificaciones:', error);
            }
        }

        // Obtener icono seg√∫n tipo de notificaci√≥n
        function getNotificationIcon(type) {
            const icons = {
                'tarea': 'üìö',
                'task': 'üìö',
                'assignment': 'üìö',
                'mensaje': '‚úâÔ∏è',
                'message': '‚úâÔ∏è',
                'chat': 'üí¨',
                'logro': 'üèÜ',
                'achievement': 'üèÜ',
                'xp': '‚≠ê',
                'nivel': 'üéØ',
                'level': 'üéØ',
                'alerta': '‚è∞',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            return icons[type] || 'üîî';
        }

        // Formatear timestamp de Firestore
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Hace un momento';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return 'Hace un momento';
            }

            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // diferencia en segundos

            if (diff < 60) return 'Hace un momento';
            if (diff < 3600) return `hace ${Math.floor(diff / 60)} minutos`;
            if (diff < 86400) return `hace ${Math.floor(diff / 3600)} horas`;
            if (diff < 604800) return `hace ${Math.floor(diff / 86400)} d√≠as`;
            
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            const modalCount = document.getElementById('modalNotificationCount');
            if (modalCount) modalCount.textContent = unreadCount;
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            if (notifications.length === 0) {
                container.innerHTML = '<div class="p-12 text-center"><svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><p class="text-gray-500 text-base font-medium">No hay notificaciones</p></div>';
                return;
            }
            let html = '';
            notifications.forEach(n => {
                const bg = n.read ? 'bg-white' : 'bg-gradient-to-r from-purple-50 to-indigo-50 border-l-4 border-purple-500';
                const txt = n.read ? 'text-gray-700' : 'text-gray-900 font-semibold';
                html += `<div class="notification-item ${bg} p-5 hover:bg-gray-50 transition-all duration-200 relative group" data-id="${n.id}"><div class="flex items-start gap-4"><div class="flex-shrink-0 text-3xl mt-1">${n.icon}</div><div class="flex-1 min-w-0"><h4 class="${txt} text-base leading-tight mb-1">${n.title}</h4><p class="text-gray-600 text-sm leading-relaxed mb-2">${n.description}</p><div class="flex items-center gap-2"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="text-gray-400 text-sm">${n.time}</span></div></div><div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">${!n.read ? '<button class="mark-read-btn p-2 hover:bg-green-100 rounded-lg transition-colors" data-id="'+n.id+'" title="Marcar como le√≠do"><svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg></button>' : '<button class="mark-unread-btn p-2 hover:bg-blue-100 rounded-lg transition-colors" data-id="'+n.id+'" title="Marcar como no le√≠do"><svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></button>'}<button class="delete-btn p-2 hover:bg-red-100 rounded-lg transition-colors" data-id="${n.id}" title="Eliminar"><svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></div></div>`;
            });
            container.innerHTML = html;
            attachNotificationListeners();
            updateNotificationBadge();
        }

        function attachNotificationListeners() {
            // Marcar como le√≠da
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const notificationId = btn.dataset.id;
                    await markNotificationAsRead(notificationId);
                });
            });
            
            // Marcar como no le√≠da
            document.querySelectorAll('.mark-unread-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const notificationId = btn.dataset.id;
                    await markNotificationAsUnread(notificationId);
                });
            });
            
            // Eliminar notificaci√≥n
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const notificationId = btn.dataset.id;
                    const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                    
                    if (item) {
                        // Animaci√≥n de salida
                        item.style.transform = 'translateX(100%)';
                        item.style.opacity = '0';
                        item.style.transition = 'all 0.3s ease-out';
                        
                        setTimeout(async () => {
                            await deleteNotification(notificationId);
                        }, 300);
                    }
                });
            });
        }

        // Marcar notificaci√≥n como le√≠da en Firestore
        async function markNotificationAsRead(notificationId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;

                const notificationRef = doc(window.db, `users/${user.uid}/notifications/${notificationId}`);
                await updateDoc(notificationRef, { read: true });
                console.log('‚úÖ Notificaci√≥n marcada como le√≠da');
            } catch (error) {
                console.error('‚ùå Error marcando como le√≠da:', error);
            }
        }

        // Marcar notificaci√≥n como no le√≠da en Firestore
        async function markNotificationAsUnread(notificationId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;

                const notificationRef = doc(window.db, `users/${user.uid}/notifications/${notificationId}`);
                await updateDoc(notificationRef, { read: false });
                console.log('‚úÖ Notificaci√≥n marcada como no le√≠da');
            } catch (error) {
                console.error('‚ùå Error marcando como no le√≠da:', error);
            }
        }

        // Eliminar notificaci√≥n de Firestore
        async function deleteNotification(notificationId) {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;

                const notificationRef = doc(window.db, `users/${user.uid}/notifications/${notificationId}`);
                await window.deleteDoc(notificationRef);
                console.log('‚úÖ Notificaci√≥n eliminada');
            } catch (error) {
                console.error('‚ùå Error eliminando notificaci√≥n:', error);
            }
        }

        // Marcar todas las notificaciones como le√≠das
        async function markAllNotificationsAsRead() {
            try {
                const user = window.auth?.currentUser;
                if (!user) return;

                const unreadNotifications = notifications.filter(n => !n.read);
                
                const updatePromises = unreadNotifications.map(notification => {
                    const notificationRef = doc(window.db, `users/${user.uid}/notifications/${notification.id}`);
                    return updateDoc(notificationRef, { read: true });
                });

                await Promise.all(updatePromises);
                console.log('‚úÖ Todas las notificaciones marcadas como le√≠das');
            } catch (error) {
                console.error('‚ùå Error marcando todas como le√≠das:', error);
            }
        }

        // Event listeners del modal de notificaciones
        document.getElementById('notificationBtn')?.addEventListener('click', () => {
            const modal = document.getElementById('notificationsModal');
            
            // Cargar notificaciones si no se han cargado
            if (notifications.length === 0 && !notificationsListener) {
                loadNotifications();
            }
            
            renderNotifications();
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        });

        document.getElementById('closeNotificationsBtn')?.addEventListener('click', () => {
            const modal = document.getElementById('notificationsModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        });

        document.getElementById('notificationsModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'notificationsModal') {
                const modal = document.getElementById('notificationsModal');
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });

        document.getElementById('markAllReadBtn')?.addEventListener('click', async () => {
            await markAllNotificationsAsRead();
        });

        // Cargar notificaciones al iniciar (solo badge)
        (async function initNotifications() {
            try {
                await loadNotifications();
            } catch (error) {
                console.error('‚ùå Error inicializando notificaciones:', error);
            }
        })();

        // ============================================
        // üì¨ FUNCI√ìN PARA CREAR NOTIFICACIONES (Testing)
        // ============================================
        window.createTestNotification = async function(type = 'tarea') {
            try {
                const user = window.auth?.currentUser;
                if (!user) {
                    console.warn('‚ö†Ô∏è No hay usuario autenticado');
                    return;
                }

                const notificationsRef = collection(window.db, `users/${user.uid}/notifications`);
                
                const testNotifications = {
                    'tarea': {
                        type: 'tarea',
                        title: 'Nueva tarea asignada: Algoritmos en Python',
                        description: 'Completa los ejercicios de ordenamiento y b√∫squeda. Fecha l√≠mite: 25/12/2025',
                        read: false,
                        createdAt: serverTimestamp(),
                        metadata: { taskId: 'task_123', dueDate: '2025-12-25' }
                    },
                    'mensaje': {
                        type: 'mensaje',
                        title: 'Nuevo mensaje de Graciela Salazar Torres',
                        description: '¬øC√≥mo est√°s? Necesito ayuda con el proyecto final de JavaScript...',
                        read: false,
                        createdAt: serverTimestamp(),
                        metadata: { senderId: 'user_456', chatId: 'chat_789' }
                    },
                    'logro': {
                        type: 'logro',
                        title: '¬°Felicitaciones! Nivel 3 Desbloqueado',
                        description: 'Has alcanzado el nivel 3. Nuevos marcos y recompensas disponibles.',
                        read: false,
                        createdAt: serverTimestamp(),
                        metadata: { level: 3, xpEarned: 150 }
                    },
                    'xp': {
                        type: 'xp',
                        title: '¬°Bonus de XP ganado!',
                        description: 'Has ganado 50 puntos de experiencia adicionales por completar la racha de 7 d√≠as.',
                        read: false,
                        createdAt: serverTimestamp(),
                        metadata: { xpAmount: 50, reason: 'streak_7_days' }
                    }
                };

                const notification = testNotifications[type] || testNotifications['tarea'];
                await addDoc(notificationsRef, notification);
                
                console.log('‚úÖ Notificaci√≥n de prueba creada:', type);
            } catch (error) {
                console.error('‚ùå Error creando notificaci√≥n:', error);
            }
        };

        // Funci√≥n helper
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Cargar avatar desde state manager si existe
        (function initAvatarFromState(){
            try {
                if (window.userState?.state?.photoURL) {
                    document.getElementById('userAvatar').src = window.userState.state.photoURL;
                }
            } catch(_){}
        })();

        // Cargar nueva foto desde input y persistir
        function bindAvatarUpload(){
            const fileInput = document.getElementById('avatarUpload');
            if (!fileInput) return;
            fileInput.addEventListener('change', async (e)=>{
                const file = e.target.files?.[0];
                if (!file) return;
                try {
                    const base64 = await window.userState.setProfilePhoto(file);
                    document.getElementById('userAvatar').src = base64;
                    alert('Foto de perfil actualizada.');
                } catch (err){ console.error(err); alert('No se pudo actualizar la foto'); }
            });
        }

        // ============================================
        // üîç BUSCADOR INTELIGENTE CON FIRESTORE
        // ============================================
        const searchInput = document.getElementById('globalSearch');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        // Funci√≥n de b√∫squeda en Firestore
        async function performSearch(query) {
            if (!query || query.trim().length === 0) {
                searchResults.classList.add('hidden');
                return;
            }

            const searchTerm = query.toLowerCase().trim();
            
            // Mostrar indicador de carga
            searchResults.innerHTML = `
                <div class="p-8 text-center">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-purple-500 border-t-transparent mb-3"></div>
                    <p class="text-gray-600 text-sm">Buscando...</p>
                </div>
            `;
            searchResults.classList.remove('hidden');
            
            try {
                // Buscar usuarios
                const usersRef = collection(window.db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const usuarios = [];
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    const nombre = data.displayName || data.email || '';
                    
                    if (nombre.toLowerCase().includes(searchTerm)) {
                        usuarios.push({
                            id: doc.id,
                            nombre: data.displayName || 'Usuario',
                            avatar: data.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=667eea&color=fff`,
                            nivel: data.nivel || 1,
                            email: data.email
                        });
                    }
                });

                // Buscar lecciones (del array COURSES_DASH si existe, o datos simulados)
                const lecciones = [];
                if (window.COURSES_DASH) {
                    window.COURSES_DASH.forEach(course => {
                        course.videos?.forEach(video => {
                            const titulo = video.title || '';
                            if (titulo.toLowerCase().includes(searchTerm) || course.title.toLowerCase().includes(searchTerm)) {
                                lecciones.push({
                                    id: video.id || video.videoId,
                                    titulo: video.title,
                                    curso: course.title,
                                    icono: course.icon || 'üìö',
                                    courseId: course.id
                                });
                            }
                        });
                    });
                }

                // Buscar juegos (del array de juegos si existe)
                const juegos = [];
                const gamesData = [
                    { id: 'maze-runner', nombre: 'Maze Runner', descripcion: 'Resuelve laberintos con c√≥digo', icono: 'üéÆ', ruta: '../games/maze-runner/index.html' },
                    { id: 'code-combat', nombre: 'Code Combat', descripcion: 'Batalla programando', icono: '‚öîÔ∏è', ruta: '#laboratorio' },
                    { id: 'algorithm-race', nombre: 'Algorithm Race', descripcion: 'Carrera de algoritmos', icono: 'üèéÔ∏è', ruta: '#laboratorio' },
                    { id: 'debug-quest', nombre: 'Debug Quest', descripcion: 'Encuentra y corrige bugs', icono: 'üêõ', ruta: '#laboratorio' },
                    { id: 'code-builder', nombre: 'Code Builder', descripcion: 'Construye proyectos paso a paso', icono: 'üèóÔ∏è', ruta: '#laboratorio' },
                    { id: 'logic-puzzle', nombre: 'Logic Puzzle', descripcion: 'Resuelve acertijos l√≥gicos', icono: 'üß©', ruta: '#laboratorio' }
                ];

                gamesData.forEach(game => {
                    if (game.nombre.toLowerCase().includes(searchTerm) || game.descripcion.toLowerCase().includes(searchTerm)) {
                        juegos.push(game);
                    }
                });

                // Renderizar resultados
                renderSearchResults(usuarios, lecciones, juegos, searchTerm);
                
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda:', error);
                searchResults.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-red-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-gray-600 text-sm">Error al buscar</p>
                        <p class="text-gray-400 text-xs mt-2">Intenta nuevamente</p>
                    </div>
                `;
            }
        }

        // Renderizar resultados con dise√±o mejorado
        function renderSearchResults(usuarios, lecciones, juegos, query) {
            let html = '';
            
            const hasResults = usuarios.length > 0 || lecciones.length > 0 || juegos.length > 0;
            
            if (!hasResults) {
                html = `
                    <div class="p-8 text-center">
                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <p class="text-gray-600 font-semibold text-base mb-2">No se encontraron resultados</p>
                        <p class="text-gray-400 text-sm">Intenta buscar con otras palabras clave</p>
                    </div>
                `;
            } else {
                // Usuarios
                if (usuarios.length > 0) {
                    html += `
                        <div class="sticky top-0 z-10">
                            <div class="px-5 py-3 bg-gradient-to-r from-purple-100 via-pink-50 to-purple-50 border-b border-purple-200">
                                <h3 class="text-sm font-bold text-purple-700 uppercase tracking-wide flex items-center gap-2.5">
                                    <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                    </svg>
                                    Usuarios
                                    <span class="ml-auto text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full font-semibold">${usuarios.length}</span>
                                </h3>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-100">
                    `;
                    usuarios.forEach(usuario => {
                        html += `
                            <button onclick="verPerfilUsuario('${usuario.id}')" class="w-full px-5 py-4 hover:bg-purple-50 transition-all duration-200 flex items-center gap-4 text-left group border-l-4 border-transparent hover:border-purple-500">
                                <img src="${usuario.avatar}" alt="${usuario.nombre}" class="w-12 h-12 rounded-full border-2 border-purple-300 shadow-md group-hover:border-purple-500 group-hover:scale-105 transition-all duration-200">
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-gray-900 group-hover:text-purple-700 transition-colors text-base truncate">${usuario.nombre}</div>
                                    <div class="text-sm text-gray-600 flex items-center gap-1.5 mt-0.5">
                                        <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                        <span class="font-semibold">Nivel ${usuario.nivel}</span>
                                    </div>
                                </div>
                                <svg class="w-6 h-6 text-gray-300 group-hover:text-purple-600 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        `;
                    });
                    html += '</div>';
                }

                // Lecciones
                if (lecciones.length > 0) {
                    html += `
                        <div class="sticky top-0 z-10">
                            <div class="px-5 py-3 bg-gradient-to-r from-blue-100 via-cyan-50 to-blue-50 border-b border-blue-200">
                                <h3 class="text-sm font-bold text-blue-700 uppercase tracking-wide flex items-center gap-2.5">
                                    <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
                                    </svg>
                                    Lecciones
                                    <span class="ml-auto text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full font-semibold">${lecciones.length}</span>
                                </h3>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-100">
                    `;
                    lecciones.forEach(leccion => {
                        html += `
                            <button onclick="irALeccion('${leccion.courseId}', '${leccion.id}')" class="w-full px-5 py-4 hover:bg-blue-50 transition-all duration-200 flex items-center gap-4 text-left group border-l-4 border-transparent hover:border-blue-500">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 group-hover:shadow-xl transition-all duration-200">
                                    ${leccion.icono}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-gray-900 group-hover:text-blue-700 transition-colors text-base truncate">${leccion.titulo}</div>
                                    <div class="text-sm text-gray-600 mt-0.5 truncate">${leccion.curso}</div>
                                </div>
                                <svg class="w-6 h-6 text-gray-300 group-hover:text-blue-600 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        `;
                    });
                    html += '</div>';
                }

                // Juegos
                if (juegos.length > 0) {
                    html += `
                        <div class="sticky top-0 z-10">
                            <div class="px-5 py-3 bg-gradient-to-r from-green-100 via-emerald-50 to-green-50 border-b border-green-200">
                                <h3 class="text-sm font-bold text-green-700 uppercase tracking-wide flex items-center gap-2.5">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                                    </svg>
                                    Juegos
                                    <span class="ml-auto text-xs bg-green-600 text-white px-2 py-0.5 rounded-full font-semibold">${juegos.length}</span>
                                </h3>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-100">
                    `;
                    juegos.forEach(juego => {
                        html += `
                            <button onclick="irAJuego('${juego.id}', '${juego.ruta}')" class="w-full px-5 py-4 hover:bg-green-50 transition-all duration-200 flex items-center gap-4 text-left group border-l-4 border-transparent hover:border-green-500">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 group-hover:shadow-xl transition-all duration-200">
                                    ${juego.icono}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-gray-900 group-hover:text-green-700 transition-colors text-base truncate">${juego.nombre}</div>
                                    <div class="text-sm text-gray-600 mt-0.5 truncate">${juego.descripcion}</div>
                                </div>
                                <svg class="w-6 h-6 text-gray-300 group-hover:text-green-600 group-hover:translate-x-1 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        `;
                    });
                    html += '</div>';
                }
            }

            searchResults.innerHTML = html;
            searchResults.classList.remove('hidden');
        }

        // Event listeners para el buscador
        if (searchInput) {
            // Mostrar resultados al escribir (sin m√≠nimo de caracteres)
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value;
                
                if (query.trim().length === 0) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                // Debounce de 300ms
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            searchInput.addEventListener('focus', (e) => {
                if (e.target.value.trim().length > 0) {
                    performSearch(e.target.value);
                }
            });

            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // Prevenir que se cierre al hacer clic en los resultados
            searchResults.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // ============================================
        // üîó FUNCIONES DE NAVEGACI√ìN DESDE B√öSQUEDA
        // ============================================
        
        // Ver perfil de usuario
        window.verPerfilUsuario = function(userId) {
            searchResults.classList.add('hidden');
            searchInput.value = '';
            
            // Mostrar modal de perfil de usuario
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                // Cargar datos del usuario
                loadUserProfile(userId);
                modal.classList.remove('hidden');
            } else {
                console.log('üë§ Navegando a perfil:', userId);
                // Alternativamente: window.location.href = `perfil.html?id=${userId}`;
            }
        };

        // Ir a lecci√≥n espec√≠fica
        window.irALeccion = function(courseId, videoId) {
            searchResults.classList.add('hidden');
            searchInput.value = '';
            
            console.log('üìö Navegando a lecci√≥n:', { courseId, videoId });
            
            // Cambiar a la secci√≥n de lecciones
            window.location.hash = 'lecciones';
            
            // Esperar a que la secci√≥n se cargue y luego abrir la lecci√≥n
            setTimeout(() => {
                if (window.openCourse) {
                    window.openCourse(courseId);
                    // Si hay funci√≥n para reproducir video espec√≠fico
                    if (window.playVideo) {
                        window.playVideo(videoId);
                    }
                }
            }, 300);
        };

        // Ir a juego espec√≠fico
        window.irAJuego = function(gameId, ruta) {
            searchResults.classList.add('hidden');
            searchInput.value = '';
            
            console.log('üéÆ Navegando a juego:', { gameId, ruta });
            
            if (ruta.startsWith('#')) {
                // Es una ruta interna (hash)
                window.location.hash = ruta.substring(1);
            } else {
                // Es una ruta externa
                window.open(ruta, '_blank');
            }
        };

        // Cargar datos de perfil de usuario (funci√≥n auxiliar)
        async function loadUserProfile(userId) {
            try {
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('üë§ Datos de usuario cargados:', userData);
                    // Aqu√≠ puedes actualizar el modal con los datos del usuario
                    // Por ejemplo: document.getElementById('profileName').textContent = userData.displayName;
                }
            } catch (error) {
                console.error('‚ùå Error cargando perfil:', error);
            }
        }

        // Toggle dropdown de notificaciones
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationDropdown = document.getElementById('notificationDropdown');
        
        notificationBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown?.classList.toggle('hidden');
            // Cerrar otros dropdowns
            document.getElementById('settingsDropdown')?.classList.add('hidden');
        });

        // Toggle dropdown de configuraci√≥n
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        
        settingsBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown?.classList.toggle('hidden');
            // Cerrar otros dropdowns
            notificationDropdown?.classList.add('hidden');
        });

        // Cerrar dropdowns al hacer click fuera
        document.addEventListener('click', () => {
            notificationDropdown?.classList.add('hidden');
            settingsDropdown?.classList.add('hidden');
        });

        // Toggle Tema Claro/Oscuro (bot√≥n del header)
        const themeToggle = document.getElementById('themeToggle');
        const themeIconLight = document.getElementById('themeIconLight');
        const themeIconDark = document.getElementById('themeIconDark');
        
        // Elementos del men√∫ de configuraci√≥n - Apariencia
        const appearanceOption = document.getElementById('appearanceOption');
        const appearanceIconPath = document.getElementById('appearanceIconPath');
        const currentThemeLabel = document.getElementById('currentThemeLabel');
        
        // Funci√≥n para actualizar tema visual
        function updateThemeUI(isDark) {
            // Actualizar bot√≥n del header
            if (themeIconLight && themeIconDark) {
                themeIconLight.classList.toggle('hidden', isDark);
                themeIconDark.classList.toggle('hidden', !isDark);
            }
            
            // Actualizar opci√≥n de Apariencia en el men√∫
            if (currentThemeLabel) {
                currentThemeLabel.textContent = isDark ? 'Oscuro' : 'Claro';
            }
            
            if (appearanceIconPath) {
                // Cambiar icono: Sol para modo claro, Luna para modo oscuro
                appearanceIconPath.setAttribute('d', isDark 
                    ? 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z'
                    : 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z'
                );
            }
            
            // Sincronizar checkbox del modal de configuraci√≥n
            const toggleDarkModeCheckbox = document.getElementById('toggleDarkMode');
            const darkModeStatus = document.getElementById('darkModeStatus');
            if (toggleDarkModeCheckbox) {
                toggleDarkModeCheckbox.checked = isDark;
            }
            if (darkModeStatus) {
                darkModeStatus.textContent = isDark ? 'Activado' : 'Desactivado';
            }
        }
        
        // Cargar tema guardado
        const currentTheme = localStorage.getItem('app-theme') || 'light';
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark', 'theme-dark');
            updateThemeUI(true);
        } else {
            updateThemeUI(false);
        }
        
        // Toggle desde el bot√≥n del header
        themeToggle?.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                // Cambiar a modo claro
                document.documentElement.classList.remove('dark', 'theme-dark');
                document.body.classList.remove('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'light');
                updateThemeUI(false);
                
                // Restaurar el tema de fondo seleccionado
                const selectedTheme = localStorage.getItem('dashboard-theme') || 'default';
                if (selectedTheme !== 'default') {
                    applyThemeToBackground(selectedTheme);
                }
            } else {
                // Cambiar a modo oscuro
                document.documentElement.classList.add('dark', 'theme-dark');
                document.body.classList.add('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'dark');
                updateThemeUI(true);
            }
        });
        
        // Toggle desde la opci√≥n Apariencia en el men√∫ de Configuraci√≥n
        appearanceOption?.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                // Cambiar a modo claro
                document.documentElement.classList.remove('dark', 'theme-dark');
                document.body.classList.remove('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'light');
                updateThemeUI(false);
                
                // Restaurar el tema de fondo seleccionado
                const selectedTheme = localStorage.getItem('dashboard-theme') || 'default';
                if (selectedTheme !== 'default') {
                    applyThemeToBackground(selectedTheme);
                }
            } else {
                // Cambiar a modo oscuro
                document.documentElement.classList.add('dark', 'theme-dark');
                document.body.classList.add('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'dark');
                updateThemeUI(true);
            }
        });
        
        // Toggle desde el checkbox del modal de configuraci√≥n
        const toggleDarkModeCheckbox = document.getElementById('toggleDarkMode');
        const darkModeStatus = document.getElementById('darkModeStatus');
        
        // Sincronizar estado inicial del checkbox
        if (toggleDarkModeCheckbox) {
            const isDark = document.documentElement.classList.contains('dark');
            toggleDarkModeCheckbox.checked = isDark;
            if (darkModeStatus) {
                darkModeStatus.textContent = isDark ? 'Activado' : 'Desactivado';
            }
        }
        
        toggleDarkModeCheckbox?.addEventListener('change', (e) => {
            const isDark = e.target.checked;
            
            if (isDark) {
                // Cambiar a modo oscuro
                document.documentElement.classList.add('dark', 'theme-dark');
                document.body.classList.add('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'dark');
                updateThemeUI(true);
                if (darkModeStatus) darkModeStatus.textContent = 'Activado';
            } else {
                // Cambiar a modo claro
                document.documentElement.classList.remove('dark', 'theme-dark');
                document.body.classList.remove('dark', 'theme-dark');
                localStorage.setItem('app-theme', 'light');
                updateThemeUI(false);
                if (darkModeStatus) darkModeStatus.textContent = 'Desactivado';
                
                // Restaurar el tema de fondo seleccionado
                const selectedTheme = localStorage.getItem('dashboard-theme') || 'default';
                if (selectedTheme !== 'default') {
                    applyThemeToBackground(selectedTheme);
                }
            }
        });

        // ============================================
        // MODALES DE CONFIGURACI√ìN
        // ============================================
        
        // Modal de Cambiar Foto
        const changePhotoModal = document.getElementById('changePhotoModal');
        const changePhotoBtn = document.getElementById('changePhotoBtn');
        const cancelPhotoBtn = document.getElementById('cancelPhotoBtn');
        const savePhotoBtn = document.getElementById('savePhotoBtn');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        let selectedPhotoFile = null;

        // Abrir modal de cambiar foto
        changePhotoBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown?.classList.add('hidden');
            changePhotoModal.style.display = 'flex';
            setTimeout(() => changePhotoModal.classList.remove('hidden'), 10);
            
            // Cargar foto actual del usuario
            const currentUser = window.auth?.currentUser;
            if (currentUser?.photoURL) {
                photoPreview.src = currentUser.photoURL;
            }
        });

        // Cerrar modal de cambiar foto
        cancelPhotoBtn?.addEventListener('click', () => {
            changePhotoModal.classList.add('hidden');
            setTimeout(() => changePhotoModal.style.display = 'none', 300);
            selectedPhotoFile = null;
            savePhotoBtn.disabled = true;
        });

        // Manejar selecci√≥n de archivo
        photoInput?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen no puede superar los 5MB');
                    return;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert('Por favor selecciona una imagen v√°lida');
                    return;
                }

                // Previsualizar imagen
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoPreview.src = e.target.result;
                    selectedPhotoFile = file;
                    savePhotoBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        // Guardar nueva foto
        savePhotoBtn?.addEventListener('click', async () => {
            if (!selectedPhotoFile) return;
            
            try {
                savePhotoBtn.disabled = true;
                savePhotoBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                
                const currentUser = window.auth?.currentUser;
                if (!currentUser) throw new Error('Usuario no autenticado');

                // Subir imagen a Storage (simulado - en producci√≥n usar Firebase Storage)
                // Por ahora solo actualizamos con el base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const photoURL = e.target.result;
                    
                    // Actualizar en Firestore
                    const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                    await window.updateDoc(userDocRef, { photoURL });
                    
                    // Actualizar en la UI
                    document.querySelectorAll('[data-user-photo]').forEach(img => {
                        img.src = photoURL;
                    });
                    
                    // Cerrar modal
                    changePhotoModal.classList.add('hidden');
                    setTimeout(() => changePhotoModal.style.display = 'none', 300);
                    
                    // Mostrar mensaje de √©xito
                    alert('‚úÖ Foto actualizada correctamente');
                    
                    selectedPhotoFile = null;
                    savePhotoBtn.disabled = true;
                    savePhotoBtn.innerHTML = 'Guardar';
                };
                reader.readAsDataURL(selectedPhotoFile);
                
            } catch (error) {
                console.error('Error al actualizar foto:', error);
                alert('‚ùå Error al actualizar la foto. Int√©ntalo de nuevo.');
                savePhotoBtn.disabled = false;
                savePhotoBtn.innerHTML = 'Guardar';
            }
        });

        // Modal de Temas y Fondos
        const themesModal = document.getElementById('themesModal');
        const themesBtn = document.getElementById('themesBtn');
        const closeThemesBtn = document.getElementById('closeThemesBtn');
        const currentThemeName = document.getElementById('currentThemeName');
        let selectedTheme = localStorage.getItem('dashboard-theme') || 'default';

        // Definici√≥n completa de temas con todos sus atributos
        const THEME_CONFIG = {
            'default': {
                name: 'Fondo Code Kids',
                background: 'linear-gradient(to bottom right, #f9fafb 0%, #f3f4f6 100%)',
                class: 'theme-default',
                isDark: false,
                isDefault: true
            },
            'ocean-blue': {
                name: 'Azul Oc√©ano',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                class: 'theme-ocean-blue',
                isDark: false
            },
            'ocean-deep': {
                name: 'Oc√©ano Profundo',
                background: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                class: 'theme-ocean-deep',
                isDark: true  // Tema oscuro
            },
            'ocean-tropical': {
                name: 'Tropical',
                background: 'linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%)',
                class: 'theme-ocean-tropical',
                isDark: false
            },
            'space-purple': {
                name: 'Nebulosa P√∫rpura',
                background: 'linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%)',
                class: 'theme-space-purple',
                isDark: true  // Tema oscuro
            },
            'space-galaxy': {
                name: 'Galaxia',
                background: 'linear-gradient(135deg, #2c3e50 0%, #3498db 100%)',
                class: 'theme-space-galaxy',
                isDark: true  // Tema oscuro
            },
            'space-aurora': {
                name: 'Aurora Boreal',
                background: 'linear-gradient(135deg, #13547a 0%, #80d0c7 100%)',
                class: 'theme-space-aurora',
                isDark: true  // Tema oscuro
            },
            'solid-purple': {
                name: 'P√∫rpura CodeKids',
                background: 'linear-gradient(135deg, #9333ea 0%, #7e22ce 100%)',
                class: 'theme-solid-purple',
                isDark: false
            },
            'solid-cyan': {
                name: 'Cyan CodeKids',
                background: 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',
                class: 'theme-solid-cyan',
                isDark: false
            },
            'solid-orange': {
                name: 'Naranja CodeKids',
                background: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
                class: 'theme-solid-orange',
                isDark: false
            },
            'abstract-sunset': {
                name: 'Atardecer',
                background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                class: 'theme-abstract-sunset',
                isDark: false
            },
            'abstract-rainbow': {
                name: 'Arco√≠ris',
                background: 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%)',
                class: 'theme-abstract-rainbow',
                isDark: false
            },
            'abstract-fire': {
                name: 'Fuego',
                background: 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)',
                class: 'theme-abstract-fire',
                isDark: false
            }
        };

        // Abrir modal de temas
        themesBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown?.classList.add('hidden');
            themesModal.style.display = 'flex';
            setTimeout(() => themesModal.classList.remove('hidden'), 10);
            
            // Actualizar UI del modal
            updateThemeSelectionUI();
        });

        // Cerrar modal de temas
        closeThemesBtn?.addEventListener('click', () => {
            themesModal.classList.add('hidden');
            setTimeout(() => themesModal.style.display = 'none', 300);
        });

        // Manejar selecci√≥n de tema
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.addEventListener('click', function() {
                const theme = this.getAttribute('data-theme');
                
                // Actualizar tema seleccionado
                selectedTheme = theme;
                
                // Aplicar tema inmediatamente (vista previa)
                applyThemeToBackground(theme);
                
                // Actualizar UI del modal
                updateThemeSelectionUI();
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('dashboard-theme', theme);
                
                // Guardar en Firestore si el usuario est√° autenticado
                saveThemeToFirestore(theme);
                
                // Feedback visual con animaci√≥n
                this.style.transform = 'scale(0.95)';
                setTimeout(() => this.style.transform = 'scale(1)', 100);
            });
        });

        function updateThemeSelectionUI() {
            const themeConfig = THEME_CONFIG[selectedTheme];
            
            // Actualizar nombre del tema en el indicador
            if (currentThemeName && themeConfig) {
                currentThemeName.textContent = themeConfig.name;
            }

            // Actualizar indicadores visuales en las miniaturas
            document.querySelectorAll('.theme-option').forEach(btn => {
                const themePreview = btn.querySelector('.theme-preview');
                const checkmark = btn.querySelector('.theme-checkmark');
                const currentTheme = btn.getAttribute('data-theme');
                
                if (currentTheme === selectedTheme) {
                    // Mostrar borde brillante morado
                    themePreview.style.borderColor = '#9333ea';
                    themePreview.style.boxShadow = '0 0 0 3px rgba(147, 51, 234, 0.3)';
                    
                    // Mostrar checkmark
                    if (checkmark) {
                        checkmark.classList.remove('hidden');
                    }
                    
                    // Animar entrada del checkmark
                    if (checkmark) {
                        checkmark.style.animation = 'checkmarkPop 0.3s ease-out';
                    }
                } else {
                    // Restablecer estilo normal
                    themePreview.style.borderColor = 'transparent';
                    themePreview.style.boxShadow = '';
                    
                    // Ocultar checkmark
                    if (checkmark) {
                        checkmark.classList.add('hidden');
                    }
                }
            });
        }

        function applyThemeToBackground(theme) {
            const themeConfig = THEME_CONFIG[theme];
            if (!themeConfig) return;

            // Obtener el contenedor principal del dashboard
            const mainContent = document.querySelector('.flex.pt-16') || document.querySelector('main') || document.body;
            
            // Remover todas las clases de tema previas del mainContent Y del body
            Object.values(THEME_CONFIG).forEach(config => {
                mainContent.classList.remove(config.class);
                document.body.classList.remove(config.class);
            });
            
            // Si es el tema default, solo removemos clases y aplicamos el fondo base
            if (themeConfig.isDefault) {
                // Remover inline styles para permitir CSS por defecto
                mainContent.style.background = '';
                mainContent.style.backgroundAttachment = '';
                mainContent.style.backgroundSize = '';
                document.body.style.background = '';
                document.body.style.backgroundAttachment = '';
                document.body.style.backgroundSize = '';
                
                // Remover theme-dark si existe
                mainContent.classList.remove('theme-dark');
                document.body.classList.remove('theme-dark');
                
                console.log(`‚úÖ Tema predeterminado restaurado`);
                return;
            }
            
            // Agregar nueva clase de tema al mainContent Y al body
            mainContent.classList.add(themeConfig.class);
            document.body.classList.add(themeConfig.class);
            
            // Aplicar o remover clase theme-dark seg√∫n el tema
            if (themeConfig.isDark) {
                mainContent.classList.add('theme-dark');
                document.body.classList.add('theme-dark');
            } else {
                mainContent.classList.remove('theme-dark');
                document.body.classList.remove('theme-dark');
            }
            
            // Aplicar fondo directamente al contenedor Y al body
            mainContent.style.background = themeConfig.background;
            mainContent.style.backgroundAttachment = 'fixed';
            mainContent.style.backgroundSize = 'cover';
            
            // Aplicar el mismo fondo al body
            document.body.style.background = themeConfig.background;
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundSize = 'cover';
            
            // Tambi√©n aplicar a la variable CSS global
            document.documentElement.style.setProperty('--theme-gradient', themeConfig.background);
            
            console.log(`‚úÖ Tema aplicado: ${themeConfig.name} ${themeConfig.isDark ? '(Oscuro)' : '(Claro)'}`);
        }

        async function saveThemeToFirestore(theme) {
            try {
                const currentUser = window.auth?.currentUser;
                if (!currentUser) return;

                const themeConfig = THEME_CONFIG[theme];
                
                // Guardar preferencia de tema en Firestore
                const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                await window.updateDoc(userDocRef, {
                    preferences: {
                        theme: theme,
                        isDark: themeConfig?.isDark || false,
                        updatedAt: window.serverTimestamp()
                    }
                });
                
                console.log('‚úÖ Tema guardado en Firestore');
            } catch (error) {
                console.warn('No se pudo guardar tema en Firestore:', error);
                // No mostrar error al usuario, localStorage es suficiente
            }
        }

        async function loadThemeFromFirestore() {
            try {
                const currentUser = window.auth?.currentUser;
                if (!currentUser) {
                    // Usar tema de localStorage
                    applyThemeToBackground(selectedTheme);
                    return;
                }

                // Intentar cargar desde Firestore
                const userDocRef = window.doc(window.db, 'users', currentUser.uid);
                const userDoc = await window.getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.preferences?.theme) {
                        selectedTheme = userData.preferences.theme;
                        localStorage.setItem('dashboard-theme', selectedTheme);
                    }
                }
            } catch (error) {
                console.warn('No se pudo cargar tema de Firestore:', error);
            } finally {
                // Siempre aplicar el tema (de Firestore o localStorage)
                applyThemeToBackground(selectedTheme);
                updateThemeSelectionUI();
            }
        }

        // Aplicar tema guardado al cargar la p√°gina
        // Primero aplicar desde localStorage inmediatamente (evita flash)
        applyThemeToBackground(selectedTheme);
        
        // Luego intentar cargar desde Firestore cuando est√© disponible
        if (window.auth?.currentUser) {
            loadThemeFromFirestore();
        } else {
            // Esperar a que se autentique
            window.auth?.onAuthStateChanged((user) => {
                if (user) {
                    loadThemeFromFirestore();
                }
            });
        }

        // Modal de Reportar Problema
        const reportProblemModal = document.getElementById('reportProblemModal');
        const reportProblemBtn = document.getElementById('reportProblemBtn');
        const cancelReportBtn = document.getElementById('cancelReportBtn');
        const sendReportBtn = document.getElementById('sendReportBtn');
        const problemDescription = document.getElementById('problemDescription');
        const reportSuccessMessage = document.getElementById('reportSuccessMessage');
        let selectedCategory = null;

        // Abrir modal de reportar problema
        reportProblemBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown?.classList.add('hidden');
            reportProblemModal.style.display = 'flex';
            setTimeout(() => reportProblemModal.classList.remove('hidden'), 10);
            
            // Reset form
            problemDescription.value = '';
            selectedCategory = null;
            sendReportBtn.disabled = true;
            reportSuccessMessage.classList.add('hidden');
            document.querySelectorAll('.report-category-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-purple-500', 'border-purple-500');
            });
        });

        // Cerrar modal de reportar problema
        cancelReportBtn?.addEventListener('click', () => {
            reportProblemModal.classList.add('hidden');
            setTimeout(() => reportProblemModal.style.display = 'none', 300);
        });

        // Manejar selecci√≥n de categor√≠a
        document.querySelectorAll('.report-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedCategory = this.getAttribute('data-category');
                
                // Resaltar opci√≥n seleccionada
                document.querySelectorAll('.report-category-btn').forEach(b => {
                    b.classList.remove('ring-2', 'ring-offset-2', 'ring-purple-500', 'border-purple-500');
                });
                this.classList.add('ring-2', 'ring-offset-2', 'ring-purple-500', 'border-purple-500');
                
                // Validar si puede enviar
                validateReportForm();
            });
        });

        // Validar descripci√≥n mientras escribe
        problemDescription?.addEventListener('input', validateReportForm);

        function validateReportForm() {
            const description = problemDescription?.value.trim() || '';
            const isValid = selectedCategory && description.length >= 10;
            sendReportBtn.disabled = !isValid;
        }

        // Enviar reporte
        sendReportBtn?.addEventListener('click', async () => {
            try {
                sendReportBtn.disabled = true;
                sendReportBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                
                const currentUser = window.auth?.currentUser;
                if (!currentUser) throw new Error('Usuario no autenticado');

                const description = problemDescription.value.trim();

                // Crear notificaci√≥n para admin (buscar uid de admin)
                // Por simplicidad, guardamos en una colecci√≥n de reportes
                const reportsRef = window.collection(window.db, 'problem_reports');
                await window.addDoc(reportsRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Usuario',
                    userEmail: currentUser.email,
                    category: selectedCategory,
                    description: description,
                    status: 'pending',
                    createdAt: window.serverTimestamp(),
                    timestamp: new Date().toISOString()
                });

                // Mostrar mensaje de √©xito
                reportSuccessMessage.classList.remove('hidden');
                problemDescription.value = '';
                selectedCategory = null;
                sendReportBtn.innerHTML = 'Enviar Reporte';
                
                // Cerrar modal despu√©s de 2 segundos
                setTimeout(() => {
                    reportProblemModal.classList.add('hidden');
                    setTimeout(() => reportProblemModal.style.display = 'none', 300);
                }, 2000);
                
            } catch (error) {
                console.error('Error al enviar reporte:', error);
                alert('‚ùå Error al enviar el reporte. Int√©ntalo de nuevo.');
                sendReportBtn.disabled = false;
                sendReportBtn.innerHTML = 'Enviar Reporte';
            }
        });

        // Cerrar modales al hacer clic en el overlay
        [changePhotoModal, themesModal, reportProblemModal].forEach(modal => {
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    setTimeout(() => modal.style.display = 'none', 300);
                }
            });
        });

        // Router por hash con iframe para m√≥dulos
        const routes = {
            inicio: 'section-inicio',
            lecciones: 'section-lecciones',
            tareas: 'section-tareas',
            laboratorio: 'section-laboratorio',
            coleccion: 'section-coleccion',
            grupos: 'section-grupos',
            chats: 'section-chats',
            racha: 'section-racha'
        };

        function setActive(route){
            document.querySelectorAll('.sidebar .sidebar-item').forEach(a=>{
                if (a.getAttribute('data-route')===route) a.classList.add('active');
                else a.classList.remove('active');
            });
        }

        function showRoute(){
            const hash = window.location.hash.replace('#','') || 'inicio';
            const targetId = routes[hash];
            document.querySelectorAll('[data-section]').forEach(sec=>{
                if (sec.id === targetId) sec.classList.remove('hidden'); else sec.classList.add('hidden');
            });
            setActive(hash);
            ensureInit(hash);
        }
        window.addEventListener('hashchange', showRoute);
        document.addEventListener('DOMContentLoaded', showRoute);

        // Inicializadores por secci√≥n (one-time)
        const initialized = { inicio:false, lecciones:false, laboratorio:false, coleccion:false, grupos:false, chats:false, racha:false, tareas:false };

        function ensureInit(route){
            if (initialized[route]) return;
            switch(route){
                case 'inicio': initInicio(); break;
                case 'lecciones': initLecciones(); break;
                case 'laboratorio': initLaboratorio(); break;
                case 'coleccion': initColeccion(); break;
                case 'grupos': initGrupos(); break;
                case 'chats': initChats(); break;
                case 'racha': initRacha(); break;
                case 'tareas': initTareas(); break;
            }
            initialized[route] = true;
        }

        // Hook router para inicializar secciones
        const __origShowRoute = showRoute;
        function _showRouteWithInit(){
            const hash = window.location.hash.replace('#','') || 'inicio';
            const targetId = routes[hash];
            document.querySelectorAll('[data-section]').forEach(sec=>{
                if (sec.id === targetId) sec.classList.remove('hidden'); else sec.classList.add('hidden');
            });
            setActive(hash);
            ensureInit(hash);
        }
        showRoute = _showRouteWithInit;

        // Inicio: continuar aprendiendo
        function initInicio(){
            renderContinueLearning();
            try { window.userState?.subscribe(renderContinueLearning); } catch(_){ }
        }

        function renderContinueLearning(){
            const el = document.getElementById('continueLearning');
            if (!el) return;
            const last = window.userState?.state?.lastLesson;
            if (last){
                el.innerHTML = `<div class="flex items-center justify-between"><div><div class="font-semibold">${last.title||'Tu √∫ltima lecci√≥n'}</div><div class="text-xs text-gray-500">${last.course||''} ¬∑ Paso ${last.step||''}</div></div><a href="#lecciones" class="text-indigo-600 text-sm hover:underline">Continuar ‚Üí</a></div>`;
            } else {
                el.innerHTML = `<p class="text-gray-600 text-sm">A√∫n no has comenzado. Ve a <a class='text-indigo-600 hover:underline' href='#lecciones'>Lecciones</a>.</p>`;
            }
        }

        // Lecciones maestro-detalle (simulado)
        const COURSES = [
            { id:'python', title:'Python B√°sico', steps:[
                { id:'py1', title:'Print y variables' },
                { id:'py2', title:'Condicionales' },
                { id:'py3', title:'Bucles' },
                { id:'py4', title:'Funciones' },
                { id:'py5', title:'Listas y diccionarios' }
            ]}
        ];

        function initLecciones(){
            const courseList = document.getElementById('courseList');
            if (!courseList) return;
            courseList.innerHTML = COURSES.map(c=>`<button data-id="${c.id}" class="w-full text-left card">${c.title}</button>`).join('');
            courseList.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>openCourse(b.getAttribute('data-id'))));
            const last = window.userState?.state?.lastLesson; if (last?.courseId) openCourse(last.courseId); else openCourse(COURSES[0].id);
        }

        function openCourse(courseId){
            const course = COURSES.find(c=>c.id===courseId) || COURSES[0];
            const stepsEl = document.getElementById('lessonSteps');
            const player = document.getElementById('lessonPlayerContainer');
            const completed = new Set(window.userState?.state?.completedLessons||[]);
            if (player) player.innerHTML = `<div class='aspect-video'><iframe class='w-full h-full' src='https://www.youtube.com/embed/8ext9G7xspg' allowfullscreen></iframe></div>`;
            stepsEl.innerHTML = course.steps.map((s,idx)=>{
                const done = completed.has(s.id);
                return `<li class="flex items-center justify-between p-2 border rounded ${done?'bg-green-50':''}">
                    <div class="text-sm"><span class="font-semibold">Paso ${idx+1}:</span> ${s.title} ${done?'<span class=\"ml-2 text-green-600 text-xs\">‚úì</span>':''}</div>
                    <div class="flex gap-2">
                        <button class="text-xs px-2 py-1 border rounded" data-view="${s.id}">Ver</button>
                        <button class="text-xs px-2 py-1 border rounded" data-complete="${s.id}">Marcar 90%</button>
                    </div>
                </li>`;
            }).join('');
            stepsEl.querySelectorAll('[data-view]').forEach(btn=>btn.addEventListener('click',()=>{
                const sid = btn.getAttribute('data-view');
                window.userState?.setLastLesson({ courseId: course.id, course: course.title, step: (course.steps.findIndex(s=>s.id===sid)+1), stepId: sid, title: course.title+': '+(course.steps.find(s=>s.id===sid)?.title||'') });
                renderContinueLearning();
            }));
            stepsEl.querySelectorAll('[data-complete]').forEach(btn=>btn.addEventListener('click', async ()=>{
                const sid = btn.getAttribute('data-complete');
                window.userState?.completeLesson(sid);
                await addXP(100, 'lesson');
                updateGamificationHeader(window.userState?.state?.xp||0);
                openCourse(course.id); // re-render
                renderContinueLearning();
                alert('¬°Lecci√≥n completada! +100 XP');
            }));
        }

        // Laboratorio
        function initLaboratorio(){
            // Blocky
            const grid = document.getElementById('blockyGrid');
            const status = document.getElementById('blockyStatus');
            const SIZE=5; const GOAL={x:4,y:4}; let pos={x:0,y:0}; let dir=0; // 0E 1S 2O 3N
            function draw(){
                grid.innerHTML='';
                for(let y=0;y<SIZE;y++){
                    for(let x=0;x<SIZE;x++){
                        const cell=document.createElement('div');
                        cell.className='aspect-square rounded flex items-center justify-center text-xs border';
                        if (x===GOAL.x && y===GOAL.y) { cell.classList.add('bg-green-100'); cell.textContent='üèÅ'; }
                        if (x===pos.x && y===pos.y) { cell.classList.add('bg-indigo-100'); cell.textContent = ['‚Üí','‚Üì','‚Üê','‚Üë'][dir]; }
                        grid.appendChild(cell);
                    }
                }
                status.textContent = `Pos (${pos.x},${pos.y}) ¬∑ Dir ${['E','S','O','N'][dir]}`;
            }
            function reset(){ pos={x:0,y:0}; dir=0; draw(); }
            function move(){ const nx=pos.x + (dir===0?1:dir===2?-1:0); const ny=pos.y + (dir===1?1:dir===3?-1:0); if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) return; pos={x:nx,y:ny}; draw(); check(); }
            function turn(){ dir=(dir+1)%4; draw(); }
            function check(){ if (pos.x===GOAL.x && pos.y===GOAL.y){ window.userState?.completeGame('blocky', 100); addXP(25,'blocky'); updateGamificationHeader(window.userState?.state?.xp||0); alert('¬°Ganaste Blocky! +25 XP'); reset(); } }
            document.getElementById('btnMove')?.addEventListener('click', move);
            document.getElementById('btnTurn')?.addEventListener('click', turn);
            document.getElementById('btnResetBlocky')?.addEventListener('click', reset);
            draw();

            // Typo Racer
            const targets = [ 'print("Hola")', 'for i in range(5):', 'if x == 10:', 'def suma(a,b):' ];
            let tStart=0; let target='';
            const tEl = document.getElementById('typoTarget');
            const inEl = document.getElementById('typoInput');
            const accEl = document.getElementById('typoAccuracy');
            const wpmEl = document.getElementById('typoWpm');
            const stEl = document.getElementById('typoStatus');
            function newTarget(){ target = targets[Math.floor(Math.random()*targets.length)]; tEl.textContent = target; inEl.value=''; inEl.focus(); tStart=Date.now(); stEl.textContent='Escribe la l√≠nea...'; accEl.textContent='Precisi√≥n: 0%'; wpmEl.textContent='WPM: 0'; }
            function compute(){
                const val = inEl.value;
                const len = Math.max(val.length, target.length);
                let ok=0; for(let i=0;i<Math.min(val.length,target.length);i++){ if(val[i]===target[i]) ok++; }
                const acc = Math.round((ok/len)*100);
                const mins = (Date.now()-tStart)/60000;
                const wpm = Math.max(0, Math.round((val.length/5)/Math.max(mins, 0.01)));
                accEl.textContent = `Precisi√≥n: ${isFinite(acc)?acc:0}%`;
                wpmEl.textContent = `WPM: ${isFinite(wpm)?wpm:0}`;
                if (val === target) {
                    // Guardar en Firestore
                    (async () => {
                        try {
                            const user = window.currentUser || window.auth?.currentUser;
                            if (user && window.db) {
                                const userRef = doc(window.db, 'users', user.uid);
                                const userDoc = await getDoc(userRef);
                                const userData = userDoc.exists() ? userDoc.data() : {};
                                const gameScores = userData.studentProfile?.gameScores || {};
                                gameScores['typo_racer'] = (gameScores['typo_racer'] || 0) + 1;
                                
                                await updateDoc(userRef, {
                                    'studentProfile.gameScores': gameScores
                                });
                            }
                        } catch (err) { console.error('Error guardando typo-racer:', err); }
                    })();
                    
                    addXP(15,'typo-racer'); 
                    window.userState?.completeGame('typo', wpm); 
                    updateGamificationHeader(window.userState?.state?.xp||0); 
                    stEl.textContent='¬°Perfecto! +15 XP'; 
                    setTimeout(newTarget, 700); 
                }
            }
            inEl.addEventListener('input', compute);
            newTarget();
        }

        // Grupos feed
        // ========== GRUPOS - FEED SOCIAL REAL ==========
        let postsUnsubscribe = null;
        
        async function initGrupos() {
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            // Obtener grupo del usuario (primer grupo al que pertenece)
            const userDoc = await getDoc(doc(window.db, 'users', user.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            const groupId = userData.groupId || 'demo_group'; // Grupo demo por defecto
            
            // Botones
            document.getElementById('btnNewPost')?.addEventListener('click', () => toggleNewPostForm());
            document.getElementById('submitPost')?.addEventListener('click', () => createPost(groupId));
            document.getElementById('cancelPost')?.addEventListener('click', () => toggleNewPostForm());
            document.getElementById('closeProfileModal')?.addEventListener('click', () => closeUserProfileModal());
            
            // Cargar posts en tiempo real
            loadGroupFeed(groupId);
        }
        
        function toggleNewPostForm() {
            const form = document.getElementById('newPostForm');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                document.getElementById('newPostContent').focus();
            }
        }
        
        async function createPost(groupId) {
            const content = document.getElementById('newPostContent').value.trim();
            if (!content) return;
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            try {
                const postsRef = collection(window.db, 'groups', groupId, 'posts');
                await addDoc(postsRef, {
                    content,
                    authorId: user.uid,
                    createdAt: serverTimestamp(),
                    likes: 0,
                    commentsCount: 0
                });
                
                document.getElementById('newPostContent').value = '';
                toggleNewPostForm();
            } catch (error) {
                console.error('Error creando post:', error);
                alert('Error al crear publicaci√≥n');
            }
        }
        
        async function loadGroupFeed(groupId) {
            const feed = document.getElementById('groupsFeed');
            feed.innerHTML = '<div class="text-center text-gray-400 py-4">Cargando posts...</div>';
            
            // Cancelar listener anterior
            if (postsUnsubscribe) postsUnsubscribe();
            
            // Escuchar posts en tiempo real
            const postsRef = collection(window.db, 'groups', groupId, 'posts');
            const postsQuery = query(postsRef, orderBy('createdAt', 'desc'), limit(20));
            
            postsUnsubscribe = onSnapshot(postsQuery, async (snapshot) => {
                feed.innerHTML = '';
                
                if (snapshot.empty) {
                    feed.innerHTML = '<div class="card p-6 text-center text-gray-400">No hay publicaciones a√∫n. ¬°S√© el primero en publicar!</div>';
                    return;
                }
                
                for (const postDoc of snapshot.docs) {
                    const post = postDoc.data();
                    
                    // Obtener datos del autor
                    const authorDoc = await getDoc(doc(window.db, 'users', post.authorId));
                    const author = authorDoc.exists() ? authorDoc.data() : {};
                    
                    // Renderizar post
                    const postEl = document.createElement('div');
                    postEl.className = 'card';
                    postEl.innerHTML = `
                        <div class="flex items-start gap-3 mb-3">
                            <img src="${author.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(author.displayName || 'Usuario')}&background=667eea&color=fff`}" 
                                 class="w-10 h-10 rounded-full cursor-pointer hover:ring-2 hover:ring-indigo-300 transition"
                                 onclick="showUserProfile('${post.authorId}')">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-gray-800 cursor-pointer hover:text-indigo-600" onclick="showUserProfile('${post.authorId}')">${author.displayName || 'Usuario'}</span>
                                    <span class="text-xs text-gray-400">${post.createdAt?.toDate ? new Date(post.createdAt.toDate()).toLocaleDateString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Ahora'}</span>
                                </div>
                                <p class="text-sm text-gray-700 mt-2 whitespace-pre-wrap">${post.content}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 pt-3 border-t border-gray-100 text-sm text-gray-500">
                            <button class="hover:text-indigo-600 transition flex items-center gap-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="hover:text-indigo-600 transition flex items-center gap-1" onclick="toggleComments('${postDoc.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span>${post.commentsCount || 0}</span>
                            </button>
                        </div>
                        <div id="comments-${postDoc.id}" class="hidden mt-4 pt-4 border-t border-gray-100 space-y-3">
                            <div class="text-center text-gray-400 text-sm py-2">Cargando comentarios...</div>
                        </div>
                    `;
                    feed.appendChild(postEl);
                }
            });
        }
        
        async function showUserProfile(userId) {
            try {
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                document.getElementById('modalUserAvatar').src = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'Usuario')}&background=667eea&color=fff`;
                document.getElementById('modalUserName').textContent = userData.displayName || 'Usuario';
                document.getElementById('modalUserRole').textContent = (userData.rol || 'estudiante').charAt(0).toUpperCase() + (userData.rol || 'estudiante').slice(1);
                
                // Bot√≥n de chat
                const chatBtn = document.getElementById('modalChatBtn');
                chatBtn.onclick = async () => {
                    const currentUser = window.currentUser || window.auth?.currentUser;
                    if (!currentUser) return;
                    
                    const chatId = await getOrCreateChat(currentUser.uid, userId);
                    closeUserProfileModal();
                    
                    // Cambiar a secci√≥n de chats
                    window.location.hash = 'chats';
                    
                    // Esperar a que se cargue la secci√≥n
                    setTimeout(() => {
                        openChat(chatId, {
                            uid: userId,
                            name: userData.displayName,
                            photoURL: userData.photoURL,
                            role: userData.rol
                        });
                    }, 300);
                };
                
                document.getElementById('userProfileModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error cargando perfil:', error);
            }
        }
        
        function closeUserProfileModal() {
            document.getElementById('userProfileModal').classList.add('hidden');
        }
        
        function toggleComments(postId) {
            const commentsEl = document.getElementById(`comments-${postId}`);
            commentsEl.classList.toggle('hidden');
            // Aqu√≠ podr√≠as cargar comentarios reales de Firestore
        }
        
        // Hacer funciones globales
        window.showUserProfile = showUserProfile;
        window.toggleComments = toggleComments;

        // ========== FUNCIONALIDAD DEL CHAT ==========
        let isRecording = false;
        let recordingStartTime = null;
        let recordingInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Habilitar/deshabilitar bot√≥n enviar seg√∫n input
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('chatSendBtn');
            
            if (chatInput && sendBtn) {
                chatInput.addEventListener('input', () => {
                    if (chatInput.value.trim().length > 0) {
                        sendBtn.classList.remove('disabled');
                        sendBtn.disabled = false;
                    } else {
                        sendBtn.classList.add('disabled');
                        sendBtn.disabled = true;
                    }
                });
                
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !sendBtn.disabled) {
                        sendMessage();
                    }
                });
            }

            // Bot√≥n Emojis
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiPicker = document.getElementById('emojiPicker');
            
            if (emojiBtn && emojiPicker) {
                emojiBtn.addEventListener('click', () => {
                    emojiPicker.classList.toggle('hidden');
                });
                
                document.querySelectorAll('.emoji-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (chatInput) {
                            chatInput.value += btn.textContent;
                            chatInput.dispatchEvent(new Event('input'));
                            chatInput.focus();
                        }
                    });
                });
            }

            // Bot√≥n Fotos
            const photoBtn = document.getElementById('photoBtn');
            const photoInput = document.getElementById('photoInput');
            
            if (photoBtn && photoInput) {
                photoBtn.addEventListener('click', () => {
                    photoInput.click();
                });
                
                photoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        console.log('üì∏ Imagen seleccionada:', file.name);
                        
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'info',
                                title: 'Pr√≥ximamente',
                                text: 'La funci√≥n de enviar im√°genes estar√° disponible pronto',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                        }
                    }
                    photoInput.value = '';
                });
            }

            // Bot√≥n Audio (Grabar)
            const audioBtn = document.getElementById('audioBtn');
            const micIcon = document.getElementById('micIcon');
            const stopIcon = document.getElementById('stopIcon');
            const recordingTimer = document.getElementById('recordingTimer');
            
            if (audioBtn) {
                audioBtn.addEventListener('click', async () => {
                    if (!isRecording) {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            mediaRecorder = new MediaRecorder(stream);
                            audioChunks = [];
                            
                            mediaRecorder.ondataavailable = (event) => {
                                audioChunks.push(event.data);
                            };
                            
                            mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                console.log('üé§ Audio grabado:', audioBlob.size, 'bytes');
                                
                                if (typeof Swal !== 'undefined') {
                                    Swal.fire({
                                        icon: 'info',
                                        title: 'Pr√≥ximamente',
                                        text: 'La funci√≥n de enviar audios estar√° disponible pronto',
                                        toast: true,
                                        position: 'top-end',
                                        showConfirmButton: false,
                                        timer: 3000
                                    });
                                }
                                
                                stream.getTracks().forEach(track => track.stop());
                            };
                            
                            mediaRecorder.start();
                            isRecording = true;
                            recordingStartTime = Date.now();
                            
                            micIcon.classList.add('hidden');
                            stopIcon.classList.remove('hidden');
                            recordingTimer.classList.remove('hidden');
                            audioBtn.style.color = '#ef4444';
                            
                            recordingInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                                const minutes = Math.floor(elapsed / 60);
                                const seconds = elapsed % 60;
                                recordingTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            }, 1000);
                            
                        } catch (error) {
                            console.error('Error accediendo al micr√≥fono:', error);
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'No se pudo acceder al micr√≥fono',
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000
                                });
                            }
                        }
                    } else {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                        
                        isRecording = false;
                        clearInterval(recordingInterval);
                        
                        micIcon.classList.remove('hidden');
                        stopIcon.classList.add('hidden');
                        recordingTimer.classList.add('hidden');
                        recordingTimer.textContent = '0:00';
                        audioBtn.style.color = '';
                    }
                });
            }
        });

        // Funci√≥n para actualizar estado de presencia
        function updatePresenceStatus(userId, isOnline) {
            const indicator = document.getElementById('chatPresenceIndicator');
            const status = document.getElementById('chatRecipientStatus');
            
            if (indicator && status) {
                if (isOnline) {
                    indicator.classList.remove('offline');
                    indicator.classList.add('online');
                    status.textContent = 'En l√≠nea';
                } else {
                    indicator.classList.remove('online');
                    indicator.classList.add('offline');
                    status.textContent = 'Desconectado';
                }
            }
        }

        window.updatePresenceStatus = updatePresenceStatus;

    // Exponer funciones del chat para uso inline/fallback
    window.showNewChatModal = showNewChatModal;
    window.openChat = openChat;


        // Chats
        // ========== CHAT EN TIEMPO REAL CON FIRESTORE ==========
        let activeChat = null;
        let chatUnsubscribe = null;
        
        async function initChats() {
            console.log('üí¨ Inicializando chat...');
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) {
                console.error('‚ùå No hay usuario en initChats');
                return;
            }
            
            console.log('‚úÖ Usuario detectado:', user.uid, user.displayName);
            
            // Cargar conversaciones del usuario
            await loadConversations(user.uid);
            
            // Bot√≥n para nuevo chat
            const newChatBtn = document.getElementById('newChatBtn');
            if (newChatBtn) {
                newChatBtn.onclick = () => showNewChatModal();
                console.log('‚úÖ Bot√≥n nuevo chat configurado');
            }
            
            // Enviar mensaje
            const sendBtn = document.getElementById('chatSendBtn');
            const input = document.getElementById('chatMessageInput');
            
            if (sendBtn) {
                sendBtn.onclick = () => sendMessage();
            }
            
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            console.log('‚úÖ Chat inicializado completamente');
        }
        
        async function loadConversations(userId) {
            console.log('üìã Cargando conversaciones para:', userId);
            
            const conversationsEl = document.getElementById('chatConversations');
            if (!conversationsEl) {
                console.error('‚ùå No se encontr√≥ #chatConversations');
                return;
            }
            
            conversationsEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Cargando...</div>';
            
            try {
                if (!window.db) {
                    throw new Error('window.db no est√° definido');
                }
                
                // Buscar chats donde el usuario sea participante
                const chatsRef = collection(window.db, 'chats');
                const q = query(chatsRef, where('participants', 'array-contains', userId));
                const snapshot = await getDocs(q);
                
                console.log('üìä Chats encontrados:', snapshot.size);
                
                if (snapshot.empty) {
                    conversationsEl.innerHTML = `
                        <div class="p-6 text-center">
                            <div class="text-4xl mb-2" aria-hidden="true"></div>
                            <p class="text-gray-400 text-sm mb-3">No hay conversaciones</p>
                            <button onclick="showNewChatModal && showNewChatModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                                Iniciar Chat
                            </button>
                        </div>
                    `;
                    return;
                }
                
                conversationsEl.innerHTML = '';
                const conversations = [];
                
                console.log('üîÑ Procesando', snapshot.size, 'conversaciones...');
                
                for (const chatDoc of snapshot.docs) {
                    const chatData = chatDoc.data();
                    const otherUserId = chatData.participants.find(p => p !== userId);
                    
                    if (!otherUserId) continue;
                    
                    // Obtener datos del otro usuario
                    const otherUserDoc = await getDoc(doc(window.db, 'users', otherUserId));
                    const otherUser = otherUserDoc.exists() ? otherUserDoc.data() : {};
                    
                    conversations.push({
                        chatId: chatDoc.id,
                        otherUser: {
                            uid: otherUserId,
                            name: otherUser.displayName || 'Usuario',
                            photoURL: otherUser.photoURL,
                            role: otherUser.rol || 'estudiante'
                        },
                        lastMessage: chatData.lastMessage || '',
                        updatedAt: chatData.updatedAt
                    });
                }
                
                console.log('‚úÖ Conversaciones procesadas:', conversations.length);
                
                // Ordenar por m√°s reciente
                conversations.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
                
                // Renderizar
                conversations.forEach(conv => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 px-3 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 transition';
                    div.innerHTML = `
                        <img src="${conv.otherUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(conv.otherUser.name)}&background=667eea&color=fff`}" 
                             class="w-10 h-10 rounded-full">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-semibold text-gray-800 truncate">${conv.otherUser.name}</div>
                            <div class="text-xs text-gray-500 truncate">${conv.lastMessage || 'Nuevo chat'}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(conv.chatId, conv.otherUser);
                    conversationsEl.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error cargando conversaciones:', error);
                conversationsEl.innerHTML = `
                    <div class="p-4 text-center">
                        <div class="text-red-500 text-sm mb-2">Error al cargar</div>
                        <button onclick="location.reload()" class="btn btn-sm bg-gray-300 hover:bg-gray-400 text-xs">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        async function openChat(chatId, otherUser) {
            console.log('üìñ Abriendo chat:', chatId, 'con', otherUser.name);
            
            activeChat = { chatId, otherUser };
            
            // Mostrar header y √°rea de input
            const chatHeader = document.getElementById('chatHeader');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatMessagesArea = document.getElementById('chatMessagesArea');
            
            if (chatHeader) chatHeader.classList.remove('hidden');
            if (chatInputArea) chatInputArea.classList.remove('hidden');
            
            // Actualizar header con info del destinatario
            if (chatHeader) {
                chatHeader.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <img src="${otherUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUser.name)}&background=667eea&color=fff`}" 
                                 class="w-10 h-10 rounded-full border-2 border-white shadow" id="chatRecipientAvatar">
                            <div id="chatPresenceIndicator" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full online" title="En l√≠nea"></div>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800" id="chatRecipientName">${otherUser.name}</div>
                            <div class="text-xs text-gray-500" id="chatRecipientStatus">En l√≠nea</div>
                        </div>
                    </div>
                `;
                
                // Simular estado de presencia (en producci√≥n vendr√≠a de Firestore realtime)
                const isOnline = Math.random() > 0.3; // 70% probabilidad de estar en l√≠nea
                setTimeout(() => {
                    updatePresenceStatus(otherUser.uid, isOnline);
                }, 100);
            }
            
            // Limpiar listener anterior
            if (chatUnsubscribe) {
                chatUnsubscribe();
            }
            
            // Escuchar mensajes en tiempo real
            const messagesRef = collection(window.db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                console.log('üì® Mensajes actualizados:', snapshot.size);
                
                if (!chatMessagesArea) return;
                
                chatMessagesArea.innerHTML = '';
                
                if (snapshot.empty) {
                    chatMessagesArea.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-gray-400">
                                <div class="text-4xl mb-2" aria-hidden="true"></div>
                                <p class="text-sm">Env√≠a tu primer mensaje</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgId = doc.id;
                    const isMe = msg.senderId === (window.currentUser?.uid || window.auth?.currentUser?.uid);
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-3`;
                    msgDiv.innerHTML = `
                        <div class="chat-bubble ${isMe ? 'chat-bubble-sent' : 'chat-bubble-received'}">
                            ${isMe ? `<button class="chat-delete-btn" onclick="deleteMessage('${msgId}')" title="Eliminar mensaje">\u{1F5D1}\uFE0F</button>` : ''}
                            <p class="text-sm whitespace-pre-wrap break-words">${escapeHtml(msg.text)}</p>
                            <p class="text-xs mt-1 ${isMe ? 'text-indigo-200' : 'text-gray-500'}">
                                ${msg.timestamp ? formatTime(msg.timestamp.toDate()) : 'Enviando...'}
                            </p>
                        </div>
                    `;
                    chatMessagesArea.appendChild(msgDiv);
                });
                
                // Scroll al final
                scrollChatToBottom();
            });
        }
        
        function scrollChatToBottom() {
            const messagesArea = document.getElementById('chatMessagesArea');
            if (messagesArea) {
                setTimeout(() => {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);
            }
        }
        
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Ahora';
            if (minutes < 60) return `${minutes}m`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}h`;
            
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function sendMessage() {
            console.log('üì§ Intentando enviar mensaje...');
            
            if (!activeChat) {
                console.error('‚ùå No hay chat activo');
                return;
            }
            
            const input = document.getElementById('chatMessageInput');
            if (!input) {
                console.error('‚ùå No se encontr√≥ el input');
                return;
            }
            
            const text = input.value.trim();
            if (!text) return;
            
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) {
                console.error('‚ùå No hay usuario');
                return;
            }
            
            console.log('üíæ Guardando mensaje en Firestore...');
            const sendBtn = document.getElementById('chatSendBtn');
            if (sendBtn) sendBtn.disabled = true;

            // Optimistic UI
            const messagesArea = document.getElementById('chatMessagesArea');
            const tempId = 'temp-' + Date.now();
            const optimisticDiv = document.createElement('div');
            optimisticDiv.id = tempId;
            optimisticDiv.className = 'flex justify-end mb-3 opacity-70';
            optimisticDiv.innerHTML = `
                <div class="bg-indigo-300 text-white rounded-2xl px-4 py-2 max-w-xs shadow-sm">
                    <p class="text-sm whitespace-pre-wrap break-words">${escapeHtml(text)}</p>
                    <p class="text-xs mt-1 text-indigo-100">Enviando...</p>
                </div>
            `;
            messagesArea.appendChild(optimisticDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            try {
                // Agregar mensaje a la subcolecci√≥n
                const messagesRef = collection(window.db, 'chats', activeChat.chatId, 'messages');
                console.log('üõ∞Ô∏è Payload:', { chatId: activeChat.chatId, text, sender: user.uid });
                
                await addDoc(messagesRef, {
                    text,
                    senderId: user.uid,
                    timestamp: serverTimestamp()
                });
                
                console.log('‚úÖ Mensaje guardado');
                
                // Actualizar √∫ltimo mensaje en el chat
                await updateDoc(doc(window.db, 'chats', activeChat.chatId), {
                    lastMessage: text,
                    updatedAt: serverTimestamp()
                });
                
                console.log('‚úÖ Chat actualizado');
                
                // Reemplazar estado optimista; lo real vendr√° por snapshot
                input.value = '';
                input.focus();
                setTimeout(()=>{
                    const el = document.getElementById(tempId);
                    if (el) el.remove();
                }, 200); // se espera al snapshot real
                
                if (sendBtn) sendBtn.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error enviando mensaje:', error);
                const el = document.getElementById(tempId);
                if (el) {
                    el.querySelector('p.text-xs').textContent = 'Error';
                    el.classList.remove('opacity-70');
                    el.classList.add('opacity-100');
                    el.firstElementChild.classList.remove('bg-indigo-300');
                    el.firstElementChild.classList.add('bg-red-500');
                }
                if (sendBtn) sendBtn.disabled = false;
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo enviar el mensaje: ' + error.message,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            }
        }
        
        // Funci√≥n para eliminar mensaje
        async function deleteMessage(messageId) {
            if (!activeChat || !messageId) return;
            
            if (typeof Swal !== 'undefined') {
                const result = await Swal.fire({
                    title: '¬øEliminar mensaje?',
                    text: 'Esta acci√≥n no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                });
                
                if (!result.isConfirmed) return;
            } else {
                if (!confirm('¬øEst√°s seguro de que quieres eliminar este mensaje?')) return;
            }
            
            try {
                const messageRef = doc(window.db, 'chats', activeChat.chatId, 'messages', messageId);
                await deleteDoc(messageRef);
                
                console.log('‚úÖ Mensaje eliminado');
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Mensaje eliminado',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando mensaje:', error);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo eliminar el mensaje',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            }
        }
        
        window.deleteMessage = deleteMessage;
        
        async function showNewChatModal() {
               console.log('üîç Abriendo modal de nuevo chat...');
           
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
           
               if (typeof Swal === 'undefined') {
                   console.error('‚ùå SweetAlert2 no est√° cargado, usando fallback con prompt');
                   const term = prompt('Escribe el nombre del usuario para chatear:');
                   if (!term) return;
                   try {
                       const usersRef = collection(window.db, 'users');
                       const snapshot = await getDocs(usersRef);
                       let foundUser = null;
                       snapshot.forEach(docSnap => {
                           const data = docSnap.data();
                           if (docSnap.id !== user.uid && (data.displayName || '').toLowerCase().includes(term.toLowerCase())) {
                               foundUser = { uid: docSnap.id, name: data.displayName || 'Usuario', photoURL: data.photoURL, role: data.rol || 'estudiante' };
                           }
                       });
                       if (!foundUser) { alert('No se encontr√≥ usuario'); return; }
                       const chatId = await getOrCreateChat(user.uid, foundUser.uid);
                       openChat(chatId, foundUser);
                       await loadConversations(user.uid);
                   } catch (e) {
                       alert('Error creando chat: ' + e.message);
                   }
                   return;
               }
            
            const result = await Swal.fire({
                title: 'Nuevo Chat',
                html: `
                    <div class="text-left">
                        <input id="searchUserInput" type="text" placeholder="Buscar usuario..." 
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-3">
                        <div id="userSearchResults" class="max-h-60 overflow-y-auto"></div>
                    </div>
                `,
                showCancelButton: false,
                showConfirmButton: false,
                width: '500px',
                didOpen: () => {
                    const input = document.getElementById('searchUserInput');
                    const resultsDiv = document.getElementById('userSearchResults');
                    let searchTimeout;
                    
                    resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe para buscar usuarios...</p>';
                    
                    input.addEventListener('input', async (e) => {
                        clearTimeout(searchTimeout);
                        const searchTerm = e.target.value.trim().toLowerCase();
                        
                        if (searchTerm.length < 2) {
                            resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">Escribe al menos 2 letras...</p>';
                            return;
                        }
                        
                        searchTimeout = setTimeout(async () => {
                            resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Buscando...</p>';
                            
                            try {
                                const usersRef = collection(window.db, 'users');
                                const snapshot = await getDocs(usersRef);
                                
                                const matches = [];
                                snapshot.forEach(docSnap => {
                                    const userData = docSnap.data();
                                    // Construir nombre completo desde Firestore
                                    const fullName = userData.displayName || 
                                                    (userData.nombre ? `${userData.nombre} ${userData.apellidoPaterno || ''} ${userData.apellidoMaterno || ''}`.trim() : '');
                                    const userName = fullName.toLowerCase();
                                    
                                    if (docSnap.id !== user.uid && userName.includes(searchTerm)) {
                                        matches.push({
                                            uid: docSnap.id,
                                            name: fullName || 'Usuario',
                                            photoURL: userData.photoURL,
                                            role: userData.rol || 'estudiante'
                                        });
                                    }
                                });
                                
                                if (matches.length === 0) {
                                    resultsDiv.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">üòï No se encontraron usuarios</p>';
                                    return;
                                }
                                
                                resultsDiv.innerHTML = matches.map(foundUser => `
                                    <div class="flex items-center gap-3 p-3 hover:bg-indigo-50 rounded-lg cursor-pointer transition user-result" data-uid="${foundUser.uid}">
                                        <img src="${foundUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(foundUser.name)}&background=667eea&color=fff`}" 
                                             class="w-10 h-10 rounded-full border-2 border-white shadow">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${foundUser.name}</div>
                                            <div class="text-xs text-gray-500">${foundUser.role === 'profesor' ? 'üë®‚Äçüè´ Profesor' : 'üë§ Estudiante'}</div>
                                        </div>
                                        <div class="text-indigo-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                `).join('');
                                
                                // Click en resultado
                                document.querySelectorAll('.user-result').forEach(el => {
                                    el.addEventListener('click', async () => {
                                        const selectedUid = el.dataset.uid;
                                        const selectedUser = matches.find(u => u.uid === selectedUid);
                                        
                                        Swal.close();
                                        
                                        Swal.fire({
                                            title: 'Abriendo chat...',
                                            text: 'Por favor espera',
                                            allowOutsideClick: false,
                                            showConfirmButton: false,
                                            willOpen: () => Swal.showLoading()
                                        });
                                        
                                        try {
                                            const chatId = await getOrCreateChat(user.uid, selectedUid);
                                            openChat(chatId, selectedUser);
                                            await loadConversations(user.uid);
                                            Swal.close();
                                        } catch (error) {
                                            Swal.fire('Error', 'No se pudo abrir el chat', 'error');
                                        }
                                    });
                                });
                                
                            } catch (error) {
                                console.error('Error buscando usuarios:', error);
                                resultsDiv.innerHTML = '<p class="text-sm text-red-500 text-center py-4">‚ùå Error en la b√∫squeda</p>';
                            }
                        }, 400);
                    });
                    
                    input.focus();
                }
            });
        }
        
        async function getOrCreateChat(userId1, userId2) {
            // Buscar chat existente
            const chatsRef = collection(window.db, 'chats');
            const q = query(chatsRef, where('participants', 'array-contains', userId1));
            const snapshot = await getDocs(q);
            
            let existingChatId = null;
            snapshot.forEach(chatDoc => {
                const participants = chatDoc.data().participants;
                if (participants.includes(userId2)) {
                    existingChatId = chatDoc.id;
                }
            });
            
            if (existingChatId) return existingChatId;
            
            // Crear nuevo chat
            const newChat = await addDoc(chatsRef, {
                participants: [userId1, userId2],
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: ''
            });
            
            return newChat.id;
        }

        // Racha
        // ========== RACHA VISUAL - ESTILO GITHUB ==========
        async function initRacha() {
            const user = window.currentUser || window.auth?.currentUser;
            if (!user) return;
            
            renderStreakCalendar(user.uid);
        }
        
        async function renderStreakCalendar(userId) {
            const cal = document.getElementById('streakCalendar');
            const maxEl = document.getElementById('maxStreak');
            
            try {
                // Obtener datos del usuario
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const loginDates = userData.loginDates || [];
                const loginSet = new Set(loginDates.map(d => {
                    if (typeof d === 'string') return d;
                    if (d?.toDate) return d.toDate().toDateString();
                    return new Date(d).toDateString();
                }));
                
                // Calcular racha actual
                let currentStreak = 0;
                let maxStreak = 0;
                let tempStreak = 0;
                const today = new Date();
                
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    
                    if (loginSet.has(checkDate.toDateString())) {
                        tempStreak++;
                        if (i === 0 || i === 1) currentStreak++; // Los √∫ltimos 2 d√≠as cuentan para racha actual
                    } else {
                        if (tempStreak > maxStreak) maxStreak = tempStreak;
                        tempStreak = 0;
                        if (i > 1) break; // Si hace m√°s de 1 d√≠a que no se conecta, la racha se rompe
                    }
                }
                
                if (tempStreak > maxStreak) maxStreak = tempStreak;
                
                // Renderizar calendario de 7 d√≠as (estilo GitHub)
                cal.innerHTML = '';
                cal.className = 'grid grid-cols-7 gap-2';
                
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const ds = d.toDateString();
                    const hasActivity = loginSet.has(ds);
                    
                    const div = document.createElement('div');
                    div.className = `aspect-square rounded-lg border-2 flex flex-col items-center justify-center text-xs font-semibold transition-all hover:scale-110 ${
                        hasActivity 
                            ? 'bg-gradient-to-br from-green-400 to-green-600 border-green-700 text-white shadow-lg' 
                            : 'bg-gray-50 border-gray-200 text-gray-400'
                    }`;
                    div.title = d.toLocaleDateString('es-MX', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    const dayName = d.toLocaleDateString('es-MX', { weekday: 'short' }).replace('.', '').toUpperCase();
                    const dayNum = d.getDate();
                    
                    div.innerHTML = `
                        <div class="text-[10px]">${dayName}</div>
                        <div class="text-lg font-bold">${dayNum}</div>
                        ${hasActivity ? '<div class="text-[8px]">‚úì</div>' : ''}
                    `;
                    
                    cal.appendChild(div);
                }
                
                // Mostrar racha m√°xima
                maxEl.textContent = maxStreak;
                
                // Actualizar racha en el header
                const streakEl = document.getElementById('userStreak');
                if (streakEl) {
                    streakEl.textContent = currentStreak > 0 ? `üî• ${currentStreak}` : '0';
                }
                
            } catch (error) {
                console.error('Error cargando racha:', error);
                cal.innerHTML = '<div class="col-span-7 text-center text-red-500 text-sm">Error al cargar racha</div>';
            }
        }

        // Tareas placeholder
        function initTareas(){
            const box = document.getElementById('tasksList');
            if (box) box.innerHTML = '<div class="p-4 border rounded">No hay tareas asignadas a√∫n.</div>';
        }

        function initColeccion(){
            // Inicializar filtros de colecci√≥n
            document.querySelectorAll('.collection-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Actualizar bot√≥n activo
                    document.querySelectorAll('.collection-filter').forEach(b => {
                        b.classList.remove('active', 'bg-purple-600', 'text-white');
                        b.classList.add('bg-gray-100', 'text-gray-700');
                    });
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                    btn.classList.add('active', 'bg-purple-600', 'text-white');
                    
                    // Filtrar robots
                    const filter = btn.getAttribute('data-filter');
                    filterRobots(filter);
                });
            });
            
            // Cargar robots de ejemplo
            loadSampleRobots();
            
            initialized['coleccion'] = true;
        }

        function loadSampleRobots() {
            const robotsData = [
                { id: 1, name: 'Robot Detective', emoji: 'üïµÔ∏è', rarity: 'comun', locked: false, equipped: false, unlockLevel: 0, description: 'Detective curioso que busca bugs en el c√≥digo' },
                { id: 2, name: 'Robot Sargento', emoji: 'üèÖ', rarity: 'comun', locked: false, equipped: true, unlockLevel: 0, description: 'Disciplinado y organizado, mantiene tu c√≥digo en orden' },
                { id: 3, name: 'Robot Pintor', emoji: 'üé®', rarity: 'raro', locked: false, equipped: false, unlockLevel: 0, description: 'Crea interfaces hermosas con CSS art√≠stico' },
                { id: 4, name: 'Robot Astronauta', emoji: 'üöÄ', rarity: 'especial', locked: true, unlockLevel: 3, description: 'Explora las galaxias del desarrollo web' },
                { id: 5, name: 'Detective √âlite', emoji: 'üïµÔ∏è', rarity: 'epico', locked: true, unlockLevel: 4, description: 'Versi√≥n mejorada con habilidades de debugging avanzadas' },
                { id: 6, name: 'Sargento Mayor', emoji: 'üèÖ', rarity: 'epico', locked: true, unlockLevel: 4, description: 'Lidera proyectos completos con eficiencia militar' },
                { id: 7, name: 'Maestro Artista', emoji: 'üé®', rarity: 'epico', locked: true, unlockLevel: 5, description: 'Domina todos los frameworks de dise√±o conocidos' },
                { id: 8, name: 'Comandante Espacial', emoji: 'üöÄ', rarity: 'legendario', locked: true, unlockLevel: 6, description: 'Despliega aplicaciones en cualquier plataforma' },
            ];

            const grid = document.getElementById('robotsGrid');
            if (!grid) return;

            grid.innerHTML = robotsData.map(robot => `
                <div class="robot-card ${robot.locked ? 'locked' : ''}" data-rarity="${robot.rarity}" data-robot-id="${robot.id}">
                    ${!robot.locked && robot.equipped ? '<div class="robot-equipped-badge">‚úì EQUIPADO</div>' : ''}
                    <div class="robot-avatar">
                        ${robot.emoji}
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${robot.name}</h3>
                    <span class="robot-rarity-badge ${robot.rarity}">${robot.rarity.toUpperCase()}</span>
                    ${!robot.locked ? `
                        <p class="text-sm text-gray-600 mt-3 mb-4 leading-relaxed">${robot.description}</p>
                        <button class="robot-equip-btn ${robot.equipped ? 'equipped' : ''}" data-robot-id="${robot.id}">
                            ${robot.equipped ? 'Equipado' : 'Equipar'}
                        </button>
                    ` : `
                        <p class="text-sm text-gray-500 mt-3 mb-4">${robot.description}</p>
                        <div class="robot-locked-info">
                            <svg class="w-5 h-5 text-gray-400 inline-block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                            <span class="text-sm font-semibold text-gray-600">Desbloquea en Nivel ${robot.unlockLevel}</span>
                        </div>
                    `}
                </div>
            `).join('');

            // Actualizar estad√≠sticas
            const unlockedRobots = robotsData.filter(r => !r.locked);
            const legendaryUnlocked = robotsData.filter(r => r.rarity === 'legendario' && !r.locked);
            
            document.getElementById('robotsCollected').textContent = unlockedRobots.length;
            document.getElementById('chestsAvailable').textContent = '2';
            document.getElementById('legendaryRobots').textContent = legendaryUnlocked.length;
            document.getElementById('collectionLevel').textContent = Math.floor(unlockedRobots.length / 2) + 1;
            
            // Event listeners para botones Equipar
            document.querySelectorAll('.robot-equip-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const robotId = parseInt(btn.getAttribute('data-robot-id'));
                    equipRobot(robotId);
                });
            });
        }
        
        function equipRobot(robotId) {
            // Simular equipar robot
            const allBtns = document.querySelectorAll('.robot-equip-btn');
            allBtns.forEach(btn => {
                btn.classList.remove('equipped');
                btn.textContent = 'Equipar';
            });
            
            const selectedBtn = document.querySelector(`.robot-equip-btn[data-robot-id="${robotId}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('equipped');
                selectedBtn.textContent = 'Equipado';
            }
            
            // Actualizar badge EQUIPADO
            document.querySelectorAll('.robot-equipped-badge').forEach(badge => badge.remove());
            const robotCard = selectedBtn?.closest('.robot-card');
            if (robotCard) {
                const badge = document.createElement('div');
                badge.className = 'robot-equipped-badge';
                badge.textContent = '‚úì EQUIPADO';
                robotCard.insertBefore(badge, robotCard.firstChild);
            }
            
            console.log('Robot equipado:', robotId);
            // TODO: Guardar en Firestore
        }

        function filterRobots(filter) {
            const cards = document.querySelectorAll('.robot-card');
            cards.forEach(card => {
                const rarity = card.getAttribute('data-rarity');
                const isLocked = card.classList.contains('locked');
                
                if (filter === 'all') {
                    card.style.display = 'block';
                } else if (filter === 'one-in-million') {
                    card.style.display = rarity === 'one-in-million' ? 'block' : 'none';
                } else {
                    card.style.display = rarity === filter ? 'block' : 'none';
                }
            });
        }

        // Actualizar estilos del filtro activo
        document.querySelectorAll('.collection-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.collection-filter').forEach(b => {
                    b.classList.remove('active', 'bg-purple-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                btn.classList.add('active', 'bg-purple-600', 'text-white');
            });
        });


        // Actividad reciente desde state manager
        function renderRecentActivity(){
            const cont = document.getElementById('recentActivity');
            if (!cont) return;
            const items = window.userState?.state?.activityLog || [];
            if (!items.length){ cont.innerHTML = '<p class="text-gray-500">Sin actividad reciente</p>'; return; }
            cont.innerHTML = items.slice(-10).reverse().map(ev=>{
                const time = new Date(ev.timestamp||Date.now()).toLocaleString('es-MX');
                return `<div class="flex items-start gap-2"><span>‚Ä¢</span><div><p class="text-gray-700">${ev.text||ev.type||'Actividad'}</p><p class="text-[11px] text-gray-400">${time}</p></div></div>`;
            }).join('');
        }
        try { renderRecentActivity(); window.userState?.subscribe(renderRecentActivity); } catch(_){}
    
    // bindAvatarUpload() - Funci√≥n eliminada: el input avatarUpload fue removido del men√∫ del avatar
    // La funcionalidad de cambiar foto ahora est√° disponible solo desde el men√∫ de Configuraci√≥n

    </script>
    
        <!-- Modales: Marcos, Configuraci√≥n, Usuario -->
        <div id="framesModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
                <div class="bg-white rounded-xl p-6 max-w-lg w-[90%] animate-scale-in">
                        <div class="flex items-start justify-between mb-3">
                                <h3 class="text-xl font-bold">Selecciona tu Marco</h3>
                                <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('framesModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Los marcos se desbloquean al subir de nivel. Haz clic en un marco desbloqueado para aplicarlo a tu avatar.</p>
                        <div id="framesGrid" class="grid sm:grid-cols-2 gap-3 text-sm mb-4">
                                <!-- Se llena con JavaScript -->
                        </div>
                        <div class="mt-4 text-right">
                                <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" onclick="document.getElementById('framesModal').classList.add('hidden')">Cerrar</button>
                        </div>
                </div>
        </div>

        <div id="settingsModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
                <div class="bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in">
                        <div class="flex items-start justify-between mb-3">
                                <h3 class="text-xl font-bold">Configuraci√≥n</h3>
                                <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('settingsModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class="space-y-3 text-sm">
                                <label for="toggleDarkMode" class="flex items-center gap-2 cursor-pointer select-none py-2 px-3 rounded-lg hover:bg-gray-50 transition-colors">
                                        <input id="toggleDarkMode" type="checkbox" class="form-checkbox cursor-pointer" />
                                        <span class="flex-1">Modo Oscuro</span>
                                        <span id="darkModeStatus" class="text-xs text-gray-500">Desactivado</span>
                                </label>
                        </div>
                        <div class="mt-4 text-right">
                                <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" onclick="document.getElementById('settingsModal').classList.add('hidden')">Cerrar</button>
                        </div>
                </div>
        </div>

        <div id="userModal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center"></div>

        <script>
            // Abrir marcos desde el men√∫ de Configuraci√≥n
            document.getElementById('openFramesModalSettings')?.addEventListener('click', async ()=>{
                const m = document.getElementById('framesModal'); m.classList.remove('hidden'); m.classList.add('flex');
                document.getElementById('settingsDropdown')?.classList.add('hidden');
                await renderFramesGrid();
            });
            
            // Renderizar grid de marcos
            async function renderFramesGrid() {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const nivel = userData.nivel || 1;
                const selectedFrame = userData.selectedFrame || 'none';
                const unlockedFrames = userData.unlockedFrames || [];
                
                const frames = [
                    { id: 'none', name: 'Sin Marco', icon: '‚≠ï', level: 0, class: 'none' },
                    { id: 'marco_bronce', name: 'Marco Bronce', icon: 'ü•â', level: 2, class: 'bronce' },
                    { id: 'marco_plata', name: 'Marco Plata', icon: 'ü•à', level: 5, class: 'plata' },
                    { id: 'marco_oro', name: 'Marco Oro', icon: 'ü•á', level: 8, class: 'oro' },
                    { id: 'marco_diamante', name: 'Marco Diamante', icon: 'üíé', level: 10, class: 'diamante' }
                ];
                
                const grid = document.getElementById('framesGrid');
                grid.innerHTML = frames.map(frame => {
                    const unlocked = nivel >= frame.level || unlockedFrames.includes(frame.id);
                    const isSelected = selectedFrame === frame.id;
                    
                    return `
                        <div 
                            class="p-4 rounded-lg border-2 transition cursor-pointer ${unlocked ? 'hover:bg-indigo-50' : 'opacity-50 cursor-not-allowed'} ${isSelected ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}"
                            onclick="${unlocked ? `selectFrame('${frame.id}', '${frame.class}')` : ''}"
                        >
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">${frame.icon}</div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${frame.name}</div>
                                    <div class="text-xs text-gray-500">${unlocked ? (isSelected ? '‚úì Seleccionado' : 'Click para activar') : `Nivel ${frame.level} requerido`}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Seleccionar marco
            window.selectFrame = async function(frameId, frameClass) {
                const user = window.auth?.currentUser;
                if (!user) return;
                
                try {
                    await updateDoc(doc(window.db, `users/${user.uid}`), {
                        selectedFrame: frameId
                    });
                    
                    // Aplicar el marco al avatar
                    applyFrame(frameClass);
                    
                    // Actualizar el grid
                    await renderFramesGrid();
                    
                    // Cerrar modal
                    setTimeout(() => {
                        document.getElementById('framesModal').classList.add('hidden');
                        document.getElementById('framesModal').classList.remove('flex');
                    }, 300);
                } catch (error) {
                    console.error('Error al seleccionar marco:', error);
                    alert('Error al seleccionar marco');
                }
            };
            
            // Aplicar marco al avatar
            function applyFrame(frameClass) {
                const avatar = document.getElementById('userAvatar');
                if (!avatar) return;
                
                // Remover todas las clases de marco anteriores
                avatar.className = avatar.className.replace(/avatar-frame-\w+/g, '');
                
                // Agregar la nueva clase de marco
                avatar.classList.add(`avatar-frame-${frameClass}`);
                
                // Guardar en localStorage para persistencia
                localStorage.setItem('codekids_selected_frame', frameClass);
            }
            
            // Cargar marco guardado al iniciar
            async function loadSavedFrame() {
                const user = window.auth?.currentUser;
                if (!user) {
                    // Intentar cargar de localStorage temporalmente
                    const savedFrame = localStorage.getItem('codekids_selected_frame');
                    if (savedFrame) {
                        applyFrame(savedFrame);
                    }
                    return;
                }
                
                try {
                    const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const selectedFrame = userData.selectedFrame || 'none';
                        
                        // Mapear ID a clase
                        const frameMap = {
                            'none': 'none',
                            'marco_bronce': 'bronce',
                            'marco_plata': 'plata',
                            'marco_oro': 'oro',
                            'marco_diamante': 'diamante'
                        };
                        
                        const frameClass = frameMap[selectedFrame] || 'none';
                        applyFrame(frameClass);
                    }
                } catch (error) {
                    console.error('Error cargando marco:', error);
                }
            }
            
            document.getElementById('openSettings')?.addEventListener('click', (e)=>{
                e.preventDefault();
                e.stopPropagation();
                // Usar la configuraci√≥n global si est√° disponible
                if (window.openGlobalSettings) { 
                    window.openGlobalSettings(e.currentTarget); 
                } else {
                    alert('Configuraci√≥n no disponible. Por favor recarga la p√°gina.');
                }
            });
            
            // Cerrar sesi√≥n (bot√≥n del men√∫ de avatar - ya no existe, mantener por compatibilidad)
            document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
                if (window.logout) {
                    window.logout();
                }
            });

            // Cerrar sesi√≥n (nuevo bot√≥n del men√∫ de configuraci√≥n)
            document.getElementById('logoutBtnSettings')?.addEventListener('click', ()=>{
                if (window.logout) {
                    window.logout();
                }
                // Cerrar dropdown de configuraci√≥n
                document.getElementById('settingsDropdown')?.classList.add('hidden');
            });

            // Modal de usuario para resultados de b√∫squeda
            function openUserModal(userId){
                const data = {
                    prof_alan: { id:'prof_alan', name:'Profesor Alan', role:'Profesor', level:7, avatar:'https://ui-avatars.com/api/?name=Alan&background=6366f1&color=fff' }
                };
                const u = data[userId]; if (!u) return;
                const el = document.getElementById('userModal');
                el.innerHTML = `
                    <div class='bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in'>
                        <div class='flex items-start justify-between mb-3'>
                            <h3 class='text-xl font-bold'>Perfil</h3>
                            <button class='text-gray-500 hover:text-gray-700' onclick="document.getElementById('userModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class='flex items-center gap-3 mb-4'>
                            <img src='${u.avatar}' class='w-12 h-12 rounded-full border'/>
                            <div>
                                <div class='font-semibold'>${u.name}</div>
                                <div class='text-xs text-gray-500'>${u.role} ¬∑ Nivel ${u.level}</div>
                            </div>
                        </div>
                        <div class='text-sm text-gray-600 mb-4'>Mentor en programaci√≥n y ciencias de la computaci√≥n.</div>
                        <div class='text-right'>
                            <button id='btnMsgUser' class='bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700'>Enviar Mensaje</button>
                        </div>
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('btnMsgUser').onclick = ()=>{ document.getElementById('userModal').classList.add('hidden'); window.location.hash = '#chats'; };
            }
            window.openUserModal = openUserModal;
            
            // Modal de usuario con datos reales de Firestore
            function openUserModalReal(user){
                const el = document.getElementById('userModal');
                const roleNames = {
                    'Profesor': 'Profesor',
                    'Estudiante': 'Estudiante',
                    'Admin': 'Administrador'
                };
                const roleName = roleNames[user.role] || user.role;
                
                el.innerHTML = `
                    <div class='bg-white rounded-xl p-6 max-w-md w-[90%] animate-scale-in'>
                        <div class='flex items-start justify-between mb-3'>
                            <h3 class='text-xl font-bold'>Perfil</h3>
                            <button class='text-gray-500 hover:text-gray-700' onclick="document.getElementById('userModal').classList.add('hidden')">‚úñ</button>
                        </div>
                        <div class='flex items-center gap-3 mb-4'>
                            <img src='${user.avatar}' class='w-16 h-16 rounded-full border-2 border-indigo-200'/>
                            <div>
                                <div class='font-semibold text-lg'>${user.name}</div>
                                <div class='text-sm text-gray-600'>${roleName}</div>
                                <div class='text-xs text-indigo-600 font-semibold mt-1'>Nivel ${user.level} ¬∑ ${user.xp} XP</div>
                            </div>
                        </div>
                        <div class='mb-4'>
                            <div class='flex justify-between text-xs text-gray-500 mb-1'>
                                <span>Progreso al siguiente nivel</span>
                                <span>${Math.min(100, Math.floor((user.xp % 100) / 1))}%</span>
                            </div>
                            <div class='w-full bg-gray-200 rounded-full h-2'>
                                <div class='bg-indigo-600 h-2 rounded-full transition-all' style='width: ${Math.min(100, (user.xp % 100))}%'></div>
                            </div>
                        </div>
                        <div class='text-right'>
                            <button id='btnMsgUser' class='bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition'>Enviar Mensaje</button>
                        </div>
                    </div>`;
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('btnMsgUser').onclick = ()=>{ 
                    document.getElementById('userModal').classList.add('hidden'); 
                    window.location.hash = '#chats'; 
                };
            }
            window.openUserModalReal = openUserModalReal;
        </script>
        <script src="../js/global-ui.js"></script>
        <script type="module">
            import '../js/firebase-init.js';
            import { initAuth } from '../js/auth.js';
            import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
            import { doc, getDoc, collection, query, where, orderBy, limit, startAfter, getDocs, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
            import { updateGamificationHeader, addXP, loadXPFromFirestore } from '../js/gamification.js';
            
            // Hacer funciones globales
            if (!window.addXP) {
                window.addXP = addXP;
            }
            if (!window.loadXPFromFirestore) {
                window.loadXPFromFirestore = loadXPFromFirestore;
            }
            
            window.logout = async function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    try { await signOut(window.auth); window.location.href = '../index.html'; } catch (e) { alert('Error al cerrar sesi√≥n'); }
                }
            };
            
            // ========== B√öSQUEDA REAL CON FIRESTORE ==========
            const searchInput = document.getElementById('globalSearch');
            const searchBtn = document.getElementById('searchBtn');
            const searchResults = document.getElementById('searchResults');
            
            async function performSearchReal(){
                const q = (searchInput.value||'').toLowerCase().trim();
                if (!q || q.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Buscando...</div>';
                searchResults.classList.remove('hidden');
                
                // Esperar a que window.currentUser est√© disponible (desde firebase-init.js)
                if (!window.currentUser) {
                    // Esperar hasta 3 segundos
                    for (let i = 0; i < 30; i++) {
                        await new Promise(r => setTimeout(r, 100));
                        if (window.currentUser) break;
                    }
                    if (!window.currentUser) {
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Inicia sesi√≥n para buscar</div>';
                        return;
                    }
                }
                
                try {
                    // Verificar que db est√© disponible
                    if (!window.db) {
                        console.error('window.db no est√° disponible');
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Error: Base de datos no inicializada</div>';
                        return;
                    }
                    
                    console.log('Buscando en Firestore:', q);
                    
                    // Buscar usuarios en Firestore
                    const usersRef = collection(window.db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    
                    console.log('Usuarios encontrados:', usersSnapshot.size);
                    
                    const users = [];
                    usersSnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const name = (data.displayName || '').toLowerCase();
                        const searchable = (data.searchableDisplayName || '').toLowerCase();
                        
                        if (name.includes(q) || searchable.includes(q)) {
                            const avatar = data.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.displayName)}&background=6366f1&color=fff`;
                            users.push({
                                id: docSnap.id,
                                name: data.displayName,
                                role: data.role || data.rol,
                                level: data.nivel || 1,
                                xp: data.xp || 0,
                                avatar: avatar
                            });
                        }
                    });
                    
                    console.log('Usuarios que coinciden:', users.length);
                    
                    // Buscar lecciones y juegos
                    const lessons = (window.COURSES||[{id:'python', title:'Python B√°sico'}]).map(c=>({ id:c.id, title:c.title, route:'#lecciones' }));
                    const games = [{ id:'blocky', title:'Blocky', route:'#laboratorio' }, { id:'typo', title:'Typo-Racer', route:'#laboratorio' }];
                    
                    const fL = lessons.filter(l=>l.title.toLowerCase().includes(q));
                    const fG = games.filter(g=>g.title.toLowerCase().includes(q));
                    
                    if (!users.length && !fL.length && !fG.length){
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No se encontraron resultados</div>';
                        return;
                    }
                    
                    const sec = [];
                    if (users.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Usuarios (${users.length})</div>`);
                        sec.push(...users.map(u=>`<button data-user='${u.id}' class='search-user-btn w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-50 transition'>
                            <img src='${u.avatar}' class='w-8 h-8 rounded-full border-2 border-gray-200'/> 
                            <div class='flex-1 text-left'>
                                <div class='font-semibold text-sm'>${u.name}</div>
                                <div class='text-xs text-gray-500'>${u.role}</div>
                            </div>
                            <span class='text-xs text-indigo-600 font-semibold'>Nivel ${u.level}</span>
                        </button>`));
                    }
                    if (fL.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Lecciones</div>`);
                        sec.push(...fL.map(l=>`<button data-route='${l.route}' class='search-route-btn w-full text-left px-4 py-2 hover:bg-gray-50'>${l.title}</button>`));
                    }
                    if (fG.length){
                        sec.push(`<div class='px-3 py-2 text-[11px] text-gray-500 uppercase font-semibold'>Juegos</div>`);
                        sec.push(...fG.map(g=>`<button data-route='${g.route}' class='search-route-btn w-full text-left px-4 py-2 hover:bg-gray-50'>${g.title}</button>`));
                    }
                    
                    searchResults.innerHTML = sec.join('');
                    
                    // Eventos para rutas
                    searchResults.querySelectorAll('.search-route-btn').forEach(b=>b.addEventListener('click',()=>{ 
                        window.location.hash = b.getAttribute('data-route'); 
                        searchResults.classList.add('hidden'); 
                    }));
                    
                    // Eventos para usuarios
                    searchResults.querySelectorAll('.search-user-btn').forEach(b=>b.addEventListener('click',()=>{ 
                        const userId = b.getAttribute('data-user'); 
                        const user = users.find(u => u.id === userId);
                        if (user) openUserModalReal(user);
                        searchResults.classList.add('hidden'); 
                    }));
                    
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                    console.error('Error completo:', error.message, error.stack);
                    searchResults.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${error.message}</div>`;
                }
            }
            
            searchBtn?.addEventListener('click', performSearchReal);
            searchInput?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ performSearchReal(); }});
            
            // Cerrar resultados al hacer click fuera
            document.addEventListener('click', (e) => {
                if (searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target) && !searchBtn.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
            
            // ========== NOTIFICACIONES REALES CON FIRESTORE ==========
            async function loadNotifications(){
                const uid = window.auth.currentUser?.uid;
                if (!uid) return;
                
                try {
                    const notifList = document.getElementById('notificationList');
                    const notifDot = document.getElementById('notificationDot');
                    
                    // Cargar notificaciones desde Firestore
                    const notifRef = collection(window.db, `users/${uid}/notifications`);
                    const q = query(notifRef, orderBy('createdAt', 'desc'), limit(10));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        notifList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No tienes notificaciones</div>';
                        notifDot.classList.add('hidden');
                        return;
                    }
                    
                    notifList.innerHTML = '';
                    let hasUnread = false;
                    
                    snapshot.forEach(docSnap => {
                        const notif = docSnap.data();
                        const isUnread = !notif.read;
                        if (isUnread) hasUnread = true;
                        
                        const item = document.createElement('div');
                        item.className = `p-4 hover:bg-gray-50 cursor-pointer border-b ${isUnread ? 'bg-blue-50' : ''}`;
                        item.innerHTML = `
                            <div class='flex justify-between items-start'>
                                <div class='flex-1'>
                                    <div class='font-semibold text-sm'>${notif.title || 'Notificaci√≥n'}</div>
                                    <div class='text-xs text-gray-500 mt-1'>${notif.message || ''}</div>
                                    <div class='text-xs text-gray-400 mt-1'>${formatRelative(notif.createdAt)}</div>
                                </div>
                                ${isUnread ? '<span class="ml-2 w-2 h-2 bg-blue-600 rounded-full"></span>' : ''}
                            </div>
                        `;
                        
                        // Marcar como le√≠da al hacer clic
                        item.addEventListener('click', async () => {
                            if (isUnread) {
                                await updateDoc(doc(window.db, `users/${uid}/notifications/${docSnap.id}`), { read: true });
                                item.classList.remove('bg-blue-50');
                                item.querySelector('.w-2')?.remove();
                                loadNotifications(); // Recargar para actualizar el dot
                            }
                        });
                        
                        notifList.appendChild(item);
                    });
                    
                    // Mostrar/ocultar el punto rojo
                    if (hasUnread) {
                        notifDot.classList.remove('hidden');
                    } else {
                        notifDot.classList.add('hidden');
                    }
                    
                } catch (error) {
                    console.error('Error cargando notificaciones:', error);
                }
            }
            
            // Event listener para el bot√≥n de notificaciones
            const notifBtn = document.getElementById('notificationBtn');
            const notifDropdown = document.getElementById('notificationDropdown');
            
            notifBtn?.addEventListener('click', () => {
                const isHidden = notifDropdown.classList.contains('hidden');
                if (isHidden) {
                    loadNotifications(); // Cargar al abrir
                }
                notifDropdown.classList.toggle('hidden');
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (notifDropdown && !notifDropdown.classList.contains('hidden') && !notifDropdown.contains(e.target) && !notifBtn?.contains(e.target)) {
                    notifDropdown.classList.add('hidden');
                }
            });
            
            // ========== FORMATO DE TIEMPO ==========
            function formatRelative(ts){
                try { const d = ts.toDate(); const diff = (Date.now()-d.getTime())/1000; if (diff<60) return 'Hace segundos'; if (diff<3600) return `Hace ${Math.floor(diff/60)} min`; if (diff<86400) return `Hace ${Math.floor(diff/3600)} h`; return d.toLocaleDateString('es-MX'); } catch(_) { return ''; }
            }

            let lastAnnDoc = null;
            async function loadAnnouncements({ append=false }={}){
                                        const feed = document.getElementById('announcementsFeed');
                                        let qRef = query(collection(window.db,'announcements'), orderBy('createdAt','desc'), limit(10));
                                        if (append && lastAnnDoc) qRef = query(collection(window.db,'announcements'), orderBy('createdAt','desc'), startAfter(lastAnnDoc), limit(10));
                                        const snap = await getDocs(qRef);
                                        if (snap.docs.length) lastAnnDoc = snap.docs[snap.docs.length-1];
                                        const frag = document.createDocumentFragment();
                                        snap.forEach(docSnap => { const a = docSnap.data(); const div=document.createElement('div'); div.className=`border-l-4 ${a.authorRole==='Admin'?'border-indigo-600 bg-indigo-50':'border-gray-300 bg-gray-50'} p-3 rounded`; div.innerHTML = `
                                            <div class='flex justify-between items-start'><div><p class='font-semibold text-gray-800'>${a.title||'Anuncio'}</p><p class='text-xs text-gray-500'>Publicado por ${a.authorName||'---'} ¬∑ ${formatRelative(a.createdAt)}</p></div><button data-id='${docSnap.id}' class='markRead text-xs text-indigo-600 hover:underline'>Marcar le√≠do</button></div>
                                            <p class='text-sm mt-2 line-clamp-3'>${a.content||''}</p>
                                            <button data-full='${docSnap.id}' class='openAnnouncement text-xs mt-2 text-gray-700 hover:text-gray-900'>Ver completo</button>`; frag.appendChild(div); });
                                        if (!append) feed.innerHTML=''; feed.appendChild(frag);
                                        // Bind markRead
                                        feed.querySelectorAll('.markRead').forEach(btn=>btn.addEventListener('click', async ()=>{
                                            const id = btn.getAttribute('data-id');
                                            const uid = window.auth.currentUser?.uid; if (!uid) return;
                                            await setDoc(doc(window.db, `users/${uid}/announcementsRead/${id}`), { readAt: new Date() });
                                            btn.textContent = 'Le√≠do'; btn.disabled = true; btn.classList.add('opacity-60');
                                        }));
                                    }

                        async function loadContinueLearning(userData, user = null){
                            const el = document.getElementById('continueLearning');
                            
                            // Si no se pasa user, intentar obtenerlo de window.dashboardUser
                            if (!user) {
                                user = window.dashboardUser || window.auth?.currentUser || window.currentUser;
                            }
                            
                            if (!user) {
                                console.warn('‚ö†Ô∏è loadContinueLearning: No hay usuario autenticado');
                                el.innerHTML = `<p class="text-gray-600 text-sm">Inicia sesi√≥n para ver tu progreso.</p>`;
                                return;
                            }
                            
                            console.log('üìö loadContinueLearning iniciado para:', user.uid);
                            
                            try {
                                // Leer progreso de lecciones desde Firestore
                                const lessonsDoc = await getDoc(doc(window.db, `users/${user.uid}/progress/lessons`));
                                
                                if (!lessonsDoc.exists() || !lessonsDoc.data().courses) {
                                    el.innerHTML = `<p class="text-gray-600 text-sm">No has comenzado ning√∫n curso a√∫n.</p>
                                                    <a href="#lecciones" class="text-indigo-600 hover:underline text-sm mt-2 inline-block">Explorar cursos ‚Üí</a>`;
                                    return;
                                }
                                
                                const courses = lessonsDoc.data().courses || {};
                                let lastVideo = null;
                                let lastCourse = null;
                                let lastTimestamp = null;
                                
                                // Buscar el √∫ltimo video completado o en progreso
                                COURSES_DASH.forEach(course => {
                                    const courseProgress = courses[course.id];
                                    if (!courseProgress) return;
                                    
                                    course.videos.forEach((video, index) => {
                                        const videoProgress = courseProgress[video.id];
                                        if (videoProgress && videoProgress.completedAt) {
                                            const timestamp = videoProgress.completedAt.toDate ? videoProgress.completedAt.toDate() : new Date(videoProgress.completedAt);
                                            if (!lastTimestamp || timestamp > lastTimestamp) {
                                                lastTimestamp = timestamp;
                                                lastVideo = video;
                                                lastCourse = course;
                                            }
                                        }
                                    });
                                });
                                
                                if (lastVideo && lastCourse) {
                                    // Buscar el siguiente video sin completar
                                    const lastIndex = lastCourse.videos.findIndex(v => v.id === lastVideo.id);
                                    const nextIndex = lastIndex + 1;
                                    
                                    if (nextIndex < lastCourse.videos.length) {
                                        const nextVideo = lastCourse.videos[nextIndex];
                                        el.innerHTML = `
                                            <div class="text-sm">
                                                <p class="text-gray-600 mb-2">üìö ${lastCourse.title}</p>
                                                <p class="font-semibold text-gray-800">${nextVideo.title}</p>
                                                <button onclick="window.location.hash='#lecciones'; setTimeout(() => window.openCourseDash('${lastCourse.id}'), 300);" 
                                                        class="mt-2 text-indigo-600 hover:underline text-sm">
                                                    Continuar curso ‚Üí
                                                </button>
                                            </div>
                                        `;
                                    } else {
                                        el.innerHTML = `
                                            <div class="text-sm">
                                                <p class="text-green-600 font-semibold mb-2">‚úì ${lastCourse.title} completado</p>
                                                <a href="#lecciones" class="text-indigo-600 hover:underline">Ver m√°s cursos ‚Üí</a>
                                            </div>
                                        `;
                                    }
                                } else {
                                    el.innerHTML = `<p class="text-gray-600 text-sm">No has comenzado ning√∫n curso a√∫n.</p>
                                                    <a href="#lecciones" class="text-indigo-600 hover:underline text-sm mt-2 inline-block">Explorar cursos ‚Üí</a>`;
                                }
                            } catch (error) {
                                console.error('‚ùå Error cargando continuar aprendiendo:', error);
                                console.error('Error details:', { code: error.code, message: error.message });
                                // Mostrar mensaje amigable sin romper la UI
                                el.innerHTML = `<p class="text-gray-600 text-sm">No has comenzado ning√∫n curso a√∫n.</p>
                                               <a href="#lecciones" class="text-indigo-600 hover:underline text-sm mt-2 inline-block">Explorar cursos ‚Üí</a>`;
                            }
                        }

                        initAuth(async (user, userData) => {
                                console.log('üîê ========== INICIO DE SESI√ìN ==========');
                                console.log('üë§ Usuario:', user.uid);
                                console.log('üìã Datos:', userData);
                                
                                // CR√çTICO: Guardar user globalmente para acceso posterior
                                window.dashboardUser = user;
                                window.dashboardUserData = userData;
                                
                                // 1. Actualizar nombre y rol
                                document.getElementById('userName').textContent = userData.displayName || 'Usuario';
                                document.getElementById('userRole').textContent = (userData.role || userData.rol || '').toString();
                                document.getElementById('welcomeName').textContent = userData.displayName?.split(' ')[0] || 'Usuario';
                                
                                // 1.1. Actualizar foto de perfil
                                const avatarUrl = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'Usuario')}&background=667eea&color=fff`;
                                document.getElementById('userAvatar').src = avatarUrl;
                                console.log('‚úÖ Avatar actualizado:', avatarUrl);
                                
                                // 2. Cargar TODOS los datos desde Firestore UNA SOLA VEZ
                                console.log('üìä Cargando datos desde Firestore...');
                                try {
                                    const userDocRef = doc(window.db, `users/${user.uid}`);
                                    const userDoc = await getDoc(userDocRef);
                                    let freshData = {};
                                    
                                    if (userDoc.exists()) {
                                        freshData = userDoc.data();
                                        
                                        // INICIALIZAR xp y nivel si no existen
                                        if (freshData.xp === undefined || freshData.nivel === undefined) {
                                            console.warn('‚ö†Ô∏è Usuario sin XP/nivel - inicializando...');
                                            const { updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                            await updateDoc(userDocRef, { xp: 0, nivel: 1, unlockedFrames: [] });
                                            freshData.xp = 0;
                                            freshData.nivel = 1;
                                            freshData.unlockedFrames = [];
                                        }
                                        
                                        console.log('‚úÖ Datos frescos:', { xp: freshData.xp, nivel: freshData.nivel, selectedFrame: freshData.selectedFrame });
                                        
                                        // 3. Actualizar XP y nivel usando gamification.js
                                        if (window.updateGamificationHeader) {
                                            window.updateGamificationHeader(freshData.xp || 0);
                                            console.log('‚úÖ Header de gamificaci√≥n actualizado');
                                        }
                                        
                                        // 4. Cargar marco guardado (sin sobrescribir el src de la imagen)
                                        if (freshData.selectedFrame) {
                                            const avatar = document.getElementById('userAvatar');
                                            const frameClass = `avatar-frame-${freshData.selectedFrame.replace('marco_', '')}`;
                                            // Solo actualizar las clases, no el src de la imagen
                                            avatar.className = `w-full h-full rounded-full border-2 ${frameClass}`;
                                            console.log('‚úÖ Marco aplicado:', frameClass);
                                        } else {
                                            // Si no hay marco guardado, asegurar clases por defecto
                                            const avatar = document.getElementById('userAvatar');
                                            avatar.className = 'w-full h-full rounded-full border-2 border-transparent';
                                        }
                                        
                                        // 5. Actualizar estad√≠sticas del dashboard
                                        await updateDashboardStats(user, freshData);
                                        console.log('‚úÖ Estad√≠sticas actualizadas');
                                        
                                        // 6. Cargar continuar aprendiendo
                                        await loadContinueLearning(userData, user);
                                        console.log('‚úÖ Continuar aprendiendo cargado');
                                        
                                        // 7. Cargar anuncios
                                        loadAnnouncements();
                                        console.log('‚úÖ Anuncios cargados');
                                        
                                        console.log('üéâ ========== CARGA COMPLETA ==========');
                                    }
                                } catch (error) {
                                    console.error('‚ùå Error cargando datos:', error);
                                }
                        });
                        
                        // Funci√≥n global para actualizar estad√≠sticas del dashboard
                        window.loadUserData = async function() {
                          const user = window.dashboardUser;
                          if (!user) {
                            console.warn('‚ö†Ô∏è loadUserData: No hay usuario autenticado');
                            return;
                          }
                          
                          // Recargar datos frescos
                          const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                          if (userDoc.exists()) {
                            const freshData = userDoc.data();
                            await updateDashboardStats(user, freshData);
                            window.updateGamificationHeader(freshData.xp || 0);
                          }
                        };
                        
                        async function updateDashboardStats(user, userData = null) {
                          if (!user) {
                            console.warn('‚ö†Ô∏è updateDashboardStats: No user provided');
                            return;
                          }
                          
                          // Si no se pasaron datos, cargarlos
                          if (!userData) {
                            const userDoc = await getDoc(doc(window.db, `users/${user.uid}`));
                            if (!userDoc.exists()) {
                              console.warn('‚ö†Ô∏è No se encontr√≥ documento de usuario');
                              return;
                            }
                            userData = userDoc.data();
                          }
                          
                          console.log('üìä updateDashboardStats iniciado para:', user.uid);
                          
                          try {
                            // Obtener progreso de lecciones
                            const lessonsDoc = await getDoc(doc(window.db, `users/${user.uid}/progress/lessons`));
                            let completedVideosCount = 0;
                            let totalVideos = 0;
                            
                            if (lessonsDoc.exists()) {
                              const courses = lessonsDoc.data().courses || {};
                              COURSES_DASH.forEach(course => {
                                totalVideos += course.videos.length;
                                const courseProgress = courses[course.id] || {};
                                completedVideosCount += Object.values(courseProgress).filter(v => v.completed).length;
                              });
                            } else {
                              COURSES_DASH.forEach(course => {
                                totalVideos += course.videos.length;
                              });
                            }
                            
                            console.log('üìö Lecciones completadas:', completedVideosCount, 'de', totalVideos);
                            const statsLessonsEl = document.getElementById('statsLessons');
                            if (statsLessonsEl) {
                              statsLessonsEl.textContent = completedVideosCount;
                              console.log('‚úÖ statsLessons actualizado a:', completedVideosCount);
                            } else {
                              console.error('‚ùå No se encontr√≥ elemento statsLessons');
                            }
                            
                            const lessonsPercent = totalVideos > 0 ? (completedVideosCount / totalVideos) * 100 : 0;
                            const progressLessonsEl = document.getElementById('progressLessons');
                            if (progressLessonsEl) {
                              progressLessonsEl.style.width = `${lessonsPercent}%`;
                            }
                            
                            // Usar userData que ya se pas√≥ (no volver a cargar)
                            console.log('üë§ Datos de usuario:', { xp: userData.xp, nivel: userData.nivel, unlockedFrames: userData.unlockedFrames });
                            
                            // Actualizar XP en el header
                            if (window.updateGamificationHeader) {
                              window.updateGamificationHeader(userData.xp || 0);
                            }
                            
                            // Juegos jugados (estimado por XP o gameScores)
                            const gamesPlayed = Object.keys(userData.studentProfile?.gameScores || {}).length;
                            console.log('üéÆ Juegos jugados:', gamesPlayed);
                            const statsGamesEl = document.getElementById('statsGames');
                            if (statsGamesEl) {
                              statsGamesEl.textContent = gamesPlayed;
                              console.log('‚úÖ statsGames actualizado a:', gamesPlayed);
                            }
                            
                            const gamesPercent = gamesPlayed > 0 ? Math.min((gamesPlayed / 10) * 100, 100) : 0;
                            const progressGamesEl = document.getElementById('progressGames');
                            if (progressGamesEl) {
                              progressGamesEl.style.width = `${gamesPercent}%`;
                            }
                            
                            // Marcos desbloqueados
                            const unlockedFrames = (userData.unlockedFrames || []).length;
                            console.log('üñºÔ∏è Marcos desbloqueados:', unlockedFrames);
                            const statsFramesEl = document.getElementById('statsFrames');
                            if (statsFramesEl) {
                              statsFramesEl.textContent = `${unlockedFrames}/5`;
                              console.log('‚úÖ statsFrames actualizado a:', `${unlockedFrames}/5`);
                            }
                            
                            // Tiempo de estudio (mock por ahora)
                            const studyMinutes = userData.studentProfile?.studyTime || 0;
                            const hours = Math.floor(studyMinutes / 60);
                            const mins = studyMinutes % 60;
                            const statsStudyTimeEl = document.getElementById('statsStudyTime');
                            if (statsStudyTimeEl) {
                              statsStudyTimeEl.textContent = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                            }
                            
                            // Actividad reciente
                            updateRecentActivity(userData);
                            
                            console.log('‚úÖ Estad√≠sticas del dashboard actualizadas completamente');
                          } catch (error) {
                            console.error('‚ùå Error actualizando estad√≠sticas:', error);
                          }
                        }
                        
                        function updateRecentActivity(userData) {
                          const activityContainer = document.getElementById('recentActivity');
                          const activities = [];
                          
                          // Actividades de lecciones (√∫ltimas 3)
                          if (userData.studentProfile?.recentLessons) {
                            userData.studentProfile.recentLessons.slice(0, 3).forEach(lesson => {
                              activities.push(`<div class="flex items-center gap-2 py-1">
                                <span class="text-green-500">‚úì</span>
                                <span class="text-gray-700">${lesson.title || 'Lecci√≥n completada'}</span>
                              </div>`);
                            });
                          }
                          
                          // XP ganado recientemente
                          const xp = userData.xp || 0;
                          if (xp > 0) {
                                                        activities.push(`<div class="flex items-center gap-2 py-1">
                                                            <span class="text-yellow-500" aria-hidden="true"></span>
                                                            <span class="text-gray-700">${xp} XP total acumulado</span>
                                                        </div>`);
                          }
                          
                          if (activities.length > 0) {
                            activityContainer.innerHTML = activities.join('');
                          } else {
                            activityContainer.innerHTML = '<p class="text-gray-500">Sin actividad reciente</p>';
                          }
                        }
                        
                        document.getElementById('loadMoreAnnouncements').addEventListener('click', ()=>loadAnnouncements({append:true}));
                        document.getElementById('refreshAnnouncements').addEventListener('click', ()=>{ lastAnnDoc=null; loadAnnouncements({append:false}); });
                        
                        // ========== M√ìDULO DE LECCIONES INTEGRADO ==========
                        window.COURSES_DASH = [
                          {
                            id: 'python_basico',
                            title: 'Python B√°sico',
                            description: 'Aprende los fundamentos de Python desde cero. Este curso te ense√±ar√° variables, tipos de datos, condicionales, bucles y funciones. Perfecto para principiantes que quieren dar sus primeros pasos en programaci√≥n.',
                            thumbnail: 'https://img.youtube.com/vi/kqtD5dpn9C8/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '45 min',
                            icon: 'üêç',
                            videos: [
                              { id:'v1', title:'Paso 1: Introducci√≥n a Python', ytId:'kqtD5dpn9C8', duration: 300 },
                              { id:'v2', title:'Paso 2: Variables y Tipos', ytId:'x7X9w_GIm1s', duration: 420 },
                              { id:'v3', title:'Paso 3: Condicionales', ytId:'5u0jaA3qAGk', duration: 380 },
                              { id:'v4', title:'Paso 4: Bucles', ytId:'9OK32jb_TdI', duration: 450 },
                              { id:'v5', title:'Paso 5: Funciones', ytId:'NSbOtYzIQI0', duration: 520 }
                            ]
                          },
                          {
                            id: 'javascript_intro',
                            title: 'JavaScript para Principiantes',
                            description: 'Descubre el lenguaje que hace las p√°ginas web interactivas. Aprender√°s a manipular el DOM, crear funciones y trabajar con eventos.',
                            thumbnail: 'https://img.youtube.com/vi/z95mZVUcJ-E/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '1 hora',
                            icon: '‚ö°',
                            videos: [
                              { id:'js1', title:'Introducci√≥n a JavaScript', ytId:'z95mZVUcJ-E', duration: 600 },
                              { id:'js2', title:'Variables y Operadores', ytId:'Zlr5rNSpPBo', duration: 480 },
                              { id:'js3', title:'Funciones', ytId:'N8ap4k_1QEQ', duration: 540 }
                            ]
                          },
                          {
                            id: 'html_css_basico',
                            title: 'HTML & CSS B√°sico',
                            description: 'Crea tus primeras p√°ginas web. Aprender√°s la estructura de HTML y c√≥mo darle estilo con CSS.',
                            icon: 'üåê',
                            thumbnail: 'https://img.youtube.com/vi/kN1XP-Bef7w/maxresdefault.jpg',
                            level: 'Principiante',
                            duration: '50 min',
                            videos: [
                              { id:'html1', title:'Estructura HTML', ytId:'kN1XP-Bef7w', duration: 400 },
                              { id:'html2', title:'CSS B√°sico', ytId:'wRNinF7YQqQ', duration: 480 },
                              { id:'html3', title:'Flexbox y Grid', ytId:'tXIhdp5R7sc', duration: 520 }
                            ]
                          }
                        ];

                        let currentCourseDash = null;
                        let currentVideoIndexDash = 0;
                        let ytPlayerDash = null;
                        let progressIntervalDash = null;
                        let userProgressDash = {};

                        async function loadUserProgressDash() {
                          const user = window.auth?.currentUser;
                          if (!user) return;
                          try {
                            const progressDoc = await getDoc(doc(window.db, `users/${user.uid}/progress/lessons`));
                            if (progressDoc.exists()) {
                              userProgressDash = progressDoc.data().courses || {};
                            }
                          } catch (error) {
                            console.error('Error cargando progreso:', error);
                          }
                        }

                        async function saveProgressDash() {
                          const user = window.auth?.currentUser;
                          if (!user) return;
                          try {
                            await setDoc(doc(window.db, `users/${user.uid}/progress/lessons`), {
                              courses: userProgressDash,
                              lastUpdated: new Date()
                            }, { merge: true });
                          } catch (error) {
                            console.error('Error guardando progreso:', error);
                          }
                        }

                        function renderCatalogDash() {
                          const grid = document.getElementById('coursesGridDash');
                          if (!grid) return;
                          
                          grid.innerHTML = COURSES_DASH.map(course => {
                            const courseProgress = userProgressDash[course.id] || {};
                            const completedVideos = Object.values(courseProgress).filter(v => v.completed).length;
                            const totalVideos = course.videos.length;
                            const progressPercent = totalVideos > 0 ? Math.round((completedVideos / totalVideos) * 100) : 0;

                            return `
                              <div class="course-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition" data-course-id="${course.id}">
                                <div class="aspect-video bg-gray-200 overflow-hidden">
                                  <img src="${course.thumbnail}" alt="${course.title}" class="w-full h-full object-cover">
                                </div>
                                <div class="p-5">
                                  <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full">${course.level}</span>
                                    <span class="text-xs text-gray-500">‚è±Ô∏è ${course.duration}</span>
                                  </div>
                                  <h3 class="text-lg font-bold text-gray-800 mb-2">${course.title}</h3>
                                  <p class="text-sm text-gray-600 mb-4 line-clamp-2">${course.description.substring(0, 100)}...</p>
                                  
                                  <div class="mb-3">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>${completedVideos} de ${totalVideos} videos</span>
                                      <span>${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                      <div class="bg-indigo-600 h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                                    </div>
                                  </div>
                                  
                                  <button class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">
                                    ${progressPercent > 0 ? 'Continuar' : 'Comenzar'} ‚Üí
                                  </button>
                                </div>
                              </div>
                            `;
                          }).join('');

                          grid.querySelectorAll('.course-card').forEach(card => {
                            card.addEventListener('click', () => {
                              const courseId = card.getAttribute('data-course-id');
                              openCourseDash(courseId);
                            });
                          });
                        }

                        function openCourseDash(courseId) {
                          currentCourseDash = COURSES_DASH.find(c => c.id === courseId);
                          if (!currentCourseDash) return;

                          if (!userProgressDash[courseId]) {
                            userProgressDash[courseId] = {};
                          }

                          if (!window.YT) {
                            const tag = document.createElement('script');
                            tag.src = "https://www.youtube.com/iframe_api";
                            document.head.appendChild(tag);
                          }

                          renderCourseDetailDash();
                          showDetailDash();
                          
                          const firstIncomplete = currentCourseDash.videos.findIndex((v) => {
                            return !userProgressDash[courseId][v.id]?.completed;
                          });
                          loadVideoDash(firstIncomplete >= 0 ? firstIncomplete : 0);
                        }

                        function renderCourseDetailDash() {
                          document.getElementById('courseTitleDash').textContent = currentCourseDash.title;
                          document.getElementById('courseDescriptionDash').textContent = currentCourseDash.description;
                          updateCourseProgressDash();
                          renderVideosListDash();
                        }

                        function updateCourseProgressDash() {
                          const courseProgress = userProgressDash[currentCourseDash.id] || {};
                          const completedCount = Object.values(courseProgress).filter(v => v.completed).length;
                          const totalCount = currentCourseDash.videos.length;
                          const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                          
                          document.getElementById('courseProgressDash').textContent = `${percent}% completado`;
                          document.getElementById('courseProgressBarDash').style.width = `${percent}%`;
                        }

                        function renderVideosListDash() {
                          const list = document.getElementById('videosListDash');
                          const courseProgress = userProgressDash[currentCourseDash.id] || {};
                          
                          list.innerHTML = currentCourseDash.videos.map((video, index) => {
                            const isCompleted = courseProgress[video.id]?.completed || false;
                            const isLocked = index > 0 && !courseProgress[currentCourseDash.videos[index - 1].id]?.completed;
                            const isCurrent = index === currentVideoIndexDash;
                            
                            return `
                              <div class="video-item ${isCompleted ? 'bg-green-50' : ''} ${isLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-50'} ${isCurrent ? 'border-2 border-indigo-500' : 'border border-gray-200'} rounded-lg p-3 transition" data-video-index="${index}">
                                <div class="flex items-center gap-3">
                                  <div class="flex-shrink-0">
                                    ${isCompleted ? '<span class="status-text">Completada</span>' : isLocked ? '<span class="status-text">Bloqueada</span>' : isCurrent ? '<span class="status-text">En curso</span>' : '<span class="status-text">Pendiente</span>'}
                                  </div>
                                  <div class="flex-1">
                                    <div class="text-sm font-semibold text-gray-800">${video.title}</div>
                                    <div class="text-xs text-gray-500">${Math.floor(video.duration / 60)} min</div>
                                  </div>
                                </div>
                              </div>
                            `;
                          }).join('');

                          list.querySelectorAll('.video-item').forEach((item, index) => {
                            const isLocked = index > 0 && !courseProgress[currentCourseDash.videos[index - 1].id]?.completed;
                            if (!isLocked) {
                              item.addEventListener('click', () => loadVideoDash(index));
                            }
                          });
                        }

                        function loadVideoDash(index) {
                          currentVideoIndexDash = index;
                          const video = currentCourseDash.videos[index];
                          
                          document.getElementById('currentVideoTitleDash').textContent = video.title;
                          document.getElementById('videoProgressDash').textContent = 'Progreso: 0%';
                          document.getElementById('btnMarkCompleteDash').classList.add('hidden');
                          
                          renderVideosListDash();
                          
                          if (ytPlayerDash) {
                            ytPlayerDash.destroy();
                          }

                          const container = document.getElementById('ytPlayerContainerDash');
                          container.innerHTML = '<div id="ytPlayerDash"></div>';
                          
                          if (window.YT && window.YT.Player) {
                            createPlayerDash(video.ytId);
                          } else {
                            window.onYouTubeIframeAPIReady = () => {
                              createPlayerDash(video.ytId);
                            };
                          }
                        }

                        function createPlayerDash(videoId) {
                          ytPlayerDash = new YT.Player('ytPlayerDash', {
                            width: '100%',
                            height: '100%',
                            videoId: videoId,
                            playerVars: { autoplay: 1, rel: 0, modestbranding: 1 },
                            events: {
                              onReady: (event) => {
                                document.getElementById('videoLoadingDash').classList.add('hidden');
                                startProgressTrackingDash();
                              },
                              onStateChange: (event) => {
                                if (event.data === YT.PlayerState.PLAYING) {
                                  startProgressTrackingDash();
                                } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                  stopProgressTrackingDash();
                                }
                              }
                            }
                          });
                        }

                        function startProgressTrackingDash() {
                          stopProgressTrackingDash();
                          progressIntervalDash = setInterval(() => {
                            if (!ytPlayerDash || !ytPlayerDash.getDuration) return;
                            
                            const currentTime = ytPlayerDash.getCurrentTime();
                            const duration = ytPlayerDash.getDuration();
                            const progress = duration > 0 ? (currentTime / duration) * 100 : 0;
                            
                            document.getElementById('videoProgressDash').textContent = `Progreso: ${Math.round(progress)}%`;
                            
                            if (progress >= 90) {
                              const video = currentCourseDash.videos[currentVideoIndexDash];
                              const courseProgress = userProgressDash[currentCourseDash.id] || {};
                              
                              if (!courseProgress[video.id]?.completed) {
                                document.getElementById('btnMarkCompleteDash').classList.remove('hidden');
                                stopProgressTrackingDash();
                              }
                            }
                          }, 1000);
                        }

                        function stopProgressTrackingDash() {
                          if (progressIntervalDash) {
                            clearInterval(progressIntervalDash);
                            progressIntervalDash = null;
                          }
                        }

                        // Funci√≥n global para marcar video como completado
                        window.markVideoCompleteDash = async function() {
                          console.log('üéØ markVideoCompleteDash llamada');
                          try {
                            const video = currentCourseDash.videos[currentVideoIndexDash];
                            console.log('Video actual:', video);
                            
                            if (!userProgressDash[currentCourseDash.id]) {
                              userProgressDash[currentCourseDash.id] = {};
                            }
                            userProgressDash[currentCourseDash.id][video.id] = {
                              completed: true,
                              completedAt: new Date(),
                              progress: 100
                            };
                            
                            console.log('Guardando progreso...');
                            await saveProgressDash();
                            console.log('Progreso guardado');
                            
                            // Dar XP
                            console.log('Dando XP... window.addXP exists?', !!window.addXP);
                            if (window.addXP) {
                              await window.addXP(50);
                              console.log('XP dado: +50');
                            } else {
                              console.error('window.addXP no est√° disponible');
                            }
                            
                            // Actualizar la barra de XP en el header
                            console.log('Actualizando header...');
                            if (window.loadUserData) {
                              await window.loadUserData();
                              console.log('Header actualizado');
                            }
                            
                            updateCourseProgressDash();
                            renderVideosListDash();
                            document.getElementById('btnMarkCompleteDash').classList.add('hidden');
                            
                            if (currentVideoIndexDash < currentCourseDash.videos.length - 1) {
                              const shouldContinue = confirm(`¬°Felicitaciones!\n\nHas completado: ${video.title}\n+50 XP\n\n¬øQuieres continuar con el siguiente video?`);
                              if (shouldContinue) {
                                console.log('Cargando siguiente video...');
                                loadVideoDash(currentVideoIndexDash + 1);
                              }
                            } else {
                              alert(`üéä ¬°Felicitaciones!\n\nHas completado: ${video.title}\n+50 XP\n\nHas terminado todo el curso.`);
                            }
                          } catch (error) {
                            console.error('‚ùå Error al completar video:', error);
                            alert('Error al completar el video: ' + error.message);
                          }
                        };

                        document.getElementById('btnBackToCatalogDash')?.addEventListener('click', () => {
                          document.getElementById('catalogViewDash').classList.remove('hidden');
                          document.getElementById('detailViewDash').classList.add('hidden');
                          stopProgressTrackingDash();
                          if (ytPlayerDash) {
                            ytPlayerDash.destroy();
                            ytPlayerDash = null;
                          }
                          renderCatalogDash();
                        });

                        function showDetailDash() {
                          document.getElementById('catalogViewDash').classList.add('hidden');
                          document.getElementById('detailViewDash').classList.remove('hidden');
                        }

                        // Inicializar lecciones cuando se muestra la secci√≥n
                        const leccionesSection = document.getElementById('section-lecciones');
                        if (leccionesSection) {
                          const observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                if (!leccionesSection.classList.contains('hidden')) {
                                  loadUserProgressDash().then(() => renderCatalogDash());
                                }
                              }
                            });
                          });
                          observer.observe(leccionesSection, { attributes: true });
                        }

                        // ========== M√ìDULO DE LABORATORIO INTEGRADO ==========
                        let currentGameDash = null;
                        let mazeLevelDash = 0;
                        let playerPosDash = { x: 0, y: 0 };
                        let playerDirectionDash = 0;
                        let commandsDash = [];
                        
                        const mazeLevels = [
                          {
                            grid: [
                              [0, 0, 0, 0, 0],
                              [0, 1, 1, 1, 0],
                              [0, 0, 0, 1, 0],
                              [0, 1, 0, 0, 0],
                              [0, 0, 0, 1, 2]
                            ],
                            start: { x: 0, y: 0 },
                            goal: { x: 4, y: 4 }
                          }
                        ];

                        let typoChallengesDash = [
                          'print("Hola Mundo")',
                          'x = 10',
                          'if x > 5:',
                          'for i in range(10):',
                          'def suma(a, b):',
                          'return a + b',
                          'nombre = input("Tu nombre: ")',
                          'lista = [1, 2, 3, 4, 5]',
                          'while True:',
                          'import random'
                        ];
                        let currentChallengeIndexDash = 0;
                        let startTimeDash = null;
                        let correctCountDash = 0;

                        document.querySelectorAll('#section-laboratorio .arcade-game-card').forEach(card => {
                          card.addEventListener('click', () => {
                            const game = card.getAttribute('data-game');
                            openGameDash(game);
                          });
                        });

                        // Event listeners para los botones de juego
                        document.querySelectorAll('#section-laboratorio .arcade-play-button').forEach(btn => {
                          btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // Feedback visual de carga
                            const originalText = btn.textContent;
                            btn.textContent = 'Cargando...';
                            btn.style.opacity = '0.7';
                            btn.disabled = true;
                            
                            const card = btn.closest('.arcade-game-card');
                            const game = card.getAttribute('data-game');
                            
                            // Simular peque√±o delay para feedback visual
                            setTimeout(() => {
                              openGameDash(game);
                              // Restaurar bot√≥n
                              btn.textContent = originalText;
                              btn.style.opacity = '1';
                              btn.disabled = false;
                            }, 150);
                          });
                        });

                        document.getElementById('closeGameBtnDash')?.addEventListener('click', closeGameDash);

                        // Funcionalidad de filtrado por categor√≠as
                        document.querySelectorAll('.arcade-filter-btn').forEach(btn => {
                          btn.addEventListener('click', (e) => {
                            const category = btn.getAttribute('data-category');
                            
                            // Actualizar bot√≥n activo
                            document.querySelectorAll('.arcade-filter-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            
                            // Filtrar juegos
                            const gameCards = document.querySelectorAll('.arcade-game-card');
                            gameCards.forEach(card => {
                              const cardCategory = card.getAttribute('data-category');
                              
                              if (category === 'all' || cardCategory === category) {
                                card.style.display = 'block';
                              } else {
                                card.style.display = 'none';
                              }
                            });
                          });
                        });

                        function openGameDash(gameName) {
                          currentGameDash = gameName;
                          const modal = document.getElementById('gameModalDash');
                          const content = document.getElementById('gameContentDash');
                          
                          if (gameName === 'maze') {
                            content.innerHTML = renderMazeGameDash();
                            initMazeGameDash();
                          } else if (gameName === 'typo') {
                            content.innerHTML = renderTypoGameDash();
                            initTypoGameDash();
                          }
                          
                          modal.classList.remove('hidden');
                        }

                        function closeGameDash() {
                          document.getElementById('gameModalDash').classList.add('hidden');
                          currentGameDash = null;
                          mazeLevelDash = 0;
                          currentChallengeIndexDash = 0;
                          correctCountDash = 0;
                        }

                        function renderMazeGameDash() {
                          return `
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Laberinto de Bloques - Nivel ${mazeLevelDash + 1}</h2>
                            <p class="text-gray-600 mb-4">Programa al robot para llegar a la meta.</p>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                              <div>
                                <div id="mazeGridDash" class="inline-grid gap-1 mb-4" style="grid-template-columns: repeat(5, 60px);"></div>
                              </div>
                              
                              <div>
                                <h3 class="font-bold text-gray-800 mb-3">Comandos:</h3>
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                  <button class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700" onclick="window.addCommandDash('forward')">Avanzar</button>
                                  <button class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700" onclick="window.addCommandDash('turnLeft')">Girar Izq</button>
                                  <button class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700" onclick="window.addCommandDash('turnRight')">Girar Der</button>
                                  <button class="bg-red-600 text-white p-3 rounded-lg hover:bg-red-700" onclick="window.clearCommandsDash()">Limpiar</button>
                                </div>
                                
                                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                                  <h4 class="font-semibold text-gray-700 mb-2">Programa:</h4>
                                  <div id="commandsListDash" class="text-sm space-y-1">Sin comandos</div>
                                </div>
                                
                                                                <button class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold mb-2" onclick="window.executeCommandsDash()">
                                                                    Ejecutar Programa
                                                                </button>
                                                                <button class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition" onclick="window.resetMazeDash()">
                                                                    Reiniciar Nivel
                                                                </button>
                              </div>
                            </div>
                          `;
                        }

                        function initMazeGameDash() {
                          const level = mazeLevels[mazeLevelDash];
                          playerPosDash = { ...level.start };
                          playerDirectionDash = 0;
                          commandsDash = [];
                          renderMazeDash();
                          updateCommandsListDash();
                        }

                        function renderMazeDash() {
                          const grid = document.getElementById('mazeGridDash');
                          const level = mazeLevels[mazeLevelDash];
                          if (!grid) return;
                          
                          grid.innerHTML = '';
                          
                          for (let y = 0; y < level.grid.length; y++) {
                            for (let x = 0; x < level.grid[0].length; x++) {
                              const cell = document.createElement('div');
                              cell.style.width = '60px';
                              cell.style.height = '60px';
                              cell.style.border = '2px solid #e5e7eb';
                              cell.style.display = 'flex';
                              cell.style.alignItems = 'center';
                              cell.style.justifyContent = 'center';
                              cell.style.fontSize = '2rem';
                              
                              if (level.grid[y][x] === 1) {
                                cell.style.backgroundColor = '#1f2937';
                                cell.textContent = '‚¨õ';
                              } else if (x === playerPosDash.x && y === playerPosDash.y) {
                                                                const icons = ['‚Üí', '‚Üì', '‚Üê', '‚Üë'];
                                                                cell.textContent = icons[playerDirectionDash];
                              } else if (x === level.goal.x && y === level.goal.y) {
                                                                cell.classList.add('maze-goal');
                                                                cell.setAttribute('aria-label','Meta');
                              }
                              
                              grid.appendChild(cell);
                            }
                          }
                        }

                        window.addCommandDash = function(cmd) {
                          commandsDash.push(cmd);
                          updateCommandsListDash();
                        };

                        window.clearCommandsDash = function() {
                          commandsDash = [];
                          updateCommandsListDash();
                        };

                        function updateCommandsListDash() {
                          const list = document.getElementById('commandsListDash');
                          if (!list) return;
                          if (commandsDash.length === 0) {
                            list.innerHTML = '<p class="text-gray-400">Sin comandos</p>';
                          } else {
                                                        const labels = {
                                                            forward: 'Avanzar',
                                                            turnLeft: 'Girar Izquierda',
                                                            turnRight: 'Girar Derecha'
                                                        };
                            list.innerHTML = commandsDash.map((cmd, i) => `<div>${i + 1}. ${labels[cmd]}</div>`).join('');
                          }
                        }

                        window.executeCommandsDash = async function() {
                          const level = mazeLevels[mazeLevelDash];
                          playerPosDash = { ...level.start };
                          playerDirectionDash = 0;
                          
                          for (let cmd of commandsDash) {
                            if (cmd === 'forward') {
                              const directions = [
                                { dx: 1, dy: 0 },
                                { dx: 0, dy: 1 },
                                { dx: -1, dy: 0 },
                                { dx: 0, dy: -1 }
                              ];
                              const dir = directions[playerDirectionDash];
                              const newX = playerPosDash.x + dir.dx;
                              const newY = playerPosDash.y + dir.dy;
                              
                              if (newX >= 0 && newX < level.grid[0].length && 
                                  newY >= 0 && newY < level.grid.length && 
                                  level.grid[newY][newX] !== 1) {
                                playerPosDash.x = newX;
                                playerPosDash.y = newY;
                              }
                            } else if (cmd === 'turnLeft') {
                              playerDirectionDash = (playerDirectionDash + 3) % 4;
                            } else if (cmd === 'turnRight') {
                              playerDirectionDash = (playerDirectionDash + 1) % 4;
                            }
                            
                            renderMazeDash();
                            await new Promise(resolve => setTimeout(resolve, 500));
                          }
                          
                          if (playerPosDash.x === level.goal.x && playerPosDash.y === level.goal.y) {
                            console.log('üéØ ¬°Llegaste a la meta!');
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            try {
                              // Guardar juego completado en Firestore
                              const user = window.currentUser || window.auth?.currentUser;
                              if (user && window.db) {
                                const userRef = doc(window.db, 'users', user.uid);
                                const userDoc = await getDoc(userRef);
                                const userData = userDoc.exists() ? userDoc.data() : {};
                                const gameScores = userData.studentProfile?.gameScores || {};
                                gameScores['maze_runner'] = (gameScores['maze_runner'] || 0) + 1;
                                
                                await updateDoc(userRef, {
                                  'studentProfile.gameScores': gameScores
                                });
                                console.log('‚úÖ Juego guardado en Firestore');
                              }
                              
                              // Dar XP
                              console.log('Dando XP del laberinto... window.addXP exists?', !!window.addXP);
                              if (window.addXP) {
                                await window.addXP(30);
                                console.log('‚úÖ XP dado: +30');
                              } else {
                                console.error('‚ùå window.addXP no disponible');
                              }
                              
                              // Actualizar barra de XP
                              console.log('Actualizando barra de XP...');
                              if (window.loadUserData) {
                                await window.loadUserData();
                                console.log('‚úÖ Barra actualizada');
                              }
                              
                              alert('¬°Felicitaciones!\n\nHas completado el nivel.\n+30 XP');
                              closeGameDash();
                            } catch (error) {
                              console.error('‚ùå Error en laberinto:', error);
                              alert('Error: ' + error.message);
                            }
                          } else {
                            alert('‚ùå No llegaste a la meta.\n\nIntenta de nuevo.');
                          }
                        };

                        window.resetMazeDash = function() {
                          initMazeGameDash();
                        };

                        function renderTypoGameDash() {
                          return `
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Typo-Racer: Python Edition</h2>
                            <p class="text-gray-600 mb-4">Escribe el c√≥digo exactamente como aparece.</p>
                            
                            <div class="mb-6">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">Progreso:</span>
                                <span id="typoProgressDash" class="text-sm text-gray-600">0/10</span>
                              </div>
                              <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="typoProgressBarDash" class="bg-green-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                              </div>
                            </div>
                            
                            <div class="p-4 rounded bg-gray-900 text-green-400 font-mono text-xl mb-4" id="typoChallengeDash">
                              print("Hola Mundo")
                            </div>
                            
                            <input 
                              type="text" 
                              id="typoInputDash" 
                              class="w-full p-3 font-mono text-lg bg-gray-800 text-blue-400 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 mb-4" 
                              placeholder="Escribe el c√≥digo aqu√≠..."
                              autocomplete="off"
                              spellcheck="false"
                            >
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                              <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-3xl font-bold text-blue-600" id="typoCorrectDash">0</div>
                                <div class="text-sm text-gray-600">Correctos</div>
                              </div>
                              <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-3xl font-bold text-purple-600" id="typoTimeDash">0s</div>
                                <div class="text-sm text-gray-600">Tiempo</div>
                              </div>
                            </div>
                            
                            <div id="typoFeedbackDash" class="text-center text-sm"></div>
                          `;
                        }

                        function initTypoGameDash() {
                          currentChallengeIndexDash = 0;
                          correctCountDash = 0;
                          startTimeDash = Date.now();
                          
                          typoChallengesDash = typoChallengesDash.sort(() => Math.random() - 0.5);
                          
                          showNextChallengeDash();
                          
                          const input = document.getElementById('typoInputDash');
                          if (input) {
                            input.focus();
                            input.addEventListener('input', checkTypoInputDash);
                          }
                          
                          setInterval(updateTimerDash, 100);
                        }

                        function showNextChallengeDash() {
                          if (currentChallengeIndexDash >= 10) {
                            const totalTime = ((Date.now() - startTimeDash) / 1000).toFixed(1);
                            (async () => {
                              // Dar XP
                              if (window.addXP) {
                                await window.addXP(20);
                              }
                              
                              // Actualizar barra de XP
                              if (window.loadUserData) {
                                await window.loadUserData();
                              }
                              
                              alert(`üéä ¬°Juego completado!\n\nC√≥digos correctos: ${correctCountDash}/10\nTiempo: ${totalTime}s\n+20 XP`);
                              closeGameDash();
                            })();
                            return;
                          }
                          
                          const challenge = typoChallengesDash[currentChallengeIndexDash % typoChallengesDash.length];
                          document.getElementById('typoChallengeDash').textContent = challenge;
                          document.getElementById('typoInputDash').value = '';
                          document.getElementById('typoProgressDash').textContent = `${currentChallengeIndexDash}/10`;
                          document.getElementById('typoProgressBarDash').style.width = `${(currentChallengeIndexDash / 10) * 100}%`;
                          document.getElementById('typoInputDash').focus();
                        }

                        function checkTypoInputDash(e) {
                          const input = e.target.value;
                          const challenge = typoChallengesDash[currentChallengeIndexDash % typoChallengesDash.length];
                          const feedback = document.getElementById('typoFeedbackDash');
                          
                          if (input === challenge) {
                            feedback.innerHTML = '<span class="text-green-600 font-semibold">‚úì ¬°Correcto!</span>';
                            correctCountDash++;
                            document.getElementById('typoCorrectDash').textContent = correctCountDash;
                            
                            setTimeout(() => {
                              currentChallengeIndexDash++;
                              showNextChallengeDash();
                              feedback.innerHTML = '';
                            }, 300);
                          } else if (challenge.startsWith(input)) {
                            feedback.innerHTML = '<span class="text-gray-500">Sigue escribiendo...</span>';
                          } else {
                            feedback.innerHTML = '<span class="text-red-600">‚úó Error</span>';
                          }
                        }

                        function updateTimerDash() {
                          if (!startTimeDash || currentGameDash !== 'typo') return;
                          const elapsed = ((Date.now() - startTimeDash) / 1000).toFixed(1);
                          const timeEl = document.getElementById('typoTimeDash');
                          if (timeEl) {
                            timeEl.textContent = elapsed + 's';
                          }
                        }
        </script>
        
        <!-- Dashboard Enhancements Script -->
        <script src="../js/dashboard-enhancements.js"></script>
        
        <!-- Lecciones Enhancements Script -->
        <script src="../js/lecciones-enhancements.js"></script>
</body>
</html>
